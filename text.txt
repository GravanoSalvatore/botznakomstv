 tree -I "node_modules" -L 4
rm telegram-bot/bot/handlers/bot.lock
 
kill -9 18044 17397 9886 2371 22658 20770 23467











const admin = require("firebase-admin");
const fs = require("fs");
const path = require("path");
const CryptoPayHandler = require("./cryptoPay");

module.exports = (bot, db) => {
  // ================= 1. –ü–†–ï–î–ó–ê–ì–†–£–ó–ö–ê –ò–ó–û–ë–†–ê–ñ–ï–ù–ò–Ø =================
  const welcomeImage = {
    path: path.join(__dirname, "../../img/welcome.jpg"),
    buffer: null,
    fileId: null,
    load: function () {
      if (fs.existsSync(this.path)) {
        this.buffer = fs.readFileSync(this.path);
        console.log("–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ welcome.jpg –∑–∞–≥—Ä—É–∂–µ–Ω–æ –≤ –ø–∞–º—è—Ç—å");
      }
    },
  };
  welcomeImage.load();

  const cryptoPay = new CryptoPayHandler(bot, db);

  // ================= 2. –§–£–ù–ö–¶–ò–Ø –ü–†–û–í–ï–†–ö–ò –ü–û–î–ü–ò–°–ö–ò =================
  const checkSubscription = async (userId) => {
    try {
      const subRef = db.collection("subscriptions").doc(userId.toString());
      const doc = await subRef.get();

      if (!doc.exists) {
        return {
          active: false,
          message: "‚ùå –£ –≤–∞—Å –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–π –ø–æ–¥–ø–∏—Å–∫–∏",
        };
      }

      const subData = doc.data();
      const isActive =
        subData.isActive && subData.endDate.toDate() > new Date();

      let message = "";
      if (isActive) {
        const endDate = subData.endDate.toDate();
        const daysLeft = Math.ceil(
          (endDate - new Date()) / (1000 * 60 * 60 * 24)
        );

        if (subData.subscriptionType === "forever") {
          message = "üéâ –£ –≤–∞—Å –±–µ—Å—Å—Ä–æ—á–Ω–∞—è –ø–æ–¥–ø–∏—Å–∫–∞!";
        } else {
          message = `‚úÖ –ü–æ–¥–ø–∏—Å–∫–∞ –∞–∫—Ç–∏–≤–Ω–∞ –¥–æ: ${endDate.toLocaleDateString()} (–æ—Å—Ç–∞–ª–æ—Å—å ${daysLeft} –¥–Ω–µ–π)`;
        }
      } else {
        message = "‚ùå –ü–æ–¥–ø–∏—Å–∫–∞ –∏—Å—Ç–µ–∫–ª–∞";
      }

      return {
        active: isActive,
        message: message,
        subscription: subData,
      };
    } catch (error) {
      console.error("–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ–¥–ø–∏—Å–∫–∏:", error);
      return {
        active: false,
        message: "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ–¥–ø–∏—Å–∫–∏",
      };
    }
  };

  // ================= 3. –§–£–ù–ö–¶–ò–Ø –û–ß–ò–°–¢–ö–ò –ß–ê–¢–ê =================
  const clearChat = async (ctx) => {
    try {
      const chatId = ctx.chat.id;
      const messageId = ctx.message
        ? ctx.message.message_id
        : ctx.update.callback_query.message.message_id;

      // –£–¥–∞–ª—è–µ–º —Ç–µ–∫—É—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
      await ctx.deleteMessage();

      // –£–¥–∞–ª—è–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è (–¥–æ 10 —à—Ç—É–∫)
      for (let i = 1; i <= 10; i++) {
        try {
          await ctx.telegram.deleteMessage(chatId, messageId - i);
        } catch (e) {
          // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏ (—Å–æ–æ–±—â–µ–Ω–∏—è –º–æ–≥—É—Ç –Ω–µ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞—Ç—å)
        }
      }

      return true;
    } catch (error) {
      console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—á–∏—Å—Ç–∫–µ —á–∞—Ç–∞:", error);
      return false;
    }
  };

// ================= 4. –§–£–ù–ö–¶–ò–Ø –û–ß–ò–°–¢–ö–ò –≠–ö–†–ê–ù–ê =================
const clearScreen = async (ctx) => {
    try {
        await clearChat(ctx);

        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é
        const userId = ctx.from.id;
        const subscription = await checkSubscription(userId);
        const hasSub = subscription.active;

        const baseKeyboard = [];

        if (hasSub) {
            baseKeyboard.push([
                { text: "üåç –í—Å–µ —Å—Ç—Ä–∞–Ω—ã", callback_data: "all_countries" },
            ]);
        }
        if (!hasSub) {
            baseKeyboard.push([
                { text: "üåç –í—Å–µ —Å—Ç—Ä–∞–Ω—ã", callback_data: "choose_payment_method" },
            ]);
        }

        baseKeyboard.push([
            { text: "üíé –ö—É–ø–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É", callback_data: "choose_payment_method" },
        ]);
        // –î–û–ë–ê–í–õ–ï–ù–ê –ù–û–í–ê–Ø –ö–ù–û–ü–ö–ê
        baseKeyboard.push([
            { text: "üë®‚Äçüíª –°–≤—è–∑–∞—Ç—å—Å—è —Å –∞–¥–º–∏–Ω–æ–º", url: "https://t.me/MagicAdd" },
        ]);
        baseKeyboard.push([
            { text: "üßπ –û—á–∏—Å—Ç–∏—Ç—å —ç–∫—Ä–∞–Ω", callback_data: "clear_screen" },
        ]);

        const welcomeText = `üëã<b> –ü—Ä–∏–≤–µ—Ç, ${ctx.from.first_name}!
–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –∫–ª—É–±  ‚ú®Magic</b> 
<em>–ó–¥–µ—Å—å —Ç—ã –Ω–∞–π–¥—ë—à—å –∫–∞—Ç–∞–ª–æ–≥ –∞–Ω–∫–µ—Ç —Å–æ –≤—Å–µ–≥–æ –º–∏—Ä–∞ –¥–ª—è –æ–±—â–µ–Ω–∏—è, —Ñ–ª–∏—Ä—Ç–∞ –∏ —Å–µ—Ä—å—ë–∑–Ω—ã—Ö –æ—Ç–Ω–æ—à–µ–Ω–∏–π.
üéâ –ö–∞—Ç–∞–ª–æ–≥ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –∫–∞–∂–¥—ã–π –¥–µ–Ω—å ‚Äî –≤—Å–µ–≥–¥–∞ —Å–≤–µ–∂–∏–µ –ø—Ä–æ—Ñ–∏–ª–∏!
–ù–∞—á–Ω–∏ –ø–æ–∏—Å–∫ –∏–ª–∏ —Ä–∞–∑–º–µ—Å—Ç–∏ —Å–≤–æ—é –∞–Ω–∫–µ—Ç—É ‚Äî –≤–æ–∑–º–æ–∂–Ω–æ, —Ç–≤–æ—è –≤—Ç–æ—Ä–∞—è –ø–æ–ª–æ–≤–∏–Ω–∫–∞ —É–∂–µ –∑–¥–µ—Å—å!</em>\n
<a href="http://t.me/MagicYourClub"><b>–ü–æ–¥–ø–∏—à–∏—Å—å –Ω–∞ –Ω–æ–≤–æ—Å—Ç–∏ –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è ‚ú®</b></a>\n`;

        try {
            if (welcomeImage.fileId) {
                await ctx.replyWithPhoto(welcomeImage.fileId, {
                    caption: welcomeText,
                    parse_mode: "HTML",
                    reply_markup: { inline_keyboard: baseKeyboard },
                });
            } else if (welcomeImage.buffer) {
                const msg = await ctx.replyWithPhoto(
                    { source: welcomeImage.buffer },
                    {
                        caption: welcomeText,
                        parse_mode: "HTML",
                        reply_markup: { inline_keyboard: baseKeyboard },
                    }
                );
                welcomeImage.fileId = msg.photo[0].file_id;
            } else {
                await ctx.reply(welcomeText, {
                    parse_mode: "HTML",
                    reply_markup: { inline_keyboard: baseKeyboard },
                });
            }
        } catch (e) {
            console.error("–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ welcome:", e);
            await ctx.reply(welcomeText, {
                parse_mode: "HTML",
                reply_markup: { inline_keyboard: baseKeyboard },
            });
        }

        if (hasSub) {
            setTimeout(async () => {
                try {
                    await ctx.reply(subscription.message, { parse_mode: "HTML" });
                } catch (e) {
                    console.error("–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å—Ç–∞—Ç—É—Å–∞ –ø–æ–¥–ø–∏—Å–∫–∏:", e);
                }
            }, 500);
        }
    } catch (error) {
        console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—á–∏—Å—Ç–∫–µ —ç–∫—Ä–∞–Ω–∞:", error);
        // –ï—Å–ª–∏ –æ—á–∏—Å—Ç–∫–∞ –Ω–µ —É–¥–∞–ª–∞—Å—å, –ø—Ä–æ—Å—Ç–æ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é
        await showMainMenu(ctx);
    }
};

  // ================= 5. –§–£–ù–ö–¶–ò–Ø –û–¢–û–ë–†–ê–ñ–ï–ù–ò–Ø –ì–õ–ê–í–ù–û–ì–û –ú–ï–ù–Æ =================
const showMainMenu = async (ctx) => {
    const userId = ctx.from.id;
    const subscription = await checkSubscription(userId);
    const hasSub = subscription.active;

    const baseKeyboard = [];

    if (hasSub) {
        baseKeyboard.push([
            { text: "üåç –í—Å–µ —Å—Ç—Ä–∞–Ω—ã", callback_data: "all_countries" },
        ]);
    }
    if (!hasSub) {
        baseKeyboard.push([
            { text: "üåç –í—Å–µ —Å—Ç—Ä–∞–Ω—ã", callback_data: "choose_payment_method" },
        ]);
    }
    baseKeyboard.push([
        { text: "üíé –ö—É–ø–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É", callback_data: "choose_payment_method" },
    ]);
    // –î–û–ë–ê–í–õ–ï–ù–ê –ù–û–í–ê–Ø –ö–ù–û–ü–ö–ê
    baseKeyboard.push([
        { text: "üë®‚Äçüíª –°–≤—è–∑–∞—Ç—å—Å—è —Å –∞–¥–º–∏–Ω–æ–º", url: "https://t.me/MagicAdd" },
    ]);
    baseKeyboard.push([
        { text: "üßπ –û—á–∏—Å—Ç–∏—Ç—å —ç–∫—Ä–∞–Ω", callback_data: "clear_screen" },
    ]);

    const welcomeText = `üëã<b> –ü—Ä–∏–≤–µ—Ç, ${ctx.from.first_name}!
–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –∫–ª—É–± –∑–Ω–∞–∫–æ–º—Å—Ç–≤ ‚ú®Magic!</b> 
<em>–ó–¥–µ—Å—å —Ç—ã –Ω–∞–π–¥—ë—à—å –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö –∞–Ω–∫–µ—Ç —Å–æ –≤—Å–µ–≥–æ –º–∏—Ä–∞ –¥–ª—è –æ–±—â–µ–Ω–∏—è –∏ –Ω–µ —Ç–æ–ª—å–∫–æ. 
üóÑÔ∏è –ë–∞–∑–∞ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –∏ –ø–æ–ø–æ–ª–Ω—è–µ—Ç—Å—è –∫–∞–∂–¥—ã–π –¥–µ–Ω—å ‚Äî –≤—Å–µ–≥–¥–∞ —Å–≤–µ–∂–∏–µ –ø—Ä–æ—Ñ–∏–ª–∏!
–ù–∞—á–Ω–∏ –ø–æ–∏—Å–∫ –∏–ª–∏ —Ä–∞–∑–º–µ—Å—Ç–∏ —Å–≤–æ—é –∞–Ω–∫–µ—Ç—É ‚Äî –≤–æ–∑–º–æ–∂–Ω–æ, —Ç–≤–æ—è –≤—Ç–æ—Ä–∞—è –ø–æ–ª–æ–≤–∏–Ω–∫–∞ —É–∂–µ –∑–¥–µ—Å—å!</em>\n
<a href="http://t.me/MagicYourClub"><b>‚ú® –ü–æ–¥–ø–∏—à–∏—Å—å –Ω–∞ –Ω–æ–≤–æ—Å—Ç–∏ –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è </b></a>\n`;

    try {
        if (welcomeImage.fileId) {
            await ctx.replyWithPhoto(welcomeImage.fileId, {
                caption: welcomeText,
                parse_mode: "HTML",
                reply_markup: { inline_keyboard: baseKeyboard },
            });
        } else if (welcomeImage.buffer) {
            const msg = await ctx.replyWithPhoto(
                { source: welcomeImage.buffer },
                {
                    caption: welcomeText,
                    parse_mode: "HTML",
                    reply_markup: { inline_keyboard: baseKeyboard },
                }
            );
            welcomeImage.fileId = msg.photo[0].file_id;
        } else {
            await ctx.reply(welcomeText, {
                parse_mode: "HTML",
                reply_markup: { inline_keyboard: baseKeyboard },
            });
        }
    } catch (e) {
        console.error("–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ welcome:", e);
        await ctx.reply(welcomeText, {
            parse_mode: "HTML",
            reply_markup: { inline_keyboard: baseKeyboard },
        });
    }

    if (hasSub) {
        setTimeout(async () => {
            try {
                await ctx.reply(subscription.message, { parse_mode: "HTML" });
            } catch (e) {
                console.error("–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å—Ç–∞—Ç—É—Å–∞ –ø–æ–¥–ø–∏—Å–∫–∏:", e);
            }
        }, 500);
    }
};
  // ================= 6. –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –ö–û–õ–õ–ï–ö–¶–ò–ô =================
  const initCollections = async () => {
    const collections = [
      "subscriptions",
      "transactions",
      "payment_logs",
      "cryptoPayPayments",
    ];
    for (const col of collections) {
      try {
        const ref = db.collection(col).doc("init");
        await ref.set({ _init: true });
        await ref.delete();
      } catch (error) {
        console.log(`–ö–æ–ª–ª–µ–∫—Ü–∏—è ${col} —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç`);
      }
    }
  };

  // ================= 7. –û–ë–†–ê–ë–û–¢–ß–ò–ö START =================
  bot.start(async (ctx) => {
    initCollections().catch((e) => console.error("–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏:", e));
    await showMainMenu(ctx);
  });

  // ================= 8. –û–ë–†–ê–ë–û–¢–ß–ò–ö –û–ß–ò–°–¢–ö–ò –≠–ö–†–ê–ù–ê =================
  bot.action("clear_screen", async (ctx) => {
    await clearScreen(ctx);
  });

  // ================= 9. –í–´–ë–û–† –°–ü–û–°–û–ë–ê –û–ü–õ–ê–¢–´ =================
  bot.action("choose_payment_method", async (ctx) => {
    const keyboard = {
      inline_keyboard: [
        [
          {
            text: "‚≠ê –û–ø–ª–∞—Ç–∞ Stars",
            callback_data: "show_stars_plans",
          },
        ],
        [
          {
            text: "üí≤ –û–ø–ª–∞—Ç–∞ USDT ",
            callback_data: "show_crypto_plans",
          },
        ],
        [
          {
            text: "üíé –û–ø–ª–∞—Ç–∞ TON",
            callback_data: "show_ton_plans",
          },
        ],
        [
          {
            text: "üîô –ù–∞–∑–∞–¥",
            callback_data: "back_to_main",
          },
          {
            text: "üßπ –û—á–∏—Å—Ç–∏—Ç—å —ç–∫—Ä–∞–Ω",
            callback_data: "clear_screen",
          },
        ],
      ],
    };

    await ctx.reply(
      `üíé <b>–í–´–ë–ï–†–ò –°–ü–û–°–û–ë –û–ü–õ–ê–¢–´</b>\n\n` +
        `‚≠ê <b>Stars</b> - –æ–ø–ª–∞—Ç–∞ —á–µ—Ä–µ–∑ Telegram\n` +
        `‚Ä¢ –ë—ã—Å—Ç—Ä–æ –∏ —É–¥–æ–±–Ω–æ\n` +
        `‚Ä¢ –í–Ω—É—Ç—Ä–∏ Telegram\n\n` +
        ` üí≤ <b>USDT </b> - –æ–ø–ª–∞—Ç–∞ –∫—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç–æ–π\n` +
        `‚Ä¢ –ê–Ω–æ–Ω–∏–º–Ω–æ –∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ\n` +
        `‚Ä¢ –ü–æ–¥–¥–µ—Ä–∂–∫–∞ USDT, BTC, ETH\n\n` +
        `üíé <b>TON</b> - –æ–ø–ª–∞—Ç–∞ –≤ Toncoin\n` +
        `‚Ä¢ –ë—ã—Å—Ç—Ä—ã–µ –ø–µ—Ä–µ–≤–æ–¥—ã\n` +
        `‚Ä¢ –ù–∏–∑–∫–∏–µ –∫–æ–º–∏—Å—Å–∏–∏\n\n` +
        `<b>–í—ã–±–µ—Ä–∏ —Å–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã:</b>`,
      {
        parse_mode: "HTML",
        reply_markup: keyboard,
      }
    );
  });

  // ================= 10. –¢–ê–†–ò–§–´ –î–õ–Ø STARS =================
  bot.action("show_stars_plans", async (ctx) => {
    const keyboard = {
      inline_keyboard: [
        [
          {
            text: "üî• 1 –¥–µ–Ω—å (399üåü)",
            callback_data: "buy_1day",
          },
        ],
        [
          {
            text: "‚ù§Ô∏è 1 –º–µ—Å—è—Ü (799üåü)",
            callback_data: "buy_1month",
          },
        ],
        [
          {
            text: "üí´ 1 –≥–æ–¥ (3999üåü)",
            callback_data: "buy_forever",
          },
        ],
        [
          {
            text: "üîô –ù–∞–∑–∞–¥",
            callback_data: "choose_payment_method",
          },
          {
            text: "üßπ –û—á–∏—Å—Ç–∏—Ç—å —ç–∫—Ä–∞–Ω",
            callback_data: "clear_screen",
          },
        ],
      ],
    };

    await ctx.reply(
  `‚≠ê <b>–û–ü–õ–ê–¢–ê STARS</b>\n\n` +
  
  `üî• <b>1 –¥–µ–Ω—å</b> - 399 Stars\n` +
  `‚ù§Ô∏è <b>1 –º–µ—Å—è—Ü</b> - 799 Stars\n` +
  `üí´ <b>1 –≥–æ–¥</b> - 3999 Stars\n\n` +
  `<b>–í—ã–±–µ—Ä–∏ —Ç–∞—Ä–∏—Ñ:</b>`,
  {
    parse_mode: "HTML",
    reply_markup: keyboard,
  }
);
  });

  // ================= 11. –¢–ê–†–ò–§–´ –î–õ–Ø CRYPTO PAY =================
  bot.action("show_crypto_plans", async (ctx) => {
    const keyboard = {
      inline_keyboard: [
        [
          {
            text: "üü¢ 1 –¥–µ–Ω—å - 5 USDT",
            callback_data: "crypto_basic",
          },
        ],
        [
          {
            text: "üîµ 1 –º–µ—Å—è—Ü - 10 USDT",
            callback_data: "crypto_pro",
          },
        ],
        [
          {
            text: "üü£ 1 –≥–æ–¥ - 50 USDT",
            callback_data: "crypto_premium",
          },
        ],
        [
          {
            text: "üîô –ù–∞–∑–∞–¥",
            callback_data: "choose_payment_method",
          },
          {
            text: "üßπ –û—á–∏—Å—Ç–∏—Ç—å —ç–∫—Ä–∞–Ω",
            callback_data: "clear_screen",
          },
        ],
      ],
    };

    await ctx.reply(
      ` <b>–û–ü–õ–ê–¢–ê USDT </b>\n\n` +
      `–ß—Ç–æ–±—ã –∫—É–ø–∏—Ç—å USDT —á–µ—Ä–µ–∑ ü§ñ–∫—Ä–∏–ø—Ç–æ-–±–æ—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –±–æ—Ç–∞, –Ω–∞–π–¥–∏—Ç–µ —Ä–∞–∑–¥–µ–ª P2P-—Ç–æ—Ä–≥–æ–≤–ª–∏, –≤—ã–±–µ—Ä–∏—Ç–µ USDT, –∑–∞—Ç–µ–º —É–∫–∞–∂–∏—Ç–µ —Å–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã (–Ω–∞–ø—Ä–∏–º–µ—Ä, –°–ë–ü) –∏ –Ω–∞–π–¥–∏—Ç–µ –ø–æ–¥—Ö–æ–¥—è—â–µ–≥–æ –ø—Ä–æ–¥–∞–≤—Ü–∞, —á—å–∏ –ª–∏–º–∏—Ç—ã –∏ –∫—É—Ä—Å –≤–∞—Å —É—Å—Ç—Ä–∞–∏–≤–∞—é—Ç. –°–ª–µ–¥—É–π—Ç–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è–º –ø—Ä–æ–¥–∞–≤—Ü–∞ –¥–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Å–¥–µ–ª–∫–∏: —Å–¥–µ–ª–∞–π—Ç–µ –ø–µ—Ä–µ–≤–æ–¥ —Ñ–∏–∞—Ç–Ω—ã—Ö –¥–µ–Ω–µ–≥ –∏ –¥–æ–∂–¥–∏—Ç–µ—Å—å –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏—è USDT –Ω–∞ –≤–∞—à —Å—á–µ—Ç.\n\n` +
  `<b>–ü–æ—à–∞–≥–æ–≤–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è:</b>\n` +
  `1. –ù–∞–π–¥–∏—Ç–µ –±–æ—Ç–∞: –ó–∞–ø—É—Å—Ç–∏—Ç–µ –Ω—É–∂–Ω–æ–≥–æ –∫—Ä–∏–ø—Ç–æ-–±–æ—Ç–∞, –Ω–∞–ø—Ä–∏–º–µ—Ä, —á–µ—Ä–µ–∑ —Ç–µ–ª–µ–≥—Ä–∞–º-–∫–æ—à–µ–ª–µ–∫.\n` +
  `2. –ù–∞—Å—Ç—Ä–æ–π—Ç–µ –±–æ—Ç–∞ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ): –ü–µ—Ä–µ–¥ –Ω–∞—á–∞–ª–æ–º –∑–∞–π–¥–∏—Ç–µ –≤ ¬´–ù–∞—Å—Ç—Ä–æ–π–∫–∏¬ª, —á—Ç–æ–±—ã —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –Ω—É–∂–Ω—É—é —Ñ–∏–∞—Ç–Ω—É—é –≤–∞–ª—é—Ç—É (–Ω–∞–ø—Ä–∏–º–µ—Ä, –≥—Ä–∏–≤–Ω—É –∏–ª–∏ —Ä—É–±–ª—å), —ç—Ç–æ –ø–æ–≤–ª–∏—è–µ—Ç –Ω–∞ –¥–æ—Å—Ç—É–ø–Ω—ã–µ —Å–ø–æ—Å–æ–±—ã –æ–ø–ª–∞—Ç—ã.\n` +
  `3. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ P2P-—Ä–∞–∑–¥–µ–ª: –ù–∞–π–¥–∏—Ç–µ –≤ –º–µ–Ω—é —Ä–∞–∑–¥–µ–ª ¬´P2P¬ª (peer-to-peer), –≥–¥–µ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –ø–æ–∫—É–ø–∫–∞ –∏ –ø—Ä–æ–¥–∞–∂–∞ –∫—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç—ã –Ω–∞–ø—Ä—è–º—É—é –º–µ–∂–¥—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏.\n` +
  `4. –í—ã–±–µ—Ä–∏—Ç–µ ¬´–ö—É–ø–∏—Ç—å¬ª: –ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∫–Ω–æ–ø–∫—É ¬´–ö—É–ø–∏—Ç—å¬ª, –≤—ã–±–µ—Ä–∏—Ç–µ USDT –∏ —É–¥–æ–±–Ω—ã–π –¥–ª—è –≤–∞—Å –º–µ—Ç–æ–¥ –æ–ø–ª–∞—Ç—ã (–Ω–∞–ø—Ä–∏–º–µ—Ä, –°–ë–ü, –±–∞–Ω–∫–æ–≤—Å–∫–∏–π –ø–µ—Ä–µ–≤–æ–¥).\n` +
  `5. –í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–æ–¥–∞–≤—Ü–∞: –û–∑–Ω–∞–∫–æ–º—å—Ç–µ—Å—å —Å –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–Ω—ã–º–∏ –ø—Ä–æ–¥–∞–≤—Ü–∞–º–∏. –û–±—Ä–∞—Ç–∏—Ç–µ –≤–Ω–∏–º–∞–Ω–∏–µ –Ω–∞ –∫—É—Ä—Å, –ª–∏–º–∏—Ç—ã –ø–æ —Å—É–º–º–µ –∏ —Ä–µ–ø—É—Ç–∞—Ü–∏—é –ø—Ä–æ–¥–∞–≤—Ü–∞.\n` +
  `6. –°–æ–∑–¥–∞–π—Ç–µ —Å–¥–µ–ª–∫—É: –í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–¥—Ö–æ–¥—è—â–µ–≥–æ –ø—Ä–æ–¥–∞–≤—Ü–∞ –∏ —Å–ª–µ–¥—É–π—Ç–µ –µ–≥–æ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è–º –¥–ª—è —Å–æ–≤–µ—Ä—à–µ–Ω–∏—è —Å–¥–µ–ª–∫–∏.\n` +
  `7. –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –ø–µ—Ä–µ–≤–æ–¥: –ü–æ—Å–ª–µ —Å–æ–≤–µ—Ä—à–µ–Ω–∏—è –ø–µ—Ä–µ–≤–æ–¥–∞ –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ —Å–¥–µ–ª–∫—É –≤ –±–æ—Ç–µ. –ü—Ä–æ–¥–∞–≤–µ—Ü –ø–æ–ª—É—á–∏—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ, –∏ –ø–æ—Å–ª–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –æ–ø–ª–∞—Ç—ã –æ—Ç–ø—Ä–∞–≤–∏—Ç –≤–∞–º USDT.\n\n` +
  `–í—ã–±–µ—Ä–∏ —Ç–∞—Ä–∏—Ñ –ø–æ–¥–ø–∏—Å–∫–∏:\n\n` +
        
        `üü¢ <b>1 –¥–µ–Ω—å</b> - 5 USDT\n` +
        `üîµ <b>1 –º–µ—Å—è—Ü</b> - 10 USDT\n` +
        `üü£ <b>1 –≥–æ–¥</b> - 50 USDT\n\n` +
        `<b>–í—ã–±–µ—Ä–∏ —Ç–∞—Ä–∏—Ñ:</b>`,
      {
        parse_mode: "HTML",
        reply_markup: keyboard,
      }
    );
  });

  // ================= 12. –¢–ê–†–ò–§–´ –î–õ–Ø TON =================
  bot.action("show_ton_plans", async (ctx) => {
    const keyboard = {
      inline_keyboard: [
        [
          {
            text: "üü° 1 –¥–µ–Ω—å - 1.5 TON",
            callback_data: "ton_basic",
          },
        ],
        [
          {
            text: "üü† 1 –º–µ—Å—è—Ü - 3.5 TON",
            callback_data: "ton_pro",
          },
        ],
        [
          {
            text: "üî¥ 1 –≥–æ–¥ - 15 TON",
            callback_data: "ton_premium",
          },
        ],
        [
          {
            text: "üîô –ù–∞–∑–∞–¥",
            callback_data: "choose_payment_method",
          },
          {
            text: "üßπ –û—á–∏—Å—Ç–∏—Ç—å —ç–∫—Ä–∞–Ω",
            callback_data: "clear_screen",
          },
        ],
      ],
    };

    await ctx.reply(
      `üíé <b>–û–ü–õ–ê–¢–ê TON</b>\n\n` +
        `–í—ã–±–µ—Ä–∏ —Ç–∞—Ä–∏—Ñ –ø–æ–¥–ø–∏—Å–∫–∏:\n\n` +
        `üü° <b>1 –¥–µ–Ω—å</b> - 1.5 TON\n` +
        `üü† <b>1 –º–µ—Å—è—Ü</b> - 3.5 TON\n` +
        `üî¥ <b>1 –≥–æ–¥</b> - 15 TON\n\n` +
        `<b>–í—ã–±–µ—Ä–∏ —Ç–∞—Ä–∏—Ñ:</b>`,
      {
        parse_mode: "HTML",
        reply_markup: keyboard,
      }
    );
  });

  // ================= 13. –û–ë–†–ê–ë–û–¢–ö–ê CRYPTO PAY –ü–õ–ê–¢–ï–ñ–ï–ô =================
  bot.action(/crypto_(.+)/, async (ctx) => {
    const plan = ctx.match[1];
    let planData;

    if (plan === "basic") {
      planData = { amount: 5, name: "1 –¥–µ–Ω—å", duration: 1, asset: "USDT" };
    } else if (plan === "pro") {
      planData = { amount: 10, name: "1 –º–µ—Å—è—Ü", duration: 30, asset: "USDT" };
    } else if (plan === "premium") {
      planData = { amount: 50, name: "1 –≥–æ–¥", duration: 365, asset: "USDT" };
    } else {
      await ctx.reply("‚ùå –ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ç–∞—Ä–∏—Ñ");
      return;
    }

    try {
      console.log(
        `–°–æ–∑–¥–∞–Ω–∏–µ –∏–Ω–≤–æ–π—Å–∞ –¥–ª—è –ø–ª–∞–Ω–∞: ${plan}, —Å—É–º–º–∞: ${planData.amount} ${planData.asset}`
      );

      const invoice = await cryptoPay.createInvoice(
        planData.amount,
        `–ü–æ–¥–ø–∏—Å–∫–∞: ${planData.name}`
      );

      if (!invoice || !invoice.invoice_id) {
        console.error("–ò–Ω–≤–æ–π—Å –Ω–µ —Å–æ–∑–¥–∞–Ω:", invoice);
        await ctx.reply("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Å—á–µ—Ç–∞. –ü–æ–ø—Ä–æ–±—É–π –µ—â–µ —Ä–∞–∑.");
        return;
      }

      console.log("–ò–Ω–≤–æ–π—Å —Å–æ–∑–¥–∞–Ω —É—Å–ø–µ—à–Ω–æ:", invoice);

      const paymentData = {
        userId: ctx.from.id,
        plan: plan === "basic" ? "1day" : plan === "pro" ? "1month" : "forever",
        invoiceId: invoice.invoice_id,
        amount: planData.amount,
        asset: planData.asset,
        status: "active",
        createdAt: admin.firestore.FieldValue.serverTimestamp(),
        expiresAt: new Date(Date.now() + 3600 * 1000),
      };

      const paymentRef = await db
        .collection("cryptoPayPayments")
        .add(paymentData);

      const keyboard = {
        inline_keyboard: [
          [
            {
              text: "üí≥ –û–ü–õ–ê–¢–ò–¢–¨ –í @CryptoBot",
              url: `https://t.me/CryptoBot?start=${invoice.hash}`,
            },
          ],
          [
            {
              text: "‚úÖ –Ø –û–ü–õ–ê–¢–ò–õ",
              callback_data: `check_crypto_${paymentRef.id}`,
            },
          ],
          [
            {
              text: "üîô –ù–ê–ó–ê–î",
              callback_data: "show_crypto_plans",
            },
            {
              text: "üßπ –û—á–∏—Å—Ç–∏—Ç—å —ç–∫—Ä–∞–Ω",
              callback_data: "clear_screen",
            },
          ],
        ],
      };

      await ctx.reply(
        `üíé <b>${planData.name}</b>\n` +
          `üí≤ <b>–û–ü–õ–ê–¢–ê –ß–ï–†–ï–ó CRYPTO PAY</b>\n\n` +
          `üí∞ <b>–°—É–º–º–∞:</b> ${planData.amount} ${planData.asset}\n` +
          `‚è∞ <b>–í—Ä–µ–º—è –Ω–∞ –æ–ø–ª–∞—Ç—É:</b> 1 —á–∞—Å\n\n` +
          `üìã <b>–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è:</b>\n` +
          `1. –ù–∞–∂–º–∏ "–û–ü–õ–ê–¢–ò–¢–¨ –í @CryptoBot"\n` +
          `2. –û–ø–ª–∞—Ç–∏ —Å—á–µ—Ç –≤ –±–æ—Ç–µ @CryptoBot\n` +
          `3. –í–µ—Ä–Ω–∏—Å—å –∏ –Ω–∞–∂–º–∏ "–Ø –û–ü–õ–ê–¢–ò–õ"\n\n` +
          `üÜî <b>ID –ø–ª–∞—Ç–µ–∂–∞:</b> <code>${paymentRef.id}</code>\n` +
          `üÜî <b>ID —Å—á–µ—Ç–∞:</b> <code>${invoice.invoice_id}</code>`,
        {
          parse_mode: "HTML",
          reply_markup: keyboard,
        }
      );
    } catch (error) {
      console.error("Crypto Pay error:", error);
      await ctx.reply(
        "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –ø–ª–∞—Ç–µ–∂–∞. –ü—Ä–æ–≤–µ—Ä—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ Crypto Pay."
      );
    }
  });

  // ================= 14. –û–ë–†–ê–ë–û–¢–ö–ê TON –ü–õ–ê–¢–ï–ñ–ï–ô =================
  bot.action(/ton_(.+)/, async (ctx) => {
    const plan = ctx.match[1];
    let planData;

    if (plan === "basic") {
      planData = { amount: 1.5, name: "1 –¥–µ–Ω—å", duration: 1, asset: "TON" };
    } else if (plan === "pro") {
      planData = { amount: 3.5, name: "1 –º–µ—Å—è—Ü", duration: 30, asset: "TON" };
    } else if (plan === "premium") {
      planData = { amount: 15, name: "1 –≥–æ–¥", duration: 365, asset: "TON" };
    } else {
      await ctx.reply("‚ùå –ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ç–∞—Ä–∏—Ñ");
      return;
    }

    try {
      console.log(
        `–°–æ–∑–¥–∞–Ω–∏–µ TON –∏–Ω–≤–æ–π—Å–∞ –¥–ª—è –ø–ª–∞–Ω–∞: ${plan}, —Å—É–º–º–∞: ${planData.amount} ${planData.asset}`
      );

      const invoice = await cryptoPay.createInvoice(
        planData.amount,
        `–ü–æ–¥–ø–∏—Å–∫–∞: ${planData.name}`,
        "TON"
      );

      if (!invoice || !invoice.invoice_id) {
        console.error("TON –∏–Ω–≤–æ–π—Å –Ω–µ —Å–æ–∑–¥–∞–Ω:", invoice);
        await ctx.reply("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Å—á–µ—Ç–∞. –ü–æ–ø—Ä–æ–±—É–π –µ—â–µ —Ä–∞–∑.");
        return;
      }

      console.log("TON –∏–Ω–≤–æ–π—Å —Å–æ–∑–¥–∞–Ω —É—Å–ø–µ—à–Ω–æ:", invoice);

      const paymentData = {
        userId: ctx.from.id,
        plan: plan === "basic" ? "1day" : plan === "pro" ? "1month" : "forever",
        invoiceId: invoice.invoice_id,
        amount: planData.amount,
        asset: planData.asset,
        status: "active",
        createdAt: admin.firestore.FieldValue.serverTimestamp(),
        expiresAt: new Date(Date.now() + 3600 * 1000),
      };

      const paymentRef = await db
        .collection("cryptoPayPayments")
        .add(paymentData);

      const keyboard = {
        inline_keyboard: [
          [
            {
              text: "üí≥ –û–ü–õ–ê–¢–ò–¢–¨ –í @CryptoBot",
              url: `https://t.me/CryptoBot?start=${invoice.hash}`,
            },
          ],
          [
            {
              text: "‚úÖ –Ø –û–ü–õ–ê–¢–ò–õ",
              callback_data: `check_crypto_${paymentRef.id}`,
            },
          ],
          [
            {
              text: "üîô –ù–ê–ó–ê–î",
              callback_data: "show_ton_plans",
            },
            {
              text: "üßπ –û—á–∏—Å—Ç–∏—Ç—å —ç–∫—Ä–∞–Ω",
              callback_data: "clear_screen",
            },
          ],
        ],
      };

      await ctx.reply(
        `üíé <b>${planData.name}</b>\n` +
          `üíé <b>–û–ü–õ–ê–¢–ê TON</b>\n\n` +
          `üí∞ <b>–°—É–º–º–∞:</b> ${planData.amount} ${planData.asset}\n` +
          `‚è∞ <b>–í—Ä–µ–º—è –Ω–∞ –æ–ø–ª–∞—Ç—É:</b> 1 —á–∞—Å\n\n` +
          `üìã <b>–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è:</b>\n` +
          `1. –ù–∞–∂–º–∏ "–û–ü–õ–ê–¢–ò–¢–¨ –í @CryptoBot"\n` +
          `2. –û–ø–ª–∞—Ç–∏ —Å—á–µ—Ç –≤ –±–æ—Ç–µ @CryptoBot\n` +
          `3. –í–µ—Ä–Ω–∏—Å—å –∏ –Ω–∞–∂–º–∏ "–Ø –û–ü–õ–ê–¢–ò–õ"\n\n` +
          `üÜî <b>ID –ø–ª–∞—Ç–µ–∂–∞:</b> <code>${paymentRef.id}</code>\n` +
          `üÜî <b>ID —Å—á–µ—Ç–∞:</b> <code>${invoice.invoice_id}</code>`,
        {
          parse_mode: "HTML",
          reply_markup: keyboard,
        }
      );
    } catch (error) {
      console.error("TON Pay error:", error);
      await ctx.reply(
        "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –ø–ª–∞—Ç–µ–∂–∞. –ü—Ä–æ–≤–µ—Ä—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ Crypto Pay."
      );
    }
  });

  // ================= 15. –ü–†–û–í–ï–†–ö–ê CRYPTO PAY –ü–õ–ê–¢–ï–ñ–ê =================
  bot.action(/check_crypto_(.+)/, async (ctx) => {
    const paymentId = ctx.match[1];

    try {
      await ctx.answerCbQuery("üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–ª–∞—Ç–µ–∂...");

      const paymentDoc = await db
        .collection("cryptoPayPayments")
        .doc(paymentId)
        .get();

      if (!paymentDoc.exists) {
        await ctx.answerCbQuery("‚ùå –ü–ª–∞—Ç–µ–∂ –Ω–µ –Ω–∞–π–¥–µ–Ω");
        return;
      }

      const payment = paymentDoc.data();

      if (payment.userId !== ctx.from.id) {
        await ctx.answerCbQuery("‚ùå –≠—Ç–æ –Ω–µ –≤–∞—à –ø–ª–∞—Ç–µ–∂");
        return;
      }

      let invoice;
      try {
        invoice = await cryptoPay.getInvoice(payment.invoiceId);
      } catch (error) {
        console.error("–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –∏–Ω–≤–æ–π—Å–∞:", error);
        await ctx.answerCbQuery("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—á–µ—Ç–∞");
        return;
      }

      if (!invoice) {
        await ctx.answerCbQuery("‚ùå –°—á–µ—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω –∏–ª–∏ –∏—Å—Ç–µ–∫");
        return;
      }

      console.log(`–°—Ç–∞—Ç—É—Å –∏–Ω–≤–æ–π—Å–∞ ${payment.invoiceId}:`, invoice.status);

      if (invoice.status === "paid") {
        const planId = payment.plan;
        const subRef = db
          .collection("subscriptions")
          .doc(ctx.from.id.toString());
        const subData = {
          userId: ctx.from.id,
          plan: planId,
          subscriptionType: planId,
          startDate: admin.firestore.FieldValue.serverTimestamp(),
          status: "active",
          isActive: true,
          lastUpdated: admin.firestore.FieldValue.serverTimestamp(),
          paymentMethod: payment.asset === "TON" ? "ton" : "crypto",
        };

        if (planId === "1day") {
          subData.endDate = admin.firestore.Timestamp.fromDate(
            new Date(Date.now() + 86400000)
          );
        } else if (planId === "1month") {
          subData.endDate = admin.firestore.Timestamp.fromDate(
            new Date(Date.now() + 2592000000)
          );
        } else if (planId === "forever") {
          subData.endDate = admin.firestore.Timestamp.fromDate(
            new Date(Date.now() + 365 * 86400000)
          );
        }

        await subRef.set(subData, { merge: true });
        await paymentDoc.ref.update({
          status: "paid",
          paidAt: admin.firestore.FieldValue.serverTimestamp(),
        });

        const subscription = await checkSubscription(ctx.from.id);
        const keyboard = {
          inline_keyboard: [
            [{ text: "üåç –í—Å–µ —Å—Ç—Ä–∞–Ω—ã", callback_data: "all_countries" }],
            [{ text: "üßπ –û—á–∏—Å—Ç–∏—Ç—å —ç–∫—Ä–∞–Ω", callback_data: "clear_screen" }],
          ],
        };

        await ctx.reply(
          `üéâ <b>–ü–õ–ê–¢–ï–ñ –ü–û–î–¢–í–ï–†–ñ–î–ï–ù!</b>\n\n` +
            `‚úÖ –ü–æ–¥–ø–∏—Å–∫–∞ —É—Å–ø–µ—à–Ω–æ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞!\n\n` +
            `${subscription.message}`,
          {
            parse_mode: "HTML",
            reply_markup: keyboard,
          }
        );
      } else {
        let statusText = "–Ω–µ –æ–ø–ª–∞—á–µ–Ω";
        if (invoice.status === "active") statusText = "–æ–∂–∏–¥–∞–µ—Ç –æ–ø–ª–∞—Ç—ã";
        if (invoice.status === "expired") statusText = "–∏—Å—Ç–µ–∫";

        await ctx.answerCbQuery(
          `‚ùå –°—á–µ—Ç ${statusText}. –ü–æ–ø—Ä–æ–±—É–π —á–µ—Ä–µ–∑ –º–∏–Ω—É—Ç—É.`
        );
      }
    } catch (error) {
      console.error("Payment check error:", error);
      await ctx.answerCbQuery("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–ª–∞—Ç–µ–∂–∞");
    }
  });

  // ================= 16. –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò –ü–û–î–ü–ò–°–û–ö STARS =================
  const handleSubscriptionPurchase = async (ctx, planId, amount, duration) => {
    try {
      await ctx.replyWithInvoice({
        title: `–ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ ${
          planId === "1day"
            ? "1 –¥–µ–Ω—å"
            : planId === "1month"
            ? "1 –º–µ—Å—è—Ü"
            : "1 –≥–æ–¥"
        }`,
        description:
          planId === "1day"
            ? "–î–æ—Å—Ç—É–ø –Ω–∞ 24 —á–∞—Å–∞"
            : planId === "1month"
            ? "–î–æ—Å—Ç—É–ø –Ω–∞ 30 –¥–Ω–µ–π"
            : "–î–æ—Å—Ç—É–ø –Ω–∞ 365 –¥–Ω–µ–π",
        payload: `${planId}_${ctx.from.id}_${Date.now()}`,
        currency: "XTR",
        prices: [{ label: "–ü–æ–¥–ø–∏—Å–∫–∞", amount: amount }],
        start_parameter: `${planId}_sub`,
      });
    } catch (error) {
      console.error("–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Å—á–µ—Ç–∞:", error);
      await ctx.reply("‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –ø–ª–∞—Ç–µ–∂–∞");
    }
  };

  bot.action("buy_1day", (ctx) =>
    handleSubscriptionPurchase(ctx, "1day", 399, 86400000)
  );
  bot.action("buy_1month", (ctx) =>
    handleSubscriptionPurchase(ctx, "1month", 799, 2592000000)
  );
  bot.action("buy_forever", (ctx) =>
    handleSubscriptionPurchase(ctx, "forever", 3999, 31536000000)
  );

  bot.on("pre_checkout_query", (ctx) => ctx.answerPreCheckoutQuery(true));

  bot.on("successful_payment", async (ctx) => {
    const userId = ctx.from.id;
    const payment = ctx.message.successful_payment;
    const [planId, _] = payment.invoice_payload.split("_");

    try {
      await clearChat(ctx);

      const subRef = db.collection("subscriptions").doc(userId.toString());
      const subData = {
        userId,
        plan: planId,
        subscriptionType: planId,
        startDate: admin.firestore.FieldValue.serverTimestamp(),
        status: "active",
        isActive: true,
        lastUpdated: admin.firestore.FieldValue.serverTimestamp(),
        paymentMethod: "stars",
      };

      if (planId === "1day") {
        subData.endDate = admin.firestore.Timestamp.fromDate(
          new Date(Date.now() + 86400000)
        );
      } else if (planId === "1month") {
        subData.endDate = admin.firestore.Timestamp.fromDate(
          new Date(Date.now() + 2592000000)
        );
      } else if (planId === "forever") {
        subData.endDate = admin.firestore.Timestamp.fromDate(
          new Date(Date.now() + 31536000000)
        );
      }

      await subRef.set(subData, { merge: true });

      const subscription = await checkSubscription(userId);
      const keyboard = {
        inline_keyboard: [
          [{ text: "üåç –í—Å–µ —Å—Ç—Ä–∞–Ω—ã", callback_data: "all_countries" }],
          [{ text: "üßπ –û—á–∏—Å—Ç–∏—Ç—å —ç–∫—Ä–∞–Ω", callback_data: "clear_screen" }],
        ],
      };

      await ctx.reply(
        `‚úÖ <b>–ü–æ–¥–ø–∏—Å–∫–∞ —É—Å–ø–µ—à–Ω–æ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞!</b>\n\n${subscription.message}`,
        {
          parse_mode: "HTML",
          reply_markup: keyboard,
        }
      );
    } catch (error) {
      console.error("–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –ø–ª–∞—Ç–µ–∂–∞:", error);
      await ctx.reply("‚ö†Ô∏è –û—à–∏–±–∫–∞ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ –ø–æ–¥–ø–∏—Å–∫–∏");
    }
  });

  // ================= 17. –ù–ê–ó–ê–î –í –ì–õ–ê–í–ù–û–ï –ú–ï–ù–Æ =================
  bot.action("back_to_main", async (ctx) => {
    await showMainMenu(ctx);
  });
};const admin = require('firebase-admin');

module.exports = (bot, db) => {
  // 1. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  const ensureUser = async (userId) => {
    const userRef = db.collection('usersPay').doc(userId.toString());
    try {
      const userDoc = await userRef.get();
      
      if (!userDoc.exists) {
        await userRef.set({
          balance: 1000,    // –°—Ç–∞—Ä—Ç–æ–≤—ã–π –±–∞–ª–∞–Ω—Å 1000üåü
          reserved: 0,
          createdAt: admin.firestore.FieldValue.serverTimestamp(),
          lastUpdated: admin.firestore.FieldValue.serverTimestamp()
        });
        console.log(`[User] –°–æ–∑–¥–∞–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ${userId} —Å –±–∞–ª–∞–Ω—Å–æ–º 1000üåü`);
      }
      
      return userRef;
    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', error);
      throw error;
    }
  };

  // 2. –ö–æ–º–∞–Ω–¥–∞ /buy
  bot.command('buy', async (ctx) => {
    try {
      const userId = ctx.from.id;
      const userRef = await ensureUser(userId);
      const userDoc = await userRef.get();
      const balance = userDoc.data().balance || 0;

      // –û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ —Ç–∞—Ä–∏—Ñ—ã (1 –¥–µ–Ω—å —Ç–µ–ø–µ—Ä—å –∑–∞ 1üåü)
      const plans = [
        { id: '1day', name: "1 –¥–µ–Ω—å", price: 399, duration: 86400000 }, // –ò–∑–º–µ–Ω–µ–Ω–æ —Å 300 –Ω–∞ 1
        { id: '1month', name: "1 –º–µ—Å—è—Ü", price: 799, duration: 2592000000 },
        { id: 'forever', name: "–ù–∞–≤—Å–µ–≥–¥–∞", price: 3999, duration: null }
      ];

      await ctx.reply(`üí∞ <b>–í–∞—à –±–∞–ª–∞–Ω—Å: ${balance}üåü</b>\n–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–¥–ø–∏—Å–∫—É:`, {
        parse_mode: 'HTML',
        reply_markup: {
          inline_keyboard: plans.map(p => [
            { 
              text: `${p.name} - ${p.price}üåü`, 
              callback_data: `start_pay_${p.id}`
            }
          ])
        }
      });

    } catch (error) {
      console.error('Buy command error:', error);
      await ctx.reply('‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –º–µ–Ω—é');
    }
  });

  // 3. –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ —Ç–∞—Ä–∏—Ñ–∞
  bot.action(/start_pay_(.+)/, async (ctx) => {
    const userId = ctx.from.id;
    const planId = ctx.match[1];
    
    try {
      // –û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ —Ç–∞—Ä–∏—Ñ—ã (1 –¥–µ–Ω—å –∑–∞ 1üåü)
      const plan = {
        '1day': { price: 399, name: "1 –¥–µ–Ω—å", duration: 86400000 }, // –ò–∑–º–µ–Ω–µ–Ω–æ —Å 300 –Ω–∞ 1
        '1month': { price: 799, name: "1 –º–µ—Å—è—Ü", duration: 2592000000 },
        'forever': { price: 3999, name: "1 –≥–æ–¥", duration: null }
      }[planId];

      if (!plan) throw new Error('–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ç–∞—Ä–∏—Ñ');

      const userRef = db.collection('usersPay').doc(userId.toString());
      const txRef = db.collection('transactions').doc();

      // –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–∞–ª–∞–Ω—Å–∞
      const userDoc = await userRef.get();
      const userData = userDoc.data() || {};
      const available = (userData.balance || 0) - (userData.reserved || 0);

      if (available < plan.price) {
        throw new Error(`–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤. –î–æ—Å—Ç—É–ø–Ω–æ: ${available}üåü`);
      }

      // –†–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ä–µ–¥—Å—Ç–≤
      await userRef.update({
        reserved: admin.firestore.FieldValue.increment(plan.price),
        lastUpdated: admin.firestore.FieldValue.serverTimestamp()
      });

      // –°–æ–∑–¥–∞–Ω–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
      await txRef.set({
        userId,
        amount: plan.price,
        plan: planId,
        status: 'pending',
        createdAt: admin.firestore.FieldValue.serverTimestamp()
      });

      // –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –æ–ø–ª–∞—Ç—ã
      await ctx.editMessageText(
        `–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –ø–æ–∫—É–ø–∫—É:\n\n` +
        `üîπ ${plan.name}\n` +
        `üîπ ${plan.price}üåü\n\n` +
        `–ë–∞–ª–∞–Ω—Å –ø–æ—Å–ª–µ —Å–ø–∏—Å–∞–Ω–∏—è: ${(userData.balance || 0) - plan.price}üåü`,
        {
          reply_markup: {
            inline_keyboard: [
              [{ text: '‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å', callback_data: `confirm_pay_${txRef.id}` }],
              [{ text: '‚ùå –û—Ç–º–µ–Ω–∞', callback_data: `cancel_pay_${txRef.id}` }]
            ]
          }
        }
      );

    } catch (error) {
      console.error('Payment start error:', error);
      await ctx.reply(`‚ö†Ô∏è –û—à–∏–±–∫–∞: ${error.message}`);
    }
  });

  // 4. –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞
  bot.action(/confirm_pay_(.+)/, async (ctx) => {
    const txId = ctx.match[1];
    const userId = ctx.from.id;
    
    try {
      const txRef = db.collection('transactions').doc(txId);
      const userRef = db.collection('usersPay').doc(userId.toString());
      const subRef = db.collection('subscriptions').doc(userId.toString());

      await db.runTransaction(async (t) => {
        const txDoc = await t.get(txRef);
        if (!txDoc.exists) throw new Error('–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞');
        
        const txData = txDoc.data();
        if (txData.status !== 'pending') throw new Error('–ù–µ–≤–µ—Ä–Ω—ã–π —Å—Ç–∞—Ç—É—Å');

        const plan = {
          '1day': { name: "1 –¥–µ–Ω—å", duration: 86400000 },
          '1month': { name: "1 –º–µ—Å—è—Ü", duration: 2592000000 },
          'forever': { name: "–ù–∞–≤—Å–µ–≥–¥–∞", duration: null }
        }[txData.plan];

        // –°–ø–∏—Å–∞–Ω–∏–µ —Å—Ä–µ–¥—Å—Ç–≤
        t.update(userRef, {
          balance: admin.firestore.FieldValue.increment(-txData.amount),
          reserved: admin.firestore.FieldValue.increment(-txData.amount),
          lastUpdated: admin.firestore.FieldValue.serverTimestamp()
        });

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
        t.update(txRef, {
          status: 'completed',
          completedAt: admin.firestore.FieldValue.serverTimestamp()
        });

        // –ê–∫—Ç–∏–≤–∞—Ü–∏—è –ø–æ–¥–ø–∏—Å–∫–∏
        const subData = {
          userId,
          plan: txData.plan,
          subscriptionType: txData.plan,
          startDate: admin.firestore.FieldValue.serverTimestamp(),
          status: 'active',
          isActive: true,
          lastUpdated: admin.firestore.FieldValue.serverTimestamp()
        };

        if (plan.duration) {
          subData.endDate = admin.firestore.Timestamp.fromDate(new Date(Date.now() + plan.duration));
        }

        t.set(subRef, subData, { merge: true });
      });

      await ctx.editMessageText('‚úÖ –ü–æ–¥–ø–∏—Å–∫–∞ —É—Å–ø–µ—à–Ω–æ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞!');

    } catch (error) {
      console.error('Payment confirm error:', error);
      await ctx.reply(`‚ö†Ô∏è –û—à–∏–±–∫–∞: ${error.message}`);
    }
  });

  // 5. –û—Ç–º–µ–Ω–∞ –ø–ª–∞—Ç–µ–∂–∞
  bot.action(/cancel_pay_(.+)/, async (ctx) => {
    const txId = ctx.match[1];
    const userId = ctx.from.id;
    
    try {
      await db.runTransaction(async (t) => {
        const txRef = db.collection('transactions').doc(txId);
        const txDoc = await t.get(txRef);
        
        if (txDoc.exists && txDoc.data().status === 'pending') {
          const amount = txDoc.data().amount;
          
          t.update(db.collection('usersPay').doc(userId.toString()), {
            reserved: admin.firestore.FieldValue.increment(-amount),
            lastUpdated: admin.firestore.FieldValue.serverTimestamp()
          });
          
          t.update(txRef, {
            status: 'cancelled',
            cancelledAt: admin.firestore.FieldValue.serverTimestamp()
          });
        }
      });
      
      await ctx.deleteMessage();
      await ctx.reply('‚ÑπÔ∏è –ü–ª–∞—Ç–µ–∂ –æ—Ç–º–µ–Ω–µ–Ω');

    } catch (error) {
      console.error('Payment cancel error:', error);
      await ctx.reply('‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–º–µ–Ω–µ');
    }
  });
}; –≤ —ç—Ç–æ–º –∫–æ–¥–µ –∫–æ–≥–¥–∞ –ø–æ–¥–ø–∏—Å–∫–∞ –∞–∫—Ç–∏–≤–Ω–∞ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –∫–Ω–æ–ø–∫–∞ –≤—Å–µ —Å—Ç—Ä–∞–Ω—ã ! –Ω–æ —Ç–æ–ª—å–∫–æ –∫–æ–≥–¥–∞ –∑–∞ –∑–≤–µ–∑–¥—ã !—Ç–∞–∫–∂–µ –Ω—É–∂–Ω–æ –∫–æ–≥–¥–∞ –∑–∞ —é–∑–¥—Ç –æ–ø–ª–∞—á–µ–Ω–æ —Ç–æ —Ç–æ–∂–µ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –∫–Ω–æ–ø–∫–∞!—É –º–µ–Ω—è –µ—Å—Ç—å –∫–æ–ª–µ–∫—Ü–∏—è subsscriptions  endDate
October 27, 2027 at 8:07:53‚ÄØAM UTC+3
(timestamp)


isActive
true
(boolean)


lastUpdated
September 17, 2025 at 8:07:55‚ÄØAM UTC+3
(timestamp)


plan
"1day"
(string)


startDate
September 17, 2025 at 8:07:55‚ÄØAM UTC+3
(timestamp)


status
"active"
(string)


subscriptionType
"1day"
(string)


userId
1227459883
(number) –∏ cryptoPayPayments amount
5
(number)


asset
"USDT"
(string)


createdAt
October 24, 2025 at 5:23:46‚ÄØPM UTC+3
(timestamp)


expiresAt
October 24, 2025 at 6:23:46‚ÄØPM UTC+3
(timestamp)


invoiceId
36208031
(number)


plan
"1day"
(string)


status
"active"
(string)


userId
7574264848 –µ—Å–ª–∏ –ø–æ–¥–ø–∏—Å–∫–∞ –≤ subsscriptions –∞–∫—Ç–∏–≤–Ω–∞ status
"active"
(string) —Ç–æ –∫–Ω–æ–ø–∫–∞ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è ! –Ω—É–∂–Ω–æ –∏ —Å cryptoPayPayments —Ç–∞–∫–∂–µ —Å–¥–µ–ª–∞—Ç—å! –Ω–æ —É—á—Ç–∏ —á—Ç–æ –≤ cryptoPayPayments —Å—Ç–∞—Ç—É—Å –∞–∫—Ç–∏–≤–Ω–∞ –µ—â—ë –¥–æ –æ–ø–ª–∞—Ç—ã –∏ —ç—Ç–æ –Ω—É–∂–Ω–æ –∏–∑–º–µ–Ω–∏—Ç—å !–∏–ª–∏ –æ–±—ä–µ–¥–∏–Ω–∏—Ç—å –∫–æ–ª–µ–∫—Ü–∏–∏ –≤ –æ–¥–Ω—É –æ–ø–ª–∞—Ç–∞ –∑–∞ –∑–≤–µ–∑–¥—ã –∏ –∑–∞ —é–∑–¥—Ç –∏ —Ç–æ–Ω