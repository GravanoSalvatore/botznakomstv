
const RateLimiter = require("telegraf-ratelimit");
const { default: PQueue } = require("p-queue");
const NodeCache = require("node-cache");
const fs = require('fs');
const path = require('path');
const zlib = require('zlib');
const DiskCache = require('./diskCache'); // ‚Üê –î–û–ë–ê–í–¨–¢–ï –≠–¢–£ –°–¢–†–û–ß–ö–£
const diskCache = new DiskCache();        // ‚Üê –î–û–ë–ê–í–¨–¢–ï –≠–¢–£ –°–¢–†–û–ß–ö–£
// ===== –£–î–ê–õ–ï–ù–ò–ï LOCK –§–ê–ô–õ–ê –ü–†–ò –ó–ê–ü–£–°–ö–ï =====
const LOCK_FILE = path.join(__dirname, 'bot.lock');
try {
    if (fs.existsSync(LOCK_FILE)) {
        console.log('üóëÔ∏è –£–î–ê–õ–Ø–ï–ú LOCK –§–ê–ô–õ –î–õ–Ø RENDER');
        fs.unlinkSync(LOCK_FILE);
    }
} catch (error) {
    console.log('‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å lock —Ñ–∞–π–ª:', error.message);
}

// ===================== –ë–õ–û–ö–ò–†–û–í–ö–ê –û–¢ –ú–ù–û–ñ–ï–°–¢–í–ï–ù–ù–û–ì–û –ó–ê–ü–£–°–ö–ê =====================
if (fs.existsSync(LOCK_FILE)) {
    const existingPid = fs.readFileSync(LOCK_FILE, 'utf8');
    console.error(`‚ùå –ë–æ—Ç —É–∂–µ –∑–∞–ø—É—â–µ–Ω —Å PID: ${existingPid}`);
    console.error('‚ùå –û—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –ø—Ä–µ–¥—ã–¥—É—â–∏–π –ø—Ä–æ—Ü–µ—Å—Å –∏–ª–∏ —É–¥–∞–ª–∏—Ç–µ —Ñ–∞–π–ª bot.lock');
    process.exit(1);
}
fs.writeFileSync(LOCK_FILE, process.pid.toString());
process.on('exit', () => { 
    if (fs.existsSync(LOCK_FILE)) fs.unlinkSync(LOCK_FILE); 
});
process.on('SIGINT', () => { 
    if (fs.existsSync(LOCK_FILE)) fs.unlinkSync(LOCK_FILE); 
    process.exit(0); 
});

// ===================== –ì–õ–û–ë–ê–õ–¨–ù–´–ï –§–õ–ê–ì–ò –î–õ–Ø –ü–†–ï–î–û–¢–í–†–ê–©–ï–ù–ò–Ø –ü–û–í–¢–û–†–ù–û–ô –ó–ê–ì–†–£–ó–ö–ò =====================
let globalCacheInitialized = false;
let fullCacheLoading = false;
let fullCacheLoadPromise = null;
let demoCacheLoading = false;
let demoCacheLoadPromise = null;

// ===================== –§–£–ù–ö–¶–ò–Ø –ü–†–ï–õ–û–ê–î–ï–†–ê =====================
// ===================== –ö–†–ê–°–ò–í–´–ô –ü–†–ï–õ–û–ê–î–ï–† =====================
const sendPreloader = async (ctx, type = "default", title = "‚ú®Magic") => {
    try {
        const preloaderConfigs = {
            'city': {
                title: "üîç –ü–û–ò–°–ö –ê–ù–ö–ï–¢",
                text: `üîç <b>–ü–æ–∏—Å–∫ –∞–Ω–∫–µ—Ç –≤ –≤—ã–±—Ä–∞–Ω–Ω–æ–º –≥–æ—Ä–æ–¥–µ...</b>\n\n‚è≥ <i>–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è, —ç—Ç–æ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –¥–æ 2 –º–∏–Ω—É—Ç</i>\n\nüìä <i>–ò—â–µ–º —Å–∞–º—ã–µ —Å–≤–µ–∂–∏–µ –∞–Ω–∫–µ—Ç—ã –¥–ª—è –≤–∞—Å...</i>\n\n‚ú® <i>–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥–æ–∂–¥–∏—Ç–µ</i>`
            },
            'country': {
                title: "üåç –ó–ê–ì–†–£–ó–ö–ê –°–¢–†–ê–ù", 
                text: `üåç <b>–ó–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ —Å—Ç—Ä–∞–Ω –∏ –≥–æ—Ä–æ–¥–æ–≤...</b>\n\n‚è≥ <i>–û–±–Ω–æ–≤–ª—è–µ–º –≥–µ–æ–≥—Ä–∞—Ñ–∏—é –∞–Ω–∫–µ—Ç</i>\n\nüåé <i>–ò—â–µ–º –∞–Ω–∫–µ—Ç—ã —Å–æ –≤—Å–µ–≥–æ –º–∏—Ä–∞</i>\n\n‚ú® <i>–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥–æ–∂–¥–∏—Ç–µ</i>`
            },
            'access': {
                title: "üîç –ü–†–û–í–ï–†–ö–ê –î–û–°–¢–£–ü–ê",
                text: `üîç <b>–ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–∞—à –¥–æ—Å—Ç—É–ø...</b>\n\n‚è≥ <i>–ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–ø–∏—Å–∫—É –∏ —Å—Ç–∞—Ç—É—Å –∫–∞–Ω–∞–ª–∞</i>\n\n‚úÖ <i>–û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ä–µ–∂–∏–º —Ä–∞–±–æ—Ç—ã</i>\n\n‚ú® <i>–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥–æ–∂–¥–∏—Ç–µ</i>`
            },
            'default': {
                title: "‚ú®Magic",
                text: `üîÑ <b>${title}</b>\n\n‚è≥ <i>–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥–æ–∂–¥–∏—Ç–µ...</i>\n\n‚ú® <i>–°–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∏—Ç—Å—è –∫ —Ä–∞–±–æ—Ç–µ</i>`
            }
        };

        const config = preloaderConfigs[type] || preloaderConfigs.default;
        
        const preloaderMsg = await ctx.reply(config.text, {
            parse_mode: "HTML",
            reply_markup: {
                inline_keyboard: [
                    [{ text: "üîÑ –ó–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è...", callback_data: "loading" }]
                ]
            }
        });
        
        return preloaderMsg;
    } catch (error) {
        console.log("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –ø—Ä–µ–ª–æ–∞–¥–µ—Ä:", error.message);
        return null;
    }
};

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è –ø—Ä–µ–ª–æ–∞–¥–µ—Ä–∞
const removePreloader = async (ctx, preloaderMsg) => {
    if (preloaderMsg) {
        try {
            await ctx.telegram.deleteMessage(ctx.chat.id, preloaderMsg.message_id);
        } catch (error) {
            console.log("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å –ø—Ä–µ–ª–æ–∞–¥–µ—Ä:", error.message);
        }
    }
};

// ===================== –°–ò–°–¢–ï–ú–ê –ë–õ–û–ö–ò–†–û–í–ö–ò –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø =====================
const userLocks = new Map();

const acquireUserLock = (userId, timeoutMs = 10000) => {
    const now = Date.now();
    const userLock = userLocks.get(userId);
    
    if (userLock && now < userLock.expires) {
        return false;
    }
    
    userLocks.set(userId, {
        expires: now + timeoutMs,
        timestamp: now
    });
    return true;
};

const releaseUserLock = (userId) => {
    userLocks.delete(userId);
};

setInterval(() => {
    const now = Date.now();
    let cleanedCount = 0;
    
    userLocks.forEach((lock, userId) => {
        if (now >= lock.expires) {
            userLocks.delete(userId);
            cleanedCount++;
        }
    });
    
    if (cleanedCount > 0) {
        console.log(`üßπ [LOCKS] –û—á–∏—â–µ–Ω–æ ${cleanedCount} —Å—Ç–∞—Ä—ã—Ö –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫`);
    }
}, 60000);

// ===================== –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø –ú–ê–°–®–¢–ê–ë–ò–†–û–í–ê–ù–ò–Ø =====================
const SCALING_CONFIG = {
    MESSAGE_QUEUE: {
        CONCURRENCY: 50,
        INTERVAL: 1000,
        INTERVAL_CAP: 200,
        TIMEOUT: 30000,
    },
    
    CACHE: {
        PROFILES_TTL: 7 * 24 * 60 * 60, // 7 –¥–Ω–µ–π
        FILTERS_TTL: 24 * 60 * 60, // ‚Üê 24 –ß–ê–°–ê –≤–º–µ—Å—Ç–æ 10 –º–∏–Ω—É—Ç!
        SESSIONS_TTL: 7 * 24 * 60 * 60, // 7 –¥–Ω–µ–π
        SUBSCRIPTION_TTL: 24 * 60 * 60, // 24 —á–∞—Å–∞ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ–¥–ø–∏—Å–∫–∏
        CHANNEL_TTL: 5 * 60, // 5 –º–∏–Ω—É—Ç –¥–ª—è –∫–∞–Ω–∞–ª–∞
        MAX_FILTER_KEYS: 500,
        CHECKPERIOD: 300,
    },
    
    PERFORMANCE: {
        PROFILES_PER_PAGE: 1,
        MAX_CAPTION_LENGTH: 900,
        MESSAGE_TTL: 86400000,
        FILTER_CHUNK_SIZE: 500,
        MAX_CONCURRENT_FILTERS: 10,
        PARALLEL_CHUNKS: 8, // ‚Üê –ù–û–í–´–ô –ü–ê–†–ê–ú–ï–¢–† –¥–ª—è –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏
        PARALLEL_BATCH_SIZE: 10000, // ‚Üê –ù–û–í–´–ô –ü–ê–†–ê–ú–ï–¢–†
    }
};

// ===================== –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –ö–û–ù–°–¢–ê–ù–¢–´ =====================
const AGE_RANGES = [
    { label: "18-25", min: 18, max: 25 },
    { label: "26-35", min: 26, max: 35 },
    { label: "36-45", min: 36, max: 45 },
    { label: "46+", min: 46, max: 999 },
];

const POPULAR_COUNTRIES = [
    { name: "–†–æ—Å—Å–∏—è", flag: "üá∑üá∫" },
    { name: "–£–∫—Ä–∞–∏–Ω–∞", flag: "üá∫üá¶" },
    { name: "–ë–µ–ª–∞—Ä—É—Å—å", flag: "üáßüáæ" },
    { name: "–ö–∞–∑–∞—Ö—Å—Ç–∞–Ω", flag: "üá∞üáø" },
    { name: "–¢—É—Ä—Ü–∏—è", flag: "üáπüá∑" },
    { name: "–ì–µ—Ä–º–∞–Ω–∏—è", flag: "üá©üá™" },
    { name: "–°–®–ê", flag: "üá∫üá∏" },
    { name: "–ò–∑—Ä–∞–∏–ª—å", flag: "üáÆüá±" },
];

const PAGINATION_JUMP_SECTIONS = [
    { label: "1-1000", start: 0, end: 999 },
    { label: "1000-2000", start: 1000, end: 1999 },
    { label: "2000-3000", start: 2000, end: 2999 },
];

// –ö–∞—Ä—Ç–∞ –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–∏ —É–∫—Ä–∞–∏–Ω—Å–∫–∏—Ö –≥–æ—Ä–æ–¥–æ–≤
const cityNormalizationMap = {
  kyiv: "–ö–∏–µ–≤", kiev: "–ö–∏–µ–≤", kiyv: "–ö–∏–µ–≤",
  "kryvyi rih": "–ö—Ä–∏–≤–æ–π –†–æ–≥", "kryvyi rig": "–ö—Ä–∏–≤–æ–π –†–æ–≥",
  odesa: "–û–¥–µ—Å—Å–∞", odessa: "–û–¥–µ—Å—Å–∞",
  kharkiv: "–•–∞—Ä—å–∫–æ–≤", lviv: "–õ—å–≤–æ–≤", dnipro: "–î–Ω–µ–ø—Ä",
  zaporizhzhia: "–ó–∞–ø–æ—Ä–æ–∂—å–µ", zaporozhye: "–ó–∞–ø–æ—Ä–æ–∂—å–µ",
  vinnytsia: "–í–∏–Ω–Ω–∏—Ü–∞", vinnitsa: "–í–∏–Ω–Ω–∏—Ü–∞",
  ternopil: "–¢–µ—Ä–Ω–æ–ø–æ–ª—å",
  khmelnytskyi: "–•–º–µ–ª—å–Ω–∏—Ü–∫–∏–π", khmelnitsky: "–•–º–µ–ª—å–Ω–∏—Ü–∫–∏–π",
  cherkasy: "–ß–µ—Ä–∫–∞—Å—Å—ã", chernivtsi: "–ß–µ—Ä–Ω–æ–≤—Ü—ã", chernovtsy: "–ß–µ—Ä–Ω–æ–≤—Ü—ã",
  "ivano-frankivsk": "–ò–≤–∞–Ω–æ-–§—Ä–∞–Ω–∫–æ–≤—Å–∫",
  kropyvnytskyi: "–ö—Ä–æ–ø–∏–≤–Ω–∏—Ü–∫–∏–π",
  mykolaiv: "–ù–∏–∫–æ–ª–∞–µ–≤", nikolaev: "–ù–∏–∫–æ–ª–∞–µ–≤",
  poltava: "–ü–æ–ª—Ç–∞–≤–∞", rivne: "–†–æ–≤–Ω–æ", rovno: "–†–æ–≤–Ω–æ",
  sumy: "–°—É–º—ã", uzhhorod: "–£–∂–≥–æ—Ä–æ–¥", zhytomyr: "–ñ–∏—Ç–æ–º–∏—Ä",
  kramatorsk: "–ö—Ä–∞–º–∞—Ç–æ—Ä—Å–∫", sloviansk: "–°–ª–∞–≤—è–Ω—Å–∫",
  lutsk: "–õ—É—Ü–∫", kherson: "–•–µ—Ä—Å–æ–Ω", bukovel: "–ë—É–∫–æ–≤–µ–ª—å",

  –∫–∏—ó–≤: "–ö–∏–µ–≤", "–∫—Ä–∏–≤–∏–π —Ä—ñ–≥": "–ö—Ä–∏–≤–æ–π –†–æ–≥", –æ–¥–µ—Å–∞: "–û–¥–µ—Å—Å–∞",
  —Ö–∞—Ä–∫—ñ–≤: "–•–∞—Ä—å–∫–æ–≤", –ª—å–≤—ñ–≤: "–õ—å–≤–æ–≤", –¥–Ω—ñ–ø—Ä–æ: "–î–Ω–µ–ø—Ä",
  –¥–Ω—ñ–ø—Ä–æ–ø–µ—Ç—Ä–æ–≤—Å—å–∫: "–î–Ω–µ–ø—Ä", –∑–∞–ø–æ—Ä—ñ–∂–∂—è: "–ó–∞–ø–æ—Ä–æ–∂—å–µ",
  –≤—ñ–Ω–Ω–∏—Ü—è: "–í–∏–Ω–Ω–∏—Ü–∞", —Ç–µ—Ä–Ω–æ–ø—ñ–ª—å: "–¢–µ—Ä–Ω–æ–ø–æ–ª—å",
  —Ö–º–µ–ª—å–Ω–∏—Ü—å–∫–∏–π: "–•–º–µ–ª—å–Ω–∏—Ü–∫–∏–π", —á–µ—Ä–∫–∞—Å–∏: "–ß–µ—Ä–∫–∞—Å—Å—ã",
  —á–µ—Ä–Ω—ñ–≤—Ü—ñ: "–ß–µ—Ä–Ω–æ–≤—Ü—ã", "—ñ–≤–∞–Ω–æ-—Ñ—Ä–∞–Ω–∫—ñ–≤—Å—å–∫": "–ò–≤–∞–Ω–æ-–§—Ä–∞–Ω–∫–æ–≤—Å–∫",
  –∫—Ä–æ–ø–∏–≤–Ω–∏—Ü—å–∫–∏–π: "–ö—Ä–æ–ø–∏–≤–Ω–∏—Ü–∫–∏–π", –º–∏–∫–æ–ª–∞—ó–≤: "–ù–∏–∫–æ–ª–∞–µ–≤",
  –ø–æ–ª—Ç–∞–≤–∞: "–ü–æ–ª—Ç–∞–≤–∞", —Ä—ñ–≤–Ω–µ: "–†–æ–≤–Ω–æ", —Å—É–º–∏: "–°—É–º—ã",
  —É–∂–≥–æ—Ä–æ–¥: "–£–∂–≥–æ—Ä–æ–¥", –∂–∏—Ç–æ–º–∏—Ä: "–ñ–∏—Ç–æ–º–∏—Ä",
  –∫—Ä–∞–º–∞—Ç–æ—Ä—Å—å–∫: "–ö—Ä–∞–º–∞—Ç–æ—Ä—Å–∫", "—Å–ª–æ–≤'—è–Ω—Å—å–∫": "–°–ª–∞–≤—è–Ω—Å–∫",
  –ª—É—Ü—å–∫: "–õ—É—Ü–∫", —Ö–µ—Ä—Å–æ–Ω: "–•–µ—Ä—Å–æ–Ω", –±—É–∫–æ–≤–µ–ª—å: "–ë—É–∫–æ–≤–µ–ª—å",
};

const countryNormalizationMap = {
    // –°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Å—Ç—Ä–∞–Ω—ã –ï–≤—Ä–æ–ø—ã
    'russia': 'üá∑üá∫ –†–æ—Å—Å–∏—è', 'russian federation': 'üá∑üá∫ –†–æ—Å—Å–∏—è', 'rus': 'üá∑üá∫ –†–æ—Å—Å–∏—è',
    'ukraine': 'üá∫üá¶ –£–∫—Ä–∞–∏–Ω–∞', 'ukr': 'üá∫üá¶ –£–∫—Ä–∞–∏–Ω–∞',
    'belarus': 'üáßüáæ –ë–µ–ª–∞—Ä—É—Å—å', 'belarus republic': 'üáßüáæ –ë–µ–ª–∞—Ä—É—Å—å', 'blr': 'üáßüáæ –ë–µ–ª–∞—Ä—É—Å—å',
    'kazakhstan': 'üá∞üáø –ö–∞–∑–∞—Ö—Å—Ç–∞–Ω', 'kaz': 'üá∞üáø –ö–∞–∑–∞—Ö—Å—Ç–∞–Ω',
    'germany': 'üá©üá™ –ì–µ—Ä–º–∞–Ω–∏—è', 'deutschland': 'üá©üá™ –ì–µ—Ä–º–∞–Ω–∏—è', 'deu': 'üá©üá™ –ì–µ—Ä–º–∞–Ω–∏—è', 'ger': 'üá©üá™ –ì–µ—Ä–º–∞–Ω–∏—è',
    'france': 'üá´üá∑ –§—Ä–∞–Ω—Ü–∏—è', 'french republic': 'üá´üá∑ –§—Ä–∞–Ω—Ü–∏—è', 'fra': 'üá´üá∑ –§—Ä–∞–Ω—Ü–∏—è',
    'italy': 'üáÆüáπ –ò—Ç–∞–ª–∏—è', 'italian republic': 'üáÆüáπ –ò—Ç–∞–ª–∏—è', 'ita': 'üáÆüáπ –ò—Ç–∞–ª–∏—è',
    'spain': 'üá™üá∏ –ò—Å–ø–∞–Ω–∏—è', 'kingdom of spain': 'üá™üá∏ –ò—Å–ø–∞–Ω–∏—è', 'esp': 'üá™üá∏ –ò—Å–ø–∞–Ω–∏—è',
    'united kingdom': 'üá¨üáß –í–µ–ª–∏–∫–æ–±—Ä–∏—Ç–∞–Ω–∏—è', 'great britain': 'üá¨üáß –í–µ–ª–∏–∫–æ–±—Ä–∏—Ç–∞–Ω–∏—è', 'england': 'üá¨üáß –í–µ–ª–∏–∫–æ–±—Ä–∏—Ç–∞–Ω–∏—è', 'gb': 'üá¨üáß –í–µ–ª–∏–∫–æ–±—Ä–∏—Ç–∞–Ω–∏—è', 'gbr': 'üá¨üáß –í–µ–ª–∏–∫–æ–±—Ä–∏—Ç–∞–Ω–∏—è',
    'poland': 'üáµüá± –ü–æ–ª—å—à–∞', 'republic of poland': 'üáµüá± –ü–æ–ª—å—à–∞', 'pol': 'üáµüá± –ü–æ–ª—å—à–∞',
    'netherlands': 'üá≥üá± –ù–∏–¥–µ—Ä–ª–∞–Ω–¥—ã', 'holland': 'üá≥üá± –ù–∏–¥–µ—Ä–ª–∞–Ω–¥—ã', 'nld': 'üá≥üá± –ù–∏–¥–µ—Ä–ª–∞–Ω–¥—ã',
    'belgium': 'üáßüá™ –ë–µ–ª—å–≥–∏—è', 'belgian': 'üáßüá™ –ë–µ–ª—å–≥–∏—è', 'bel': 'üáßüá™ –ë–µ–ª—å–≥–∏—è',
    'switzerland': 'üá®üá≠ –®–≤–µ–π—Ü–∞—Ä–∏—è', 'swiss': 'üá®üá≠ –®–≤–µ–π—Ü–∞—Ä–∏—è', 'che': 'üá®üá≠ –®–≤–µ–π—Ü–∞—Ä–∏—è',
    'austria': 'üá¶üáπ –ê–≤—Å—Ç—Ä–∏—è', 'aut': 'üá¶üáπ –ê–≤—Å—Ç—Ä–∏—è',
    'portugal': 'üáµüáπ –ü–æ—Ä—Ç—É–≥–∞–ª–∏—è', 'prt': 'üáµüáπ –ü–æ—Ä—Ç—É–≥–∞–ª–∏—è',
    'greece': 'üá¨üá∑ –ì—Ä–µ—Ü–∏—è', 'grc': 'üá¨üá∑ –ì—Ä–µ—Ü–∏—è',
    'czech republic': 'üá®üáø –ß–µ—Ö–∏—è', 'czech': 'üá®üáø –ß–µ—Ö–∏—è', 'cze': 'üá®üáø –ß–µ—Ö–∏—è',
    'sweden': 'üá∏üá™ –®–≤–µ—Ü–∏—è', 'swe': 'üá∏üá™ –®–≤–µ—Ü–∏—è',
    'norway': 'üá≥üá¥ –ù–æ—Ä–≤–µ–≥–∏—è', 'nor': 'üá≥üá¥ –ù–æ—Ä–≤–µ–≥–∏—è',
    'finland': 'üá´üáÆ –§–∏–Ω–ª—è–Ω–¥–∏—è', 'fin': 'üá´üáÆ –§–∏–Ω–ª—è–Ω–¥–∏—è',
    'denmark': 'üá©üá∞ –î–∞–Ω–∏—è', 'dnk': 'üá©üá∞ –î–∞–Ω–∏—è',
    'ireland': 'üáÆüá™ –ò—Ä–ª–∞–Ω–¥–∏—è', 'irl': 'üáÆüá™ –ò—Ä–ª–∞–Ω–¥–∏—è',
    'hungary': 'üá≠üá∫ –í–µ–Ω–≥—Ä–∏—è', 'hun': 'üá≠üá∫ –í–µ–Ω–≥—Ä–∏—è',
    'romania': 'üá∑üá¥ –†—É–º—ã–Ω–∏—è', 'rou': 'üá∑üá¥ –†—É–º—ã–Ω–∏—è',
    'bulgaria': 'üáßüá¨ –ë–æ–ª–≥–∞—Ä–∏—è', 'bgr': 'üáßüá¨ –ë–æ–ª–≥–∞—Ä–∏—è',
    'serbia': 'üá∑üá∏ –°–µ—Ä–±–∏—è', 'srb': 'üá∑üá∏ –°–µ—Ä–±–∏—è',
    'croatia': 'üá≠üá∑ –•–æ—Ä–≤–∞—Ç–∏—è', 'hrv': 'üá≠üá∑ –•–æ—Ä–≤–∞—Ç–∏—è',
    'slovakia': 'üá∏üá∞ –°–ª–æ–≤–∞–∫–∏—è', 'svk': 'üá∏üá∞ –°–ª–æ–≤–∞–∫–∏—è',
    'slovenia': 'üá∏üáÆ –°–ª–æ–≤–µ–Ω–∏—è', 'svn': 'üá∏üáÆ –°–ª–æ–≤–µ–Ω–∏—è',
    'lithuania': 'üá±üáπ –õ–∏—Ç–≤–∞', 'ltu': 'üá±üáπ –õ–∏—Ç–≤–∞',
    'latvia': 'üá±üáª –õ–∞—Ç–≤–∏—è', 'lva': 'üá±üáª –õ–∞—Ç–≤–∏—è',
    'estonia': 'üá™üá™ –≠—Å—Ç–æ–Ω–∏—è', 'est': 'üá™üá™ –≠—Å—Ç–æ–Ω–∏—è',
    'moldova': 'üá≤üá© –ú–æ–ª–¥–æ–≤–∞', 'mda': 'üá≤üá© –ú–æ–ª–¥–æ–≤–∞',
    'georgia': 'üá¨üá™ –ì—Ä—É–∑–∏—è', 'geo': 'üá¨üá™ –ì—Ä—É–∑–∏—è',
    'armenia': 'üá¶üá≤ –ê—Ä–º–µ–Ω–∏—è', 'arm': 'üá¶üá≤ –ê—Ä–º–µ–Ω–∏—è',
    'azerbaijan': 'üá¶üáø –ê–∑–µ—Ä–±–∞–π–¥–∂–∞–Ω', 'aze': 'üá¶üáø –ê–∑–µ—Ä–±–∞–π–¥–∂–∞–Ω',
    'luxembourg': 'üá±üá∫ –õ—é–∫—Å–µ–º–±—É—Ä–≥', 'lux': 'üá±üá∫ –õ—é–∫—Å–µ–º–±—É—Ä–≥',
    'malta': 'üá≤üáπ –ú–∞–ª—å—Ç–∞', 'mlt': 'üá≤üáπ –ú–∞–ª—å—Ç–∞',
    'monaco': 'üá≤üá® –ú–æ–Ω–∞–∫–æ', 'mco': 'üá≤üá® –ú–æ–Ω–∞–∫–æ',
    'montenegro': 'üá≤üá™ –ß–µ—Ä–Ω–æ–≥–æ—Ä–∏—è', 'mne': 'üá≤üá™ –ß–µ—Ä–Ω–æ–≥–æ—Ä–∏—è',
    'iceland': 'üáÆüá∏ –ò—Å–ª–∞–Ω–¥–∏—è', 'isl': 'üáÆüá∏ –ò—Å–ª–∞–Ω–¥–∏—è',
    'albania': 'üá¶üá± –ê–ª–±–∞–Ω–∏—è', 'alb': 'üá¶üá± –ê–ª–±–∞–Ω–∏—è',
    'bosnia': 'üáßüá¶ –ë–æ—Å–Ω–∏—è', 'bosnia and herzegovina': 'üáßüá¶ –ë–æ—Å–Ω–∏—è', 'bih': 'üáßüá¶ –ë–æ—Å–Ω–∏—è',
    'cyprus': 'üá®üáæ –ö–∏–ø—Ä', 'cyp': 'üá®üáæ –ö–∏–ø—Ä',
    'north macedonia': 'üá≤üá∞ –°–µ–≤–µ—Ä–Ω–∞—è –ú–∞–∫–µ–¥–æ–Ω–∏—è', 'macedonia': 'üá≤üá∞ –°–µ–≤–µ—Ä–Ω–∞—è –ú–∞–∫–µ–¥–æ–Ω–∏—è', 'mkd': 'üá≤üá∞ –°–µ–≤–µ—Ä–Ω–∞—è –ú–∞–∫–µ–¥–æ–Ω–∏—è',

    // –ê—Ñ—Ä–∏–∫–∞
    'south africa': 'üáøüá¶ –Æ–ê–†', 'south africa republic': 'üáøüá¶ –Æ–ê–†', 'zaf': 'üáøüá¶ –Æ–ê–†',
    'egypt': 'üá™üá¨ –ï–≥–∏–ø–µ—Ç', 'egy': 'üá™üá¨ –ï–≥–∏–ø–µ—Ç',
    'morocco': 'üá≤üá¶ –ú–∞—Ä–æ–∫–∫–æ', 'mar': 'üá≤üá¶ –ú–∞—Ä–æ–∫–∫–æ',
    'algeria': 'üá©üáø –ê–ª–∂–∏—Ä', 'dza': 'üá©üáø –ê–ª–∂–∏—Ä',
    'tunisia': 'üáπüá≥ –¢—É–Ω–∏—Å', 'tun': 'üáπüá≥ –¢—É–Ω–∏—Å',
    'nigeria': 'üá≥üá¨ –ù–∏–≥–µ—Ä–∏—è', 'nga': 'üá≥üá¨ –ù–∏–≥–µ—Ä–∏—è',
    'kenya': 'üá∞üá™ –ö–µ–Ω–∏—è', 'ken': 'üá∞üá™ –ö–µ–Ω–∏—è',
    'ethiopia': 'üá™üáπ –≠—Ñ–∏–æ–ø–∏—è', 'eth': 'üá™üáπ –≠—Ñ–∏–æ–ø–∏—è',
    'ghana': 'üá¨üá≠ –ì–∞–Ω–∞', 'gha': 'üá¨üá≠ –ì–∞–Ω–∞',
    'tanzania': 'üáπüáø –¢–∞–Ω–∑–∞–Ω–∏—è', 'tza': 'üáπüáø –¢–∞–Ω–∑–∞–Ω–∏—è',
    'uganda': 'üá∫üá¨ –£–≥–∞–Ω–¥–∞', 'uga': 'üá∫üá¨ –£–≥–∞–Ω–¥–∞',
    'cameroon': 'üá®üá≤ –ö–∞–º–µ—Ä—É–Ω', 'cmr': 'üá®üá≤ –ö–∞–º–µ—Ä—É–Ω',
    'ivory coast': 'üá®üáÆ –ö–æ—Ç-–¥\'–ò–≤—É–∞—Ä', 'cote d\'ivoire': 'üá®üáÆ –ö–æ—Ç-–¥\'–ò–≤—É–∞—Ä', 'civ': 'üá®üáÆ –ö–æ—Ç-–¥\'–ò–≤—É–∞—Ä',
    'senegal': 'üá∏üá≥ –°–µ–Ω–µ–≥–∞–ª', 'sen': 'üá∏üá≥ –°–µ–Ω–µ–≥–∞–ª',

    // –°–µ–≤–µ—Ä–Ω–∞—è –∏ –Æ–∂–Ω–∞—è –ê–º–µ—Ä–∏–∫–∞
    'usa': 'üá∫üá∏ –°–®–ê', 'united states': 'üá∫üá∏ –°–®–ê', 'america': 'üá∫üá∏ –°–®–ê', 'united states of america': 'üá∫üá∏ –°–®–ê',
    'canada': 'üá®üá¶ –ö–∞–Ω–∞–¥–∞', 'can': 'üá®üá¶ –ö–∞–Ω–∞–¥–∞',
    'mexico': 'üá≤üáΩ –ú–µ–∫—Å–∏–∫–∞', 'mex': 'üá≤üáΩ –ú–µ–∫—Å–∏–∫–∞',
    'brazil': 'üáßüá∑ –ë—Ä–∞–∑–∏–ª–∏—è', 'bra': 'üáßüá∑ –ë—Ä–∞–∑–∏–ª–∏—è',
    'argentina': 'üá¶üá∑ –ê—Ä–≥–µ–Ω—Ç–∏–Ω–∞', 'arg': 'üá¶üá∑ –ê—Ä–≥–µ–Ω—Ç–∏–Ω–∞',
    'colombia': 'üá®üá¥ –ö–æ–ª—É–º–±–∏—è', 'col': 'üá®üá¥ –ö–æ–ª—É–º–±–∏—è',
    'chile': 'üá®üá± –ß–∏–ª–∏', 'chl': 'üá®üá± –ß–∏–ª–∏',
    'peru': 'üáµüá™ –ü–µ—Ä—É', 'per': 'üáµüá™ –ü–µ—Ä—É',
    'venezuela': 'üáªüá™ –í–µ–Ω–µ—Å—É—ç–ª–∞', 'ven': 'üáªüá™ –í–µ–Ω–µ—Å—É—ç–ª–∞',
    'ecuador': 'üá™üá® –≠–∫–≤–∞–¥–æ—Ä', 'ecu': 'üá™üá® –≠–∫–≤–∞–¥–æ—Ä',
    'bolivia': 'üáßüá¥ –ë–æ–ª–∏–≤–∏—è', 'bol': 'üáßüá¥ –ë–æ–ª–∏–≤–∏—è',
    'paraguay': 'üáµüáæ –ü–∞—Ä–∞–≥–≤–∞–π', 'pry': 'üáµüáæ –ü–∞—Ä–∞–≥–≤–∞–π',
    'uruguay': 'üá∫üáæ –£—Ä—É–≥–≤–∞–π', 'ury': 'üá∫üáæ –£—Ä—É–≥–≤–∞–π',
    'cuba': 'üá®üá∫ –ö—É–±–∞', 'cub': 'üá®üá∫ –ö—É–±–∞',
    'dominican republic': 'üá©üá¥ –î–æ–º–∏–Ω–∏–∫–∞–Ω–∞', 'dom': 'üá©üá¥ –î–æ–º–∏–Ω–∏–∫–∞–Ω–∞',
    'puerto rico': 'üáµüá∑ –ü—É—ç—Ä—Ç–æ-–†–∏–∫–æ', 'pri': 'üáµüá∑ –ü—É—ç—Ä—Ç–æ-–†–∏–∫–æ',
    'panama': 'üáµüá¶ –ü–∞–Ω–∞–º–∞', 'pan': 'üáµüá¶ –ü–∞–Ω–∞–º–∞',
    'costa rica': 'üá®üá∑ –ö–æ—Å—Ç–∞-–†–∏–∫–∞', 'cri': 'üá®üá∑ –ö–æ—Å—Ç–∞-–†–∏–∫–∞',

    // –ê–∑–∏—è
    'china': 'üá®üá≥ –ö–∏—Ç–∞–π', 'chn': 'üá®üá≥ –ö–∏—Ç–∞–π',
    'japan': 'üáØüáµ –Ø–ø–æ–Ω–∏—è', 'jpn': 'üáØüáµ –Ø–ø–æ–Ω–∏—è',
    'south korea': 'üá∞üá∑ –Æ–∂–Ω–∞—è –ö–æ—Ä–µ—è', 'korea': 'üá∞üá∑ –Æ–∂–Ω–∞—è –ö–æ—Ä–µ—è', 'kor': 'üá∞üá∑ –Æ–∂–Ω–∞—è –ö–æ—Ä–µ—è',
    'north korea': 'üá∞üáµ –°–µ–≤–µ—Ä–Ω–∞—è –ö–æ—Ä–µ—è', 'prk': 'üá∞üáµ –°–µ–≤–µ—Ä–Ω–∞—è –ö–æ—Ä–µ—è',
    'india': 'üáÆüá≥ –ò–Ω–¥–∏—è', 'ind': 'üáÆüá≥ –ò–Ω–¥–∏—è',
    'pakistan': 'üáµüá∞ –ü–∞–∫–∏—Å—Ç–∞–Ω', 'pak': 'üáµüá∞ –ü–∞–∫–∏—Å—Ç–∞–Ω',
    'bangladesh': 'üáßüá© –ë–∞–Ω–≥–ª–∞–¥–µ—à', 'bgd': 'üáßüá© –ë–∞–Ω–≥–ª–∞–¥–µ—à',
    'indonesia': 'üáÆüá© –ò–Ω–¥–æ–Ω–µ–∑–∏—è', 'idn': 'üáÆüá© –ò–Ω–¥–æ–Ω–µ–∑–∏—è',
    'philippines': 'üáµüá≠ –§–∏–ª–∏–ø–ø–∏–Ω—ã', 'phl': 'üáµüá≠ –§–∏–ª–∏–ø–ø–∏–Ω—ã',
    'vietnam': 'üáªüá≥ –í—å–µ—Ç–Ω–∞–º', 'vnm': 'üáªüá≥ –í—å–µ—Ç–Ω–∞–º',
    'thailand': 'üáπüá≠ –¢–∞–∏–ª–∞–Ω–¥', 'tha': 'üáπüá≠ –¢–∞–∏–ª–∞–Ω–¥',
    'malaysia': 'üá≤üáæ –ú–∞–ª–∞–π–∑–∏—è', 'mys': 'üá≤üáæ –ú–∞–ª–∞–π–∑–∏—è',
    'singapore': 'üá∏üá¨ –°–∏–Ω–≥–∞–ø—É—Ä', 'sgp': 'üá∏üá¨ –°–∏–Ω–≥–∞–ø—É—Ä',
    'myanmar': 'üá≤üá≤ –ú—å—è–Ω–º–∞', 'burma': 'üá≤üá≤ –ú—å—è–Ω–º–∞', 'mmr': 'üá≤üá≤ –ú—å—è–Ω–º–∞',
    'sri lanka': 'üá±üá∞ –®—Ä–∏-–õ–∞–Ω–∫–∞', 'lka': 'üá±üá∞ –®—Ä–∏-–õ–∞–Ω–∫–∞',
    'nepal': 'üá≥üáµ –ù–µ–ø–∞–ª', 'npl': 'üá≥üáµ –ù–µ–ø–∞–ª',
    'afghanistan': 'üá¶üá´ –ê—Ñ–≥–∞–Ω–∏—Å—Ç–∞–Ω', 'afg': 'üá¶üá´ –ê—Ñ–≥–∞–Ω–∏—Å—Ç–∞–Ω',
    'iran': 'üáÆüá∑ –ò—Ä–∞–Ω', 'irn': 'üáÆüá∑ –ò—Ä–∞–Ω',
    'iraq': 'üáÆüá∂ –ò—Ä–∞–∫', 'irq': 'üáÆüá∂ –ò—Ä–∞–∫',
    'saudi arabia': 'üá∏üá¶ –°–∞—É–¥–æ–≤—Å–∫–∞—è –ê—Ä–∞–≤–∏—è', 'sau': 'üá∏üá¶ –°–∞—É–¥–æ–≤—Å–∫–∞—è –ê—Ä–∞–≤–∏—è',
    'united arab emirates': 'üá¶üá™ –û–ê–≠', 'uae': 'üá¶üá™ –û–ê–≠', 'are': 'üá¶üá™ –û–ê–≠',
    'qatar': 'üá∂üá¶ –ö–∞—Ç–∞—Ä', 'qat': 'üá∂üá¶ –ö–∞—Ç–∞—Ä',
    'kuwait': 'üá∞üáº –ö—É–≤–µ–π—Ç', 'kwt': 'üá∞üáº –ö—É–≤–µ–π—Ç',
    'oman': 'üá¥üá≤ –û–º–∞–Ω', 'omn': 'üá¥üá≤ –û–º–∞–Ω',
    'bahrain': 'üáßüá≠ –ë–∞—Ö—Ä–µ–π–Ω', 'bhr': 'üáßüá≠ –ë–∞—Ö—Ä–µ–π–Ω',
    'jordan': 'üáØüá¥ –ò–æ—Ä–¥–∞–Ω–∏—è', 'jor': 'üáØüá¥ –ò–æ—Ä–¥–∞–Ω–∏—è',
    'lebanon': 'üá±üáß –õ–∏–≤–∞–Ω', 'lbn': 'üá±üáß –õ–∏–≤–∞–Ω',
    'syria': 'üá∏üáæ –°–∏—Ä–∏—è', 'syr': 'üá∏üáæ –°–∏—Ä–∏—è',
    'yemen': 'üáæüá™ –ô–µ–º–µ–Ω', 'yem': 'üáæüá™ –ô–µ–º–µ–Ω',
    'israel': 'üáÆüá± –ò–∑—Ä–∞–∏–ª—å', 'isr': 'üáÆüá± –ò–∑—Ä–∞–∏–ª—å',
    'palestine': 'üáµüá∏ –ü–∞–ª–µ—Å—Ç–∏–Ω–∞', 'pse': 'üáµüá∏ –ü–∞–ª–µ—Å—Ç–∏–Ω–∞',
    'turkey': 'üáπüá∑ –¢—É—Ä—Ü–∏—è', 'tur': 'üáπüá∑ –¢—É—Ä—Ü–∏—è',

    // –¶–µ–Ω—Ç—Ä–∞–ª—å–Ω–∞—è –ê–∑–∏—è
    'uzbekistan': 'üá∫üáø –£–∑–±–µ–∫–∏—Å—Ç–∞–Ω', 'uzb': 'üá∫üáø –£–∑–±–µ–∫–∏—Å—Ç–∞–Ω',
    'kyrgyzstan': 'üá∞üá¨ –ö—ã—Ä–≥—ã–∑—Å—Ç–∞–Ω', 'kgz': 'üá∞üá¨ –ö—ã—Ä–≥—ã–∑—Å—Ç–∞–Ω',
    'tajikistan': 'üáπüáØ –¢–∞–¥–∂–∏–∫–∏—Å—Ç–∞–Ω', 'tjk': 'üáπüáØ –¢–∞–¥–∂–∏–∫–∏—Å—Ç–∞–Ω',
    'turkmenistan': 'üáπüá≤ –¢—É—Ä–∫–º–µ–Ω–∏—Å—Ç–∞–Ω', 'tkm': 'üáπüá≤ –¢—É—Ä–∫–º–µ–Ω–∏—Å—Ç–∞–Ω',

    // –û–∫–µ–∞–Ω–∏—è
    'australia': 'üá¶üá∫ –ê–≤—Å—Ç—Ä–∞–ª–∏—è', 'aus': 'üá¶üá∫ –ê–≤—Å—Ç—Ä–∞–ª–∏—è',
    'new zealand': 'üá≥üáø –ù–æ–≤–∞—è –ó–µ–ª–∞–Ω–¥–∏—è', 'nzl': 'üá≥üáø –ù–æ–≤–∞—è –ó–µ–ª–∞–Ω–¥–∏—è',
    'fiji': 'üá´üáØ –§–∏–¥–∂–∏', 'fji': 'üá´üáØ –§–∏–¥–∂–∏',
    'papua new guinea': 'üáµüá¨ –ü–∞–ø—É–∞-–ù–æ–≤–∞—è –ì–≤–∏–Ω–µ—è', 'png': 'üáµüá¨ –ü–∞–ø—É–∞-–ù–æ–≤–∞—è –ì–≤–∏–Ω–µ—è',

    // –ö–∞—Ä–∏–±—Å–∫–∏–µ –æ—Å—Ç—Ä–æ–≤–∞
    'jamaica': 'üáØüá≤ –Ø–º–∞–π–∫–∞', 'jam': 'üáØüá≤ –Ø–º–∞–π–∫–∞',
    'haiti': 'üá≠üáπ –ì–∞–∏—Ç–∏', 'hti': 'üá≠üáπ –ì–∞–∏—Ç–∏',
    'trinidad and tobago': 'üáπüáπ –¢—Ä–∏–Ω–∏–¥–∞–¥ –∏ –¢–æ–±–∞–≥–æ', 'tto': 'üáπüáπ –¢—Ä–∏–Ω–∏–¥–∞–¥ –∏ –¢–æ–±–∞–≥–æ',
    'bahamas': 'üáßüá∏ –ë–∞–≥–∞–º—ã', 'bhs': 'üáßüá∏ –ë–∞–≥–∞–º—ã',
    'barbados': 'üáßüáß –ë–∞—Ä–±–∞–¥–æ—Å', 'brb': 'üáßüáß –ë–∞—Ä–±–∞–¥–æ—Å',

    // –î—Ä—É–≥–∏–µ –≤–∞–∂–Ω—ã–µ —Å—Ç—Ä–∞–Ω—ã
    'mongolia': 'üá≤üá≥ –ú–æ–Ω–≥–æ–ª–∏—è', 'mng': 'üá≤üá≥ –ú–æ–Ω–≥–æ–ª–∏—è',
    'laos': 'üá±üá¶ –õ–∞–æ—Å', 'lao': 'üá±üá¶ –õ–∞–æ—Å',
    'cambodia': 'üá∞üá≠ –ö–∞–º–±–æ–¥–∂–∞', 'khm': 'üá∞üá≠ –ö–∞–º–±–æ–¥–∂–∞',
    'brunei': 'üáßüá≥ –ë—Ä—É–Ω–µ–π', 'brn': 'üáßüá≥ –ë—Ä—É–Ω–µ–π',
    'east timor': 'üáπüá± –í–æ—Å—Ç–æ—á–Ω—ã–π –¢–∏–º–æ—Ä', 'timor-leste': 'üáπüá± –í–æ—Å—Ç–æ—á–Ω—ã–π –¢–∏–º–æ—Ä', 'tls': 'üáπüá± –í–æ—Å—Ç–æ—á–Ω—ã–π –¢–∏–º–æ—Ä',
    'madagascar': 'üá≤üá¨ –ú–∞–¥–∞–≥–∞—Å–∫–∞—Ä', 'mdg': 'üá≤üá¨ –ú–∞–¥–∞–≥–∞—Å–∫–∞—Ä',
    'mozambique': 'üá≤üáø –ú–æ–∑–∞–º–±–∏–∫', 'moz': 'üá≤üáø –ú–æ–∑–∞–º–±–∏–∫',
    'zimbabwe': 'üáøüáº –ó–∏–º–±–∞–±–≤–µ', 'zwe': 'üáøüáº –ó–∏–º–±–∞–±–≤–µ',
    'zambia': 'üáøüá≤ –ó–∞–º–±–∏—è', 'zmb': 'üáøüá≤ –ó–∞–º–±–∏—è',
    'botswana': 'üáßüáº –ë–æ—Ç—Å–≤–∞–Ω–∞', 'bwa': 'üáßüáº –ë–æ—Ç—Å–≤–∞–Ω–∞',
    'namibia': 'üá≥üá¶ –ù–∞–º–∏–±–∏—è', 'nam': 'üá≥üá¶ –ù–∞–º–∏–±–∏—è',
    'angola': 'üá¶üá¥ –ê–Ω–≥–æ–ª–∞', 'ago': 'üá¶üá¥ –ê–Ω–≥–æ–ª–∞',
    'congo': 'üá®üá¨ –ö–æ–Ω–≥–æ', 'cog': 'üá®üá¨ –ö–æ–Ω–≥–æ',
    'dr congo': 'üá®üá© –î–† –ö–æ–Ω–≥–æ', 'democratic republic of the congo': 'üá®üá© –î–† –ö–æ–Ω–≥–æ', 'cod': 'üá®üá© –î–† –ö–æ–Ω–≥–æ',
    'rwanda': 'üá∑üáº –†—É–∞–Ω–¥–∞', 'rwa': 'üá∑üáº –†—É–∞–Ω–¥–∞',
    'burundi': 'üáßüáÆ –ë—É—Ä—É–Ω–¥–∏', 'bdi': 'üáßüáÆ –ë—É—Ä—É–Ω–¥–∏',
    'somalia': 'üá∏üá¥ –°–æ–º–∞–ª–∏', 'som': 'üá∏üá¥ –°–æ–º–∞–ª–∏',
    'sudan': 'üá∏üá© –°—É–¥–∞–Ω', 'sdn': 'üá∏üá© –°—É–¥–∞–Ω',
    'south sudan': 'üá∏üá∏ –Æ–∂–Ω—ã–π –°—É–¥–∞–Ω', 'ssd': 'üá∏üá∏ –Æ–∂–Ω—ã–π –°—É–¥–∞–Ω',
    'libya': 'üá±üáæ –õ–∏–≤–∏—è', 'lby': 'üá±üáæ –õ–∏–≤–∏—è',
    'mauritius': 'üá≤üá∫ –ú–∞–≤—Ä–∏–∫–∏–π', 'mus': 'üá≤üá∫ –ú–∞–≤—Ä–∏–∫–∏–π',
    'seychelles': 'üá∏üá® –°–µ–π—à–µ–ª—ã', 'syc': 'üá∏üá® –°–µ–π—à–µ–ª—ã',
    'comoros': 'üá∞üá≤ –ö–æ–º–æ—Ä—ã', 'com': 'üá∞üá≤ –ö–æ–º–æ—Ä—ã',
    'djibouti': 'üá©üáØ –î–∂–∏–±—É—Ç–∏', 'dji': 'üá©üáØ –î–∂–∏–±—É—Ç–∏',
    'eritrea': 'üá™üá∑ –≠—Ä–∏—Ç—Ä–µ—è', 'eri': 'üá™üá∑ –≠—Ä–∏—Ç—Ä–µ—è',
    'gabon': 'üá¨üá¶ –ì–∞–±–æ–Ω', 'gab': 'üá¨üá¶ –ì–∞–±–æ–Ω',
    'equatorial guinea': 'üá¨üá∂ –≠–∫–≤–∞—Ç–æ—Ä–∏–∞–ª—å–Ω–∞—è –ì–≤–∏–Ω–µ—è', 'gnq': 'üá¨üá∂ –≠–∫–≤–∞—Ç–æ—Ä–∏–∞–ª—å–Ω–∞—è –ì–≤–∏–Ω–µ—è',
    'chad': 'üáπüá© –ß–∞–¥', 'tcd': 'üáπüá© –ß–∞–¥',
    'niger': 'üá≥üá™ –ù–∏–≥–µ—Ä', 'ner': 'üá≥üá™ –ù–∏–≥–µ—Ä',
    'mali': 'üá≤üá± –ú–∞–ª–∏', 'mli': 'üá≤üá± –ú–∞–ª–∏',
    'burkina faso': 'üáßüá´ –ë—É—Ä–∫–∏–Ω–∞-–§–∞—Å–æ', 'bfa': 'üáßüá´ –ë—É—Ä–∫–∏–Ω–∞-–§–∞—Å–æ',
    'benin': 'üáßüáØ –ë–µ–Ω–∏–Ω', 'ben': 'üáßüáØ –ë–µ–Ω–∏–Ω',
    'togo': 'üáπüá¨ –¢–æ–≥–æ', 'tgo': 'üáπüá¨ –¢–æ–≥–æ',
    'sierra leone': 'üá∏üá± –°—å–µ—Ä—Ä–∞-–õ–µ–æ–Ω–µ', 'sle': 'üá∏üá± –°—å–µ—Ä—Ä–∞-–õ–µ–æ–Ω–µ',
    'liberia': 'üá±üá∑ –õ–∏–±–µ—Ä–∏—è', 'lbr': 'üá±üá∑ –õ–∏–±–µ—Ä–∏—è',
    'guinea': 'üá¨üá≥ –ì–≤–∏–Ω–µ—è', 'gin': 'üá¨üá≥ –ì–≤–∏–Ω–µ—è',
    'guinea-bissau': 'üá¨üáº –ì–≤–∏–Ω–µ—è-–ë–∏—Å–∞—É', 'gnb': 'üá¨üáº –ì–≤–∏–Ω–µ—è-–ë–∏—Å–∞—É',
    'gambia': 'üá¨üá≤ –ì–∞–º–±–∏—è', 'gmb': 'üá¨üá≤ –ì–∞–º–±–∏—è',
    'cape verde': 'üá®üáª –ö–∞–±–æ-–í–µ—Ä–¥–µ', 'cpv': 'üá®üáª –ö–∞–±–æ-–í–µ—Ä–¥–µ',
    'sao tome and principe': 'üá∏üá∏ –°–∞–Ω-–¢–æ–º–µ –∏ –ü—Ä–∏–Ω—Å–∏–ø–∏', 'stp': 'üá∏üá∏ –°–∞–Ω-–¢–æ–º–µ –∏ –ü—Ä–∏–Ω—Å–∏–ø–∏',
    'mauritania': 'üá≤üá∑ –ú–∞–≤—Ä–∏—Ç–∞–Ω–∏—è', 'mrt': 'üá≤üá∑ –ú–∞–≤—Ä–∏—Ç–∞–Ω–∏—è'
};

const russianVariants = {
    '—Ä–æ—Å—Å–∏—è': 'üá∑üá∫ –†–æ—Å—Å–∏—è', '—Ä—Ñ': 'üá∑üá∫ –†–æ—Å—Å–∏—è',
    '—É–∫—Ä–∞–∏–Ω–∞': 'üá∫üá¶ –£–∫—Ä–∞–∏–Ω–∞',
    '–±–µ–ª–∞—Ä—É—Å—å': 'üáßüáæ –ë–µ–ª–∞—Ä—É—Å—å', '–±–µ–ª–æ—Ä—É—Å—Å–∏—è': 'üáßüáæ –ë–µ–ª–∞—Ä—É—Å—å',
    '–∫–∞–∑–∞—Ö—Å—Ç–∞–Ω': 'üá∞üáø –ö–∞–∑–∞—Ö—Å—Ç–∞–Ω',
    '–≥–µ—Ä–º–∞–Ω–∏—è': 'üá©üá™ –ì–µ—Ä–º–∞–Ω–∏—è',
    '—Ñ—Ä–∞–Ω—Ü–∏—è': 'üá´üá∑ –§—Ä–∞–Ω—Ü–∏—è',
    '–∏—Ç–∞–ª–∏—è': 'üáÆüáπ –ò—Ç–∞–ª–∏—è',
    '–∏—Å–ø–∞–Ω–∏—è': 'üá™üá∏ –ò—Å–ø–∞–Ω–∏—è',
    '–≤–µ–ª–∏–∫–æ–±—Ä–∏—Ç–∞–Ω–∏—è': 'üá¨üáß –í–µ–ª–∏–∫–æ–±—Ä–∏—Ç–∞–Ω–∏—è', '–∞–Ω–≥–ª–∏—è': 'üá¨üáß –í–µ–ª–∏–∫–æ–±—Ä–∏—Ç–∞–Ω–∏—è',
    '–ø–æ–ª—å—à–∞': 'üáµüá± –ü–æ–ª—å—à–∞',
    '–Ω–∏–¥–µ—Ä–ª–∞–Ω–¥—ã': 'üá≥üá± –ù–∏–¥–µ—Ä–ª–∞–Ω–¥—ã', '–≥–æ–ª–ª–∞–Ω–¥–∏—è': 'üá≥üá± –ù–∏–¥–µ—Ä–ª–∞–Ω–¥—ã',
    '–±–µ–ª—å–≥–∏—è': 'üáßüá™ –ë–µ–ª—å–≥–∏—è',
    '—à–≤–µ–π—Ü–∞—Ä–∏—è': 'üá®üá≠ –®–≤–µ–π—Ü–∞—Ä–∏—è',
    '–∞–≤—Å—Ç—Ä–∏—è': 'üá¶üáπ –ê–≤—Å—Ç—Ä–∏—è',
    '–ø–æ—Ä—Ç—É–≥–∞–ª–∏—è': 'üáµüáπ –ü–æ—Ä—Ç—É–≥–∞–ª–∏—è',
    '–≥—Ä–µ—Ü–∏—è': 'üá¨üá∑ –ì—Ä–µ—Ü–∏—è',
    '—á–µ—Ö–∏—è': 'üá®üáø –ß–µ—Ö–∏—è',
    '—à–≤–µ—Ü–∏—è': 'üá∏üá™ –®–≤–µ—Ü–∏—è',
    '–Ω–æ—Ä–≤–µ–≥–∏—è': 'üá≥üá¥ –ù–æ—Ä–≤–µ–≥–∏—è',
    '—Ñ–∏–Ω–ª—è–Ω–¥–∏—è': 'üá´üáÆ –§–∏–Ω–ª—è–Ω–¥–∏—è',
    '–¥–∞–Ω–∏—è': 'üá©üá∞ –î–∞–Ω–∏—è',
    '–∏—Ä–ª–∞–Ω–¥–∏—è': 'üáÆüá™ –ò—Ä–ª–∞–Ω–¥–∏—è',
    '–≤–µ–Ω–≥—Ä–∏—è': 'üá≠üá∫ –í–µ–Ω–≥—Ä–∏—è',
    '—Ä—É–º—ã–Ω–∏—è': 'üá∑üá¥ –†—É–º—ã–Ω–∏—è',
    '–±–æ–ª–≥–∞—Ä–∏—è': 'üáßüá¨ –ë–æ–ª–≥–∞—Ä–∏—è',
    '—Å–µ—Ä–±–∏—è': 'üá∑üá∏ –°–µ—Ä–±–∏—è',
    '—Ö–æ—Ä–≤–∞—Ç–∏—è': 'üá≠üá∑ –•–æ—Ä–≤–∞—Ç–∏—è',
    '—Å–ª–æ–≤–∞–∫–∏—è': 'üá∏üá∞ –°–ª–æ–≤–∞–∫–∏—è',
    '—Å–ª–æ–≤–µ–Ω–∏—è': 'üá∏üáÆ –°–ª–æ–≤–µ–Ω–∏—è',
    '–ª–∏—Ç–≤–∞': 'üá±üáπ –õ–∏—Ç–≤–∞',
    '–ª–∞—Ç–≤–∏—è': 'üá±üáª –õ–∞—Ç–≤–∏—è',
    '—ç—Å—Ç–æ–Ω–∏—è': 'üá™üá™ –≠—Å—Ç–æ–Ω–∏—è',
    '–º–æ–ª–¥–æ–≤–∞': 'üá≤üá© –ú–æ–ª–¥–æ–≤–∞', '–º–æ–ª–¥–∞–≤–∏—è': 'üá≤üá© –ú–æ–ª–¥–æ–≤–∞',
    '–≥—Ä—É–∑–∏—è': 'üá¨üá™ –ì—Ä—É–∑–∏—è',
    '–∞—Ä–º–µ–Ω–∏—è': 'üá¶üá≤ –ê—Ä–º–µ–Ω–∏—è',
    '–∞–∑–µ—Ä–±–∞–π–¥–∂–∞–Ω': 'üá¶üáø –ê–∑–µ—Ä–±–∞–π–¥–∂–∞–Ω',
    '—Å—à–∞': 'üá∫üá∏ –°–®–ê', '–∞–º–µ—Ä–∏–∫–∞': 'üá∫üá∏ –°–®–ê',
    '–∫–∞–Ω–∞–¥–∞': 'üá®üá¶ –ö–∞–Ω–∞–¥–∞',
    '—Ç—É—Ä—Ü–∏—è': 'üáπüá∑ –¢—É—Ä—Ü–∏—è',
    '–∏–∑—Ä–∞–∏–ª—å': 'üáÆüá± –ò–∑—Ä–∞–∏–ª—å',
    '–∫–∏—Ç–∞–π': 'üá®üá≥ –ö–∏—Ç–∞–π',
    '—è–ø–æ–Ω–∏—è': 'üáØüáµ –Ø–ø–æ–Ω–∏—è',
    '—é–∂–Ω–∞—è –∫–æ—Ä–µ—è': 'üá∞üá∑ –Æ–∂–Ω–∞—è –ö–æ—Ä–µ—è', '–∫–æ—Ä–µ—è': 'üá∞üá∑ –Æ–∂–Ω–∞—è –ö–æ—Ä–µ—è',
    '–∏–Ω–¥–∏—è': 'üáÆüá≥ –ò–Ω–¥–∏—è',
    '–±—Ä–∞–∑–∏–ª–∏—è': 'üáßüá∑ –ë—Ä–∞–∑–∏–ª–∏—è',
    '–º–µ–∫—Å–∏–∫–∞': 'üá≤üáΩ –ú–µ–∫—Å–∏–∫–∞',
    '–∞–≤—Å—Ç—Ä–∞–ª–∏—è': 'üá¶üá∫ –ê–≤—Å—Ç—Ä–∞–ª–∏—è',
    '–µ–≥–∏–ø–µ—Ç': 'üá™üá¨ –ï–≥–∏–ø–µ—Ç',
    '—Ç–∞–∏–ª–∞–Ω–¥': 'üáπüá≠ –¢–∞–∏–ª–∞–Ω–¥',
    '–æ–∞—ç': 'üá¶üá™ –û–ê–≠', '–æ–±—ä–µ–¥–∏–Ω–µ–Ω–Ω—ã–µ –∞—Ä–∞–±—Å–∫–∏–µ —ç–º–∏—Ä–∞—Ç—ã': 'üá¶üá™ –û–ê–≠',
    '—É–∑–±–µ–∫–∏—Å—Ç–∞–Ω': 'üá∫üáø –£–∑–±–µ–∫–∏—Å—Ç–∞–Ω',
    '–∫—ã—Ä–≥—ã–∑—Å—Ç–∞–Ω': 'üá∞üá¨ –ö—ã—Ä–≥—ã–∑—Å—Ç–∞–Ω', '–∫–∏—Ä–≥–∏–∑–∏—è': 'üá∞üá¨ –ö—ã—Ä–≥—ã–∑—Å—Ç–∞–Ω',
    '—Ç–∞–¥–∂–∏–∫–∏—Å—Ç–∞–Ω': 'üáπüáØ –¢–∞–¥–∂–∏–∫–∏—Å—Ç–∞–Ω',
    '—Ç—É—Ä–∫–º–µ–Ω–∏—Å—Ç–∞–Ω': 'üáπüá≤ –¢—É—Ä–∫–º–µ–Ω–∏—Å—Ç–∞–Ω',
    
    // –ù–æ–≤—ã–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –Ω–∞ —Ä—É—Å—Å–∫–æ–º
    '—é–∞—Ä': 'üáøüá¶ –Æ–ê–†', '—é–∂–Ω–∞—è –∞—Ñ—Ä–∏–∫–∞': 'üáøüá¶ –Æ–ê–†',
    '–∞–ª–±–∞–Ω–∏—è': 'üá¶üá± –ê–ª–±–∞–Ω–∏—è',
    '–±–æ—Å–Ω–∏—è': 'üáßüá¶ –ë–æ—Å–Ω–∏—è', '–±–æ—Å–Ω–∏—è –∏ –≥–µ—Ä—Ü–µ–≥–æ–≤–∏–Ω–∞': 'üáßüá¶ –ë–æ—Å–Ω–∏—è',
    '–∫–∏–ø—Ä': 'üá®üáæ –ö–∏–ø—Ä',
    '–º–∞–∫–µ–¥–æ–Ω–∏—è': 'üá≤üá∞ –°–µ–≤–µ—Ä–Ω–∞—è –ú–∞–∫–µ–¥–æ–Ω–∏—è', '—Å–µ–≤–µ—Ä–Ω–∞—è –º–∞–∫–µ–¥–æ–Ω–∏—è': 'üá≤üá∞ –°–µ–≤–µ—Ä–Ω–∞—è –ú–∞–∫–µ–¥–æ–Ω–∏—è',
    '–º–∞—Ä–æ–∫–∫–æ': 'üá≤üá¶ –ú–∞—Ä–æ–∫–∫–æ',
    '–∞–ª–∂–∏—Ä': 'üá©üáø –ê–ª–∂–∏—Ä',
    '—Ç—É–Ω–∏—Å': 'üáπüá≥ –¢—É–Ω–∏—Å',
    '–Ω–∏–≥–µ—Ä–∏—è': 'üá≥üá¨ –ù–∏–≥–µ—Ä–∏—è',
    '–∫–µ–Ω–∏—è': 'üá∞üá™ –ö–µ–Ω–∏—è',
    '—ç—Ñ–∏–æ–ø–∏—è': 'üá™üáπ –≠—Ñ–∏–æ–ø–∏—è',
    '–≥–∞–Ω–∞': 'üá¨üá≠ –ì–∞–Ω–∞',
    '—Ç–∞–Ω–∑–∞–Ω–∏—è': 'üáπüáø –¢–∞–Ω–∑–∞–Ω–∏—è',
    '—É–≥–∞–Ω–¥–∞': 'üá∫üá¨ –£–≥–∞–Ω–¥–∞',
    '–∫–∞–º–µ—Ä—É–Ω': 'üá®üá≤ –ö–∞–º–µ—Ä—É–Ω',
    '–∫–æ—Ç-–¥\'–∏–≤—É–∞—Ä': 'üá®üáÆ –ö–æ—Ç-–¥\'–ò–≤—É–∞—Ä',
    '—Å–µ–Ω–µ–≥–∞–ª': 'üá∏üá≥ –°–µ–Ω–µ–≥–∞–ª',
    '–∞—Ä–≥–µ–Ω—Ç–∏–Ω–∞': 'üá¶üá∑ –ê—Ä–≥–µ–Ω—Ç–∏–Ω–∞',
    '–∫–æ–ª—É–º–±–∏—è': 'üá®üá¥ –ö–æ–ª—É–º–±–∏—è',
    '—á–∏–ª–∏': 'üá®üá± –ß–∏–ª–∏',
    '–ø–µ—Ä—É': 'üáµüá™ –ü–µ—Ä—É',
    '–≤–µ–Ω–µ—Å—É—ç–ª–∞': 'üáªüá™ –í–µ–Ω–µ—Å—É—ç–ª–∞',
    '—ç–∫–≤–∞–¥–æ—Ä': 'üá™üá® –≠–∫–≤–∞–¥–æ—Ä',
    '–±–æ–ª–∏–≤–∏—è': 'üáßüá¥ –ë–æ–ª–∏–≤–∏—è',
    '–ø–∞—Ä–∞–≥–≤–∞–π': 'üáµüáæ –ü–∞—Ä–∞–≥–≤–∞–π',
    '—É—Ä—É–≥–≤–∞–π': 'üá∫üáæ –£—Ä—É–≥–≤–∞–π',
    '–∫—É–±–∞': 'üá®üá∫ –ö—É–±–∞',
    '–¥–æ–º–∏–Ω–∏–∫–∞–Ω–∞': 'üá©üá¥ –î–æ–º–∏–Ω–∏–∫–∞–Ω–∞',
    '–ø—É—ç—Ä—Ç–æ-—Ä–∏–∫–æ': 'üáµüá∑ –ü—É—ç—Ä—Ç–æ-–†–∏–∫–æ',
    '–ø–∞–Ω–∞–º–∞': 'üáµüá¶ –ü–∞–Ω–∞–º–∞',
    '–∫–æ—Å—Ç–∞-—Ä–∏–∫–∞': 'üá®üá∑ –ö–æ—Å—Ç–∞-–†–∏–∫–∞',
    '–ø–∞–∫–∏—Å—Ç–∞–Ω': 'üáµüá∞ –ü–∞–∫–∏—Å—Ç–∞–Ω',
    '–±–∞–Ω–≥–ª–∞–¥–µ—à': 'üáßüá© –ë–∞–Ω–≥–ª–∞–¥–µ—à',
    '–∏–Ω–¥–æ–Ω–µ–∑–∏—è': 'üáÆüá© –ò–Ω–¥–æ–Ω–µ–∑–∏—è',
    '—Ñ–∏–ª–∏–ø–ø–∏–Ω—ã': 'üáµüá≠ –§–∏–ª–∏–ø–ø–∏–Ω—ã',
    '–≤—å–µ—Ç–Ω–∞–º': 'üáªüá≥ –í—å–µ—Ç–Ω–∞–º',
    '–º–∞–ª–∞–π–∑–∏—è': 'üá≤üáæ –ú–∞–ª–∞–π–∑–∏—è',
    '—Å–∏–Ω–≥–∞–ø—É—Ä': 'üá∏üá¨ –°–∏–Ω–≥–∞–ø—É—Ä',
    '–º—å—è–Ω–º–∞': 'üá≤üá≤ –ú—å—è–Ω–º–∞',
    '—à—Ä–∏-–ª–∞–Ω–∫–∞': 'üá±üá∞ –®—Ä–∏-–õ–∞–Ω–∫–∞',
    '–Ω–µ–ø–∞–ª': 'üá≥üáµ –ù–µ–ø–∞–ª',
    '–∞—Ñ–≥–∞–Ω–∏—Å—Ç–∞–Ω': 'üá¶üá´ –ê—Ñ–≥–∞–Ω–∏—Å—Ç–∞–Ω',
    '–∏—Ä–∞–Ω': 'üáÆüá∑ –ò—Ä–∞–Ω',
    '–∏—Ä–∞–∫': 'üáÆüá∂ –ò—Ä–∞–∫',
    '—Å–∞—É–¥–æ–≤—Å–∫–∞—è –∞—Ä–∞–≤–∏—è': 'üá∏üá¶ –°–∞—É–¥–æ–≤—Å–∫–∞—è –ê—Ä–∞–≤–∏—è',
    '–∫–∞—Ç–∞—Ä': 'üá∂üá¶ –ö–∞—Ç–∞—Ä',
    '–∫—É–≤–µ–π—Ç': 'üá∞üáº –ö—É–≤–µ–π—Ç',
    '–æ–º–∞–Ω': 'üá¥üá≤ –û–º–∞–Ω',
    '–±–∞—Ö—Ä–µ–π–Ω': 'üáßüá≠ –ë–∞—Ö—Ä–µ–π–Ω',
    '–∏–æ—Ä–¥–∞–Ω–∏—è': 'üáØüá¥ –ò–æ—Ä–¥–∞–Ω–∏—è',
    '–ª–∏–≤–∞–Ω': 'üá±üáß –õ–∏–≤–∞–Ω',
    '—Å–∏—Ä–∏—è': 'üá∏üáæ –°–∏—Ä–∏—è',
    '–π–µ–º–µ–Ω': 'üáæüá™ –ô–µ–º–µ–Ω',
    '–ø–∞–ª–µ—Å—Ç–∏–Ω–∞': 'üáµüá∏ –ü–∞–ª–µ—Å—Ç–∏–Ω–∞',
    '–Ω–æ–≤–∞—è –∑–µ–ª–∞–Ω–¥–∏—è': 'üá≥üáø –ù–æ–≤–∞—è –ó–µ–ª–∞–Ω–¥–∏—è',
    '—Ñ–∏–¥–∂–∏': 'üá´üáØ –§–∏–¥–∂–∏',
    '–ø–∞–ø—É–∞-–Ω–æ–≤–∞—è –≥–≤–∏–Ω–µ—è': 'üáµüá¨ –ü–∞–ø—É–∞-–ù–æ–≤–∞—è –ì–≤–∏–Ω–µ—è',
    '—è–º–∞–π–∫–∞': 'üáØüá≤ –Ø–º–∞–π–∫–∞',
    '–≥–∞–∏—Ç–∏': 'üá≠üáπ –ì–∞–∏—Ç–∏',
    '—Ç—Ä–∏–Ω–∏–¥–∞–¥ –∏ —Ç–æ–±–∞–≥–æ': 'üáπüáπ –¢—Ä–∏–Ω–∏–¥–∞–¥ –∏ –¢–æ–±–∞–≥–æ',
    '–±–∞–≥–∞–º—ã': 'üáßüá∏ –ë–∞–≥–∞–º—ã',
    '–±–∞—Ä–±–∞–¥–æ—Å': 'üáßüáß –ë–∞—Ä–±–∞–¥–æ—Å',
    '–º–æ–Ω–≥–æ–ª–∏—è': 'üá≤üá≥ –ú–æ–Ω–≥–æ–ª–∏—è',
    '–ª–∞–æ—Å': 'üá±üá¶ –õ–∞–æ—Å',
    '–∫–∞–º–±–æ–¥–∂–∞': 'üá∞üá≠ –ö–∞–º–±–æ–¥–∂–∞',
    '–±—Ä—É–Ω–µ–π': 'üáßüá≥ –ë—Ä—É–Ω–µ–π',
    '–≤–æ—Å—Ç–æ—á–Ω—ã–π —Ç–∏–º–æ—Ä': 'üáπüá± –í–æ—Å—Ç–æ—á–Ω—ã–π –¢–∏–º–æ—Ä',
    '–º–∞–¥–∞–≥–∞—Å–∫–∞—Ä': 'üá≤üá¨ –ú–∞–¥–∞–≥–∞—Å–∫–∞—Ä',
    '–º–æ–∑–∞–º–±–∏–∫': 'üá≤üáø –ú–æ–∑–∞–º–±–∏–∫',
    '–∑–∏–º–±–∞–±–≤–µ': 'üáøüáº –ó–∏–º–±–∞–±–≤–µ',
    '–∑–∞–º–±–∏—è': 'üáøüá≤ –ó–∞–º–±–∏—è',
    '–±–æ—Ç—Å–≤–∞–Ω–∞': 'üáßüáº –ë–æ—Ç—Å–≤–∞–Ω–∞',
    '–Ω–∞–º–∏–±–∏—è': 'üá≥üá¶ –ù–∞–º–∏–±–∏—è',
    '–∞–Ω–≥–æ–ª–∞': 'üá¶üá¥ –ê–Ω–≥–æ–ª–∞',
    '–∫–æ–Ω–≥–æ': 'üá®üá¨ –ö–æ–Ω–≥–æ',
    '–¥—Ä –∫–æ–Ω–≥–æ': 'üá®üá© –î–† –ö–æ–Ω–≥–æ',
    '—Ä—É–∞–Ω–¥–∞': 'üá∑üáº –†—É–∞–Ω–¥–∞',
    '–±—É—Ä—É–Ω–¥–∏': 'üáßüáÆ –ë—É—Ä—É–Ω–¥–∏',
    '—Å–æ–º–∞–ª–∏': 'üá∏üá¥ –°–æ–º–∞–ª–∏',
    '—Å—É–¥–∞–Ω': 'üá∏üá© –°—É–¥–∞–Ω',
    '—é–∂–Ω—ã–π —Å—É–¥–∞–Ω': 'üá∏üá∏ –Æ–∂–Ω—ã–π –°—É–¥–∞–Ω',
    '–ª–∏–≤–∏—è': 'üá±üáæ –õ–∏–≤–∏—è',
    '–º–∞–≤—Ä–∏–∫–∏–π': 'üá≤üá∫ –ú–∞–≤—Ä–∏–∫–∏–π',
    '—Å–µ–π—à–µ–ª—ã': 'üá∏üá® –°–µ–π—à–µ–ª—ã',
    '–∫–æ–º–æ—Ä—ã': 'üá∞üá≤ –ö–æ–º–æ—Ä—ã',
    '–¥–∂–∏–±—É—Ç–∏': 'üá©üáØ –î–∂–∏–±—É—Ç–∏',
    '—ç—Ä–∏—Ç—Ä–µ—è': 'üá™üá∑ –≠—Ä–∏—Ç—Ä–µ—è',
    '–≥–∞–±–æ–Ω': 'üá¨üá¶ –ì–∞–±–æ–Ω',
    '—ç–∫–≤–∞—Ç–æ—Ä–∏–∞–ª—å–Ω–∞—è –≥–≤–∏–Ω–µ—è': 'üá¨üá∂ –≠–∫–≤–∞—Ç–æ—Ä–∏–∞–ª—å–Ω–∞—è –ì–≤–∏–Ω–µ—è',
    '—á–∞–¥': 'üáπüá© –ß–∞–¥',
    '–Ω–∏–≥–µ—Ä': 'üá≥üá™ –ù–∏–≥–µ—Ä',
    '–º–∞–ª–∏': 'üá≤üá± –ú–∞–ª–∏',
    '–±—É—Ä–∫–∏–Ω–∞-—Ñ–∞—Å–æ': 'üáßüá´ –ë—É—Ä–∫–∏–Ω–∞-–§–∞—Å–æ',
    '–±–µ–Ω–∏–Ω': 'üáßüáØ –ë–µ–Ω–∏–Ω',
    '—Ç–æ–≥–æ': 'üáπüá¨ –¢–æ–≥–æ',
    '—Å—å–µ—Ä—Ä–∞-–ª–µ–æ–Ω–µ': 'üá∏üá± –°—å–µ—Ä—Ä–∞-–õ–µ–æ–Ω–µ',
    '–ª–∏–±–µ—Ä–∏—è': 'üá±üá∑ –õ–∏–±–µ—Ä–∏—è',
    '–≥–≤–∏–Ω–µ—è': 'üá¨üá≥ –ì–≤–∏–Ω–µ—è',
    '–≥–≤–∏–Ω–µ—è-–±–∏—Å–∞—É': 'üá¨üáº –ì–≤–∏–Ω–µ—è-–ë–∏—Å–∞—É',
    '–≥–∞–º–±–∏—è': 'üá¨üá≤ –ì–∞–º–±–∏—è',
    '–∫–∞–±–æ-–≤–µ—Ä–¥–µ': 'üá®üáª –ö–∞–±–æ-–í–µ—Ä–¥–µ',
    '—Å–∞–Ω-—Ç–æ–º–µ –∏ –ø—Ä–∏–Ω—Å–∏–ø–∏': 'üá∏üá∏ –°–∞–Ω-–¢–æ–º–µ –∏ –ü—Ä–∏–Ω—Å–∏–ø–∏',
    '–º–∞–≤—Ä–∏—Ç–∞–Ω–∏—è': 'üá≤üá∑ –ú–∞–≤—Ä–∏—Ç–∞–Ω–∏—è'
};

// –û–±—ä–µ–¥–∏–Ω—è–µ–º –æ–±–µ –∫–∞—Ä—Ç—ã
Object.assign(countryNormalizationMap, russianVariants);

// ===================== –§–£–ù–ö–¶–ò–Ø –û–ß–ò–°–¢–ö–ò ABOUT –û–¢ –°–°–´–õ–û–ö =====================
const replaceSitesInAbout = (aboutText) => {
    if (!aboutText || typeof aboutText !== 'string') return aboutText;
    
    const siteRegex = /[a-zA-Z0-9-]+\.\s*[a-zA-Z]{2,}/g;
    const cleanedAbout = aboutText.replace(siteRegex, 'http://t.me/magicboss_bot/magic');
    
    return cleanedAbout;
};

// ===================== –ì–õ–û–ë–ê–õ–¨–ù–´–ô –ö–≠–® (–û–ë–©–ò–ô –î–õ–Ø –í–°–ï–• –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–ï–ô) =====================
// –ì–õ–û–ë–ê–õ–¨–ù–´–ô –§–õ–ê–ì: –∫—ç—à —É–∂–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω –¥–ª—è –≤—Å–µ–≥–æ –±–æ—Ç–∞

let globalFullCacheLoading = false;
let globalDemoCacheLoading = false;

// –ì–õ–û–ë–ê–õ–¨–ù–´–ô –ö–≠–® –ü–†–û–§–ò–õ–ï–ô (–æ–¥–∏–Ω –Ω–∞ –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π)
const globalProfilesCache = new NodeCache({ 
    stdTTL: SCALING_CONFIG.CACHE.PROFILES_TTL,
    checkperiod: SCALING_CONFIG.CACHE.CHECKPERIOD,
    useClones: false,
    maxKeys: 100000
});

// –ì–õ–û–ë–ê–õ–¨–ù–´–ô –î–ï–ú–û-–ö–≠–® (–æ–¥–∏–Ω –Ω–∞ –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π)
const globalDemoCache = new NodeCache({
    stdTTL: SCALING_CONFIG.CACHE.PROFILES_TTL,
    checkperiod: SCALING_CONFIG.CACHE.CHECKPERIOD,
    maxKeys: 50000
});

// –ö–≠–® –î–õ–Ø –§–ò–õ–¨–¢–†–û–í (–æ–±—â–∏–π –¥–ª—è –≤—Å–µ—Ö)
const globalFilterCache = new NodeCache({
    stdTTL: SCALING_CONFIG.CACHE.FILTERS_TTL,
    checkperiod: SCALING_CONFIG.CACHE.CHECKPERIOD,
    maxKeys: SCALING_CONFIG.CACHE.MAX_FILTER_KEYS
});
// üîÑ –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–ê–Ø –ó–ê–ì–†–£–ó–ö–ê –ö–≠–®–ê –° –î–ò–°–ö–ê –ü–†–ò –°–¢–ê–†–¢–ï
console.log('üöÄ –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –∫—ç—à–∞ –Ω–∞ –¥–∏—Å–∫–µ...');
setTimeout(async () => {
    try {
        const loaded = await diskCache.loadFromDisk(
            globalProfilesCache,
            globalDemoCache, 
            globalFilterCache
        );
        
        if (loaded) {
            globalCacheInitialized = true;
            console.log('‚úÖ –ë–æ—Ç –∑–∞–ø—É—â–µ–Ω —Å –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–º –∫—ç—à–µ–º');
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –∑–∞–≥—Ä—É–∑–∏–ª–æ—Å—å
            const demoProfiles = cacheManager.getGlobalProfiles(true);
            const fullProfiles = cacheManager.getGlobalProfiles(false);
            console.log(`üìä –ó–∞–≥—Ä—É–∂–µ–Ω–æ: ${demoProfiles?.length || 0} –¥–µ–º–æ-–ø—Ä–æ—Ñ–∏–ª–µ–π, ${fullProfiles?.length || 0} –ø–æ–ª–Ω—ã—Ö –ø—Ä–æ—Ñ–∏–ª–µ–π`);
        } else {
            console.log('üì≠ –ö—ç—à –Ω–∞ –¥–∏—Å–∫–µ –Ω–µ –Ω–∞–π–¥–µ–Ω –∏–ª–∏ —É—Å—Ç–∞—Ä–µ–ª, –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–∞–ø—Ä–æ—Å–µ');
        }
    } catch (error) {
        console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫—ç—à–∞ —Å –¥–∏—Å–∫–∞:', error);
    }
}, 3000); // –î–∞–µ–º –±–æ—Ç—É 3 —Å–µ–∫—É–Ω–¥—ã –Ω–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é
// –ö–≠–® –î–õ–Ø –ü–û–î–ü–ò–°–û–ö (–∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–π –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è)
const subscriptionCache = new NodeCache({
    stdTTL: SCALING_CONFIG.CACHE.SUBSCRIPTION_TTL,
    checkperiod: 600
});

// –ö–≠–® –î–õ–Ø –ö–ê–ù–ê–õ–ê (–∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–π –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è)
const channelSubscriptionCache = new NodeCache({
    stdTTL: SCALING_CONFIG.CACHE.CHANNEL_TTL,
    checkperiod: 60
});

// –ö–≠–® –°–¢–ê–¢–£–°–ê –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–ï–ô (–∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–π)
const userCacheStatus = new NodeCache({
    stdTTL: SCALING_CONFIG.CACHE.SESSIONS_TTL,
    checkperiod: SCALING_CONFIG.CACHE.CHECKPERIOD
});

// ===================== –°–ò–°–¢–ï–ú–ê –ú–û–ù–ò–¢–û–†–ò–ù–ì–ê –ß–¢–ï–ù–ò–ô =====================
const readingStats = {
    totalReads: 0,
    operations: { 
        profiles: 0, 
        subscriptions: 0, 
        channelSubscriptions: 0,
        countries: 0,
        cities: 0,
        other: 0, 
        cacheHits: 0, 
        cacheMisses: 0,
        firestoreReads: 0
    },
    timestamps: [],
    users: new Map(),
    
    addRead(operationType = 'other', userId = null, count = 1, source = 'firestore') {
        this.totalReads += count;
        this.operations[operationType] = (this.operations[operationType] || 0) + count;
        
        if (source === 'firestore') {
            this.operations.firestoreReads = (this.operations.firestoreReads || 0) + count;
        }
        
        this.timestamps.push({ 
            time: Date.now(), 
            type: operationType, 
            count, 
            userId,
            source 
        });
        
        if (this.timestamps.length > 1000) {
            this.timestamps = this.timestamps.slice(-500);
        }
        
        if (userId) {
            if (!this.users.has(userId)) {
                this.users.set(userId, { total: 0, operations: {} });
            }
            const userStats = this.users.get(userId);
            userStats.total += count;
            userStats.operations[operationType] = (userStats.operations[operationType] || 0) + count;
        }
        
        console.log(`üìñ [READ] ${operationType}: +${count} | Source: ${source} | Total: ${this.totalReads}`);
    },
    
    addCacheHit() { this.operations.cacheHits = (this.operations.cacheHits || 0) + 1; },
    addCacheMiss() { this.operations.cacheMisses = (this.operations.cacheMisses || 0) + 1; },
    
    getStats() {
        const cacheEfficiency = this.operations.cacheHits + this.operations.cacheMisses > 0 
            ? (this.operations.cacheHits / (this.operations.cacheHits + this.operations.cacheMisses)) * 100 
            : 0;
            
        return {
            totalReads: this.totalReads,
            operations: this.operations,
            uniqueUsers: this.users.size,
            readsPerUser: this.users.size > 0 ? this.totalReads / this.users.size : 0,
            cacheEfficiency: `${cacheEfficiency.toFixed(2)}%`,
            firestoreReads: this.operations.firestoreReads || 0,
            timeline: this.timestamps.slice(-100)
        };
    },
    
    resetStats() {
        this.totalReads = 0;
        this.operations = { 
            profiles: 0, 
            subscriptions: 0, 
            channelSubscriptions: 0,
            countries: 0,
            cities: 0,
            other: 0, 
            cacheHits: 0, 
            cacheMisses: 0,
            firestoreReads: 0 
        };
        this.timestamps = [];
        this.users.clear();
    }
};

// ===================== –û–ü–¢–ò–ú–ò–ó–ò–†–û–í–ê–ù–ù–´–ô –ì–õ–û–ë–ê–õ–¨–ù–´–ô –ö–≠–®-–ú–ï–ù–ï–î–ñ–ï–† =====================
const cacheManager = {
    // ===================== –ì–õ–û–ë–ê–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò –ö–≠–®–ê =====================
    
   // 1. –ó–ê–ì–†–£–ó–ö–ê –ì–õ–û–ë–ê–õ–¨–ù–û–ì–û –ü–û–õ–ù–û–ì–û –ö–≠–®–ê (–ü–û–õ–ù–û–°–¢–¨–Æ –ü–ï–†–ï–ü–ò–°–ê–ù–ê)
async loadGlobalFullCache(db) {
    if (globalFullCacheLoading) {
        console.log('‚è≥ [GLOBAL FULL CACHE] –£–∂–µ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è...');
        return false;
    }
    
    globalFullCacheLoading = true;
    console.log('üöÄ [GLOBAL FULL CACHE] –ù–ê–ß–ò–ù–ê–ï–ú –ó–ê–ì–†–£–ó–ö–£ –ü–û–õ–ù–û–ì–û –ö–≠–®–ê');
    console.log('='.repeat(60));
    
    const globalStartTime = Date.now();
    let allProfiles = [];
    let totalLoaded = 0;
    
    try {
        // ==================== –≠–¢–ê–ü 1: –ó–ê–ì–†–£–ó–ö–ê –ü–†–û–§–ò–õ–ï–ô ====================
        console.log('üì• –≠–¢–ê–ü 1: –ó–ê–ì–†–£–ó–ö–ê –ü–†–û–§–ò–õ–ï–ô –ò–ó FIRESTORE');
        console.log('-'.repeat(40));
        
        let lastDoc = null;
        let batchCount = 0;
        const BATCH_SIZE = 5000;
        const MAX_PROFILES = 70000;
        const firestoreStartTime = Date.now();
        
        while (totalLoaded < MAX_PROFILES) {
            batchCount++;
            console.log(`üì¶ [–ü–ê–ß–ö–ê ${batchCount}] –ó–∞–≥—Ä—É–∑–∫–∞ ${BATCH_SIZE} –∞–Ω–∫–µ—Ç...`);
            
            // –°—Ç—Ä–æ–∏–º –∑–∞–ø—Ä–æ—Å
            let query = db.collection("profiles")
                .orderBy("createdAt", "desc")
                .limit(BATCH_SIZE)
                .select(
                    "id", 
                    "name", 
                    "age", 
                    "country", 
                    "city", 
                    "about", 
                    "photoUrl", 
                    "telegram", 
                    "phone", 
                    "whatsapp", 
                    "photos", 
                    "createdAt"
                );
            
            if (lastDoc) {
                query = query.startAfter(lastDoc);
            }
            
            // –í—ã–ø–æ–ª–Ω—è–µ–º –∑–∞–ø—Ä–æ—Å
            const snapshot = await query.get();
            const docsCount = snapshot.docs.length;
            
            // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —á—Ç–µ–Ω–∏–π
            readingStats.addRead('profiles', 'system', docsCount, 'firestore');
            
            // –ï—Å–ª–∏ –±–æ–ª—å—à–µ –Ω–µ—Ç –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
            if (docsCount === 0) {
                console.log(`‚úÖ [–ó–ê–í–ï–†–®–ï–ù–û] –ë–æ–ª—å—à–µ –∞–Ω–∫–µ—Ç –Ω–µ—Ç`);
                break;
            }
            
            // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –¥–æ–∫—É–º–µ–Ω—Ç—ã
            const batchProfiles = snapshot.docs.map(doc => ({
                id: doc.id,
                ...doc.data()
            }));
            
            // –î–æ–±–∞–≤–ª—è–µ–º –∫ –æ–±—â–µ–º—É –º–∞—Å—Å–∏–≤—É
            allProfiles.push(...batchProfiles);
            totalLoaded += docsCount;
            lastDoc = snapshot.docs[docsCount - 1];
            
            console.log(`üìä [–ü–ê–ß–ö–ê ${batchCount}] –ó–∞–≥—Ä—É–∂–µ–Ω–æ: ${docsCount} –∞–Ω–∫–µ—Ç | –í—Å–µ–≥–æ: ${totalLoaded}`);
            
            // –ü–∞—É–∑–∞ –º–µ–∂–¥—É –ø–∞—á–∫–∞–º–∏ –¥–ª—è —Å–Ω–∏–∂–µ–Ω–∏—è –Ω–∞–≥—Ä—É–∑–∫–∏
            if (docsCount === BATCH_SIZE) {
                await new Promise(resolve => setTimeout(resolve, 100));
            }
            
            // –ü—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–π –æ—Ç—á–µ—Ç –∫–∞–∂–¥—ã–µ 20,000 –ø—Ä–æ—Ñ–∏–ª–µ–π
            if (totalLoaded % 20000 === 0) {
                const currentTime = Date.now();
                const elapsed = (currentTime - firestoreStartTime) / 1000;
                const speed = (totalLoaded / elapsed).toFixed(1);
                console.log(`üìà [–ü–†–û–ì–†–ï–°–°] ${totalLoaded} –∞–Ω–∫–µ—Ç –∑–∞ ${elapsed.toFixed(1)}—Å (${speed} –∞–Ω–∫–µ—Ç/—Å–µ–∫)`);
            }
        }
        
        const firestoreTime = Date.now() - firestoreStartTime;
        console.log(`‚úÖ –≠–¢–ê–ü 1 –ó–ê–í–ï–†–®–ï–ù: ${totalLoaded} –∞–Ω–∫–µ—Ç –∑–∞ ${(firestoreTime/1000).toFixed(1)}—Å`);
        console.log('-'.repeat(40));
        
        // ==================== –≠–¢–ê–ü 2: –ü–û–î–ì–û–¢–û–í–ö–ê –î–ê–ù–ù–´–• ====================
        console.log('üîÑ –≠–¢–ê–ü 2: –ü–û–î–ì–û–¢–û–í–ö–ê –î–ê–ù–ù–´–• –î–õ–Ø –ö–≠–®–ò–†–û–í–ê–ù–ò–Ø');
        console.log('-'.repeat(40));
        
        const processStartTime = Date.now();
        
        // –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º –ø—Ä–æ—Ñ–∏–ª–∏ –¥–ª—è —ç–∫–æ–Ω–æ–º–∏–∏ –ø–∞–º—è—Ç–∏
        console.log(`üîß –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è ${allProfiles.length} –ø—Ä–æ—Ñ–∏–ª–µ–π...`);
        
        const normalizedProfiles = new Array(allProfiles.length);
        const countriesSet = new Set();
        const citiesByCountry = new Map();
        let profilesWithCountry = 0;
        let profilesWithCity = 0;
        
        for (let i = 0; i < allProfiles.length; i++) {
            const profile = allProfiles[i];
            
            // –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º —Å—Ç—Ä–∞–Ω—É
            let normalizedCountry = null;
            if (profile.country) {
                normalizedCountry = this.normalizeCountryName(profile.country);
                countriesSet.add(normalizedCountry);
                profilesWithCountry++;
            }
            
            // –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º –≥–æ—Ä–æ–¥
            let normalizedCity = null;
            if (profile.city) {
                normalizedCity = this.normalizeCityName(profile.city);
                profilesWithCity++;
                
                // –î–æ–±–∞–≤–ª—è–µ–º –≥–æ—Ä–æ–¥ –≤ –∏–Ω–¥–µ–∫—Å –ø–æ —Å—Ç—Ä–∞–Ω–µ
                if (normalizedCountry) {
                    if (!citiesByCountry.has(normalizedCountry)) {
                        citiesByCountry.set(normalizedCountry, new Set());
                    }
                    citiesByCountry.get(normalizedCountry).add(normalizedCity);
                }
            }
            
            // –°–æ–∑–¥–∞–µ–º –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π –ø—Ä–æ—Ñ–∏–ª—å
            normalizedProfiles[i] = {
                id: profile.id,
                n: profile.name || '',
                a: profile.age || 0,
                c: normalizedCountry,
                ct: normalizedCity,
                ab: profile.about ? profile.about.substring(0, 500) : "",
                p: profile.photoUrl || '',
                phs: profile.photos || [],
                tg: profile.telegram || '',
                tel: profile.phone || '',
                wa: profile.whatsapp || '',
                ca: profile.createdAt || null,
                isDemo: false
            };
            
            // –ü—Ä–æ–≥—Ä–µ—Å—Å –∫–∞–∂–¥—ã–µ 10,000 –ø—Ä–æ—Ñ–∏–ª–µ–π
            if (i % 10000 === 0 && i > 0) {
                console.log(`üìä –û–±—Ä–∞–±–æ—Ç–∞–Ω–æ ${i}/${allProfiles.length} –ø—Ä–æ—Ñ–∏–ª–µ–π`);
            }
        }
        
        // –û—á–∏—â–∞–µ–º –∏—Å—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è —ç–∫–æ–Ω–æ–º–∏–∏ –ø–∞–º—è—Ç–∏
        allProfiles.length = 0;
        allProfiles = null;
        
        const processTime = Date.now() - processStartTime;
        console.log(`‚úÖ –≠–¢–ê–ü 2 –ó–ê–í–ï–†–®–ï–ù –∑–∞ ${(processTime/1000).toFixed(1)}—Å`);
        console.log(`üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞: ${profilesWithCountry} —Å —É–∫–∞–∑–∞–Ω–Ω–æ–π —Å—Ç—Ä–∞–Ω–æ–π, ${profilesWithCity} —Å —É–∫–∞–∑–∞–Ω–Ω—ã–º –≥–æ—Ä–æ–¥–æ–º`);
        console.log('-'.repeat(40));
        
        // ==================== –≠–¢–ê–ü 3: –ö–≠–®–ò–†–û–í–ê–ù–ò–ï –ü–†–û–§–ò–õ–ï–ô ====================
        console.log('üíæ –≠–¢–ê–ü 3: –ö–≠–®–ò–†–û–í–ê–ù–ò–ï –ü–†–û–§–ò–õ–ï–ô');
        console.log('-'.repeat(40));
        
        const cacheStartTime = Date.now();
        
        console.log(`üîß –°–∂–∞—Ç–∏–µ –¥–∞–Ω–Ω—ã—Ö (${normalizedProfiles.length} –ø—Ä–æ—Ñ–∏–ª–µ–π)...`);
        
        // –°–∂–∏–º–∞–µ–º –¥–∞–Ω–Ω—ã–µ
        const jsonString = JSON.stringify(normalizedProfiles);
        const compressed = zlib.gzipSync(jsonString);
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –≥–ª–æ–±–∞–ª—å–Ω—ã–π –∫—ç—à
        globalProfilesCache.set("profiles:all", compressed);
        
        const originalSizeMB = (jsonString.length / 1024 / 1024).toFixed(2);
        const compressedSizeMB = (compressed.length / 1024 / 1024).toFixed(2);
        const compressionRatio = Math.round((1 - compressed.length/jsonString.length) * 100);
        
        console.log(`üì¶ –†–∞–∑–º–µ—Ä –¥–∞–Ω–Ω—ã—Ö: ${originalSizeMB}MB ‚Üí ${compressedSizeMB}MB`);
        console.log(`‚ö° –≠–∫–æ–Ω–æ–º–∏—è: ${compressionRatio}% (—Å–∂–∞—Ç–æ –≤ ${(originalSizeMB/compressedSizeMB).toFixed(1)} —Ä–∞–∑)`);
        
        const cacheTime = Date.now() - cacheStartTime;
        console.log(`‚úÖ –≠–¢–ê–ü 3 –ó–ê–í–ï–†–®–ï–ù –∑–∞ ${cacheTime}–º—Å`);
        console.log('-'.repeat(40));
        
        // ==================== –≠–¢–ê–ü 4: –°–û–ó–î–ê–ù–ò–ï –ò–ù–î–ï–ö–°–û–í ====================
        console.log('üìá –≠–¢–ê–ü 4: –°–û–ó–î–ê–ù–ò–ï –ò–ù–î–ï–ö–°–û–í –î–õ–Ø –ë–´–°–¢–†–û–ì–û –ü–û–ò–°–ö–ê');
        console.log('-'.repeat(40));
        
        const indexStartTime = Date.now();
        
        // –°–æ–∑–¥–∞–µ–º –∏–Ω–¥–µ–∫—Å—ã —á–µ—Ä–µ–∑ AsyncFilterManager
        console.log(`üî® –°–æ–∑–¥–∞–µ–º –∏–Ω–¥–µ–∫—Å—ã –¥–ª—è ${normalizedProfiles.length} –ø—Ä–æ—Ñ–∏–ª–µ–π...`);
        const indexResult = asyncFilterManager.createIndexes(normalizedProfiles);
        
        const indexTime = Date.now() - indexStartTime;
        console.log(`‚úÖ –≠–¢–ê–ü 4 –ó–ê–í–ï–†–®–ï–ù –∑–∞ ${indexTime}–º—Å`);
        console.log(`üìä –ò–Ω–¥–µ–∫—Å—ã: ${indexResult.countryIndexSize} —Å—Ç—Ä–∞–Ω, ${indexResult.countryCityIndexSize} –ø–∞—Ä —Å—Ç—Ä–∞–Ω–∞+–≥–æ—Ä–æ–¥`);
        console.log('-'.repeat(40));
        
        // ==================== –≠–¢–ê–ü 5: –°–û–•–†–ê–ù–ï–ù–ò–ï –°–¢–†–ê–ù –ò –ì–û–†–û–î–û–í ====================
        console.log('üåç –≠–¢–ê–ü 5: –°–û–•–†–ê–ù–ï–ù–ò–ï –°–ü–ò–°–ö–û–í –°–¢–†–ê–ù –ò –ì–û–†–û–î–û–í');
        console.log('-'.repeat(40));
        
        const geoStartTime = Date.now();
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫ —Å—Ç—Ä–∞–Ω
        const sortedCountries = Array.from(countriesSet).sort();
        globalProfilesCache.set("profiles:countries", sortedCountries);
        globalProfilesCache.set("profiles:countries_raw", Array.from(countriesSet));
        
        // –°–û–•–†–ê–ù–Ø–ï–ú –ì–û–†–û–î–ê –ü–û –°–¢–†–ê–ù–ê–ú –í –ì–õ–û–ë–ê–õ–¨–ù–´–ô –ö–≠–® - –≠–¢–û –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û!
        console.log(`üó∫Ô∏è –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≥–æ—Ä–æ–¥–æ–≤ –¥–ª—è ${citiesByCountry.size} —Å—Ç—Ä–∞–Ω...`);
        let totalCities = 0;
        citiesByCountry.forEach((citiesSet, country) => {
            const citiesArray = Array.from(citiesSet).sort();
            globalProfilesCache.set(`profiles:cities:${country}`, citiesArray);
            totalCities += citiesArray.length;
            
            // –õ–æ–≥–∏ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
            if (country === "üáßüá¶ –ë–æ—Å–Ω–∏—è" || country === "üá∑üá∫ –†–æ—Å—Å–∏—è") {
                console.log(`   üìç ${country}: ${citiesArray.length} –≥–æ—Ä–æ–¥–æ–≤ (${citiesArray.slice(0, 3).join(', ')})`);
            }
        });
        
        const geoTime = Date.now() - geoStartTime;
        console.log(`‚úÖ –≠–¢–ê–ü 5 –ó–ê–í–ï–†–®–ï–ù –∑–∞ ${geoTime}–º—Å`);
        console.log(`üìä –ì–µ–æ–¥–∞–Ω–Ω—ã–µ: ${countriesSet.size} —Å—Ç—Ä–∞–Ω, ${totalCities} –≥–æ—Ä–æ–¥–æ–≤`);
        console.log('-'.repeat(40));
        
        // ==================== –ò–¢–û–ì–û–í–ê–Ø –°–¢–ê–¢–ò–°–¢–ò–ö–ê ====================
        const totalTime = Date.now() - globalStartTime;
        
        console.log('üéâ ========== –ó–ê–ì–†–£–ó–ö–ê –ö–≠–®–ê –ó–ê–í–ï–†–®–ï–ù–ê ==========');
        console.log(`‚è±Ô∏è  –û–ë–©–ï–ï –í–†–ï–ú–Ø: ${(totalTime/1000).toFixed(1)} —Å–µ–∫—É–Ω–¥`);
        console.log(`üìä –ü–†–û–§–ò–õ–ï–ô: ${normalizedProfiles.length}`);
        console.log(`üåç –°–¢–†–ê–ù: ${countriesSet.size}`);
        console.log(`üèôÔ∏è  –ì–û–†–û–î–û–í: ${totalCities}`);
        console.log(`üì¶ –°–ñ–ê–¢–ò–ï: ${originalSizeMB}MB ‚Üí ${compressedSizeMB}MB (${compressionRatio}%)`);
        console.log(`üìá –ò–ù–î–ï–ö–°–´: ${indexResult.countryIndexSize} —Å—Ç—Ä–∞–Ω + ${indexResult.countryCityIndexSize} –ø–∞—Ä`);
        console.log(`‚ö° –°–ö–û–†–û–°–¢–¨: ${(normalizedProfiles.length/(totalTime/1000)).toFixed(0)} –ø—Ä–æ—Ñ–∏–ª–µ–π/—Å–µ–∫`);
        console.log('='.repeat(60));
        
        // ==================== –û–ß–ò–°–¢–ö–ê –ü–ê–ú–Ø–¢–ò ====================
        console.log('üßπ –û—á–∏—Å—Ç–∫–∞ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö...');
        
        // –û—á–∏—â–∞–µ–º –º–∞—Å—Å–∏–≤—ã –¥–ª—è –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏—è –ø–∞–º—è—Ç–∏
        normalizedProfiles.length = 0;
        countriesSet.clear();
        citiesByCountry.clear();
        
        // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω—ã–π —Å–±–æ—Ä –º—É—Å–æ—Ä–∞ (–µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–µ–Ω)
        if (global.gc) {
            global.gc();
            console.log('‚úÖ –°–±–æ—Ä–∫–∞ –º—É—Å–æ—Ä–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞');
        }
        
        // ==================== –£–í–ï–î–û–ú–õ–ï–ù–ò–ï –û –ì–û–¢–û–í–ù–û–°–¢–ò ====================
        globalCacheInitialized = true;
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–π –∑–∞–≥—Ä—É–∑–∫–∏
        globalProfilesCache.set("last_load_time", Date.now(), 7 * 24 * 60 * 60);
        globalProfilesCache.set("profiles_count", totalLoaded, 7 * 24 * 60 * 60);
        
        console.log(`‚úÖ [GLOBAL FULL CACHE] –ö–≠–® –£–°–ü–ï–®–ù–û –ó–ê–ì–†–£–ñ–ï–ù –ò –ì–û–¢–û–í –ö –†–ê–ë–û–¢–ï!`);
        
        // üíæ –°–†–ê–ó–£ –°–û–•–†–ê–ù–Ø–ï–ú –ù–ê –î–ò–°–ö
        console.log('üíæ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∫—ç—à–∞ –Ω–∞ –¥–∏—Å–∫...');
        try {
            await diskCache.saveAllCaches(
                globalProfilesCache,
                globalDemoCache,
                globalFilterCache
            );
            console.log('‚úÖ –ö—ç—à —Å–æ—Ö—Ä–∞–Ω–µ–Ω –Ω–∞ –¥–∏—Å–∫');
        } catch (saveError) {
            console.error('‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–∞ –¥–∏—Å–∫:', saveError.message);
        }
        
        return true;
        
    } catch (error) {
        console.error('‚ùå ========== –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê –ó–ê–ì–†–£–ó–ö–ò –ö–≠–®–ê ==========');
        console.error(`‚ùå –¢–ò–ü –û–®–ò–ë–ö–ò: ${error.name}`);
        console.error(`‚ùå –°–û–û–ë–©–ï–ù–ò–ï: ${error.message}`);
        console.error(`‚ùå –°–¢–ï–ö –¢–†–ï–ô–°:`);
        console.error(error.stack);
        console.error('='.repeat(60));
        
        return false;
        
    } finally {
        globalFullCacheLoading = false;
        console.log(`üîì [GLOBAL FULL CACHE] –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–Ω—è—Ç–∞`);
        
        // –û—Ç—á–µ—Ç –æ –ø–∞–º—è—Ç–∏
        if (process.memoryUsage) {
            const mem = process.memoryUsage();
            const usedMB = (mem.heapUsed / 1024 / 1024).toFixed(2);
            const totalMB = (mem.heapTotal / 1024 / 1024).toFixed(2);
            console.log(`üíæ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø–∞–º—è—Ç–∏: ${usedMB}MB / ${totalMB}MB`);
        }
    }
},
// 2. –ó–ê–ì–†–£–ó–ö–ê –ì–õ–û–ë–ê–õ–¨–ù–û–ì–û –î–ï–ú–û-–ö–≠–®–ê (–û–ü–¢–ò–ú–ò–ó–ò–†–û–í–ê–ù–ù–ê–Ø –í–ï–†–°–ò–Ø)
async loadGlobalDemoCache(db) {
    // üîí –ë–õ–û–ö–ò–†–û–í–ö–ê: –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—É—é –∑–∞–≥—Ä—É–∑–∫—É
    if (globalDemoCacheLoading) {
        console.log('‚è≥ [GLOBAL DEMO CACHE] –£–∂–µ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è... –æ–∂–∏–¥–∞–µ–º');
        // –ñ–¥–µ–º –¥–æ 30 —Å–µ–∫—É–Ω–¥
        const startWait = Date.now();
        while (globalDemoCacheLoading && Date.now() - startWait < 30000) {
            await new Promise(resolve => setTimeout(resolve, 1000));
        }
        if (globalDemoCacheLoading) {
            console.log('‚ùå [GLOBAL DEMO CACHE] –¢–∞–π–º–∞—É—Ç –æ–∂–∏–¥–∞–Ω–∏—è –∑–∞–≥—Ä—É–∑–∫–∏');
            return false;
        }
    }
    
    globalDemoCacheLoading = true;
    console.log('üöÄ [GLOBAL DEMO CACHE] –ù–ê–ß–ò–ù–ê–ï–ú –ó–ê–ì–†–£–ó–ö–£ –î–ï–ú–û-–ö–≠–®–ê');
    
    const globalStartTime = Date.now();
    let allProfiles = [];
    let totalLoaded = 0;
    
    try {
        // ==================== –≠–¢–ê–ü 1: –ü–†–û–í–ï–†–Ø–ï–ú, –ú–û–ñ–ï–ú –õ–ò –ò–°–ü–û–õ–¨–ó–û–í–ê–¢–¨ –ü–û–õ–ù–´–ô –ö–≠–® ====================
        console.log('üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –ø–æ–ª–Ω–æ–≥–æ –∫—ç—à–∞...');
        const fullProfiles = this.getGlobalProfiles(false);
        
        if (fullProfiles && fullProfiles.length > 0) {
            console.log(`‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ–º —É–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–µ –ø—Ä–æ—Ñ–∏–ª–∏ –∏–∑ –ø–æ–ª–Ω–æ–≥–æ –∫—ç—à–∞: ${fullProfiles.length}`);
            
            // –°–û–ó–î–ê–ï–ú –î–ï–ú–û-–ö–≠–® –ò–ó –ü–û–õ–ù–û–ì–û
            const demoCreated = await this.createDemoCacheFromFullProfiles(fullProfiles);
            
            if (demoCreated) {
                // üíæ –°–û–•–†–ê–ù–Ø–ï–ú –î–ï–ú–û-–ö–≠–® –ù–ê –î–ò–°–ö
                console.log('üíæ –î–µ–º–æ-–∫—ç—à —Å–æ–∑–¥–∞–Ω, —Å–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–∞ –¥–∏—Å–∫...');
                await diskCache.saveAllCaches(
                    globalProfilesCache,
                    globalDemoCache,
                    globalFilterCache
                ).catch(e => console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:', e.message));
                
                const totalTime = Date.now() - globalStartTime;
                console.log(`‚úÖ [GLOBAL DEMO CACHE] –î–µ–º–æ-–∫—ç—à —Å–æ–∑–¥–∞–Ω –∏–∑ –ø–æ–ª–Ω–æ–≥–æ –∑–∞ ${totalTime}–º—Å`);
                
                globalDemoCacheLoading = false;
                return true;
            }
        }
        
        // ==================== –≠–¢–ê–ü 2: –ó–ê–ì–†–£–ó–ö–ê –ò–ó FIRESTORE ====================
        console.log(`üì• –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–µ–º–æ-–ø—Ä–æ—Ñ–∏–ª–∏ –∏–∑ Firestore...`);
        
        let lastDoc = null;
        let batchCount = 0;
        const BATCH_SIZE = 5000;
        const MAX_PROFILES = 70000;
        const firestoreStartTime = Date.now();
        
        while (totalLoaded < MAX_PROFILES) {
            batchCount++;
            console.log(`üì¶ [–ü–ê–ß–ö–ê ${batchCount}] –ó–∞–≥—Ä—É–∑–∫–∞ ${BATCH_SIZE} –∞–Ω–∫–µ—Ç...`);
            
            let query = db.collection("profiles")
                .orderBy("createdAt", "desc")
                .limit(BATCH_SIZE)
                .select(
                    "id", "name", "age", "country", "city", 
                    "about", "photoUrl", "telegram", "phone", 
                    "whatsapp", "photos", "createdAt"
                );
            
            if (lastDoc) {
                query = query.startAfter(lastDoc);
            }
            
            const snapshot = await query.get();
            const docsCount = snapshot.docs.length;
            
            readingStats.addRead('profiles', 'system', docsCount, 'firestore');
            
            if (docsCount === 0) {
                console.log(`‚úÖ –ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞. –í—Å–µ–≥–æ: ${totalLoaded}`);
                break;
            }
            
            const batchProfiles = snapshot.docs.map(doc => ({
                id: doc.id,
                ...doc.data()
            }));
            
            allProfiles.push(...batchProfiles);
            totalLoaded += docsCount;
            lastDoc = snapshot.docs[docsCount - 1];
            
            console.log(`üìä [–ü–ê–ß–ö–ê ${batchCount}] –ó–∞–≥—Ä—É–∂–µ–Ω–æ: ${docsCount} | –í—Å–µ–≥–æ: ${totalLoaded}`);
            
            if (docsCount === BATCH_SIZE) {
                await new Promise(resolve => setTimeout(resolve, 100));
            }
            
            if (totalLoaded % 20000 === 0) {
                const elapsed = (Date.now() - firestoreStartTime) / 1000;
                const speed = (totalLoaded / elapsed).toFixed(1);
                console.log(`üìà [–ü–†–û–ì–†–ï–°–°] ${totalLoaded} –∞–Ω–∫–µ—Ç –∑–∞ ${elapsed.toFixed(1)}—Å (${speed}/—Å–µ–∫)`);
            }
        }
        
        const firestoreTime = Date.now() - firestoreStartTime;
        console.log(`‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ ${totalLoaded} –∞–Ω–∫–µ—Ç –∑–∞ ${(firestoreTime/1000).toFixed(1)}—Å`);
        
        // ==================== –≠–¢–ê–ü 3: –°–û–ó–î–ê–ù–ò–ï –î–ï–ú–û-–ö–≠–®–ê ====================
        console.log('üîß –°–æ–∑–¥–∞–µ–º –¥–µ–º–æ-–∫—ç—à –∏–∑ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö –ø—Ä–æ—Ñ–∏–ª–µ–π...');
        const demoCreated = await this.createDemoCacheFromFullProfiles(allProfiles);
        
        if (!demoCreated) {
            console.log('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –¥–µ–º–æ-–∫—ç—à');
            globalDemoCacheLoading = false;
            return false;
        }
        
        // ==================== –≠–¢–ê–ü 4: –°–û–•–†–ê–ù–ï–ù–ò–ï –ù–ê –î–ò–°–ö ====================
        console.log('üíæ –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–µ–º–æ-–∫—ç—à –Ω–∞ –¥–∏—Å–∫...');
        const saveSuccess = await diskCache.saveAllCaches(
            globalProfilesCache,
            globalDemoCache,
            globalFilterCache
        );
        
        if (!saveSuccess) {
            console.log('‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫—ç—à –Ω–∞ –¥–∏—Å–∫, –Ω–æ –≤ –ø–∞–º—è—Ç–∏ –æ–Ω –µ—Å—Ç—å');
        }
        
        // ==================== –≠–¢–ê–ü 5: –û–ß–ò–°–¢–ö–ê –ü–ê–ú–Ø–¢–ò ====================
        allProfiles.length = 0;
        allProfiles = null;
        
        if (global.gc) {
            global.gc();
            console.log('üßπ –°–±–æ—Ä–∫–∞ –º—É—Å–æ—Ä–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞');
        }
        
        // ==================== –≠–¢–ê–ü 6: –§–ò–ù–ê–õ–ò–ó–ê–¶–ò–Ø ====================
        globalCacheInitialized = true;
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–π –∑–∞–≥—Ä—É–∑–∫–∏
        globalProfilesCache.set("last_load_time", Date.now(), 7 * 24 * 60 * 60);
        globalProfilesCache.set("profiles_count", totalLoaded, 7 * 24 * 60 * 60);
        
        const totalTime = Date.now() - globalStartTime;
        console.log(`‚úÖ [GLOBAL DEMO CACHE] –î–µ–º–æ-–∫—ç—à –∑–∞–≥—Ä—É–∂–µ–Ω –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω –∑–∞ ${(totalTime/1000).toFixed(1)}—Å`);
        
        return true;
        
    } catch (error) {
        console.error('‚ùå ========== –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê –ó–ê–ì–†–£–ó–ö–ò –î–ï–ú–û-–ö–≠–®–ê ==========');
        console.error(`‚ùå –¢–ò–ü –û–®–ò–ë–ö–ò: ${error.name}`);
        console.error(`‚ùå –°–û–û–ë–©–ï–ù–ò–ï: ${error.message}`);
        console.error(error.stack);
        console.error('='.repeat(60));
        
        // –ü—ã—Ç–∞–µ–º—Å—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å
        try {
            console.log('üîÑ –ü–æ–ø—ã—Ç–∫–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è...');
            const demoProfiles = this.getGlobalProfiles(true);
            if (demoProfiles && demoProfiles.length > 0) {
                console.log(`‚úÖ –î–µ–º–æ-–∫—ç—à –¥–æ—Å—Ç—É–ø–µ–Ω –≤ –ø–∞–º—è—Ç–∏: ${demoProfiles.length} –ø—Ä–æ—Ñ–∏–ª–µ–π`);
            }
        } catch (recoveryError) {
            console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–∏:', recoveryError.message);
        }
        
        return false;
        
    } finally {
        globalDemoCacheLoading = false;
        console.log(`üîì [GLOBAL DEMO CACHE] –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–Ω—è—Ç–∞`);
        
        // –û—Ç—á–µ—Ç –æ –ø–∞–º—è—Ç–∏
        if (process.memoryUsage) {
            const mem = process.memoryUsage();
            const usedMB = (mem.heapUsed / 1024 / 1024).toFixed(2);
            console.log(`üíæ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø–∞–º—è—Ç–∏: ${usedMB}MB`);
        }
    }
},
    
 // –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø: –°–û–ó–î–ê–ù–ò–ï –î–ï–ú–û-–ö–≠–®–ê –ò–ó –ü–û–õ–ù–´–• –ü–†–û–§–ò–õ–ï–ô (–ü–û–õ–ù–û–°–¢–¨–Æ –ü–ï–†–ï–ü–ò–°–ê–ù–ê –° –ò–ù–î–ï–ö–°–ê–ú–ò)

 // –í–ê–ñ–ù–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –§–£–ù–ö–¶–ò–Ø –°–û–ó–î–ê–ù–ò–Ø –î–ï–ú–û-–ö–≠–®–ê
async createDemoCacheFromFullProfiles(fullProfiles) {
    try {
        console.log(`üîß [DEMO CREATION] –°–æ–∑–¥–∞–µ–º –¥–µ–º–æ-–∫—ç—à –∏–∑ ${fullProfiles.length} –ø—Ä–æ—Ñ–∏–ª–µ–π...`);
        
        const demoProfiles = [];
        const countriesSet = new Set();
        const citiesByCountry = new Map();
        const cityProfilesMap = new Map(); // –ú–∞–ø–∞ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª–µ–π –ø–æ –≥–æ—Ä–æ–¥–∞–º
        
        console.log(`üë§ [DEMO PROCESSING] –û–±—Ä–∞–±–æ—Ç–∫–∞ ${fullProfiles.length} –ø—Ä–æ—Ñ–∏–ª–µ–π...`);
        
        // üî• –®–ê–ì 1: –ì–†–£–ü–ü–ò–†–£–ï–ú –ü–†–û–§–ò–õ–ò –ü–û –ì–û–†–û–î–ê–ú
        for (let i = 0; i < fullProfiles.length; i++) {
            const profile = fullProfiles[i];
            
            const originalName = profile.n || profile.name || '';
            const originalAge = profile.a || profile.age || 0;
            const originalCountry = profile.c || profile.country || '';
            const originalCity = profile.ct || profile.city || '';
            const originalAbout = profile.ab || profile.about || '';
            const originalPhotoUrl = profile.p || profile.photoUrl || '';
            const originalPhotos = profile.phs || profile.photos || [];
            
            // –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º —Å—Ç—Ä–∞–Ω—É –∏ –≥–æ—Ä–æ–¥
            const normalizedCountry = originalCountry ? 
                this.normalizeCountryName(originalCountry) : '–ù–µ —É–∫–∞–∑–∞–Ω–∞';
            const normalizedCity = originalCity ? 
                this.normalizeCityName(originalCity) : '–ù–µ —É–∫–∞–∑–∞–Ω';
            
            // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –±–µ–∑ —Å—Ç—Ä–∞–Ω—ã –∏–ª–∏ –≥–æ—Ä–æ–¥–∞
            if (normalizedCountry === '–ù–µ —É–∫–∞–∑–∞–Ω–∞' || normalizedCity === '–ù–µ —É–∫–∞–∑–∞–Ω') {
                continue;
            }
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å—Ç—Ä–∞–Ω—ã –∏ –≥–æ—Ä–æ–¥–∞ –¥–ª—è —Å–ø–∏—Å–∫–æ–≤
            if (normalizedCountry && normalizedCountry !== '–ù–µ —É–∫–∞–∑–∞–Ω–∞') {
                countriesSet.add(normalizedCountry);
                
                if (!citiesByCountry.has(normalizedCountry)) {
                    citiesByCountry.set(normalizedCountry, new Set());
                }
                if (normalizedCity && normalizedCity !== '–ù–µ —É–∫–∞–∑–∞–Ω') {
                    citiesByCountry.get(normalizedCountry).add(normalizedCity);
                }
            }
            
            // –°–æ–∑–¥–∞–µ–º –∫–ª—é—á –≥–æ—Ä–æ–¥–∞
            const cityKey = `${normalizedCountry}_${normalizedCity}`;
            
            if (!cityProfilesMap.has(cityKey)) {
                cityProfilesMap.set(cityKey, []);
            }
            
            // –î–æ–±–∞–≤–ª—è–µ–º –ø—Ä–æ—Ñ–∏–ª—å –≤ –º–∞—Å—Å–∏–≤ –¥–ª—è —ç—Ç–æ–≥–æ –≥–æ—Ä–æ–¥–∞
            cityProfilesMap.get(cityKey).push({
                index: i,
                name: originalName,
                age: originalAge,
                country: normalizedCountry,
                city: normalizedCity,
                about: originalAbout,
                photoUrl: originalPhotoUrl,
                photos: originalPhotos,
                profile: profile
            });
        }
        
        console.log(`üìä [CITY GROUPS] –°–æ–∑–¥–∞–Ω–æ ${cityProfilesMap.size} –≥—Ä—É–ø–ø –ø–æ –≥–æ—Ä–æ–¥–∞–º`);
        
        // üî• –®–ê–ì 2: –î–õ–Ø –ö–ê–ñ–î–û–ì–û –ì–û–†–û–î–ê –ë–ï–†–ï–ú –ú–ê–ö–°–ò–ú–£–ú 3 –ê–ù–ö–ï–¢–´
        let totalCitiesProcessed = 0;
        let totalProfilesAdded = 0;
        
        cityProfilesMap.forEach((cityProfiles, cityKey) => {
            totalCitiesProcessed++;
            
            // –ë–µ—Ä–µ–º –º–∞–∫—Å–∏–º—É–º 3 –ø—Ä–æ—Ñ–∏–ª—è –¥–ª—è —ç—Ç–æ–≥–æ –≥–æ—Ä–æ–¥–∞
            const maxProfiles = Math.min(cityProfiles.length, 3);
            
            // –í—ã–±–∏—Ä–∞–µ–º —Å–ª—É—á–∞–π–Ω—ã–µ –ø—Ä–æ—Ñ–∏–ª–∏ –∏–ª–∏ –ø–µ—Ä–≤—ã–µ 3
            let selectedProfiles = cityProfiles;
            if (cityProfiles.length > maxProfiles) {
                // –ï—Å–ª–∏ –±–æ–ª—å—à–µ 3 –ø—Ä–æ—Ñ–∏–ª–µ–π, –±–µ—Ä–µ–º –ø–µ—Ä–≤—ã–µ 3 (–º–æ–∂–Ω–æ –∑–∞–º–µ–Ω–∏—Ç—å –Ω–∞ —Å–ª—É—á–∞–π–Ω—ã–π –≤—ã–±–æ—Ä)
                selectedProfiles = cityProfiles.slice(0, maxProfiles);
            }
            
            selectedProfiles.forEach((profileData, index) => {
                const profile = profileData.profile;
                
                // üî• –°–û–ó–î–ê–ï–ú –î–ï–ú–û-–ü–†–û–§–ò–õ–¨ (—Å–∫—Ä—ã–≤–∞–µ–º –∫–æ–Ω—Ç–∞–∫—Ç—ã)
                const demoProfile = {
                    id: profile.id || `demo_${Date.now()}_${cityKey}_${index}`,
                    n: profileData.name || `–ê–Ω–∫–µ—Ç–∞ ${index + 1}`,
                    a: parseInt(profileData.age) || 0,
                    c: profileData.country,
                    ct: profileData.city,
                    ab: replaceSitesInAbout(profileData.about),
                    p: profileData.photoUrl,
                    phs: profileData.photos,
                    tg: null, // üî• –ö–û–ù–¢–ê–ö–¢–´ –°–ö–†–´–¢–´
                    tel: null,
                    wa: null,
                    ca: profile.ca || profile.createdAt || new Date(),
                    isDemo: true
                };
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —Ñ–æ—Ç–æ
                const hasPhoto = demoProfile.p && demoProfile.p.trim() !== '';
                const hasPhotos = demoProfile.phs && demoProfile.phs.length > 0;
                
                if (hasPhoto || hasPhotos) {
                    demoProfiles.push(demoProfile);
                    totalProfilesAdded++;
                }
            });
        });
        
        console.log(`‚úÖ [DEMO CREATION] –°–æ–∑–¥–∞–Ω–æ ${demoProfiles.length} –¥–µ–º–æ-–ø—Ä–æ—Ñ–∏–ª–µ–π (–∏–∑ ${fullProfiles.length} –ø–æ–ª–Ω—ã—Ö)`);
        console.log(`üèôÔ∏è [CITIES STATS] –û–±—Ä–∞–±–æ—Ç–∞–Ω–æ –≥–æ—Ä–æ–¥–æ–≤: ${totalCitiesProcessed}, –¥–æ–±–∞–≤–ª–µ–Ω–æ –ø—Ä–æ—Ñ–∏–ª–µ–π: ${totalProfilesAdded}`);
        
        if (demoProfiles.length === 0) {
            console.log(`‚ùå [DEMO CRITICAL] –ù–µ —Å–æ–∑–¥–∞–Ω–æ –Ω–∏ –æ–¥–Ω–æ–≥–æ –¥–µ–º–æ-–ø—Ä–æ—Ñ–∏–ª—è!`);
            
            // –°–æ–∑–¥–∞–µ–º –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ç–µ—Å—Ç–æ–≤—ã—Ö –¥–µ–º–æ-–ø—Ä–æ—Ñ–∏–ª–µ–π –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
            console.log(`üîÑ [DEBUG] –°–æ–∑–¥–∞–µ–º —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–µ–º–æ-–ø—Ä–æ—Ñ–∏–ª–∏...`);
            
            const testProfiles = [
                {
                    id: 'test_1',
                    n: '–¢–µ—Å—Ç–æ–≤–∞—è –∞–Ω–∫–µ—Ç–∞ 1',
                    a: 25,
                    c: 'üá∑üá∫ –†–æ—Å—Å–∏—è',
                    ct: '–ú–æ—Å–∫–≤–∞',
                    ab: '–≠—Ç–æ —Ç–µ—Å—Ç–æ–≤–∞—è –¥–µ–º–æ-–∞–Ω–∫–µ—Ç–∞ 1 –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏',
                    p: 'https://via.placeholder.com/600x800/0088cc/ffffff?text=Demo+1',
                    phs: [],
                    tg: null,
                    tel: null,
                    wa: null,
                    ca: new Date(),
                    isDemo: true
                },
                {
                    id: 'test_2',
                    n: '–¢–µ—Å—Ç–æ–≤–∞—è –∞–Ω–∫–µ—Ç–∞ 2',
                    a: 28,
                    c: 'üá∑üá∫ –†–æ—Å—Å–∏—è',
                    ct: '–ú–æ—Å–∫–≤–∞',
                    ab: '–≠—Ç–æ —Ç–µ—Å—Ç–æ–≤–∞—è –¥–µ–º–æ-–∞–Ω–∫–µ—Ç–∞ 2 –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏',
                    p: 'https://via.placeholder.com/600x800/0088cc/ffffff?text=Demo+2',
                    phs: [],
                    tg: null,
                    tel: null,
                    wa: null,
                    ca: new Date(),
                    isDemo: true
                },
                {
                    id: 'test_3',
                    n: '–¢–µ—Å—Ç–æ–≤–∞—è –∞–Ω–∫–µ—Ç–∞ 3',
                    a: 30,
                    c: 'üá∫üá¶ –£–∫—Ä–∞–∏–Ω–∞',
                    ct: '–ö–∏–µ–≤',
                    ab: '–≠—Ç–æ —Ç–µ—Å—Ç–æ–≤–∞—è –¥–µ–º–æ-–∞–Ω–∫–µ—Ç–∞ 3 –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏',
                    p: 'https://via.placeholder.com/600x800/0088cc/ffffff?text=Demo+3',
                    phs: [],
                    tg: null,
                    tel: null,
                    wa: null,
                    ca: new Date(),
                    isDemo: true
                }
            ];
            
            demoProfiles.push(...testProfiles);
            console.log(`‚úÖ [DEBUG] –î–æ–±–∞–≤–ª–µ–Ω–æ ${testProfiles.length} —Ç–µ—Å—Ç–æ–≤—ã—Ö –ø—Ä–æ—Ñ–∏–ª–µ–π`);
        }
        
        // üî• –ö–≠–®–ò–†–£–ï–ú –î–ï–ú–û-–ü–†–û–§–ò–õ–ò
        console.log(`üíæ [DEMO CACHE] –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ ${demoProfiles.length} –¥–µ–º–æ-–ø—Ä–æ—Ñ–∏–ª–µ–π...`);
        await this.cacheGlobalProfiles(demoProfiles, true);
        
        // üî• –°–û–•–†–ê–ù–Ø–ï–ú –°–¢–†–ê–ù–´ –ò –ì–û–†–û–î–ê
        console.log(`üó∫Ô∏è [DEMO GEO] –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å—Ç—Ä–∞–Ω –∏ –≥–æ—Ä–æ–¥–æ–≤...`);
        const sortedCountries = Array.from(countriesSet).sort();
        globalDemoCache.set("demo:countries", sortedCountries);
        globalDemoCache.set("demo:countries_raw", Array.from(countriesSet));
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≥–æ—Ä–æ–¥–∞ –ø–æ —Å—Ç—Ä–∞–Ω–∞–º
        citiesByCountry.forEach((citiesSet, country) => {
            globalDemoCache.set(`demo:cities:${country}`, Array.from(citiesSet).sort());
        });
        
        // üî• –°–û–ó–î–ê–ï–ú –ò–ù–î–ï–ö–°–´ –î–õ–Ø –î–ï–ú–û-–ö–≠–®–ê
        console.log(`üìá [DEMO INDEX] –°–æ–∑–¥–∞–Ω–∏–µ –∏–Ω–¥–µ–∫—Å–æ–≤ –¥–ª—è –¥–µ–º–æ-–∫—ç—à–∞ –∏–∑ ${demoProfiles.length} –ø—Ä–æ—Ñ–∏–ª–µ–π...`);
        
        const demoCountryCityIndex = new Map();
        const demoCountryIndex = new Map();
        const demoCityIndex = new Map();
        
        let indexedProfiles = 0;
        
        for (let i = 0; i < demoProfiles.length; i++) {
            const profile = demoProfiles[i];
            const country = profile.c;
            
            if (country && country !== '–ù–µ —É–∫–∞–∑–∞–Ω–∞') {
                // 1. –ò–Ω–¥–µ–∫—Å –ø–æ —Å—Ç—Ä–∞–Ω–µ
                if (!demoCountryIndex.has(country)) {
                    demoCountryIndex.set(country, []);
                }
                demoCountryIndex.get(country).push(i);
                
                // 2. –ò–Ω–¥–µ–∫—Å –ø–æ —Å—Ç—Ä–∞–Ω–µ+–≥–æ—Ä–æ–¥—É
                const city = profile.ct;
                if (city && city !== '–ù–µ —É–∫–∞–∑–∞–Ω') {
                    const key = `${country}:${city}`;
                    if (!demoCountryCityIndex.has(key)) {
                        demoCountryCityIndex.set(key, []);
                    }
                    demoCountryCityIndex.get(key).push(i);
                    
                    // 3. –ò–Ω–¥–µ–∫—Å —Ç–æ–ª—å–∫–æ –ø–æ –≥–æ—Ä–æ–¥—É
                    if (!demoCityIndex.has(city)) {
                        demoCityIndex.set(city, []);
                    }
                    demoCityIndex.get(city).push(i);
                }
                
                indexedProfiles++;
            }
        }
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–Ω–¥–µ–∫—Å—ã –≤ –¥–µ–º–æ-–∫—ç—à
        globalDemoCache.set("demo:index:country_city", demoCountryCityIndex);
        globalDemoCache.set("demo:index:country", demoCountryIndex);
        globalDemoCache.set("demo:index:city", demoCityIndex);
        
        console.log(`‚úÖ [DEMO INDEX] –ò–Ω–¥–µ–∫—Å—ã —Å–æ–∑–¥–∞–Ω—ã: ${demoCountryIndex.size} —Å—Ç—Ä–∞–Ω, ${demoCountryCityIndex.size} –ø–∞—Ä —Å—Ç—Ä–∞–Ω–∞+–≥–æ—Ä–æ–¥, ${demoCityIndex.size} –≥–æ—Ä–æ–¥–æ–≤`);
        console.log(`üìä [DEMO INDEX STATS] –ü—Ä–æ—Ñ–∏–ª–µ–π: ${indexedProfiles}`);
        
        // üî• –ü–†–û–í–ï–†–ö–ê –ö–û–ù–ö–†–ï–¢–ù–´–• –ì–û–†–û–î–û–í
        console.log(`üîç [DEMO INDEX CHECK] –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏–Ω–¥–µ–∫—Å–æ–≤ –¥–ª—è –≥–æ—Ä–æ–¥–æ–≤...`);
        
        const checkCities = [
            { country: "üáßüá¶ –ë–æ—Å–Ω–∏—è", city: "–°–∞—Ä–∞–µ–≤–æ" },
            { country: "üáßüá¶ –ë–æ—Å–Ω–∏—è", city: "–ú–æ—Å—Ç–∞—Ä" },
            { country: "üá¶üá™ –û–ê–≠", city: "–î—É–±–∞–π" },
            { country: "üá∑üá∫ –†–æ—Å—Å–∏—è", city: "–ú–æ—Å–∫–≤–∞" }
        ];
        
        checkCities.forEach(({ country, city }) => {
            const key = `${country}:${city}`;
            const profilesCount = demoCountryCityIndex.get(key)?.length || 0;
            console.log(`   üìç ${country} ‚Üí ${city}: ${profilesCount} –ø—Ä–æ—Ñ–∏–ª–µ–π –≤ –∏–Ω–¥–µ–∫—Å–µ`);
        });
        
        // üî• –û–°–û–ë–ê–Ø –ü–†–û–í–ï–†–ö–ê –ú–û–°–ö–í–´
        const moscowKey = "üá∑üá∫ –†–æ—Å—Å–∏—è:–ú–æ—Å–∫–≤–∞";
        const moscowProfilesCount = demoCountryCityIndex.get(moscowKey)?.length || 0;
        console.log(`üéØ [MOSCOW CHECK] –ú–æ—Å–∫–≤–∞ –≤ –¥–µ–º–æ-–∫—ç—à–µ: ${moscowProfilesCount} –ø—Ä–æ—Ñ–∏–ª–µ–π (–¥–æ–ª–∂–Ω–æ –±—ã—Ç—å 3 –µ—Å–ª–∏ –µ—Å—Ç—å)`);
        
        if (moscowProfilesCount > 0 && moscowProfilesCount < 3) {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å–∫–æ–ª—å–∫–æ —Ä–µ–∞–ª—å–Ω–æ –ø—Ä–æ—Ñ–∏–ª–µ–π –ú–æ—Å–∫–≤—ã –≤ –ø–æ–ª–Ω–æ–º –∫—ç—à–µ
            const allMoscowProfiles = fullProfiles.filter(p => {
                const pCountry = cacheManager.normalizeCountryName(p.c || p.country);
                const pCity = cacheManager.normalizeCityName(p.ct || p.city);
                return pCountry === "üá∑üá∫ –†–æ—Å—Å–∏—è" && pCity === "–ú–æ—Å–∫–≤–∞";
            });
            
            console.log(`üîç [MOSCOW FULL] –í –ø–æ–ª–Ω–æ–º –∫—ç—à–µ: ${allMoscowProfiles.length} –ø—Ä–æ—Ñ–∏–ª–µ–π –ú–æ—Å–∫–≤—ã`);
            
            if (allMoscowProfiles.length >= 3) {
                console.log(`‚ö†Ô∏è [MOSCOW ISSUE] –í –ø–æ–ª–Ω–æ–º –∫—ç—à–µ –µ—Å—Ç—å ${allMoscowProfiles.length} –∞–Ω–∫–µ—Ç –ú–æ—Å–∫–≤—ã, –Ω–æ –≤ –¥–µ–º–æ —Ç–æ–ª—å–∫–æ ${moscowProfilesCount}!`);
            }
        }
        
        console.log(`üìä [DEMO STATS] –ü—Ä–æ—Ñ–∏–ª–µ–π: ${demoProfiles.length}, –°—Ç—Ä–∞–Ω: ${countriesSet.size}`);
        
        return true;
        
    } catch (error) {
        console.error(`‚ùå [DEMO CREATION ERROR] –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –¥–µ–º–æ-–∫—ç—à–∞:`, error);
        return false;
    }
},
// async createDemoCacheFromFullProfiles(fullProfiles) {
//     try {
//         console.log(`üîß [DEMO CREATION] –°–æ–∑–¥–∞–µ–º –¥–µ–º–æ-–∫—ç—à –∏–∑ ${fullProfiles.length} –ø—Ä–æ—Ñ–∏–ª–µ–π...`);
        
//         const demoProfiles = [];
//         const countriesSet = new Set();
//         const citiesByCountry = new Map();
//         const cityProfilesMap = new Map(); // –ú–∞–ø–∞ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª–µ–π –ø–æ –≥–æ—Ä–æ–¥–∞–º
        
//         console.log(`üë§ [DEMO PROCESSING] –û–±—Ä–∞–±–æ—Ç–∫–∞ ${fullProfiles.length} –ø—Ä–æ—Ñ–∏–ª–µ–π...`);
        
//         // üî• –®–ê–ì 1: –ì–†–£–ü–ü–ò–†–£–ï–ú –ü–†–û–§–ò–õ–ò –ü–û –ì–û–†–û–î–ê–ú
//         for (let i = 0; i < fullProfiles.length; i++) {
//             const profile = fullProfiles[i];
            
//             const originalName = profile.n || profile.name || '';
//             const originalAge = profile.a || profile.age || 0;
//             const originalCountry = profile.c || profile.country || '';
//             const originalCity = profile.ct || profile.city || '';
//             const originalAbout = profile.ab || profile.about || '';
//             const originalPhotoUrl = profile.p || profile.photoUrl || '';
//             const originalPhotos = profile.phs || profile.photos || [];
            
//             // –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º —Å—Ç—Ä–∞–Ω—É –∏ –≥–æ—Ä–æ–¥
//             const normalizedCountry = originalCountry ? 
//                 this.normalizeCountryName(originalCountry) : '–ù–µ —É–∫–∞–∑–∞–Ω–∞';
//             const normalizedCity = originalCity ? 
//                 this.normalizeCityName(originalCity) : '–ù–µ —É–∫–∞–∑–∞–Ω';
            
//             // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –±–µ–∑ —Å—Ç—Ä–∞–Ω—ã –∏–ª–∏ –≥–æ—Ä–æ–¥–∞
//             if (normalizedCountry === '–ù–µ —É–∫–∞–∑–∞–Ω–∞' || normalizedCity === '–ù–µ —É–∫–∞–∑–∞–Ω') {
//                 continue;
//             }
            
//             // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å—Ç—Ä–∞–Ω—ã –∏ –≥–æ—Ä–æ–¥–∞ –¥–ª—è —Å–ø–∏—Å–∫–æ–≤
//             if (normalizedCountry && normalizedCountry !== '–ù–µ —É–∫–∞–∑–∞–Ω–∞') {
//                 countriesSet.add(normalizedCountry);
                
//                 if (!citiesByCountry.has(normalizedCountry)) {
//                     citiesByCountry.set(normalizedCountry, new Set());
//                 }
//                 if (normalizedCity && normalizedCity !== '–ù–µ —É–∫–∞–∑–∞–Ω') {
//                     citiesByCountry.get(normalizedCountry).add(normalizedCity);
//                 }
//             }
            
//             // –°–æ–∑–¥–∞–µ–º –∫–ª—é—á –≥–æ—Ä–æ–¥–∞
//             const cityKey = `${normalizedCountry}_${normalizedCity}`;
            
//             if (!cityProfilesMap.has(cityKey)) {
//                 cityProfilesMap.set(cityKey, []);
//             }
            
//             // –î–æ–±–∞–≤–ª—è–µ–º –ø—Ä–æ—Ñ–∏–ª—å –≤ –º–∞—Å—Å–∏–≤ –¥–ª—è —ç—Ç–æ–≥–æ –≥–æ—Ä–æ–¥–∞
//             cityProfilesMap.get(cityKey).push({
//                 index: i,
//                 name: originalName,
//                 age: originalAge,
//                 country: normalizedCountry,
//                 city: normalizedCity,
//                 about: originalAbout,
//                 photoUrl: originalPhotoUrl,
//                 photos: originalPhotos,
//                 profile: profile
//             });
//         }
        
//         console.log(`üìä [CITY GROUPS] –°–æ–∑–¥–∞–Ω–æ ${cityProfilesMap.size} –≥—Ä—É–ø–ø –ø–æ –≥–æ—Ä–æ–¥–∞–º`);
        
//         // üî• –®–ê–ì 2: –î–õ–Ø –ö–ê–ñ–î–û–ì–û –ì–û–†–û–î–ê –ë–ï–†–ï–ú –ú–ê–ö–°–ò–ú–£–ú 3 –ê–ù–ö–ï–¢–´
//         cityProfilesMap.forEach((cityProfiles, cityKey) => {
//             // –ë–µ—Ä–µ–º –º–∞–∫—Å–∏–º—É–º 3 –ø—Ä–æ—Ñ–∏–ª—è –¥–ª—è —ç—Ç–æ–≥–æ –≥–æ—Ä–æ–¥–∞
//             const maxProfiles = Math.min(cityProfiles.length, 3);
            
//             // –í—ã–±–∏—Ä–∞–µ–º –ø–µ—Ä–≤—ã–µ 3 –ø—Ä–æ—Ñ–∏–ª—è (–∏–ª–∏ –≤—Å–µ, –µ—Å–ª–∏ –º–µ–Ω—å—à–µ 3)
//             const selectedProfiles = cityProfiles.slice(0, maxProfiles);
            
//             selectedProfiles.forEach((profileData, index) => {
//                 const profile = profileData.profile;
                
//                 // üî• –°–û–ó–î–ê–ï–ú –î–ï–ú–û-–ü–†–û–§–ò–õ–¨ (—Å–∫—Ä—ã–≤–∞–µ–º –∫–æ–Ω—Ç–∞–∫—Ç—ã)
//                 const demoProfile = {
//                     id: profile.id || `demo_${Date.now()}_${cityKey}_${index}`,
//                     n: profileData.name || `–ê–Ω–∫–µ—Ç–∞ ${index + 1}`,
//                     a: parseInt(profileData.age) || 0,
//                     c: profileData.country,
//                     ct: profileData.city,
//                     ab: replaceSitesInAbout(profileData.about),
//                     p: profileData.photoUrl,
//                     phs: profileData.photos,
//                     tg: null, // üî• –ö–û–ù–¢–ê–ö–¢–´ –°–ö–†–´–¢–´
//                     tel: null,
//                     wa: null,
//                     ca: profile.ca || profile.createdAt || new Date(),
//                     isDemo: true
//                 };
                
//                 // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —Ñ–æ—Ç–æ
//                 const hasPhoto = demoProfile.p && demoProfile.p.trim() !== '';
//                 const hasPhotos = demoProfile.phs && demoProfile.phs.length > 0;
                
//                 if (hasPhoto || hasPhotos) {
//                     demoProfiles.push(demoProfile);
//                 }
//             });
//         });
        
//         console.log(`‚úÖ [DEMO CREATION] –°–æ–∑–¥–∞–Ω–æ ${demoProfiles.length} –¥–µ–º–æ-–ø—Ä–æ—Ñ–∏–ª–µ–π (–∏–∑ ${fullProfiles.length} –ø–æ–ª–Ω—ã—Ö)`);
        
//         if (demoProfiles.length === 0) {
//             console.log(`‚ùå [DEMO CRITICAL] –ù–µ —Å–æ–∑–¥–∞–Ω–æ –Ω–∏ –æ–¥–Ω–æ–≥–æ –¥–µ–º–æ-–ø—Ä–æ—Ñ–∏–ª—è!`);
//             return false;
//         }
        
//         // üî• –ö–≠–®–ò–†–£–ï–ú –î–ï–ú–û-–ü–†–û–§–ò–õ–ò
//         console.log(`üíæ [DEMO CACHE] –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ ${demoProfiles.length} –¥–µ–º–æ-–ø—Ä–æ—Ñ–∏–ª–µ–π...`);
//         await this.cacheGlobalProfiles(demoProfiles, true);
        
//         // üî• –°–û–•–†–ê–ù–Ø–ï–ú –°–¢–†–ê–ù–´ –ò –ì–û–†–û–î–ê
//         console.log(`üó∫Ô∏è [DEMO GEO] –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å—Ç—Ä–∞–Ω –∏ –≥–æ—Ä–æ–¥–æ–≤...`);
//         const sortedCountries = Array.from(countriesSet).sort();
//         globalDemoCache.set("demo:countries", sortedCountries);
//         globalDemoCache.set("demo:countries_raw", Array.from(countriesSet));
        
//         // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≥–æ—Ä–æ–¥–∞ –ø–æ —Å—Ç—Ä–∞–Ω–∞–º
//         citiesByCountry.forEach((citiesSet, country) => {
//             globalDemoCache.set(`demo:cities:${country}`, Array.from(citiesSet).sort());
//         });
        
//         // üî• –°–û–ó–î–ê–ï–ú –ò–ù–î–ï–ö–°–´ –î–õ–Ø –î–ï–ú–û-–ö–≠–®–ê
//         console.log(`üìá [DEMO INDEX] –°–æ–∑–¥–∞–Ω–∏–µ –∏–Ω–¥–µ–∫—Å–æ–≤ –¥–ª—è –¥–µ–º–æ-–∫—ç—à–∞ –∏–∑ ${demoProfiles.length} –ø—Ä–æ—Ñ–∏–ª–µ–π...`);
        
//         const demoCountryCityIndex = new Map();
//         const demoCountryIndex = new Map();
//         const demoCityIndex = new Map();
        
//         let indexedProfiles = 0;
        
//         for (let i = 0; i < demoProfiles.length; i++) {
//             const profile = demoProfiles[i];
//             const country = profile.c;
            
//             if (country && country !== '–ù–µ —É–∫–∞–∑–∞–Ω–∞') {
//                 // 1. –ò–Ω–¥–µ–∫—Å –ø–æ —Å—Ç—Ä–∞–Ω–µ
//                 if (!demoCountryIndex.has(country)) {
//                     demoCountryIndex.set(country, []);
//                 }
//                 demoCountryIndex.get(country).push(i);
                
//                 // 2. –ò–Ω–¥–µ–∫—Å –ø–æ —Å—Ç—Ä–∞–Ω–µ+–≥–æ—Ä–æ–¥—É
//                 const city = profile.ct;
//                 if (city && city !== '–ù–µ —É–∫–∞–∑–∞–Ω') {
//                     const key = `${country}:${city}`;
//                     if (!demoCountryCityIndex.has(key)) {
//                         demoCountryCityIndex.set(key, []);
//                     }
//                     demoCountryCityIndex.get(key).push(i);
                    
//                     // 3. –ò–Ω–¥–µ–∫—Å —Ç–æ–ª—å–∫–æ –ø–æ –≥–æ—Ä–æ–¥—É
//                     if (!demoCityIndex.has(city)) {
//                         demoCityIndex.set(city, []);
//                     }
//                     demoCityIndex.get(city).push(i);
//                 }
                
//                 indexedProfiles++;
//             }
//         }
        
//         // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–Ω–¥–µ–∫—Å—ã –≤ –¥–µ–º–æ-–∫—ç—à
//         globalDemoCache.set("demo:index:country_city", demoCountryCityIndex);
//         globalDemoCache.set("demo:index:country", demoCountryIndex);
//         globalDemoCache.set("demo:index:city", demoCityIndex);
        
//         console.log(`‚úÖ [DEMO INDEX] –ò–Ω–¥–µ–∫—Å—ã —Å–æ–∑–¥–∞–Ω—ã: ${demoCountryIndex.size} —Å—Ç—Ä–∞–Ω, ${demoCountryCityIndex.size} –ø–∞—Ä —Å—Ç—Ä–∞–Ω–∞+–≥–æ—Ä–æ–¥, ${demoCityIndex.size} –≥–æ—Ä–æ–¥–æ–≤`);
//         console.log(`üìä [DEMO INDEX STATS] –ü—Ä–æ—Ñ–∏–ª–µ–π: ${indexedProfiles}`);
        
//         // üî• –ü–†–û–í–ï–†–ö–ê –ö–û–ù–ö–†–ï–¢–ù–´–• –ì–û–†–û–î–û–í
//         console.log(`üîç [DEMO INDEX CHECK] –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏–Ω–¥–µ–∫—Å–æ–≤ –¥–ª—è –≥–æ—Ä–æ–¥–æ–≤...`);
        
//         const checkCities = [
//             { country: "üáßüá¶ –ë–æ—Å–Ω–∏—è", city: "–°–∞—Ä–∞–µ–≤–æ" },
//             { country: "üáßüá¶ –ë–æ—Å–Ω–∏—è", city: "–ú–æ—Å—Ç–∞—Ä" },
//             { country: "üá¶üá™ –û–ê–≠", city: "–î—É–±–∞–π" },
//             { country: "üá∑üá∫ –†–æ—Å—Å–∏—è", city: "–ú–æ—Å–∫–≤–∞" }
//         ];
        
//         checkCities.forEach(({ country, city }) => {
//             const key = `${country}:${city}`;
//             const profilesCount = demoCountryCityIndex.get(key)?.length || 0;
//             console.log(`   üìç ${country} ‚Üí ${city}: ${profilesCount} –ø—Ä–æ—Ñ–∏–ª–µ–π –≤ –∏–Ω–¥–µ–∫—Å–µ`);
//         });
        
//         // üî• –û–°–û–ë–ê–Ø –ü–†–û–í–ï–†–ö–ê –ú–û–°–ö–í–´
//         const moscowKey = "üá∑üá∫ –†–æ—Å—Å–∏—è:–ú–æ—Å–∫–≤–∞";
//         const moscowProfilesCount = demoCountryCityIndex.get(moscowKey)?.length || 0;
//         console.log(`üéØ [MOSCOW CHECK] –ú–æ—Å–∫–≤–∞ –≤ –¥–µ–º–æ-–∫—ç—à–µ: ${moscowProfilesCount} –ø—Ä–æ—Ñ–∏–ª–µ–π (–¥–æ–ª–∂–Ω–æ –±—ã—Ç—å 3 –µ—Å–ª–∏ –µ—Å—Ç—å)`);
        
//         if (moscowProfilesCount > 0 && moscowProfilesCount < 3) {
//             // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å–∫–æ–ª—å–∫–æ —Ä–µ–∞–ª—å–Ω–æ –ø—Ä–æ—Ñ–∏–ª–µ–π –ú–æ—Å–∫–≤—ã –≤ –ø–æ–ª–Ω–æ–º –∫—ç—à–µ
//             const allMoscowProfiles = fullProfiles.filter(p => {
//                 const pCountry = cacheManager.normalizeCountryName(p.c || p.country);
//                 const pCity = cacheManager.normalizeCityName(p.ct || p.city);
//                 return pCountry === "üá∑üá∫ –†–æ—Å—Å–∏—è" && pCity === "–ú–æ—Å–∫–≤–∞";
//             });
            
//             console.log(`üîç [MOSCOW FULL] –í –ø–æ–ª–Ω–æ–º –∫—ç—à–µ: ${allMoscowProfiles.length} –ø—Ä–æ—Ñ–∏–ª–µ–π –ú–æ—Å–∫–≤—ã`);
            
//             if (allMoscowProfiles.length >= 3) {
//                 console.log(`‚ö†Ô∏è [MOSCOW ISSUE] –í –ø–æ–ª–Ω–æ–º –∫—ç—à–µ –µ—Å—Ç—å ${allMoscowProfiles.length} –∞–Ω–∫–µ—Ç –ú–æ—Å–∫–≤—ã, –Ω–æ –≤ –¥–µ–º–æ —Ç–æ–ª—å–∫–æ ${moscowProfilesCount}!`);
//             }
//         }
        
//         console.log(`üìä [DEMO STATS] –ü—Ä–æ—Ñ–∏–ª–µ–π: ${demoProfiles.length}, –°—Ç—Ä–∞–Ω: ${countriesSet.size}`);
        
//         return true;
        
//     } catch (error) {
//         console.error(`‚ùå [DEMO CREATION ERROR] –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –¥–µ–º–æ-–∫—ç—à–∞:`, error);
//         return false;
//     }
// },
// 3. –ö–≠–®–ò–†–û–í–ê–ù–ò–ï –ü–†–û–§–ò–õ–ï–ô –í –ì–õ–û–ë–ê–õ–¨–ù–´–ô –ö–≠–® (–ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –í–ï–†–°–ò–Ø)
async cacheGlobalProfiles(profiles, isDemo = false) {
    try {
        console.log(`üîÑ [${isDemo ? 'GLOBAL DEMO' : 'GLOBAL FULL'} CACHE] –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ ${profiles.length} –∞–Ω–∫–µ—Ç...`);
        
        // üî• –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –°–æ—Ö—Ä–∞–Ω—è–µ–º –í–°–ï –¥–∞–Ω–Ω—ã–µ –ø—Ä–æ—Ñ–∏–ª—è
        const normalizedProfiles = profiles.map(profile => ({
            id: profile.id || profile._id || '',
            n: profile.n || profile.name || '',
            a: parseInt(profile.a || profile.age) || 0,
            c: profile.c || profile.country || '',
            ct: profile.ct || profile.city || '',
            ab: profile.ab || profile.about || '',
            p: profile.p || profile.photoUrl || '',
            phs: Array.isArray(profile.phs || profile.photos) ? (profile.phs || profile.photos) : [],
            tg: isDemo ? null : (profile.tg || profile.telegram),
            tel: isDemo ? null : (profile.tel || profile.phone),
            wa: isDemo ? null : (profile.wa || profile.whatsapp),
            ca: profile.ca || profile.createdAt || new Date(),
            isDemo: isDemo || profile.isDemo || false
        }));

        console.log(`üîç [CACHE SAMPLE] –ü—Ä–∏–º–µ—Ä –ø—Ä–æ—Ñ–∏–ª—è –≤ –∫—ç—à–µ: ${normalizedProfiles[0]?.n || '–Ω–µ—Ç –∏–º–µ–Ω–∏'}, —Ñ–æ—Ç–æ: ${normalizedProfiles[0]?.p ? '–µ—Å—Ç—å' : '–Ω–µ—Ç'}, —Ñ–æ—Ç–æ –≥–∞–ª–µ—Ä–µ–∏: ${normalizedProfiles[0]?.phs?.length || 0}`);

        // –°–ñ–ê–¢–ò–ï –î–ê–ù–ù–´–•
        const jsonString = JSON.stringify(normalizedProfiles);
        const compressed = zlib.gzipSync(jsonString);
        
        if (isDemo) {
            globalDemoCache.set("demo:profiles", compressed);
            console.log(`üíæ [DEMO CACHE] –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ ${normalizedProfiles.length} –ø—Ä–æ—Ñ–∏–ª–µ–π —Å –Ω–∞–∑–≤–∞–Ω–∏–µ–º: ${normalizedProfiles[0]?.n || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'}`);
        } else {
            globalProfilesCache.set("profiles:all", compressed);
            console.log(`üíæ [FULL CACHE] –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ ${normalizedProfiles.length} –ø—Ä–æ—Ñ–∏–ª–µ–π —Å –Ω–∞–∑–≤–∞–Ω–∏–µ–º: ${normalizedProfiles[0]?.n || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'}`);
        }

        console.log(`‚úÖ [GLOBAL CACHE] –°–∂–∞—Ç–∏–µ: ${jsonString.length} ‚Üí ${compressed.length} bytes (${Math.round((1 - compressed.length/jsonString.length) * 100)}% —ç–∫–æ–Ω–æ–º–∏–∏)`);
        
        return true;
        
    } catch (error) {
        console.error(`‚ùå [GLOBAL CACHE] –û—à–∏–±–∫–∞ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è:`, error);
        return false;
    }
},
    // 4. –ü–û–õ–£–ß–ï–ù–ò–ï –ü–†–û–§–ò–õ–ï–ô –ò–ó –ì–õ–û–ë–ê–õ–¨–ù–û–ì–û –ö–≠–®–ê (–ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –í–ï–†–°–ò–Ø)
getGlobalProfiles(isDemo = false) { 
    try {
        let compressed;
        if (isDemo) {
            compressed = globalDemoCache.get("demo:profiles");
            console.log(`üîç [GET DEMO PROFILES] –ö–ª—é—á –Ω–∞–π–¥–µ–Ω: ${compressed ? '–¥–∞' : '–Ω–µ—Ç'}`);
        } else {
            compressed = globalProfilesCache.get("profiles:all");
        }
        
        if (!compressed) {
            console.log(`‚ùå [GET GLOBAL PROFILES] –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –≤ –∫—ç—à–µ (–¥–µ–º–æ: ${isDemo})`);
            return null;
        }
        
        // –†–ê–°–ü–ê–ö–û–í–ö–ê –î–ê–ù–ù–´–•
        const decompressed = zlib.gunzipSync(compressed);
        const profiles = JSON.parse(decompressed.toString());
        
        console.log(`‚úÖ [GET GLOBAL PROFILES] –ó–∞–≥—Ä—É–∂–µ–Ω–æ ${profiles.length} –ø—Ä–æ—Ñ–∏–ª–µ–π (–¥–µ–º–æ: ${isDemo})`);
        if (profiles.length > 0) {
            console.log(`üìã [SAMPLE] –ü–µ—Ä–≤—ã–π –ø—Ä–æ—Ñ–∏–ª—å: ${profiles[0]?.n || '–Ω–µ—Ç –∏–º–µ–Ω–∏'}, —Ñ–æ—Ç–æ: ${profiles[0]?.p ? '–µ—Å—Ç—å' : '–Ω–µ—Ç'}, —Ñ–æ—Ç–æ –≥–∞–ª–µ—Ä–µ–∏: ${profiles[0]?.phs?.length || 0}`);
        }
        
        return profiles;
        
    } catch (error) {
        console.error(`‚ùå [GLOBAL CACHE] –û—à–∏–±–∫–∞ —Ä–∞—Å–ø–∞–∫–æ–≤–∫–∏:`, error);
        return null;
    }
},
    
    // 5. –ü–û–õ–£–ß–ï–ù–ò–ï –°–¢–†–ê–ù –ò–ó –ì–õ–û–ë–ê–õ–¨–ù–û–ì–û –ö–≠–®–ê
    getGlobalCountries(isDemo = false) { 
        if (isDemo) {
            return globalDemoCache.get("demo:countries") || [];
        } else {
            return globalProfilesCache.get("profiles:countries") || [];
        }
    },
    
    // 6. –ü–û–õ–£–ß–ï–ù–ò–ï –ì–û–†–û–î–û–í –ò–ó –ì–õ–û–ë–ê–õ–¨–ù–û–ì–û –ö–≠–®–ê
    getGlobalCities(country, isDemo = false) { 
        if (isDemo) {
            return globalDemoCache.get(`demo:cities:${country}`) || [];
        } else {
            return globalProfilesCache.get(`profiles:cities:${country}`) || [];
        }
    },
    
    // 7. –ö–≠–® –§–ò–õ–¨–¢–†–û–í (–≥–ª–æ–±–∞–ª—å–Ω—ã–π)
    cacheGlobalFilter(filterKey, profiles, isDemo = false) {
        try {
            const cacheKey = isDemo ? `demo:filter:${filterKey}` : `filter:${filterKey}`;
            
            if (isDemo) {
                globalDemoCache.set(cacheKey, profiles);
            } else {
                globalFilterCache.set(cacheKey, profiles);
            }
            
            readingStats.addCacheHit();
            return true;
        } catch (error) {
            console.error(`‚ùå [FILTER CACHE] –û—à–∏–±–∫–∞:`, error);
            return false;
        }
    },
    
    getGlobalFilter(filterKey, isDemo = false) {
        try {
            const cacheKey = isDemo ? `demo:filter:${filterKey}` : `filter:${filterKey}`;
            
            let result;
            if (isDemo) {
                result = globalDemoCache.get(cacheKey);
            } else {
                result = globalFilterCache.get(cacheKey);
            }
            
            if (result) {
                readingStats.addCacheHit();
            } else {
                readingStats.addCacheMiss();
            }
            
            return result;
        } catch (error) {
            console.error(`‚ùå [FILTER CACHE] –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è:`, error);
            return null;
        }
    },
    
    // ===================== –§–£–ù–ö–¶–ò–ò –î–õ–Ø –ò–ù–î–ò–í–ò–î–£–ê–õ–¨–ù–´–• –ö–≠–®–ï–ô –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–ï–ô =====================
    
    // 8. –ö–≠–® –ü–û–î–ü–ò–°–ö–ò (–∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–π –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è)
    cacheSubscription(userId, isActive) { 
        console.log(`üíæ [USER SUBSCRIPTION CACHE] –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–ª—è ${userId}: ${isActive}`);
        return subscriptionCache.set(`subscription:${userId}`, isActive, SCALING_CONFIG.CACHE.SUBSCRIPTION_TTL); 
    },
    
    getCachedSubscription(userId) { 
        const subscription = subscriptionCache.get(`subscription:${userId}`);
        console.log(`üîç [USER SUBSCRIPTION CACHE] –ó–∞–ø—Ä–æ—Å –¥–ª—è ${userId}: ${subscription !== undefined ? subscription : '–Ω–µ—Ç –≤ –∫—ç—à–µ'}`);
        return subscription;
    },
    
    // 9. –ö–≠–® –ö–ê–ù–ê–õ–ê (–∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–π –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è)
    cacheChannelSubscription(userId, isSubscribed) {
        console.log(`üíæ [USER CHANNEL CACHE] –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–ª—è ${userId}: ${isSubscribed}`);
        return channelSubscriptionCache.set(`channel:${userId}`, isSubscribed, SCALING_CONFIG.CACHE.CHANNEL_TTL);
    },
    
    getCachedChannelSubscription(userId) {
        const subscribed = channelSubscriptionCache.get(`channel:${userId}`);
        console.log(`üîç [USER CHANNEL CACHE] –ó–∞–ø—Ä–æ—Å –¥–ª—è ${userId}: ${subscribed !== undefined ? subscribed : '–Ω–µ—Ç –≤ –∫—ç—à–µ'}`);
        return subscribed;
    },
    
    // 10. –ö–≠–® –°–¢–ê–¢–£–°–ê –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø
    setUserCacheStatus(userId, cacheType) {
        console.log(`üíæ [USER STATUS CACHE] –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –¥–ª—è ${userId}: ${cacheType}`);
        userCacheStatus.set(`cache_status:${userId}`, cacheType, SCALING_CONFIG.CACHE.SESSIONS_TTL);
    },
    
    getUserCacheStatus(userId) {
        const status = userCacheStatus.get(`cache_status:${userId}`);
        console.log(`üîç [USER STATUS CACHE] –°—Ç–∞—Ç—É—Å –¥–ª—è ${userId}: ${status}`);
        return status;
    },
    
    // 11. –ü–†–û–í–ï–†–ö–ê –ó–ê–ì–†–£–ó–ö–ò –ì–õ–û–ë–ê–õ–¨–ù–´–• –ö–≠–®–ï–ô
    isGlobalFullCacheLoaded() {
        const fullProfiles = this.getGlobalProfiles(false);
        return !!(fullProfiles && fullProfiles.length > 0);
    },
    
    isGlobalDemoCacheLoaded() {
        const demoProfiles = this.getGlobalProfiles(true);
        return !!(demoProfiles && demoProfiles.length > 0);
    },
    
    // 12. –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò
   normalizeCityName(cityName) {
    if (!cityName || typeof cityName !== 'string') return cityName;
    
    const trimmedCity = cityName.trim();
    if (trimmedCity.length === 0) return cityName;
    
    // –¢–û–õ–¨–ö–û –£–ë–ò–†–ê–ï–ú –ö–ê–í–´–ß–ö–ò, –ù–û –ù–ï –í–°–ï –°–ò–ú–í–û–õ–´!
    const cleanCity = trimmedCity
        .replace(/^["'¬´¬ª]+/, '') // —É–¥–∞–ª—è–µ–º –≤ –Ω–∞—á–∞–ª–µ
        .replace(/["'¬´¬ª]+$/, '') // —É–¥–∞–ª—è–µ–º –≤ –∫–æ–Ω—Ü–µ
        .trim();
    
    return cleanCity;
},

    normalizeCountryName(countryName) {
        if (!countryName || typeof countryName !== 'string') return countryName;
        
        const trimmedCountry = countryName.trim();
        if (trimmedCountry.length === 0) return countryName;
        
        const lowerCountry = trimmedCountry.toLowerCase();
        
        if (countryNormalizationMap[lowerCountry]) {
            return countryNormalizationMap[lowerCountry];
        }
        
        for (const [key, value] of Object.entries(countryNormalizationMap)) {
            if (lowerCountry.includes(key) || key.includes(lowerCountry)) {
                return value;
            }
        }
        
        return trimmedCountry.charAt(0).toUpperCase() + trimmedCountry.slice(1);
    },
    
    // 13. –°–¢–ê–¢–ò–°–¢–ò–ö–ê –ö–≠–®–ê
    getGlobalCacheStats() {
        const fullProfiles = this.getGlobalProfiles(false);
        const demoProfiles = this.getGlobalProfiles(true);
        
        return {
            fullCache: {
                loaded: !!fullProfiles,
                profilesCount: fullProfiles ? fullProfiles.length : 0,
                countriesCount: this.getGlobalCountries(false).length
            },
            demoCache: {
                loaded: !!demoProfiles,
                profilesCount: demoProfiles ? demoProfiles.length : 0,
                countriesCount: this.getGlobalCountries(true).length
            },
            filterCacheKeys: globalFilterCache.keys().length,
            demoFilterCacheKeys: globalDemoCache.keys().filter(k => k.startsWith('demo:filter:')).length,
            subscriptionCacheCount: subscriptionCache.keys().length,
            channelCacheCount: channelSubscriptionCache.keys().length,
            userStatusCacheCount: userCacheStatus.keys().length
        };
    },
    
    // 14. –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –ì–õ–û–ë–ê–õ–¨–ù–´–• –ö–≠–®–ï–ô –ü–†–ò –°–¢–ê–†–¢–ï –ë–û–¢–ê
    async initializeGlobalCaches(db) {
        console.log('üöÄ [GLOBAL CACHE INIT] –ù–∞—á–∏–Ω–∞–µ–º –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é –≥–ª–æ–±–∞–ª—å–Ω—ã—Ö –∫—ç—à–µ–π...');
        
        try {
            // –ó–ê–ì–†–£–ñ–ê–ï–ú –°–ù–ê–ß–ê–õ–ê –î–ï–ú–û-–ö–≠–® (–æ–Ω –Ω—É–∂–µ–Ω –≤—Å–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º)
            if (!this.isGlobalDemoCacheLoaded()) {
                console.log('üîÑ [GLOBAL CACHE INIT] –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–µ–º–æ-–∫—ç—à...');
                await this.loadGlobalDemoCache(db);
            } else {
                console.log('‚úÖ [GLOBAL CACHE INIT] –î–µ–º–æ-–∫—ç—à —É–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω');
            }
            
            // –ü–û–õ–ù–´–ô –ö–≠–® –ë–£–î–ï–¢ –ó–ê–ì–†–£–ñ–ï–ù –ü–†–ò –ü–ï–†–í–û–ú –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–ï –° –ü–û–î–ü–ò–°–ö–û–ô
            console.log('‚è≥ [GLOBAL CACHE INIT] –ü–æ–ª–Ω—ã–π –∫—ç—à –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω –ø–æ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—é');
            
            globalCacheInitialized = true;
            console.log('‚úÖ [GLOBAL CACHE INIT] –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞');
            
            return true;
            
        } catch (error) {
            console.error('‚ùå [GLOBAL CACHE INIT] –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏:', error);
            return false;
        }
    },
    
    // 15. –õ–ï–ù–ò–í–ê–Ø –ó–ê–ì–†–£–ó–ö–ê –ü–û–õ–ù–û–ì–û –ö–≠–®–ê (–∫–æ–≥–¥–∞ –ø–µ—Ä–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å –ø–æ–¥–ø–∏—Å–∫–æ–π –∑–∞–ø—Ä–æ—Å–∏—Ç)
   async lazyLoadGlobalFullCache(db, userId = 'system') {
    // üîí –°–ò–õ–¨–ù–ê–Ø –ë–õ–û–ö–ò–†–û–í–ö–ê: –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—É—é –∑–∞–≥—Ä—É–∑–∫—É
    if (globalFullCacheLoading) {
        console.log('‚è≥ [LAZY GLOBAL CACHE] –ü–æ–ª–Ω—ã–π –∫—ç—à —É–∂–µ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è...');
        
        // –ñ–¥–µ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Ç–µ–∫—É—â–µ–π –∑–∞–≥—Ä—É–∑–∫–∏ (–¥–æ 2 –º–∏–Ω—É—Ç)
        const startWait = Date.now();
        while (globalFullCacheLoading && Date.now() - startWait < 120000) {
            console.log(`‚è≥ –û–∂–∏–¥–∞–µ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∑–∞–≥—Ä—É–∑–∫–∏... (${Math.round((Date.now() - startWait)/1000)}—Å)`);
            await new Promise(resolve => setTimeout(resolve, 5000));
        }
        
        if (globalFullCacheLoading) {
            console.log('‚ùå [LAZY GLOBAL CACHE] –¢–∞–π–º–∞—É—Ç –æ–∂–∏–¥–∞–Ω–∏—è –∑–∞–≥—Ä—É–∑–∫–∏');
            return false;
        }
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∑–∞–≥—Ä—É–∑–∏–ª—Å—è –ª–∏ –∫—ç—à –ø–æ–∫–∞ –º—ã –∂–¥–∞–ª–∏
        if (this.isGlobalFullCacheLoaded()) {
            console.log('‚úÖ [LAZY GLOBAL CACHE] –ö—ç—à –∑–∞–≥—Ä—É–∑–∏–ª—Å—è –ø–æ–∫–∞ –º—ã –∂–¥–∞–ª–∏');
            return true;
        }
    }
    
    // –ï–°–õ–ò –£–ñ–ï –ó–ê–ì–†–£–ñ–ï–ù
    if (this.isGlobalFullCacheLoaded()) {
        console.log('‚úÖ [LAZY GLOBAL CACHE] –ü–æ–ª–Ω—ã–π –∫—ç—à —É–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω');
        return true;
    }
    
    console.log(`üöÄ [LAZY GLOBAL CACHE] –ó–∞–ø—É—Å–∫–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É –ø–æ–ª–Ω–æ–≥–æ –∫—ç—à–∞ (–∏–Ω–∏—Ü–∏–∞—Ç–æ—Ä: ${userId})...`);
    globalFullCacheLoading = true;
    
    try {
        // üîî –£–í–ï–î–û–ú–õ–ï–ù–ò–ï –û –ó–ê–ì–†–£–ó–ö–ï (–µ—Å–ª–∏ –µ—Å—Ç—å –∫–æ–Ω—Ç–µ–∫—Å—Ç)
        if (userId !== 'system') {
            console.log(`üì¢ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ${userId} –∏–Ω–∏—Ü–∏–∏—Ä–æ–≤–∞–ª –∑–∞–≥—Ä—É–∑–∫—É –ø–æ–ª–Ω–æ–≥–æ –∫—ç—à–∞`);
        }
        
        // ==================== –≠–¢–ê–ü 1: –ó–ê–ì–†–£–ó–ö–ê –ò–ó FIRESTORE ====================
        console.log('üì• [FULL CACHE] –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–æ–ª–Ω—ã–π –∫—ç—à –∏–∑ Firestore...');
        
        const startTime = Date.now();
        let allProfiles = [];
        let lastDoc = null;
        let batchCount = 0;
        const BATCH_SIZE = 5000;
        const MAX_PROFILES = 70000;
        
        while (allProfiles.length < MAX_PROFILES) {
            batchCount++;
            console.log(`üì¶ [FULL BATCH ${batchCount}] –ó–∞–≥—Ä—É–∑–∫–∞ ${BATCH_SIZE} –∞–Ω–∫–µ—Ç...`);
            
            let query = db.collection("profiles")
                .orderBy("createdAt", "desc")
                .limit(BATCH_SIZE)
                .select(
                    "id", "name", "age", "country", "city", 
                    "about", "photoUrl", "telegram", "phone", 
                    "whatsapp", "photos", "createdAt"
                );
            
            if (lastDoc) {
                query = query.startAfter(lastDoc);
            }
            
            const snapshot = await query.get();
            const docsCount = snapshot.docs.length;
            
            readingStats.addRead('profiles', 'system', docsCount, 'firestore');
            
            if (docsCount === 0) {
                console.log(`‚úÖ [FULL LOAD COMPLETE] –ë–æ–ª—å—à–µ –∞–Ω–∫–µ—Ç –Ω–µ—Ç. –í—Å–µ–≥–æ: ${allProfiles.length}`);
                break;
            }
            
            const batchProfiles = snapshot.docs.map(doc => ({
                id: doc.id,
                ...doc.data()
            }));
            
            allProfiles.push(...batchProfiles);
            lastDoc = snapshot.docs[docsCount - 1];
            
            console.log(`üìä [FULL BATCH ${batchCount}] –ó–∞–≥—Ä—É–∂–µ–Ω–æ: ${docsCount} | –í—Å–µ–≥–æ: ${allProfiles.length}`);
            
            if (docsCount === BATCH_SIZE) {
                await new Promise(resolve => setTimeout(resolve, 100));
            }
            
            if (allProfiles.length % 20000 === 0) {
                const elapsed = (Date.now() - startTime) / 1000;
                const speed = (allProfiles.length / elapsed).toFixed(1);
                console.log(`üìà [FULL PROGRESS] ${allProfiles.length} –∞–Ω–∫–µ—Ç –∑–∞ ${elapsed.toFixed(1)}—Å (${speed}/—Å–µ–∫)`);
            }
        }
        
        const loadTime = ((Date.now() - startTime) / 1000).toFixed(2);
        console.log(`‚úÖ [FULL CACHE] –ó–∞–≥—Ä—É–∂–µ–Ω–æ ${allProfiles.length} –ø—Ä–æ—Ñ–∏–ª–µ–π –∑–∞ ${loadTime}—Å`);
        
        // ==================== –≠–¢–ê–ü 2: –ü–û–î–ì–û–¢–û–í–ö–ê –ò –ö–≠–®–ò–†–û–í–ê–ù–ò–ï ====================
        console.log('üîß [FULL CACHE] –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –∏ –∫—ç—à–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ...');
        
        // –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º –ø—Ä–æ—Ñ–∏–ª–∏
        const normalizedProfiles = allProfiles.map(profile => ({
            id: profile.id,
            n: profile.name || '',
            a: parseInt(profile.age) || 0,
            c: profile.country ? this.normalizeCountryName(profile.country) : '',
            ct: profile.city ? this.normalizeCityName(profile.city) : '',
            ab: profile.about ? profile.about.substring(0, 500) : "",
            p: profile.photoUrl || '',
            phs: profile.photos || [],
            tg: profile.telegram || '',
            tel: profile.phone || '',
            wa: profile.whatsapp || '',
            ca: profile.createdAt || new Date(),
            isDemo: false
        }));
        
        // –°–æ–±–∏—Ä–∞–µ–º —Å—Ç—Ä–∞–Ω—ã –∏ –≥–æ—Ä–æ–¥–∞
        const countriesSet = new Set();
        const citiesByCountry = new Map();
        
        normalizedProfiles.forEach(profile => {
            if (profile.c) {
                countriesSet.add(profile.c);
                
                if (profile.ct) {
                    if (!citiesByCountry.has(profile.c)) {
                        citiesByCountry.set(profile.c, new Set());
                    }
                    citiesByCountry.get(profile.c).add(profile.ct);
                }
            }
        });
        
        // –°–∂–∏–º–∞–µ–º –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –≥–ª–æ–±–∞–ª—å–Ω—ã–π –∫—ç—à
        const jsonString = JSON.stringify(normalizedProfiles);
        const compressed = zlib.gzipSync(jsonString);
        globalProfilesCache.set("profiles:all", compressed);
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å—Ç—Ä–∞–Ω—ã
        const sortedCountries = Array.from(countriesSet).sort();
        globalProfilesCache.set("profiles:countries", sortedCountries);
        
        // –í–ê–ñ–ù–û: –°–û–•–†–ê–ù–Ø–ï–ú –ì–û–†–û–î–ê –ü–û –°–¢–†–ê–ù–ê–ú
        console.log(`üó∫Ô∏è –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≥–æ—Ä–æ–¥–æ–≤ –¥–ª—è ${citiesByCountry.size} —Å—Ç—Ä–∞–Ω...`);
        citiesByCountry.forEach((citiesSet, country) => {
            const citiesArray = Array.from(citiesSet).sort();
            globalProfilesCache.set(`profiles:cities:${country}`, citiesArray);
        });
        
        const originalSizeMB = (jsonString.length / 1024 / 1024).toFixed(2);
        const compressedSizeMB = (compressed.length / 1024 / 1024).toFixed(2);
        const compressionRatio = Math.round((1 - compressed.length/jsonString.length) * 100);
        
        console.log(`üì¶ –°–∂–∞—Ç–∏–µ: ${originalSizeMB}MB ‚Üí ${compressedSizeMB}MB (${compressionRatio}%)`);
        console.log(`üåç –°—Ç—Ä–∞–Ω: ${countriesSet.size}`);
        console.log(`üèôÔ∏è –ì–æ—Ä–æ–¥–æ–≤ –ø–æ —Å—Ç—Ä–∞–Ω–∞–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ: ${citiesByCountry.size} —Å—Ç—Ä–∞–Ω`);
        
        // –°–æ–∑–¥–∞–µ–º –∏–Ω–¥–µ–∫—Å—ã
        console.log('üìá –°–æ–∑–¥–∞–µ–º –∏–Ω–¥–µ–∫—Å—ã –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞...');
        const indexResult = asyncFilterManager.createIndexes(normalizedProfiles);
        console.log(`‚úÖ –ò–Ω–¥–µ–∫—Å—ã: ${indexResult.countryIndexSize} —Å—Ç—Ä–∞–Ω, ${indexResult.countryCityIndexSize} –ø–∞—Ä`);
        
        // ==================== –≠–¢–ê–ü 3: –°–û–•–†–ê–ù–ï–ù–ò–ï –ù–ê –î–ò–°–ö ====================
        console.log('üíæ [FULL CACHE] –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ–ª–Ω—ã–π –∫—ç—à –Ω–∞ –¥–∏—Å–∫...');
        const saveSuccess = await diskCache.saveAllCaches(
            globalProfilesCache,
            globalDemoCache,
            globalFilterCache
        );
        
        if (saveSuccess) {
            console.log('‚úÖ [FULL CACHE] –ö—ç—à —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω –Ω–∞ –¥–∏—Å–∫');
        } else {
            console.log('‚ö†Ô∏è [FULL CACHE] –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫—ç—à –Ω–∞ –¥–∏—Å–∫');
        }
        
        // ==================== –≠–¢–ê–ü 4: –û–ß–ò–°–¢–ö–ê –ü–ê–ú–Ø–¢–ò ====================
        allProfiles.length = 0;
        allProfiles = null;
        normalizedProfiles.length = 0;
        
        if (global.gc) {
            global.gc();
            console.log('üßπ –°–±–æ—Ä–∫–∞ –º—É—Å–æ—Ä–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞');
        }
        
        // ==================== –≠–¢–ê–ü 5: –§–ò–ù–ê–õ–ò–ó–ê–¶–ò–Ø ====================
        const totalTime = Date.now() - startTime;
        console.log(`üéâ [LAZY GLOBAL CACHE] –ü–û–õ–ù–´–ô –ö–≠–® –£–°–ü–ï–®–ù–û –ó–ê–ì–†–£–ñ–ï–ù –ò –°–û–•–†–ê–ù–ï–ù!`);
        console.log(`‚è±Ô∏è  –û–±—â–µ–µ –≤—Ä–µ–º—è: ${(totalTime/1000).toFixed(1)} —Å–µ–∫—É–Ω–¥`);
        
        return true;
        
    } catch (error) {
        console.error('‚ùå [LAZY GLOBAL CACHE] –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:', error);
        console.error(error.stack);
        return false;
        
    } finally {
        globalFullCacheLoading = false;
        console.log(`üîì [LAZY GLOBAL CACHE] –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ —Å–Ω—è—Ç–∞`);
    }
}
};

// ===================== –û–ü–¢–ò–ú–ò–ó–ò–†–û–í–ê–ù–ù–ê–Ø –°–ò–°–¢–ï–ú–ê –§–ò–õ–¨–¢–†–ê–¶–ò–ò =====================

class AsyncFilterManager {
    constructor() {
        this.filterQueue = new PQueue({
            concurrency: SCALING_CONFIG.PERFORMANCE.MAX_CONCURRENT_FILTERS,
            timeout: SCALING_CONFIG.MESSAGE_QUEUE.TIMEOUT
        });
        
        // –ö—ç—à –¥–ª—è –±—ã—Å—Ç—Ä—ã—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ —á–∞—Å—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö —Ñ–∏–ª—å—Ç—Ä–æ–≤
        this.hotFilterCache = new Map();
        this.stats = {
            totalFilters: 0,
            indexHits: 0,
            cacheHits: 0,
            slowFilters: 0
        };
    }
    
    async filterProfilesAsync(profiles, filters, isDemo = false) {
        return this.filterQueue.add(async () => {
            this.stats.totalFilters++;
            
            console.log(`üîç [FILTER ${this.stats.totalFilters}] –ó–∞–ø—Ä–æ—Å (–¥–µ–º–æ: ${isDemo})`);
            console.log(`üìç –ü–∞—Ä–∞–º–µ—Ç—Ä—ã: —Å—Ç—Ä–∞–Ω–∞="${filters.country || '–Ω–µ—Ç'}", –≥–æ—Ä–æ–¥="${filters.city || '–Ω–µ—Ç'}", –≤–æ–∑—Ä–∞—Å—Ç="${filters.ageRange?.label || 'all'}"`);
            
            const filterKey = `country:${filters.country || 'all'}:age:${filters.ageRange?.label || 'all'}:city:${filters.city || 'all'}`;
            
            // 1. –ü–†–û–í–ï–†–ö–ê –ö–≠–®–ê –§–ò–õ–¨–¢–†–û–í (TTL: 24 —á–∞—Å–∞)
            const cached = cacheManager.getGlobalFilter(filterKey, isDemo);
            if (cached) {
                this.stats.cacheHits++;
                console.log(`‚úÖ [CACHE HIT] –ò–∑ –∫—ç—à–∞: ${cached.length} –ø—Ä–æ—Ñ–∏–ª–µ–π`);
                return cached;
            }
            
            console.log(`üîç [CACHE MISS] –ü—Ä–æ–º–∞—Ö: ${filterKey}`);
            console.log(`üìä –í—Å–µ–≥–æ –ø—Ä–æ—Ñ–∏–ª–µ–π: ${profiles.length} (–¥–µ–º–æ: ${isDemo})`);
            
            const startTime = Date.now();
            
            // 2. –ü–´–¢–ê–ï–ú–°–Ø –ò–°–ü–û–õ–¨–ó–û–í–ê–¢–¨ –ò–ù–î–ï–ö–°–´ –î–õ–Ø –°–í–ï–†–•–ë–´–°–¢–†–û–ô –§–ò–õ–¨–¢–†–ê–¶–ò–ò
            let filteredProfiles = [];
            
            if (filters.country || filters.city) {
                const indexedResult = this.applyFiltersWithIndex(profiles, filters);
                if (indexedResult !== null) {
                    filteredProfiles = indexedResult;
                    this.stats.indexHits++;
                    console.log(`üéØ [INDEX USED] –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω—ã –∏–Ω–¥–µ–∫—Å—ã`);
                }
            }
            
            // 3. –ï–°–õ–ò –ò–ù–î–ï–ö–°–´ –ù–ï –°–†–ê–ë–û–¢–ê–õ–ò - –ò–°–ü–û–õ–¨–ó–£–ï–ú –û–ü–¢–ò–ú–ò–ó–ò–†–û–í–ê–ù–ù–£–Æ –§–ò–õ–¨–¢–†–ê–¶–ò–Æ
            if (filteredProfiles.length === 0 && filteredProfiles !== null) {
                console.log(`üîç [STANDARD FILTER] –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—É—é —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—é`);
                
                if (profiles.length > 10000 && (filters.country || filters.city)) {
                    filteredProfiles = await this.applyFiltersParallel(profiles, filters);
                } else {
                    filteredProfiles = this.applyFiltersSequential(profiles, filters);
                }
            }
            
            const filterTime = Date.now() - startTime;
            
            // 4. –°–¢–ê–¢–ò–°–¢–ò–ö–ê –ò –°–û–•–†–ê–ù–ï–ù–ò–ï –†–ï–ó–£–õ–¨–¢–ê–¢–ê
            if (filteredProfiles.length > 0) {
                console.log(`‚úÖ [FILTER COMPLETE] –ù–∞–π–¥–µ–Ω–æ ${filteredProfiles.length} –ø—Ä–æ—Ñ–∏–ª–µ–π –∑–∞ ${filterTime}–º—Å`);
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –≥–ª–æ–±–∞–ª—å–Ω—ã–π –∫—ç—à —Ñ–∏–ª—å—Ç—Ä–æ–≤
                cacheManager.cacheGlobalFilter(filterKey, filteredProfiles, isDemo);
                console.log(`üíæ [CACHE SAVED] –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ –≤ –∫—ç—à (TTL: 24 —á–∞—Å–∞)`);
                
                // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
                const speedPer1000 = filterTime / (profiles.length / 1000);
                console.log(`üìà [SPEED] ${speedPer1000.toFixed(2)}–º—Å –Ω–∞ 1000 –ø—Ä–æ—Ñ–∏–ª–µ–π`);
                
                if (filterTime > 2000) {
                    this.stats.slowFilters++;
                    console.log(`‚ö†Ô∏è  [WARNING] –ú–µ–¥–ª–µ–Ω–Ω–∞—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è: ${(filterTime/1000).toFixed(2)}—Å`);
                }
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –≥–æ—Ä—è—á–∏–π –∫—ç—à –¥–ª—è —á–∞—Å—Ç—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
                if (filterTime < 1000 && filteredProfiles.length > 0) {
                    this.hotFilterCache.set(filterKey, {
                        profiles: filteredProfiles,
                        timestamp: Date.now(),
                        count: filteredProfiles.length
                    });
                }
            } else {
                console.log(`‚ùå [NO RESULTS] –ù–µ –Ω–∞–π–¥–µ–Ω–æ –ø—Ä–æ—Ñ–∏–ª–µ–π –∑–∞ ${filterTime}–º—Å`);
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø—É—Å—Ç–æ–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤ –∫—ç—à
                cacheManager.cacheGlobalFilter(filterKey, [], isDemo);
            }
            
            // 5. –ü–ï–†–ò–û–î–ò–ß–ï–°–ö–ò–ô –û–¢–ß–ï–¢ –°–¢–ê–¢–ò–°–¢–ò–ö–ò
            if (this.stats.totalFilters % 10 === 0) {
                this.printStats();
            }
            
            return filteredProfiles;
        });
    }
    
    // ==================== –ú–ï–¢–û–î –ò–ù–î–ï–ö–°–ù–û–ô –§–ò–õ–¨–¢–†–ê–¶–ò–ò ====================
    applyFiltersWithIndex(profiles, filters) {
        const startTime = Date.now();
        
        // –ü–æ–ª—É—á–∞–µ–º –∏–Ω–¥–µ–∫—Å—ã –∏–∑ –≥–ª–æ–±–∞–ª—å–Ω–æ–≥–æ –∫—ç—à–∞
        const countryCityIndex = globalProfilesCache.get("index:country_city");
        const countryIndex = globalProfilesCache.get("index:country");
        
        if (!countryCityIndex || !countryIndex) {
            console.log(`‚ö†Ô∏è [INDEX] –ò–Ω–¥–µ–∫—Å—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –≤ –∫—ç—à–µ`);
            return null;
        }
        
        const normalizedFilterCountry = filters.country ? cacheManager.normalizeCountryName(filters.country) : null;
        const normalizedFilterCity = filters.city ? cacheManager.normalizeCityName(filters.city) : null;
        const hasAgeFilter = filters.ageRange;
        const minAge = hasAgeFilter ? filters.ageRange.min : 0;
        const maxAge = hasAgeFilter ? filters.ageRange.max : 999;
        
        let profileIndexes = [];
        
        // –°–¶–ï–ù–ê–†–ò–ô 1: –°—Ç—Ä–∞–Ω–∞ + –ì–æ—Ä–æ–¥ (—Å–∞–º—ã–π –±—ã—Å—Ç—Ä—ã–π)
        if (normalizedFilterCountry && normalizedFilterCity) {
            const key = `${normalizedFilterCountry}:${normalizedFilterCity}`;
            profileIndexes = countryCityIndex.get(key) || [];
            
            if (profileIndexes.length > 0) {
                console.log(`‚ö° [INDEX 1] –°—Ç—Ä–∞–Ω–∞+–ì–æ—Ä–æ–¥ "${key}": ${profileIndexes.length} –ø—Ä–æ—Ñ–∏–ª–µ–π`);
            } else {
                console.log(`‚ö° [INDEX 1] –°—Ç—Ä–∞–Ω–∞+–ì–æ—Ä–æ–¥ "${key}": –Ω–µ –Ω–∞–π–¥–µ–Ω–æ`);
                return [];
            }
        }
        // –°–¶–ï–ù–ê–†–ò–ô 2: –¢–æ–ª—å–∫–æ –°—Ç—Ä–∞–Ω–∞
        else if (normalizedFilterCountry && !normalizedFilterCity) {
            profileIndexes = countryIndex.get(normalizedFilterCountry) || [];
            
            if (profileIndexes.length > 0) {
                console.log(`‚ö° [INDEX 2] –¢–æ–ª—å–∫–æ —Å—Ç—Ä–∞–Ω–∞ "${normalizedFilterCountry}": ${profileIndexes.length} –ø—Ä–æ—Ñ–∏–ª–µ–π`);
            } else {
                console.log(`‚ö° [INDEX 2] –¢–æ–ª—å–∫–æ —Å—Ç—Ä–∞–Ω–∞ "${normalizedFilterCountry}": –Ω–µ –Ω–∞–π–¥–µ–Ω–æ`);
                return [];
            }
        }
        // –°–¶–ï–ù–ê–†–ò–ô 3: –¢–æ–ª—å–∫–æ –ì–æ—Ä–æ–¥ (–Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –∏–Ω–¥–µ–∫—Å–æ–º - –Ω—É–∂–µ–Ω –ø–æ–ª–Ω—ã–π –ø–µ—Ä–µ–±–æ—Ä)
        else if (!normalizedFilterCountry && normalizedFilterCity) {
            console.log(`‚ö†Ô∏è [INDEX 3] –¢–æ–ª—å–∫–æ –≥–æ—Ä–æ–¥ "${normalizedFilterCity}" - –∏–Ω–¥–µ–∫—Å –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è`);
            return null;
        }
        // –°–¶–ï–ù–ê–†–ò–ô 4: –ù–µ—Ç —Ñ–∏–ª—å—Ç—Ä–æ–≤ –ø–æ —Å—Ç—Ä–∞–Ω–µ/–≥–æ—Ä–æ–¥—É
        else {
            console.log(`‚ö†Ô∏è [INDEX 4] –ù–µ—Ç —Ñ–∏–ª—å—Ç—Ä–æ–≤ –ø–æ —Å—Ç—Ä–∞–Ω–µ/–≥–æ—Ä–æ–¥—É`);
            return null;
        }
        
        // –ü–æ–ª—É—á–∞–µ–º –ø—Ä–æ—Ñ–∏–ª–∏ –ø–æ –∏–Ω–¥–µ–∫—Å–∞–º
        const indexedProfiles = new Array(profileIndexes.length);
        for (let i = 0; i < profileIndexes.length; i++) {
            indexedProfiles[i] = profiles[profileIndexes[i]];
        }
        
        // –ü—Ä–∏–º–µ–Ω—è–µ–º —Ñ–∏–ª—å—Ç—Ä –ø–æ –≤–æ–∑—Ä–∞—Å—Ç—É –µ—Å–ª–∏ –µ—Å—Ç—å
        let finalProfiles = indexedProfiles;
        if (hasAgeFilter && indexedProfiles.length > 0) {
            finalProfiles = [];
            for (let i = 0; i < indexedProfiles.length; i++) {
                const profile = indexedProfiles[i];
                const age = parseInt(profile.a) || 0;
                if (age >= minAge && age <= maxAge) {
                    finalProfiles.push(profile);
                }
            }
            console.log(`‚ö° [INDEX AGE] –ü–æ—Å–ª–µ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –ø–æ –≤–æ–∑—Ä–∞—Å—Ç—É: ${finalProfiles.length} –ø—Ä–æ—Ñ–∏–ª–µ–π`);
        }
        
        const indexTime = Date.now() - startTime;
        console.log(`‚úÖ [INDEX DONE] ${finalProfiles.length} –ø—Ä–æ—Ñ–∏–ª–µ–π –∑–∞ ${indexTime}–º—Å`);
        
        return finalProfiles;
    }
    
    // ==================== –ü–ê–†–ê–õ–õ–ï–õ–¨–ù–ê–Ø –§–ò–õ–¨–¢–†–ê–¶–ò–Ø ====================
    async applyFiltersParallel(profiles, filters) {
        return new Promise((resolve) => {
            console.log(`üß© [PARALLEL START] –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–∞—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è ${profiles.length} –ø—Ä–æ—Ñ–∏–ª–µ–π`);
            const startTime = Date.now();
            
            const normalizedFilterCountry = filters.country ? cacheManager.normalizeCountryName(filters.country) : null;
            const normalizedFilterCity = filters.city ? cacheManager.normalizeCityName(filters.city) : null;
            const hasAgeFilter = filters.ageRange;
            const minAge = hasAgeFilter ? filters.ageRange.min : 0;
            const maxAge = hasAgeFilter ? filters.ageRange.max : 999;
            
            // –†–∞–∑–±–∏–≤–∞–µ–º –Ω–∞ 4 —á–∞—Å—Ç–∏ (–æ–ø—Ç–∏–º–∞–ª—å–Ω–æ –¥–ª—è Node.js)
            const CHUNKS = 4;
            const chunkSize = Math.ceil(profiles.length / CHUNKS);
            const allResults = [];
            let completedChunks = 0;
            
            console.log(`üß© [PARALLEL CONFIG] ${CHUNKS} —á–∞–Ω–∫–æ–≤ –ø–æ ~${chunkSize} –ø—Ä–æ—Ñ–∏–ª–µ–π`);
            
            for (let chunkIndex = 0; chunkIndex < CHUNKS; chunkIndex++) {
                const startIdx = chunkIndex * chunkSize;
                const endIdx = Math.min(startIdx + chunkSize, profiles.length);
                
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º setImmediate –¥–ª—è –Ω–µ–±–ª–æ–∫–∏—Ä—É—é—â–µ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏
                setImmediate(() => {
                    const chunk = profiles.slice(startIdx, endIdx);
                    const chunkResults = [];
                    
                    // –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –≤–Ω—É—Ç—Ä–∏ —á–∞–Ω–∫–∞
                    for (let i = 0; i < chunk.length; i++) {
                        const profile = chunk[i];
                        
                        // –ë—ã—Å—Ç—Ä–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç—Ä–∞–Ω—ã
                        if (normalizedFilterCountry) {
                            const profileCountry = profile.c;
                            if (!profileCountry) continue;
                            
                            if (profileCountry !== normalizedFilterCountry) {
                                const normalizedProfileCountry = cacheManager.normalizeCountryName(profileCountry);
                                if (normalizedProfileCountry !== normalizedFilterCountry) {
                                    const cleanFilter = normalizedFilterCountry.toLowerCase().trim();
                                    const cleanProfile = normalizedProfileCountry.toLowerCase().trim();
                                    if (cleanProfile !== cleanFilter) continue;
                                }
                            }
                        }
                        
                        // –ë—ã—Å—Ç—Ä–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –≥–æ—Ä–æ–¥–∞
                        if (normalizedFilterCity) {
                            const profileCity = profile.ct;
                            if (!profileCity || profileCity !== normalizedFilterCity) {
                                continue;
                            }
                        }
                        
                        // –ë—ã—Å—Ç—Ä–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –≤–æ–∑—Ä–∞—Å—Ç–∞
                        if (hasAgeFilter) {
                            const age = parseInt(profile.a) || 0;
                            if (age < minAge || age > maxAge) {
                                continue;
                            }
                        }
                        
                        chunkResults.push(profile);
                    }
                    
                    // –î–æ–±–∞–≤–ª—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
                    allResults.push(...chunkResults);
                    completedChunks++;
                    
                    console.log(`üß© [CHUNK ${chunkIndex + 1}/${CHUNKS}] –ó–∞–≤–µ—Ä—à–µ–Ω: ${chunkResults.length} –ø—Ä–æ—Ñ–∏–ª–µ–π`);
                    
                    // –ö–æ–≥–¥–∞ –≤—Å–µ —á–∞–Ω–∫–∏ –∑–∞–≤–µ—Ä—à–µ–Ω—ã
                    if (completedChunks === CHUNKS) {
                        const parallelTime = Date.now() - startTime;
                        console.log(`‚úÖ [PARALLEL DONE] –í—Å–µ —á–∞–Ω–∫–∏ –∑–∞–≤–µ—Ä—à–µ–Ω—ã –∑–∞ ${parallelTime}–º—Å`);
                        console.log(`üìä [PARALLEL RESULT] –í—Å–µ–≥–æ –Ω–∞–π–¥–µ–Ω–æ: ${allResults.length} –ø—Ä–æ—Ñ–∏–ª–µ–π`);
                        
                        resolve(allResults);
                    }
                });
            }
        });
    }
    
    // ==================== –ü–û–°–õ–ï–î–û–í–ê–¢–ï–õ–¨–ù–ê–Ø –§–ò–õ–¨–¢–†–ê–¶–ò–Ø ====================
    applyFiltersSequential(profiles, filters) {
        console.log(`üîç [SEQUENTIAL] –ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–∞—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è ${profiles.length} –ø—Ä–æ—Ñ–∏–ª–µ–π`);
        const startTime = Date.now();
        
        const normalizedFilterCountry = filters.country ? cacheManager.normalizeCountryName(filters.country) : null;
        const normalizedFilterCity = filters.city ? cacheManager.normalizeCityName(filters.city) : null;
        const hasAgeFilter = filters.ageRange;
        const minAge = hasAgeFilter ? filters.ageRange.min : 0;
        const maxAge = hasAgeFilter ? filters.ageRange.max : 999;
        
        const results = [];
        let checked = 0;
        
        for (let i = 0; i < profiles.length; i++) {
            checked++;
            
            // –ü—Ä–æ–≥—Ä–µ—Å—Å –∫–∞–∂–¥—ã–µ 5000 –ø—Ä–æ—Ñ–∏–ª–µ–π
            if (checked % 5000 === 0) {
                console.log(`üìä [PROGRESS] –ü—Ä–æ–≤–µ—Ä–µ–Ω–æ ${checked}/${profiles.length} –ø—Ä–æ—Ñ–∏–ª–µ–π`);
            }
            
            const profile = profiles[i];
            
            // –ë—ã—Å—Ç—Ä–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç—Ä–∞–Ω—ã
            if (normalizedFilterCountry) {
                const profileCountry = profile.c;
                if (!profileCountry) continue;
                
                if (profileCountry !== normalizedFilterCountry) {
                    const normalizedProfileCountry = cacheManager.normalizeCountryName(profileCountry);
                    if (normalizedProfileCountry !== normalizedFilterCountry) {
                        const cleanFilter = normalizedFilterCountry.toLowerCase().trim();
                        const cleanProfile = normalizedProfileCountry.toLowerCase().trim();
                        if (cleanProfile !== cleanFilter) continue;
                    }
                }
            }
            
            // –ë—ã—Å—Ç—Ä–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –≥–æ—Ä–æ–¥–∞
            if (normalizedFilterCity) {
                const profileCity = profile.ct;
                if (!profileCity || profileCity !== normalizedFilterCity) {
                    continue;
                }
            }
            
            // –ë—ã—Å—Ç—Ä–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –≤–æ–∑—Ä–∞—Å—Ç–∞
            if (hasAgeFilter) {
                const age = parseInt(profile.a) || 0;
                if (age < minAge || age > maxAge) {
                    continue;
                }
            }
            
            results.push(profile);
        }
        
        const sequentialTime = Date.now() - startTime;
        console.log(`‚úÖ [SEQUENTIAL DONE] ${results.length} –ø—Ä–æ—Ñ–∏–ª–µ–π –∑–∞ ${sequentialTime}–º—Å`);
        
        return results;
    }
    
    // ==================== –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –ú–ï–¢–û–î–´ ====================
    
    // –°–æ–∑–¥–∞–Ω–∏–µ –∏–Ω–¥–µ–∫—Å–æ–≤ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∫—ç—à–∞
    createIndexes(profiles) {
        console.log(`üìá [INDEX CREATION] –°–æ–∑–¥–∞–Ω–∏–µ –∏–Ω–¥–µ–∫—Å–æ–≤ –¥–ª—è ${profiles.length} –ø—Ä–æ—Ñ–∏–ª–µ–π`);
        const startTime = Date.now();
        
        const countryCityIndex = new Map();
        const countryIndex = new Map();
        
        let indexedProfiles = 0;
        
        for (let i = 0; i < profiles.length; i++) {
            const profile = profiles[i];
            const country = profile.c;
            
            if (country) {
                // –ò–Ω–¥–µ–∫—Å –ø–æ —Å—Ç—Ä–∞–Ω–µ
                if (!countryIndex.has(country)) {
                    countryIndex.set(country, []);
                }
                countryIndex.get(country).push(i);
                
                // –ò–Ω–¥–µ–∫—Å –ø–æ —Å—Ç—Ä–∞–Ω–µ+–≥–æ—Ä–æ–¥—É
                const city = profile.ct;
                if (city) {
                    const key = `${country}:${city}`;
                    if (!countryCityIndex.has(key)) {
                        countryCityIndex.set(key, []);
                    }
                    countryCityIndex.get(key).push(i);
                }
                
                indexedProfiles++;
            }
            
            // –ü—Ä–æ–≥—Ä–µ—Å—Å –∫–∞–∂–¥—ã–µ 10000 –ø—Ä–æ—Ñ–∏–ª–µ–π
            if (i % 10000 === 0 && i > 0) {
                console.log(`üìä [INDEX PROGRESS] –û–±—Ä–∞–±–æ—Ç–∞–Ω–æ ${i}/${profiles.length} –ø—Ä–æ—Ñ–∏–ª–µ–π`);
            }
        }
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–Ω–¥–µ–∫—Å—ã –≤ –≥–ª–æ–±–∞–ª—å–Ω—ã–π –∫—ç—à
        globalProfilesCache.set("index:country_city", countryCityIndex);
        globalProfilesCache.set("index:country", countryIndex);
        
        const indexTime = Date.now() - startTime;
        
        console.log(`‚úÖ [INDEX CREATION DONE] –ò–Ω–¥–µ–∫—Å—ã —Å–æ–∑–¥–∞–Ω—ã –∑–∞ ${indexTime}–º—Å`);
        console.log(`üìä [INDEX STATS] –û–±—Ä–∞–±–æ—Ç–∞–Ω–æ –ø—Ä–æ—Ñ–∏–ª–µ–π: ${indexedProfiles}/${profiles.length}`);
        console.log(`üìä [INDEX STATS] –£–Ω–∏–∫–∞–ª—å–Ω—ã—Ö —Å—Ç—Ä–∞–Ω: ${countryIndex.size}`);
        console.log(`üìä [INDEX STATS] –£–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –ø–∞—Ä —Å—Ç—Ä–∞–Ω–∞+–≥–æ—Ä–æ–¥: ${countryCityIndex.size}`);
        
        // –ü—Ä–∏–º–µ—Ä—ã –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
        const sampleCountries = Array.from(countryIndex.keys()).slice(0, 3);
        sampleCountries.forEach(country => {
            console.log(`üìã [INDEX SAMPLE] ${country}: ${countryIndex.get(country).length} –ø—Ä–æ—Ñ–∏–ª–µ–π`);
        });
        
        return {
            countryIndexSize: countryIndex.size,
            countryCityIndexSize: countryCityIndex.size,
            timeMs: indexTime
        };
    }
    
    // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ä–∞–±–æ—Ç—ã
    printStats() {
        console.log(`üìä ========== FILTER MANAGER STATS ==========`);
        console.log(`üìä –í—Å–µ–≥–æ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–π: ${this.stats.totalFilters}`);
        console.log(`üìä –ü–æ–ø–∞–¥–∞–Ω–∏—è –≤ –∫—ç—à: ${this.stats.cacheHits} (${((this.stats.cacheHits/this.stats.totalFilters)*100).toFixed(1)}%)`);
        console.log(`üìä –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∏–Ω–¥–µ–∫—Å–æ–≤: ${this.stats.indexHits}`);
        console.log(`üìä –ú–µ–¥–ª–µ–Ω–Ω—ã—Ö —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–π (>2—Å): ${this.stats.slowFilters}`);
        console.log(`üìä –†–∞–∑–º–µ—Ä –≥–æ—Ä—è—á–µ–≥–æ –∫—ç—à–∞: ${this.hotFilterCache.size}`);
        console.log(`üìä ==========================================`);
    }
    
    // –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä–æ–≥–æ –≥–æ—Ä—è—á–µ–≥–æ –∫—ç—à–∞
    cleanupHotCache() {
        const now = Date.now();
        let cleaned = 0;
        
        this.hotFilterCache.forEach((value, key) => {
            if (now - value.timestamp > 3600000) { // 1 —á–∞—Å
                this.hotFilterCache.delete(key);
                cleaned++;
            }
        });
        
        if (cleaned > 0) {
            console.log(`üßπ [HOT CACHE CLEANUP] –û—á–∏—â–µ–Ω–æ ${cleaned} —Å—Ç–∞—Ä—ã—Ö –∑–∞–ø–∏—Å–µ–π`);
        }
    }
}

const asyncFilterManager = new AsyncFilterManager();

// –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞ –≥–æ—Ä—è—á–µ–≥–æ –∫—ç—à–∞
setInterval(() => {
    asyncFilterManager.cleanupHotCache();
    asyncFilterManager.printStats();
}, 300000); // –ö–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç





// ===================== –ì–õ–ê–í–ù–´–ô –ú–û–î–£–õ–¨ –ë–û–¢–ê =====================
module.exports = (bot, db) => {
    let startModule = null;
    
    // –û–ß–ï–†–ï–î–¨ –°–û–û–ë–©–ï–ù–ò–ô –î–õ–Ø –ú–ê–°–®–¢–ê–ë–ò–†–û–í–ê–ù–ò–Ø
    const messageQueue = new PQueue({
        concurrency: SCALING_CONFIG.MESSAGE_QUEUE.CONCURRENCY,
        interval: SCALING_CONFIG.MESSAGE_QUEUE.INTERVAL,
        intervalCap: SCALING_CONFIG.MESSAGE_QUEUE.INTERVAL_CAP,
        timeout: SCALING_CONFIG.MESSAGE_QUEUE.TIMEOUT,
        throwOnTimeout: false
    });

    messageQueue.on('active', () => {
        if (messageQueue.size > 10) {
            console.log(`üìä [QUEUE] –ê–∫—Ç–∏–≤–Ω—ã–µ: ${messageQueue.pending} | –û–∂–∏–¥–∞–Ω–∏–µ: ${messageQueue.size}`);
        }
    });

    // Rate Limiter –¥–ª—è –∑–∞—â–∏—Ç—ã –æ—Ç —Å–ø–∞–º–∞
    const limiter = new RateLimiter({
        window: 1000,
        limit: 8,
        keyGenerator: (ctx) => `${ctx.from.id}:${ctx.updateType}`,
        onLimitExceeded: (ctx) => {
            console.log(`‚ö†Ô∏è [RATE LIMIT] –õ–∏–º–∏—Ç –¥–ª—è ${ctx.from.id}`);
            return ctx.reply("‚ö†Ô∏è –°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–æ–≤, –ø–æ–¥–æ–∂–¥–∏—Ç–µ...");
        },
    });

    bot.use(limiter);

    // ===================== –û–ü–¢–ò–ú–ò–ó–ò–†–û–í–ê–ù–ù–´–ï –§–£–ù–ö–¶–ò–ò –ü–†–û–í–ï–†–ö–ò –ü–û–î–ü–ò–°–û–ö =====================
    
 
// ================= 5. –§–£–ù–ö–¶–ò–Ø –ü–†–û–í–ï–†–ö–ò –ü–û–î–ü–ò–°–ö–ò –ù–ê –ö–ê–ù–ê–õ =================
const checkChannelSubscription = async (ctx) => {
  try {
    const userId = ctx.from.id;
    const channelId = "-1001933124424"; // –í–∞—à —Ä–µ–∞–ª—å–Ω—ã–π Chat ID
    
    const chatMember = await ctx.telegram.getChatMember(channelId, userId);

    const isSubscribed =
      chatMember.status === "member" ||
      chatMember.status === "administrator" ||
      chatMember.status === "creator";

    return isSubscribed;
  } catch (error) {
    console.error("–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ–¥–ø–∏—Å–∫–∏ –Ω–∞ –∫–∞–Ω–∞–ª:", error);
    return false;
  }
};
    // 2. –§–£–ù–ö–¶–ò–Ø –ü–†–û–í–ï–†–ö–ò –ü–û–î–ü–ò–°–ö–ò (—Å –∫—ç—à–µ–º –Ω–∞ 24 —á–∞—Å–∞)
    const checkSubscription = async (userId) => {
        try {
            console.log(`üîç [SUBSCRIPTION] –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–ø–∏—Å–∫–∏  ${userId}`);
            
            // –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–±—É–µ–º –ø–æ–ª—É—á–∏—Ç—å –∏–∑ –∫—ç—à–∞ (24 —á–∞—Å–∞)
            const cachedSubscription = cacheManager.getCachedSubscription(userId);
            if (cachedSubscription !== undefined) {
                console.log(`‚úÖ [SUBSCRIPTION CACHE HIT] –ü–æ–¥–ø–∏—Å–∫–∞ –∏–∑ –∫—ç—à–∞: ${cachedSubscription}`);
                readingStats.addRead('subscriptions', userId, 1, 'cache');
                return cachedSubscription;
            }
            
            console.log(`üîç [SUBSCRIPTION CACHE MISS] –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –∏–∑ Firestore –¥–ª—è ${userId}`);
            readingStats.addRead('subscriptions', userId, 1, 'firestore');
            
            const subRef = db.collection('subscriptions').doc(userId.toString());
            const doc = await subRef.get();
            
            if (!doc.exists) {
                console.log(`‚ùå [SUBSCRIPTION] –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –≤ –ë–î –¥–ª—è ${userId}`);
                cacheManager.cacheSubscription(userId, false);
                return false;
            }
            
            const subData = doc.data();
            const isActive = subData.isActive && subData.endDate.toDate() > new Date();
            
            console.log(`‚úÖ [SUBSCRIPTION] –ü–æ–¥–ø–∏—Å–∫–∞ –∏–∑ –ë–î –¥–ª—è ${userId}: ${isActive}`);
            
            cacheManager.cacheSubscription(userId, isActive);
            return isActive;
            
        } catch (error) {
            console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ–¥–ø–∏—Å–∫–∏:', error);
            
            // –ü—Ä–∏ –æ—à–∏–±–∫–µ —Å—á–∏—Ç–∞–µ–º, —á—Ç–æ –ø–æ–¥–ø–∏—Å–∫–∏ –Ω–µ—Ç, –Ω–æ –∫—ç—à–∏—Ä—É–µ–º –Ω–∞ 1 —á–∞—Å
            cacheManager.cacheSubscription(userId, false);
            return false;
        }
    };
    
    // 3. –§–£–ù–ö–¶–ò–Ø –ü–†–û–í–ï–†–ö–ò –ò –û–ë–ù–û–í–õ–ï–ù–ò–Ø –ö–≠–®–ê
    const ensureProperCache = async (ctx, forceRefresh = false) => {
        const userId = ctx.from.id;
        
        console.log(`üîç [ENSURE CACHE] –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–ª—è ${userId} (force: ${forceRefresh})`);
        
        // üî• –í–°–ï–ì–î–ê –û–ß–ò–©–ê–ï–ú –°–¢–ê–†–´–ï –ö–≠–®–ò –ü–†–ò –ü–†–û–í–ï–†–ö–ï
        if (forceRefresh) {
            subscriptionCache.del(`subscription:${userId}`);
            channelSubscriptionCache.del(`channel:${userId}`);
        }
        
        // üî• –í–°–ï–ì–î–ê –ü–†–û–í–ï–†–Ø–ï–ú –ü–û–î–ü–ò–°–ö–£ –ò –ö–ê–ù–ê–õ –ó–ê–ù–û–í–û
        const hasSubscription = await checkSubscription(userId);
        const hasChannelSubscription = await checkChannelSubscription(ctx);
        const hasFullAccess = hasSubscription && hasChannelSubscription;
        
        const cacheType = hasFullAccess ? 'full' : 'demo';
        
        console.log(`‚úÖ [FRESH CHECK] ${userId}: –ø–æ–¥–ø–∏—Å–∫–∞=${hasSubscription}, –∫–∞–Ω–∞–ª=${hasChannelSubscription}, –¥–æ—Å—Ç—É–ø=${cacheType}`);
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å—Ç–∞—Ç—É—Å
        cacheManager.setUserCacheStatus(userId, cacheType);
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å–µ—Å—Å–∏—é
        if (!ctx.session) ctx.session = {};
        ctx.session.fullAccessCache = {
            value: hasFullAccess,
            timestamp: Date.now(),
            subscription: hasSubscription,
            channel: hasChannelSubscription
        };
        
        ctx.session.cacheSession = {
            type: cacheType,
            timestamp: Date.now(),
            fullAccess: hasFullAccess
        };
        
        // üî• –ï–°–õ–ò –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–¨ –° –ü–û–õ–ù–´–ú –î–û–°–¢–£–ü–û–ú, –ü–†–û–í–ï–†–Ø–ï–ú –ì–õ–û–ë–ê–õ–¨–ù–´–ô –ü–û–õ–ù–´–ô –ö–≠–®
        if (hasFullAccess && !cacheManager.isGlobalFullCacheLoaded()) {
            console.log(`üöÄ [GLOBAL FULL CACHE NEEDED] –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ${userId} –∏–º–µ–µ—Ç –ø–æ–ª–Ω—ã–π –¥–æ—Å—Ç—É–ø, –ø—Ä–æ–≤–µ—Ä—è–µ–º –≥–ª–æ–±–∞–ª—å–Ω—ã–π –∫—ç—à`);
            
            // –ó–ê–ì–†–£–ñ–ê–ï–ú –ì–õ–û–ë–ê–õ–¨–ù–´–ô –ü–û–õ–ù–´–ô –ö–≠–® –í –§–û–ù–ï
            setTimeout(async () => {
                try {
                    await cacheManager.lazyLoadGlobalFullCache(db, userId);
                } catch (error) {
                    console.error(`‚ùå [GLOBAL FULL CACHE ERROR] –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–ª—è ${userId}:`, error);
                }
            }, 1000);
        }
        
        return cacheType;
    };
    
// ===================== –§–£–ù–ö–¶–ò–Ø –ü–†–û–í–ï–†–ö–ò –ü–û–õ–ù–û–ì–û –î–û–°–¢–£–ü–ê =====================
const checkFullAccess = async (ctx, forceRefresh = false) => {
    const userId = ctx.from.id;
    
    // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å–µ—Å—Å–∏–æ–Ω–Ω–æ–µ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ
    if (!forceRefresh && ctx.session?.fullAccessCache) {
        const accessCache = ctx.session.fullAccessCache;
        const accessAge = Date.now() - accessCache.timestamp;
        
        // –ö—ç—à –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω 10 –º–∏–Ω—É—Ç –¥–ª—è –∫–∞–Ω–∞–ª–∞, 60 –º–∏–Ω—É—Ç –¥–ª—è –ø–æ–¥–ø–∏—Å–∫–∏
        if (accessAge < 10 * 60 * 1000) {
            console.log(`‚úÖ [FULL ACCESS CACHE] –ò—Å–ø–æ–ª—å–∑—É–µ–º –∫—ç—à –¥–ª—è ${userId}: ${accessCache.value}`);
            return accessCache.value;
        }
    }
    
    try {
        // üî• –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô –§–ò–ö–°: –ü–†–û–í–ï–†–Ø–ï–ú –û–ë–ê –£–°–õ–û–í–ò–Ø
        const [hasSubscription, hasChannelSubscription] = await Promise.all([
            checkSubscription(userId),
            checkChannelSubscription(ctx)
        ]);
        
        const hasFullAccess = hasSubscription && hasChannelSubscription;
        
        console.log(`üìä [FULL ACCESS] ${userId}: –ø–æ–¥–ø–∏—Å–∫–∞=${hasSubscription}, –∫–∞–Ω–∞–ª=${hasChannelSubscription}, –ø–æ–ª–Ω—ã–π –¥–æ—Å—Ç—É–ø=${hasFullAccess}`);
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ —Å–µ—Å—Å–∏–æ–Ω–Ω—ã–π –∫—ç—à
        if (!ctx.session) ctx.session = {};
        ctx.session.fullAccessCache = {
            value: hasFullAccess,
            timestamp: Date.now(),
            subscription: hasSubscription,
            channel: hasChannelSubscription
        };
        
        // üî• –ï–°–õ–ò –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–¨ –° –ü–û–õ–ù–´–ú –î–û–°–¢–£–ü–û–ú, –ü–†–û–í–ï–†–Ø–ï–ú –ì–õ–û–ë–ê–õ–¨–ù–´–ô –ü–û–õ–ù–´–ô –ö–≠–®
        if (hasFullAccess && !cacheManager.isGlobalFullCacheLoaded()) {
            console.log(`üöÄ [GLOBAL FULL CACHE NEEDED] –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ${userId} –∏–º–µ–µ—Ç –ø–æ–ª–Ω—ã–π –¥–æ—Å—Ç—É–ø, –ø—Ä–æ–≤–µ—Ä—è–µ–º –≥–ª–æ–±–∞–ª—å–Ω—ã–π –∫—ç—à`);
            
            // –ó–ê–ì–†–£–ñ–ê–ï–ú –ì–õ–û–ë–ê–õ–¨–ù–´–ô –ü–û–õ–ù–´–ô –ö–≠–® –í –§–û–ù–ï
            setTimeout(async () => {
                try {
                    await cacheManager.lazyLoadGlobalFullCache(db, userId);
                } catch (error) {
                    console.error(`‚ùå [GLOBAL FULL CACHE ERROR] –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–ª—è ${userId}:`, error);
                }
            }, 1000);
        }
        
        return hasFullAccess;
        
    } catch (error) {
        console.error(`‚ùå [FULL ACCESS ERROR] –û—à–∏–±–∫–∞ –¥–ª—è ${userId}:`, error);
        
        // –ü—Ä–∏ –æ—à–∏–±–∫–µ - –¥–µ–º–æ
        if (!ctx.session) ctx.session = {};
        ctx.session.fullAccessCache = {
            value: false,
            timestamp: Date.now(),
            error: error.message
        };
        
        return false;
    }
};
    
    // ===================== –°–ò–°–¢–ï–ú–ê –£–ü–†–ê–í–õ–ï–ù–ò–Ø –°–û–û–ë–©–ï–ù–ò–Ø–ú–ò =====================
    const chatStorage = {
        messages: new Map(),
        mainMenu: new Map(),
        userState: new Map(),
        messageTimestamps: new Map(),
        countryKeyboard: new Map(),
        cityKeyboard: new Map(),
    };

    setInterval(() => {
        const now = Date.now();
        let cleanedCount = 0;
        
        chatStorage.messages.forEach((messages, chatId) => {
            messages.forEach(messageId => {
                if (now - (chatStorage.messageTimestamps.get(messageId) || 0) > SCALING_CONFIG.PERFORMANCE.MESSAGE_TTL) {
                    messages.delete(messageId);
                    chatStorage.messageTimestamps.delete(messageId);
                    cleanedCount++;
                }
            });
            
            if (messages.size === 0) {
                chatStorage.messages.delete(chatId);
            }
        });
        
        if (cleanedCount > 0) {
            console.log(`üßπ [CLEANUP] –û—á–∏—â–µ–Ω–æ ${cleanedCount} —Å–æ–æ–±—â–µ–Ω–∏–π`);
        }
    }, 3600000);

// ===================== –û–ü–¢–ò–ú–ò–ó–ò–†–û–í–ê–ù–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø –ü–û–õ–£–ß–ï–ù–ò–Ø –°–¢–†–ê–ù =====================
const getUniqueCountries = async (isDemo = false) => {
    try {
        console.log(`üîç [COUNTRIES] –ó–∞–ø—Ä–æ—Å —Å–ø–∏—Å–∫–∞ —Å—Ç—Ä–∞–Ω (–¥–µ–º–æ: ${isDemo})`);
        
        // üî• –í–ê–ñ–ù–û: –ò–°–ü–û–õ–¨–ó–£–ï–ú –ì–õ–û–ë–ê–õ–¨–ù–´–ô –ö–≠–®
        const cachedCountries = cacheManager.getGlobalCountries(isDemo);
        
        if (cachedCountries && cachedCountries.length > 0) {
            console.log(`‚úÖ [COUNTRIES] –°—Ç—Ä–∞–Ω—ã –∏–∑ –≥–ª–æ–±–∞–ª—å–Ω–æ–≥–æ –∫—ç—à–∞: ${cachedCountries.length}`);
            readingStats.addRead('countries', null, 1, 'cache');
            return cachedCountries;
        }
        
        // üî• –ï–°–õ–ò –î–ï–ú–û-–ö–≠–® –ü–£–°–¢, –ü–û–ö–ê–ó–´–í–ê–ï–ú –°–û–û–ë–©–ï–ù–ò–ï –û –ó–ê–ì–†–£–ó–ö–ï
        if (isDemo && !cacheManager.isGlobalDemoCacheLoaded()) {
            console.log(`‚ö†Ô∏è [DEMO COUNTRIES] –î–µ–º–æ-–∫—ç—à –µ—â–µ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω!`);
            
            // üî• –í–ê–ñ–ù–û: –ù–ï –ó–ê–ì–†–£–ñ–ê–ï–ú –ö–≠–® –ù–ê –õ–ï–¢–£! –ü—Ä–æ—Å—Ç–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
            readingStats.addRead('countries', null, 1, 'error');
            
            // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π —Å–ø–∏—Å–æ–∫ –ø–æ–ø—É–ª—è—Ä–Ω—ã—Ö —Å—Ç—Ä–∞–Ω –∫–∞–∫ fallback
            const popularCountries = POPULAR_COUNTRIES.map(c => c.flag + ' ' + c.name);
            console.log(`‚ö†Ô∏è [DEMO FALLBACK] –í–æ–∑–≤—Ä–∞—â–∞–µ–º ${popularCountries.length} –ø–æ–ø—É–ª—è—Ä–Ω—ã—Ö —Å—Ç—Ä–∞–Ω`);
            
            return popularCountries;
        }
        
        // üî• –î–õ–Ø –ü–û–õ–ù–û–ì–û –î–û–°–¢–£–ü–ê: –µ—Å–ª–∏ –∫—ç—à –ø—É—Å—Ç, –Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å –¥–æ—Å—Ç—É–ø–æ–º
        if (!isDemo && !cacheManager.isGlobalFullCacheLoaded()) {
            console.log(`‚ö†Ô∏è [FULL COUNTRIES] –ü–æ–ª–Ω—ã–π –∫—ç—à –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω, –Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å –¥–æ—Å—Ç—É–ø–æ–º`);
            
            // üî• –í–ê–ñ–ù–û: –ù–ï –ó–ê–ì–†–£–ñ–ê–ï–ú –ù–ê –õ–ï–¢–£! –ü—Ä–æ—Å—Ç–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
            readingStats.addRead('countries', null, 1, 'error');
            
            // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –ø—É—Å—Ç–æ–π –º–∞—Å—Å–∏–≤
            return [];
        }
        
        // üî• –ï–°–õ–ò –î–û–®–õ–ò –°–Æ–î–ê - –í–û–ó–í–†–ê–©–ê–ï–ú –ü–£–°–¢–û–ô –ú–ê–°–°–ò–í
        console.log(`‚ùå [COUNTRIES] –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Å—Ç—Ä–∞–Ω—ã –∏–∑ –∫—ç—à–∞`);
        return [];
        
    } catch (error) {
        console.error("‚ùå [COUNTRIES] –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞–Ω:", error);
        return POPULAR_COUNTRIES.map(c => c.flag + ' ' + c.name);
    }
};

    // ===================== –û–ü–¢–ò–ú–ò–ó–ò–†–û–í–ê–ù–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø –ü–û–õ–£–ß–ï–ù–ò–Ø –ì–û–†–û–î–û–í =====================
const getUniqueCitiesForCountry = async (country, isDemo = false) => {
    try {
        console.log(`üîç [CITIES] –ó–∞–ø—Ä–æ—Å –≥–æ—Ä–æ–¥–æ–≤ –¥–ª—è ${country} (–¥–µ–º–æ: ${isDemo})`);
        
        // üî• –í–ê–ñ–ù–û: –ò–°–ü–û–õ–¨–ó–£–ï–ú –ì–õ–û–ë–ê–õ–¨–ù–´–ô –ö–≠–®
        const cachedCities = cacheManager.getGlobalCities(country, isDemo);
        
        if (cachedCities && cachedCities.length > 0) {
            console.log(`‚úÖ [CITIES] –ì–æ—Ä–æ–¥–∞ –∏–∑ –≥–ª–æ–±–∞–ª—å–Ω–æ–≥–æ –∫—ç—à–∞ –¥–ª—è ${country}: ${cachedCities.length}`);
            readingStats.addRead('cities', null, 1, 'cache');
            return cachedCities;
        }
        
        // üî• –ï–°–õ–ò –ö–≠–® –ü–£–°–¢ - –ü–†–û–°–¢–û –í–û–ó–í–†–ê–©–ê–ï–ú –ü–£–°–¢–û–ô –ú–ê–°–°–ò–í
        console.log(`‚ö†Ô∏è [CITIES] –ù–µ—Ç –≥–æ—Ä–æ–¥–æ–≤ –≤ –≥–ª–æ–±–∞–ª—å–Ω–æ–º –∫—ç—à–µ –¥–ª—è ${country}!`);
        readingStats.addRead('cities', null, 1, 'empty');
        
        return [];
        
    } catch (error) {
        console.error(`‚ùå [CITIES] –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≥–æ—Ä–æ–¥–æ–≤ –¥–ª—è ${country}:`, error);
        return [];
    }
};
    const formatCountryWithFlag = (countryName) => {
        return countryName;
    };

    // ===================== –°–ò–°–¢–ï–ú–ê –ü–ê–ì–ò–ù–ê–¶–ò–ò =====================
    const createEnhancedPaginationKeyboard = (currentPage, totalPages, filterKey, currentFilters = {}, isDemo = false) => {
        const keyboard = [];
        
        if (currentFilters.country || currentFilters.city || currentFilters.ageRange) {
            let filtersText = "";
            const filters = [];
            if (currentFilters.country) filters.push(currentFilters.country);
            if (currentFilters.city) filters.push(currentFilters.city);
            if (currentFilters.ageRange) filters.push(currentFilters.ageRange.label);
            filtersText += filters.join(", ");
            
            keyboard.push([{ text: filtersText, callback_data: "filters_info" }]);
        }
        
        const navRow = [];
        if (currentPage > 0) {
            navRow.push({ text: "‚è™", callback_data: `page_first_${currentPage}` });
            navRow.push({ text: "‚óÄÔ∏è", callback_data: `page_prev_${currentPage}` });
        }
        
        navRow.push({ text: `${currentPage + 1}/${totalPages}`, callback_data: "page_info" });
        
        if (currentPage < totalPages - 1) {
            navRow.push({ text: "‚ñ∂Ô∏è", callback_data: `page_next_${currentPage}` });
            navRow.push({ text: "‚è©", callback_data: `page_last_${currentPage}` });
        }
        
        keyboard.push(navRow);

        if (totalPages > 10) {
            const jumpRow = [];
            const totalProfiles = totalPages * SCALING_CONFIG.PERFORMANCE.PROFILES_PER_PAGE;
            
            PAGINATION_JUMP_SECTIONS.forEach(section => {
                if (section.start < totalProfiles) {
                    const sectionPage = Math.floor(section.start / SCALING_CONFIG.PERFORMANCE.PROFILES_PER_PAGE);
                    if (sectionPage < totalPages) {
                        jumpRow.push({ text: section.label, callback_data: `page_${sectionPage}_${currentPage}` });
                    }
                }
            });
            
            if (jumpRow.length > 0) keyboard.push(jumpRow);
        }

        if (totalPages > 1) {
            const quickPagesRow = [];
            const pagesToShow = Math.min(5, totalPages);
            let startPage = Math.max(0, currentPage - Math.floor(pagesToShow / 2));
            
            if (startPage + pagesToShow > totalPages) startPage = Math.max(0, totalPages - pagesToShow);

            for (let i = 0; i < pagesToShow; i++) {
                const pageNum = startPage + i;
                if (pageNum >= 0 && pageNum < totalPages) {
                    quickPagesRow.push({
                        text: pageNum === currentPage ? `‚Ä¢ ${pageNum + 1} ‚Ä¢` : `${pageNum + 1}`,
                        callback_data: `page_${pageNum}_${currentPage}`,
                    });
                }
            }
            
            if (quickPagesRow.length > 0) keyboard.push(quickPagesRow);
        }

        keyboard.push([
            { text: "üìù –°–û–ó–î–ê–¢–¨ –ê–ù–ö–ï–¢–£", web_app: { url: "https://bot-vai-web-app.web.app/?tab=catalog" } }
        ]);

        if (isDemo) {
            keyboard.push([
                { text: "üíé –ü–û–õ–£–ß–ò–¢–¨ –ü–û–õ–ù–´–ô –î–û–°–¢–£–ü", callback_data: "get_full_access" }
            ]);
        }

        return keyboard;
    };

// ===================== –û–ü–¢–ò–ú–ò–ó–ò–†–û–í–ê–ù–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø –ü–û–õ–£–ß–ï–ù–ò–Ø –ü–†–û–§–ò–õ–ï–ô =====================
const getProfilesPage = async (page = 0, searchCountry = null, ageRange = null, searchCity = null, isDemo = false) => {
    try {
        console.log(`üîç [PROFILES PAGE] –ó–∞–ø—Ä–æ—Å —Å—Ç—Ä–∞–Ω–∏—Ü—ã ${page}, –¥–µ–º–æ=${isDemo}, —Å—Ç—Ä–∞–Ω–∞="${searchCountry}", –≥–æ—Ä–æ–¥="${searchCity}"`);
        
        // üî• –í–ê–ñ–ù–û: –ò–°–ü–û–õ–¨–ó–£–ï–ú –ì–õ–û–ë–ê–õ–¨–ù–´–ô –ö–≠–®
        let allProfiles = cacheManager.getGlobalProfiles(isDemo);
        
        if (!allProfiles || allProfiles.length === 0) {
            console.log(`‚ùå [PROFILES PAGE] –ù–µ—Ç –ø—Ä–æ—Ñ–∏–ª–µ–π –≤ –≥–ª–æ–±–∞–ª—å–Ω–æ–º –∫—ç—à–µ (–¥–µ–º–æ: ${isDemo})`);
            return [];
        }

        const normalizedSearchCity = searchCity ? cacheManager.normalizeCityName(searchCity) : null;
        const normalizedSearchCountry = searchCountry ? cacheManager.normalizeCountryName(searchCountry) : null;
        
        // üî• –ö–†–ò–¢–ò–ß–ï–°–ö–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ò–°–ü–û–õ–¨–ó–£–ï–ú –ò–ù–î–ï–ö–°–´ –î–õ–Ø –î–ï–ú–û-–ö–≠–®–ê
        const filterKey = `country:${normalizedSearchCountry || 'all'}:age:${ageRange?.label || 'all'}:city:${normalizedSearchCity || 'all'}`;
        
        // –ü–†–û–í–ï–†–Ø–ï–ú –ö–≠–® –§–ò–õ–¨–¢–†–û–í
        let filteredProfiles = cacheManager.getGlobalFilter(filterKey, isDemo);
        
        if (!filteredProfiles) {
            console.log(`üîç [FILTER] –ü—Ä–æ–º–∞—Ö –≥–ª–æ–±–∞–ª—å–Ω–æ–≥–æ –∫—ç—à–∞ —Ñ–∏–ª—å—Ç—Ä–æ–≤: ${filterKey} (–¥–µ–º–æ: ${isDemo})`);
            console.log(`üìä [FILTER] –í—Å–µ–≥–æ –ø—Ä–æ—Ñ–∏–ª–µ–π –≤ –≥–ª–æ–±–∞–ª—å–Ω–æ–º –∫—ç—à–µ: ${allProfiles.length} (–¥–µ–º–æ: ${isDemo})`);
            
            // üî• –í–ê–ñ–ù–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –î–õ–Ø –î–ï–ú–û-–†–ï–ñ–ò–ú–ê –ò–°–ü–û–õ–¨–ó–£–ï–ú –ò–ù–î–ï–ö–°–´ –ò–ó –î–ï–ú–û-–ö–≠–®–ê
            if (isDemo) {
                console.log(`üéØ [DEMO INDEX SEARCH] –ò—â–µ–º –≤ –¥–µ–º–æ-–∏–Ω–¥–µ–∫—Å–∞—Ö...`);
                
                // –ü–æ–ª—É—á–∞–µ–º –∏–Ω–¥–µ–∫—Å—ã –∏–∑ –¥–µ–º–æ-–∫—ç—à–∞
                const demoCountryCityIndex = globalDemoCache.get("demo:index:country_city");
                const demoCountryIndex = globalDemoCache.get("demo:index:country");
                const demoCityIndex = globalDemoCache.get("demo:index:city");
                
                if (demoCountryCityIndex && demoCountryIndex && demoCityIndex) {
                    console.log(`‚úÖ [DEMO INDEXES LOADED] –°—Ç—Ä–∞–Ω—ã: ${demoCountryIndex.size}, –ì–æ—Ä–æ–¥–∞: ${demoCityIndex.size}, –ü–∞—Ä—ã: ${demoCountryCityIndex.size}`);
                    
                    let profileIndexes = [];
                    
                    // –°–¶–ï–ù–ê–†–ò–ô 1: –°—Ç—Ä–∞–Ω–∞ + –ì–æ—Ä–æ–¥ (—Å–∞–º—ã–π —Ç–æ—á–Ω—ã–π –ø–æ–∏—Å–∫)
                    if (normalizedSearchCountry && normalizedSearchCity) {
                        const key = `${normalizedSearchCountry}:${normalizedSearchCity}`;
                        profileIndexes = demoCountryCityIndex.get(key) || [];
                        console.log(`‚ö° [DEMO INDEX 1] –°—Ç—Ä–∞–Ω–∞+–ì–æ—Ä–æ–¥ "${key}": ${profileIndexes.length} –ø—Ä–æ—Ñ–∏–ª–µ–π`);
                    }
                    // –°–¶–ï–ù–ê–†–ò–ô 2: –¢–æ–ª—å–∫–æ –°—Ç—Ä–∞–Ω–∞
                    else if (normalizedSearchCountry && !normalizedSearchCity) {
                        profileIndexes = demoCountryIndex.get(normalizedSearchCountry) || [];
                        console.log(`‚ö° [DEMO INDEX 2] –¢–æ–ª—å–∫–æ —Å—Ç—Ä–∞–Ω–∞ "${normalizedSearchCountry}": ${profileIndexes.length} –ø—Ä–æ—Ñ–∏–ª–µ–π`);
                    }
                    // –°–¶–ï–ù–ê–†–ò–ô 3: –¢–æ–ª—å–∫–æ –ì–æ—Ä–æ–¥ (–∏—Å–ø–æ–ª—å–∑—É–µ–º –∏–Ω–¥–µ–∫—Å —Ç–æ–ª—å–∫–æ –ø–æ –≥–æ—Ä–æ–¥–∞–º)
                    else if (!normalizedSearchCountry && normalizedSearchCity) {
                        profileIndexes = demoCityIndex.get(normalizedSearchCity) || [];
                        console.log(`‚ö° [DEMO INDEX 3] –¢–æ–ª—å–∫–æ –≥–æ—Ä–æ–¥ "${normalizedSearchCity}": ${profileIndexes.length} –ø—Ä–æ—Ñ–∏–ª–µ–π`);
                    }
                    
                    // –ï—Å–ª–∏ –Ω–∞—à–ª–∏ –ø—Ä–æ—Ñ–∏–ª–∏ —á–µ—Ä–µ–∑ –∏–Ω–¥–µ–∫—Å—ã
                    if (profileIndexes.length > 0) {
                        filteredProfiles = [];
                        let validProfilesFound = 0;
                        
                        for (let i = 0; i < profileIndexes.length; i++) {
                            const profileIndex = profileIndexes[i];
                            
                            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –∏–Ω–¥–µ–∫—Å –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö –º–∞—Å—Å–∏–≤–∞
                            if (profileIndex >= 0 && profileIndex < allProfiles.length) {
                                const profile = allProfiles[profileIndex];
                                
                                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –ø—Ä–æ—Ñ–∏–ª—å —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∏ –∏–º–µ–µ—Ç –¥–∞–Ω–Ω—ã–µ
                                if (profile && (profile.id || profile.n || profile.name)) {
                                    // –ü—Ä–∏–º–µ–Ω—è–µ–º —Ñ–∏–ª—å—Ç—Ä –ø–æ –≤–æ–∑—Ä–∞—Å—Ç—É –µ—Å–ª–∏ –µ—Å—Ç—å
                                    if (ageRange) {
                                        const age = parseInt(profile.a) || 0;
                                        const minAge = ageRange.min || 0;
                                        const maxAge = ageRange.max || 999;
                                        
                                        if (age >= minAge && age <= maxAge) {
                                            filteredProfiles.push(profile);
                                            validProfilesFound++;
                                        }
                                    } else {
                                        filteredProfiles.push(profile);
                                        validProfilesFound++;
                                    }
                                } else {
                                    console.log(`‚ö†Ô∏è [DEMO INDEX WARNING] –ü—Ä–æ—Ñ–∏–ª—å –ø–æ –∏–Ω–¥–µ–∫—Å—É ${profileIndex} –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–π`);
                                }
                            } else {
                                console.log(`‚ö†Ô∏è [DEMO INDEX ERROR] –ò–Ω–¥–µ–∫—Å ${profileIndex} –≤–Ω–µ –¥–∏–∞–ø–∞–∑–æ–Ω–∞ (0-${allProfiles.length - 1})`);
                            }
                        }
                        
                        console.log(`‚úÖ [DEMO INDEX RESULT] –ù–∞–π–¥–µ–Ω–æ —á–µ—Ä–µ–∑ –∏–Ω–¥–µ–∫—Å—ã: ${validProfilesFound} –≤–∞–ª–∏–¥–Ω—ã—Ö –ø—Ä–æ—Ñ–∏–ª–µ–π`);
                        
                        // –ï—Å–ª–∏ –Ω–∞—à–ª–∏ —á–µ—Ä–µ–∑ –∏–Ω–¥–µ–∫—Å—ã - —Å–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –∫—ç—à –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º
                        if (filteredProfiles.length > 0) {
                            cacheManager.cacheGlobalFilter(filterKey, filteredProfiles, isDemo);
                            console.log(`üíæ [DEMO CACHE SAVED] –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ –≤ –∫—ç—à —Ñ–∏–ª—å—Ç—Ä–æ–≤: ${filterKey}`);
                        }
                    } else {
                        console.log(`‚ö†Ô∏è [DEMO INDEX EMPTY] –ù–µ –Ω–∞–π–¥–µ–Ω–æ –ø—Ä–æ—Ñ–∏–ª–µ–π —á–µ—Ä–µ–∑ –∏–Ω–¥–µ–∫—Å—ã, –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—É—é —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—é`);
                    }
                } else {
                    console.log(`‚ùå [DEMO INDEX MISSING] –ò–Ω–¥–µ–∫—Å—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –≤ –¥–µ–º–æ-–∫—ç—à–µ`);
                }
            }
            
            // üî• –ï–°–õ–ò –ù–ï –ù–ê–®–õ–ò –ß–ï–†–ï–ó –ò–ù–î–ï–ö–°–´ –ò–õ–ò –ù–ï –î–ï–ú–û-–†–ï–ñ–ò–ú - –ò–°–ü–û–õ–¨–ó–£–ï–ú –°–¢–ê–ù–î–ê–†–¢–ù–£–Æ –§–ò–õ–¨–¢–†–ê–¶–ò–Æ
            if (!filteredProfiles || filteredProfiles.length === 0) {
                console.log(`üîç [STANDARD FILTER] –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—É—é —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—é`);
                filteredProfiles = await asyncFilterManager.filterProfilesAsync(allProfiles, {
                    country: normalizedSearchCountry,
                    city: normalizedSearchCity,
                    ageRange: ageRange
                }, isDemo);
                
                console.log(`‚úÖ [STANDARD FILTER RESULT] –û—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–æ: ${filteredProfiles?.length || 0} –ø—Ä–æ—Ñ–∏–ª–µ–π`);
            }
            
            // üî• –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –ü–†–û–í–ï–†–ö–ê: –£–ë–ò–†–ê–ï–ú –ù–ï–í–ê–õ–ò–î–ù–´–ï –ü–†–û–§–ò–õ–ò
            if (filteredProfiles) {
                const validProfiles = filteredProfiles.filter(profile => 
                    profile && 
                    (profile.id || profile._id) && 
                    (profile.n || profile.name)
                );
                
                if (validProfiles.length !== filteredProfiles.length) {
                    console.log(`‚ö†Ô∏è [FILTER CLEANUP] –£–¥–∞–ª–µ–Ω–æ ${filteredProfiles.length - validProfiles.length} –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã—Ö –ø—Ä–æ—Ñ–∏–ª–µ–π`);
                    filteredProfiles = validProfiles;
                }
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –∫—ç—à —Ñ–∏–ª—å—Ç—Ä–æ–≤ (–µ—Å–ª–∏ –µ—â–µ –Ω–µ —Å–æ—Ö—Ä–∞–Ω–∏–ª–∏ —á–µ—Ä–µ–∑ –¥–µ–º–æ-–∏–Ω–¥–µ–∫—Å—ã)
                if (!cacheManager.getGlobalFilter(filterKey, isDemo)) {
                    cacheManager.cacheGlobalFilter(filterKey, filteredProfiles, isDemo);
                }
            }
        } else {
            console.log(`‚úÖ [CACHE HIT] –ò—Å–ø–æ–ª—å–∑—É–µ–º –∫—ç—à –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞ ${filterKey}: ${filteredProfiles.length} –ø—Ä–æ—Ñ–∏–ª–µ–π`);
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫—ç—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø—Ä–æ—Ñ–∏–ª–∏
            const validCachedProfiles = filteredProfiles.filter(profile => 
                profile && 
                (profile.id || profile._id) && 
                (profile.n || profile.name)
            );
            
            if (validCachedProfiles.length !== filteredProfiles.length) {
                console.log(`‚ö†Ô∏è [CACHE CLEANUP] –í –∫—ç—à–µ ${filteredProfiles.length - validCachedProfiles.length} –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã—Ö –ø—Ä–æ—Ñ–∏–ª–µ–π`);
                filteredProfiles = validCachedProfiles;
                cacheManager.cacheGlobalFilter(filterKey, filteredProfiles, isDemo);
            }
        }

        if (!filteredProfiles || filteredProfiles.length === 0) {
            console.log(`‚ùå [PAGE] –ù–µ—Ç –ø—Ä–æ—Ñ–∏–ª–µ–π –ø–æ—Å–ª–µ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏`);
            return [];
        }

        const startIndex = page * SCALING_CONFIG.PERFORMANCE.PROFILES_PER_PAGE;
        const endIndex = startIndex + SCALING_CONFIG.PERFORMANCE.PROFILES_PER_PAGE;
        
        const result = filteredProfiles.slice(startIndex, endIndex);
        
        // üî• –í–ê–ñ–ù–û: –ü–†–û–í–ï–†–Ø–ï–ú –ö–ê–ñ–î–´–ô –ü–†–û–§–ò–õ–¨ –í –†–ï–ó–£–õ–¨–¢–ê–¢–ï
        const validResult = result.filter(profile => 
            profile && 
            (profile.id || profile._id) && 
            (profile.n || profile.name)
        );
        
        if (validResult.length !== result.length) {
            console.log(`‚ö†Ô∏è [RESULT CLEANUP] –£–¥–∞–ª–µ–Ω–æ ${result.length - validResult.length} –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã—Ö –ø—Ä–æ—Ñ–∏–ª–µ–π –∏–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞`);
        }
        
        console.log(`üìÑ [PAGE] –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É ${page}: ${validResult.length} –ø—Ä–æ—Ñ–∏–ª–µ–π (–≤—Å–µ–≥–æ ${filteredProfiles.length})`);
        
        // üî• –î–õ–Ø –û–¢–õ–ê–î–ö–ò: –≤—ã–≤–æ–¥–∏–º –ø–µ—Ä–≤—ã–π –ø—Ä–æ—Ñ–∏–ª—å
        if (validResult.length > 0) {
            const firstProfile = validResult[0];
            console.log(`üìã [FIRST PROFILE DEBUG] ID: ${firstProfile.id || firstProfile._id || '–Ω–µ—Ç'}, –ò–º—è: "${firstProfile.n || firstProfile.name || '–Ω–µ—Ç'}", –í–æ–∑—Ä–∞—Å—Ç: ${firstProfile.a || firstProfile.age || 0}, –ì–æ—Ä–æ–¥: "${firstProfile.ct || firstProfile.city || '–Ω–µ—Ç'}", isDemo: ${firstProfile.isDemo || isDemo}`);
            console.log(`   üì∏ –§–æ—Ç–æ: ${firstProfile.p || firstProfile.photoUrl ? '–µ—Å—Ç—å' : '–Ω–µ—Ç'}, –§–æ—Ç–æ –≥–∞–ª–µ—Ä–µ–∏: ${firstProfile.phs?.length || firstProfile.photos?.length || 0}`);
        }
        
        return validResult;

    } catch (error) {
        console.error("‚ùå [PROFILES PAGE] –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞–Ω–∫–µ—Ç:", error);
        return [];
    }
};

    // ===================== –ú–ï–ù–ï–î–ñ–ï–† –°–û–û–ë–©–ï–ù–ò–ô =====================
    const messageManager = {
        track: function (chatId, messageId) {
            if (!messageId) return;
            if (!chatStorage.messages.has(chatId)) chatStorage.messages.set(chatId, new Set());
            chatStorage.messages.get(chatId).add(messageId);
            chatStorage.messageTimestamps.set(messageId, Date.now());
        },

        // –í–Ω—É—Ç—Ä–∏ messageManager:
clear: async function (ctx, keepCityKeyboard = false, keepCountryKeyboard = false) {
    const chatId = ctx.chat.id;
    if (!chatStorage.messages.has(chatId)) return;

    const messages = [...chatStorage.messages.get(chatId)];
    const mainMenuId = chatStorage.mainMenu.get(chatId);
    const countryKeyboardId = chatStorage.countryKeyboard.get(chatId);
    const cityKeyboardId = chatStorage.cityKeyboard.get(chatId);

    let deletedCount = 0;

    for (const messageId of messages) {
        const shouldKeep = 
            (keepCountryKeyboard && messageId === countryKeyboardId) ||
            (keepCityKeyboard && messageId === cityKeyboardId) ||
            messageId === mainMenuId;
            
        if (!shouldKeep) {
            try {
                await ctx.telegram.deleteMessage(chatId, messageId);
                chatStorage.messages.get(chatId).delete(messageId);
                chatStorage.messageTimestamps.delete(messageId);
                deletedCount++;
            } catch (e) {
                // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏ "—Å–æ–æ–±—â–µ–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ" –∏ "–¥–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω"
                if (e.response?.error_code !== 400 && e.response?.error_code !== 403) {
                    console.error(`‚ùå –û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è ${messageId}:`, e.message);
                } else {
                    // –£–¥–∞–ª—è–µ–º –∏–∑ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞ –¥–∞–∂–µ –µ—Å–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ —É–∂–µ —É–¥–∞–ª–µ–Ω–æ
                    chatStorage.messages.get(chatId)?.delete(messageId);
                    chatStorage.messageTimestamps.delete(messageId);
                }
            }
        }
    }

    if (cityKeyboardId && !keepCityKeyboard) {
        try {
            await ctx.telegram.deleteMessage(chatId, cityKeyboardId);
            chatStorage.messages.get(chatId)?.delete(cityKeyboardId);
            chatStorage.messageTimestamps.delete(cityKeyboardId);
            chatStorage.cityKeyboard.delete(chatId);
            deletedCount++;
        } catch (e) {
            if (e.response?.error_code !== 400 && e.response?.error_code !== 403) {
                console.error("‚ùå –û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã –≥–æ—Ä–æ–¥–æ–≤:", e);
            }
        }
    }

    if (countryKeyboardId && !keepCountryKeyboard) {
        try {
            await ctx.telegram.deleteMessage(chatId, countryKeyboardId);
            chatStorage.messages.get(chatId)?.delete(countryKeyboardId);
            chatStorage.messageTimestamps.delete(countryKeyboardId);
            chatStorage.countryKeyboard.delete(chatId);
            deletedCount++;
        } catch (e) {
            if (e.response?.error_code !== 400 && e.response?.error_code !== 403) {
                console.error("‚ùå –û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã —Å—Ç—Ä–∞–Ω:", e);
            }
        }
    }

    chatStorage.userState.delete(ctx.from.id);
    if (deletedCount > 0) console.log(`üßπ [CLEAN] –£–¥–∞–ª–µ–Ω–æ ${deletedCount} —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è —á–∞—Ç–∞ ${chatId}`);
},

        sendMainMenu: async function (ctx) {
            return messageQueue.add(async () => {
                const chatId = ctx.chat.id;
                const self = this;

                try {
                    if (chatStorage.mainMenu.has(chatId)) {
                        try {
                            await ctx.telegram.deleteMessage(chatId, chatStorage.mainMenu.get(chatId));
                            chatStorage.messages.get(chatId)?.delete(chatStorage.mainMenu.get(chatId));
                            chatStorage.messageTimestamps.delete(chatStorage.mainMenu.get(chatId));
                        } catch (e) {
                            if (e.response?.error_code !== 400) console.error("‚ùå –û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –º–µ–Ω—é:", e);
                        }
                    }

                    const hasFullAccess = await checkFullAccess(ctx);
                    const menuButtons = [];

                    menuButtons.push([{ text: "üéÇ –§–∏–ª—å—Ç—Ä –ø–æ –≤–æ–∑—Ä–∞—Å—Ç—É", callback_data: "filter_by_age" }]);
                    menuButtons.push([{ text: "üåç –í—Å–µ —Å—Ç—Ä–∞–Ω—ã", callback_data: "all_countries_with_check" }]);
                    
                    menuButtons.push([{ text: "üìù –°–û–ó–î–ê–¢–¨ –ê–ù–ö–ï–¢–£", web_app: { url: "https://bot-vai-web-app.web.app/?tab=catalog" } }]);
                    
                    menuButtons.push([{ text: "üßπ –û—á–∏—Å—Ç–∏—Ç—å —ç–∫—Ä–∞–Ω", callback_data: "clear_screen" }]);

                    if (!hasFullAccess) {
                        menuButtons.push([{ text: "üíé –ü–û–õ–£–ß–ò–¢–¨ –ü–û–õ–ù–´–ô –î–û–°–¢–£–ü", callback_data: "get_full_access" }]);
                    }

                    const menu = await ctx.reply("–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é:", { reply_markup: { inline_keyboard: menuButtons } });
                    chatStorage.mainMenu.set(chatId, menu.message_id);
                    self.track(chatId, menu.message_id);

                } catch (error) {
                    console.error("‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –º–µ–Ω—é:", error);
                    throw error;
                }
            });
        },
        
        sendCountriesKeyboard: async function (ctx, isDemo = false, page = 0) {
            return messageQueue.add(async () => {
                const chatId = ctx.chat.id;
                const self = this;

                try {
                    if (chatStorage.countryKeyboard.has(chatId)) {
                        try {
                            await ctx.telegram.deleteMessage(chatId, chatStorage.countryKeyboard.get(chatId));
                            chatStorage.messages.get(chatId)?.delete(chatStorage.countryKeyboard.get(chatId));
                            chatStorage.messageTimestamps.delete(chatStorage.countryKeyboard.get(chatId));
                        } catch (e) {
                            if (e.response?.error_code !== 400) console.error("‚ùå –û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã —Å—Ç—Ä–∞–Ω:", e);
                        }
                    }

                    const preloaderMsg = await sendPreloader(ctx, 'country');
                    const uniqueCountries = await getUniqueCountries(isDemo);
                    await removePreloader(ctx, preloaderMsg);
                    
                    if (!uniqueCountries || uniqueCountries.length === 0) {
                        const msg = await ctx.reply("‚ùå –°–ø–∏—Å–æ–∫ —Å—Ç—Ä–∞–Ω –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω. –¥–æ–∂–¥–∏—Ç–µ—Å—å –∑–∞–≥—Ä—É–∑–∫–∏.");
                        self.track(chatId, msg.message_id);
                        return;
                    }
                    
                    const countriesPerPage = 30;
                    const totalPages = Math.ceil(uniqueCountries.length / countriesPerPage);
                    
                    if (page < 0) page = 0;
                    if (page >= totalPages) page = totalPages - 1;
                    
                    const startIndex = page * countriesPerPage;
                    const endIndex = Math.min(startIndex + countriesPerPage, uniqueCountries.length);
                    const pageCountries = uniqueCountries.slice(startIndex, endIndex);

                    const keyboard = [];
                    let row = [];

                    pageCountries.forEach((country, index) => {
                        const countryWithFlag = formatCountryWithFlag(country);
                        row.push({ text: countryWithFlag, callback_data: `country_${country}` });

                        if (row.length === 2 || index === pageCountries.length - 1) {
                            keyboard.push(row);
                            row = [];
                        }
                    });

                    if (totalPages > 1) {
                        const paginationRow = [];
                        
                        if (page > 0) {
                            paginationRow.push({ 
                                text: "‚óÄÔ∏è –ù–∞–∑–∞–¥", 
                                callback_data: `countries_page_${page - 1}` 
                            });
                        }
                        
                        paginationRow.push({ 
                            text: `–°—Ç—Ä–∞–Ω–∞ ${page + 1}/${totalPages}`, 
                            callback_data: "countries_page_info" 
                        });
                        
                        if (page < totalPages - 1) {
                            paginationRow.push({ 
                                text: "–í–ø–µ—Ä–µ–¥ ‚ñ∂Ô∏è", 
                                callback_data: `countries_page_${page + 1}` 
                            });
                        }
                        
                        if (paginationRow.length > 0) {
                            keyboard.push(paginationRow);
                        }
                        
                        if (totalPages > 5) {
                            const quickPagesRow = [];
                            const pagesToShow = Math.min(5, totalPages);
                            
                            for (let i = 0; i < pagesToShow; i++) {
                                quickPagesRow.push({
                                    text: i === page ? `‚Ä¢ ${i + 1} ‚Ä¢` : `${i + 1}`,
                                    callback_data: `countries_page_${i}`
                                });
                            }
                            
                            if (page >= pagesToShow) {
                                quickPagesRow.push({ text: "...", callback_data: "countries_page_info" });
                                quickPagesRow.push({
                                    text: `‚Ä¢ ${page + 1} ‚Ä¢`,
                                    callback_data: `countries_page_${page}`
                                });
                            }
                            
                            if (quickPagesRow.length > 0) {
                                keyboard.push(quickPagesRow);
                            }
                        }
                    }

                    keyboard.push([{ text: "üìù –°–û–ó–î–ê–¢–¨ –ê–ù–ö–ï–¢–£", web_app: { url: "https://bot-vai-web-app.web.app/?tab=catalog" } }]);

                    if (isDemo) {
                        keyboard.push([{ text: "üíé –ü–û–õ–£–ß–ò–¢–¨ –ü–û–õ–ù–´–ô –î–û–°–¢–£–ü", callback_data: "get_full_access" }]);
                    }

                    keyboard.push([{ text: "üîô –ù–∞–∑–∞–¥", callback_data: "back_to_menu" }]);

                    const msgText = isDemo ? 
                        `üëÄ –î–ï–ú–û-–†–ï–ñ–ò–ú: –í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç—Ä–∞–Ω—É (–ø–æ–∫–∞–∑–∞–Ω–æ –ø–æ 3 –∞–Ω–∫–µ—Ç—ã –Ω–∞ –≥–æ—Ä–æ–¥)\n\nüìÑ –°—Ç—Ä–∞–Ω–∏—Ü–∞ ${page + 1} –∏–∑ ${totalPages}\nüåç –í—Å–µ–≥–æ —Å—Ç—Ä–∞–Ω: ${uniqueCountries.length}\n\nüíé –î–ª—è –ø–æ–ª–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞ –í—ã –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –ø–æ–¥–ø–∏—Å–∞–Ω—ã –Ω–∞ –Ω–∞—à –∫–∞–Ω–∞–ª <a href="https://t.me/+H6Eovikei9xiZWU0"><b>MagicClubPrivate</b></a>  –∏ –æ–ø–ª–∞—Ç–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É` : 
                        `üåç –í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç—Ä–∞–Ω—É (—Å—Ç—Ä–∞–Ω–∏—Ü–∞ ${page + 1} –∏–∑ ${totalPages})\nüìä –í—Å–µ–≥–æ —Å—Ç—Ä–∞–Ω: ${uniqueCountries.length}\nüìç –ü–æ–∫–∞–∑–∞–Ω–æ: ${pageCountries.length} —Å—Ç—Ä–∞–Ω`;

                    const msg = await ctx.reply(msgText, { 
                        reply_markup: { inline_keyboard: keyboard },
                        parse_mode: "HTML"
                    });
                    
                    chatStorage.countryKeyboard.set(chatId, msg.message_id);
                    self.track(chatId, msg.message_id);
                    
                } catch (error) {
                    console.error("‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã —Å—Ç—Ä–∞–Ω:", error);
                    throw error;
                }
            });
        },

        sendCitiesKeyboard: async function (ctx, country, isDemo = false) {
            return messageQueue.add(async () => {
                const chatId = ctx.chat.id;
                const self = this;

                try {
                    if (chatStorage.cityKeyboard.has(chatId)) {
                        try {
                            await ctx.telegram.deleteMessage(chatId, chatStorage.cityKeyboard.get(chatId));
                            chatStorage.messages.get(chatId)?.delete(chatStorage.cityKeyboard.get(chatId));
                            chatStorage.messageTimestamps.delete(chatStorage.cityKeyboard.get(chatId));
                        } catch (e) {
                            if (e.response?.error_code !== 400) console.error("‚ùå –û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã –≥–æ—Ä–æ–¥–æ–≤:", e);
                        }
                    }

                    const preloaderMsg = await sendPreloader(ctx, 'profiles');
                    
                    const cities = await getUniqueCitiesForCountry(country, isDemo);
                    
                    await removePreloader(ctx, preloaderMsg);
                    
                    if (!cities || cities.length === 0) {
                        const msg = await ctx.reply(`‚ùå –î–ª—è —Å—Ç—Ä–∞–Ω—ã "${country}" –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –≥–æ—Ä–æ–¥–æ–≤`);
                        self.track(chatId, msg.message_id);
                        return;
                    }

                    console.log(`üèôÔ∏è [CITIES] –ü–æ–∫–∞–∑–∞–Ω–æ –≥–æ—Ä–æ–¥–æ–≤ –¥–ª—è ${country}: ${cities.length}`);

                    const citiesPerPage = 50;
                    let currentPage = 0;
                    const totalPages = Math.ceil(cities.length / citiesPerPage);

                    // –í –º–µ—Ç–æ–¥–µ sendCitiesKeyboard –æ–±—ä–µ–∫—Ç–∞ messageManager –Ω–∞—Ö–æ–¥–∏–º —Å–æ–∑–¥–∞–Ω–∏–µ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã:
const createCitiesKeyboard = (page) => {
    const startIndex = page * citiesPerPage;
    const endIndex = Math.min(startIndex + citiesPerPage, cities.length);
    const pageCities = cities.slice(startIndex, endIndex);
    
    const keyboard = [];
    let row = [];

    pageCities.forEach((city, index) => {
        row.push({ text: city, callback_data: `city_${city}` });
        if (row.length === 2 || index === pageCities.length - 1) {
            keyboard.push(row);
            row = [];
        }
    });

    const paginationRow = [];
    if (totalPages > 1) {
        if (page > 0) {
            paginationRow.push({ 
                text: "‚óÄÔ∏è –ü—Ä–µ–¥—ã–¥—É—â–∏–µ", 
                callback_data: `cities_page_${country}_${page - 1}` 
            });
        }
        
        paginationRow.push({ 
            text: `${page + 1}/${totalPages}`, 
            callback_data: "cities_page_info" 
        });
        
        if (page < totalPages - 1) {
            paginationRow.push({ 
                text: "–°–ª–µ–¥—É—é—â–∏–µ ‚ñ∂Ô∏è", 
                callback_data: `cities_page_${country}_${page + 1}` 
            });
        }
        
        if (paginationRow.length > 0) {
            keyboard.push(paginationRow);
        }
    }

    // üî• –î–û–ë–ê–í–õ–Ø–ï–ú –ù–û–í–£–Æ –ö–ù–û–ü–ö–£ "üîô –ù–∞–∑–∞–¥ –∫ —Å—Ç—Ä–∞–Ω–∞–º"
    keyboard.push([{ 
        text: "üîô –ù–∞–∑–∞–¥ –∫ —Å—Ç—Ä–∞–Ω–∞–º", 
        callback_data: "back_to_countries" 
    }]);

    keyboard.push([{ 
        text: "üìù –°–û–ó–î–ê–¢–¨ –ê–ù–ö–ï–¢–£", 
        web_app: { url: "https://bot-vai-web-app.web.app/?tab=catalog" } 
    }]);

    if (isDemo) {
        keyboard.push([{ 
            text: "üíé –ü–û–õ–£–ß–ò–¢–¨ –ü–û–õ–ù–´–ô –î–û–°–¢–£–ü", 
            callback_data: "get_full_access" 
        }]);
    }

    return keyboard;
};

                    const msgText = isDemo ?
                        `üëÄ –î–ï–ú–û-–†–ï–ñ–ò–ú: –í—ã–±–µ—Ä–∏—Ç–µ –≥–æ—Ä–æ–¥ –≤ ${country} (${cities.length} –≥–æ—Ä–æ–¥–æ–≤, –ø–æ–∫–∞–∑–∞–Ω–æ –ø–æ 3 –∞–Ω–∫–µ—Ç—ã –Ω–∞ –≥–æ—Ä–æ–¥)\n\nüíé –î–ª—è –ø–æ–ª–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞ –∫–æ –≤—Å–µ–º –∞–Ω–∫–µ—Ç–∞–º –ø–æ–ª—É—á–∏—Ç–µ –ø–æ–¥–ø–∏—Å–∫—É!` :
                        `üèôÔ∏è –í—ã–±–µ—Ä–∏—Ç–µ –≥–æ—Ä–æ–¥ –≤ ${country} (–≤—Å–µ–≥–æ ${cities.length} –≥–æ—Ä–æ–¥–æ–≤):`;

                    const msg = await ctx.reply(msgText, { 
                        reply_markup: { inline_keyboard: createCitiesKeyboard(currentPage) } 
                    });
                    
                    chatStorage.cityKeyboard.set(chatId, msg.message_id);
                    self.track(chatId, msg.message_id);
                    
                } catch (error) {
                    console.error("‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã –≥–æ—Ä–æ–¥–æ–≤:", error);
                    throw error;
                }
            });
        },
    };

    // ===================== –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò –ö–û–ú–ê–ù–î =====================
    
    bot.command("start", async (ctx) => {
        await messageQueue.add(async () => {
            try {
                console.log(`üöÄ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ${ctx.from.id} –∑–∞–ø—É—Å—Ç–∏–ª –±–æ—Ç–∞`);
                
                // üî• –û–ß–ò–©–ê–ï–ú –≠–ö–†–ê–ù
                await messageManager.clear(ctx);
                
                // üî• –ü–û–ö–ê–ó–´–í–ê–ï–ú –ú–ï–ù–Æ –°–†–ê–ó–£
                await messageManager.sendMainMenu(ctx);
                
                // üî• –ó–ê–ì–†–£–ñ–ê–ï–ú –ì–õ–û–ë–ê–õ–¨–ù–´–ô –î–ï–ú–û-–ö–≠–® –í –§–û–ù–ï (–µ—Å–ª–∏ –µ—â–µ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω)
                if (!cacheManager.isGlobalDemoCacheLoaded() && !globalDemoCacheLoading) {
                    console.log(`üîÑ [START] –§–æ–Ω–æ–≤–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –≥–ª–æ–±–∞–ª—å–Ω–æ–≥–æ –¥–µ–º–æ-–∫—ç—à–∞...`);
                    
                    setTimeout(async () => {
                        try {
                            await cacheManager.loadGlobalDemoCache(db);
                            console.log(`‚úÖ [START] –ì–ª–æ–±–∞–ª—å–Ω—ã–π –¥–µ–º–æ-–∫—ç—à –∑–∞–≥—Ä—É–∂–µ–Ω –≤ —Ñ–æ–Ω–µ`);
                        } catch (error) {
                            console.error(`‚ùå [START] –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≥–ª–æ–±–∞–ª—å–Ω–æ–≥–æ –¥–µ–º–æ-–∫—ç—à–∞:`, error.message);
                        }
                    }, 1000); // –ó–∞–¥–µ—Ä–∂–∫–∞ 1 —Å–µ–∫—É–Ω–¥–∞
                }
                
            } catch (error) {
                console.error("‚ùå –û—à–∏–±–∫–∞ –∫–æ–º–∞–Ω–¥—ã start:", error);
                await ctx.reply("‚ö†Ô∏è –û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.");
            }
        });
    });


bot.command("fix_city", async (ctx) => {
    try {
        const [_, testCity, testCountry] = ctx.text.split(' ');
        
        if (!testCity || !testCountry) {
            return ctx.reply("–ù–∞–ø—Ä–∏–º–µ—Ä: /fix_city –î—É–±–∞–π –û–ê–≠");
        }
        
        // 1. –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—é
        const normalizedCity = cacheManager.normalizeCityName(testCity);
        const normalizedCountry = cacheManager.normalizeCountryName(testCountry);
        
        // 2. –ü–æ–ª—É—á–∞–µ–º –ø—Ä–æ—Ñ–∏–ª–∏ –∏–∑ –∫—ç—à–∞ (–ø—Ä–æ–≤–µ—Ä—è–µ–º –æ–±–∞ –∫—ç—à–∞)
        const demoProfiles = cacheManager.getGlobalProfiles(true);
        const fullProfiles = cacheManager.getGlobalProfiles(false);
        
        let response = `üîß **–î–ò–ê–ì–ù–û–°–¢–ò–ö–ê –ì–û–†–û–î–ê:**\n\n`;
        response += `‚Ä¢ –ó–∞–ø—Ä–æ—Å: ${testCity}, ${testCountry}\n`;
        response += `‚Ä¢ –ù–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–æ: ${normalizedCity}, ${normalizedCountry}\n\n`;
        
        response += `üìä **–°–¢–ê–¢–£–° –ö–≠–®–ï–ô:**\n`;
        response += `‚Ä¢ –î–µ–º–æ-–∫—ç—à: ${demoProfiles ? `${demoProfiles.length} –ø—Ä–æ—Ñ–∏–ª–µ–π` : '‚ùå –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω'}\n`;
        response += `‚Ä¢ –ü–æ–ª–Ω—ã–π –∫—ç—à: ${fullProfiles ? `${fullProfiles.length} –ø—Ä–æ—Ñ–∏–ª–µ–π` : '‚ùå –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω'}\n\n`;
        
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º –¥–µ–º–æ-–∫—ç—à –µ—Å–ª–∏ –ø–æ–ª–Ω—ã–π –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω
        const profilesToCheck = demoProfiles || fullProfiles || [];
        
        if (profilesToCheck.length === 0) {
            response += `‚ùå –ù–ï–¢ –ü–†–û–§–ò–õ–ï–ô –í –ö–≠–®–ï!\n`;
            response += `–î–µ–º–æ-–∫—ç—à –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∑–∞–≥—Ä—É–∂–µ–Ω –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ –±–æ—Ç–∞!\n`;
            await ctx.reply(response);
            return;
        }
        
        // 3. –ò—â–µ–º –í–°–ï –≥–æ—Ä–æ–¥–∞ –≤ —ç—Ç–æ–π —Å—Ç—Ä–∞–Ω–µ
        const citiesInCountry = new Set();
        const cityVariants = new Map();
        
        profilesToCheck.forEach(profile => {
            const profileCountry = profile.c || profile.country;
            const profileCity = profile.ct || profile.city;
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –æ–±–∞ –ø–æ–ª—è —Å—É—â–µ—Å—Ç–≤—É—é—Ç
            if (!profileCountry || !profileCity) return;
            
            const normProfileCountry = cacheManager.normalizeCountryName(profileCountry);
            const normProfileCity = cacheManager.normalizeCityName(profileCity);
            
            if (normProfileCountry === normalizedCountry) {
                citiesInCountry.add(normProfileCity);
                
                if (!cityVariants.has(normProfileCity)) {
                    cityVariants.set(normProfileCity, new Set());
                }
                cityVariants.get(normProfileCity).add(profileCity);
            }
        });
        
        // 4. –ü—Ä–æ–≤–µ—Ä—è–µ–º –µ—Å—Ç—å –ª–∏ –≥–æ—Ä–æ–¥ –≤ —Å–ø–∏—Å–∫–µ
        const cityExists = Array.from(citiesInCountry).some(city => {
            return city === normalizedCity || 
                   city.includes(normalizedCity) || 
                   normalizedCity.includes(city);
        });
        
        response += `üìã **–†–ï–ó–£–õ–¨–¢–ê–¢–´:**\n`;
        response += `‚Ä¢ –ì–æ—Ä–æ–¥ –≤ —Å–ø–∏—Å–∫–µ: ${cityExists ? '‚úÖ' : '‚ùå'}\n`;
        response += `‚Ä¢ –í—Å–µ–≥–æ –≥–æ—Ä–æ–¥–æ–≤ –≤ ${normalizedCountry}: ${citiesInCountry.size}\n\n`;
        
        if (!cityExists) {
            response += `‚ùå **–ì–û–†–û–î –ù–ï –ù–ê–ô–î–ï–ù –í –°–ü–ò–°–ö–ï!**\n`;
            response += `–ü–æ—Ö–æ–∂–∏–µ –≥–æ—Ä–æ–¥–∞:\n`;
            
            // –ò—â–µ–º –ø–æ—Ö–æ–∂–∏–µ
            const similarCities = Array.from(citiesInCountry).filter(city => 
                city.toLowerCase().includes(normalizedCity.toLowerCase()) ||
                normalizedCity.toLowerCase().includes(city.toLowerCase())
            );
            
            if (similarCities.length > 0) {
                similarCities.slice(0, 5).forEach(city => {
                    const variants = Array.from(cityVariants.get(city) || []);
                    response += `‚Ä¢ "${city}" (–≤–∞—Ä–∏–∞–Ω—Ç—ã –≤ –ë–î: ${variants.slice(0, 3).join(', ')})\n`;
                });
            } else {
                response += `–ù–µ—Ç –ø–æ—Ö–æ–∂–∏—Ö –≥–æ—Ä–æ–¥–æ–≤!\n`;
                
                // –ü–æ–∫–∞–∂–µ–º –Ω–µ—Å–∫–æ–ª—å–∫–æ –≥–æ—Ä–æ–¥–æ–≤ –∏–∑ —ç—Ç–æ–π —Å—Ç—Ä–∞–Ω—ã
                const someCities = Array.from(citiesInCountry).slice(0, 10);
                if (someCities.length > 0) {
                    response += `\n–ü—Ä–∏–º–µ—Ä—ã –≥–æ—Ä–æ–¥–æ–≤ –≤ ${normalizedCountry}:\n`;
                    someCities.forEach(city => {
                        response += `‚Ä¢ ${city}\n`;
                    });
                }
            }
        } else {
            response += `‚úÖ **–ì–û–†–û–î –ù–ê–ô–î–ï–ù!**\n`;
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–∞–∫ –æ–Ω –∑–∞–ø–∏—Å–∞–Ω –≤ –ë–î
            const variants = Array.from(cityVariants.get(normalizedCity) || []);
            if (variants.length > 0) {
                response += `–í–∞—Ä–∏–∞–Ω—Ç—ã –Ω–∞–ø–∏—Å–∞–Ω–∏—è –≤ –ë–î:\n`;
                variants.forEach(variant => {
                    response += `‚Ä¢ "${variant}"\n`;
                });
            }
            
            // –°—á–∏—Ç–∞–µ–º –∞–Ω–∫–µ—Ç—ã
            const exactMatches = profilesToCheck.filter(p => {
                const pCity = cacheManager.normalizeCityName(p.ct || p.city);
                const pCountry = cacheManager.normalizeCountryName(p.c || p.country);
                return pCity === normalizedCity && pCountry === normalizedCountry;
            });
            
            response += `\nüìä –ê–Ω–∫–µ—Ç –≤ –∫—ç—à–µ: ${exactMatches.length}\n`;
        }
        
        await ctx.reply(response);
        
    } catch (error) {
        console.error("–û—à–∏–±–∫–∞ –≤ fix_city:", error);
        await ctx.reply(`‚ùå –û—à–∏–±–∫–∞: ${error.message}\n–ò—Å–ø–æ–ª—å–∑—É–π: /fix_city –î—É–±–∞–π –û–ê–≠`);
    }
});
bot.command("check_country_normalization", async (ctx) => {
    try {
        const allProfiles = cacheManager.getGlobalProfiles(false);
        
        // –ò—â–µ–º –í–°–ï –≤–∞—Ä–∏–∞–Ω—Ç—ã –û–ê–≠ –≤ –ë–î
        const uaeVariants = new Set();
        const uaeProfiles = [];
        
        allProfiles.forEach(p => {
            const country = p.c || p.country;
            if (country && (country.includes("–û–ê–≠") || country.includes("UAE") || country.includes("–≠–º–∏—Ä–∞—Ç"))) {
                uaeVariants.add(country);
                uaeProfiles.push({
                    name: p.n || p.name,
                    country: country,
                    normalized: cacheManager.normalizeCountryName(country),
                    city: p.ct || p.city
                });
            }
        });
        
        let response = `üá¶üá™ **–í–ê–†–ò–ê–ù–¢–´ –ù–ê–ü–ò–°–ê–ù–ò–Ø –û–ê–≠ –í –ë–î:**\n\n`;
        response += `‚Ä¢ –í—Å–µ–≥–æ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤: ${uaeVariants.size}\n`;
        response += `‚Ä¢ –í—Å–µ–≥–æ –ø—Ä–æ—Ñ–∏–ª–µ–π: ${uaeProfiles.length}\n\n`;
        
        if (uaeVariants.size > 0) {
            response += `üìã **–í–∞—Ä–∏–∞–Ω—Ç—ã –≤ –ë–î:**\n`;
            Array.from(uaeVariants).forEach((variant, i) => {
                response += `${i+1}. "${variant}" ‚Üí –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω: ${cacheManager.normalizeCountryName(variant)}\n`;
            });
            
            response += `\nüë§ **–ü—Ä–∏–º–µ—Ä—ã –ø—Ä–æ—Ñ–∏–ª–µ–π:**\n`;
            uaeProfiles.slice(0, 5).forEach((p, i) => {
                response += `${i+1}. ${p.name}\n`;
                response += `   –°—Ç—Ä–∞–Ω–∞: "${p.country}"\n`;
                response += `   –ù–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–æ: ${p.normalized}\n`;
                response += `   –ì–æ—Ä–æ–¥: "${p.city}"\n\n`;
            });
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ñ–∏–ª—å—Ç—Ä
            const filterCountry = "üá¶üá™ –û–ê–≠";
            const normalizedFilter = cacheManager.normalizeCountryName(filterCountry);
            
            response += `\nüîç **–ü–†–û–í–ï–†–ö–ê –§–ò–õ–¨–¢–†–ê:**\n`;
            response += `‚Ä¢ –§–∏–ª—å—Ç—Ä: "${filterCountry}"\n`;
            response += `‚Ä¢ –ù–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π: "${normalizedFilter}"\n`;
            
            const matchingProfiles = uaeProfiles.filter(p => 
                cacheManager.normalizeCountryName(p.country) === normalizedFilter
            );
            
            response += `‚Ä¢ –°–æ–≤–ø–∞–¥–∞–µ—Ç —Å ${matchingProfiles.length} –ø—Ä–æ—Ñ–∏–ª—è–º–∏\n`;
        }
        
        await ctx.reply(response);
        
    } catch (error) {
        console.error("–û—à–∏–±–∫–∞ check_country_normalization:", error);
        await ctx.reply("‚ùå –û—à–∏–±–∫–∞");
    }
});
const safeClearMessages = async (ctx, keepCityKeyboard = false, keepCountryKeyboard = false) => {
    try {
        await messageManager.clear(ctx, keepCityKeyboard, keepCountryKeyboard);
    } catch (error) {
        if (error.response?.error_code !== 400 && error.response?.error_code !== 403) {
            console.error("–û—à–∏–±–∫–∞ –æ—á–∏—Å—Ç–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π:", error);
        }
    }
};
    bot.action("all_countries_with_check", async (ctx) => {
    const userId = ctx.from.id;
    console.log(`üåç [COUNTRIES] –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ${userId} –∑–∞–ø—Ä–æ—Å–∏–ª —Å—Ç—Ä–∞–Ω—ã`);
    
    // üî• –î–û–ë–ê–í–õ–Ø–ï–ú –ü–†–ï–õ–û–ê–î–ï–† –°–†–ê–ó–£
    let accessPreloader = null;
    try {
        accessPreloader = await sendPreloader(ctx, 'access', "üîç –ü–†–û–í–ï–†–ö–ê –î–û–°–¢–£–ü–ê");
    } catch (error) {
        console.log("‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –ø—Ä–µ–ª–æ–∞–¥–µ—Ä:", error.message);
    }
    
    // üî• –ë–´–°–¢–†–ê–Ø –ü–†–û–í–ï–†–ö–ê –ë–õ–û–ö–ò–†–û–í–ö–ò
    if (!acquireUserLock(userId, 2000)) {
        try {
            await ctx.answerCbQuery("‚è≥ –ü–æ–¥–æ–∂–¥–∏—Ç–µ, –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π –∑–∞–ø—Ä–æ—Å...");
            // –£–¥–∞–ª—è–µ–º –ø—Ä–µ–ª–æ–∞–¥–µ—Ä –±–µ–∑–æ–ø–∞—Å–Ω–æ
            await safeDeleteMessage(ctx, accessPreloader?.message_id);
        } catch (e) {}
        return;
    }
    
    // üî• –§–£–ù–ö–¶–ò–Ø –ë–ï–ó–û–ü–ê–°–ù–û–ì–û –£–î–ê–õ–ï–ù–ò–Ø –°–û–û–ë–©–ï–ù–ò–ô
    const safeDeleteMessage = async (messageId) => {
        if (!messageId) return;
        try {
            await ctx.telegram.deleteMessage(ctx.chat.id, messageId);
        } catch (error) {
            if (error.response?.error_code !== 400 && error.response?.error_code !== 403) {
                console.log(`‚ö†Ô∏è –û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è ${messageId}: ${error.message}`);
            }
        }
    };
    
    try {
        await ctx.answerCbQuery("üåç –ó–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç—Ä–∞–Ω—ã...");
        
        // –û—á–∏—â–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –±–µ–∑–æ–ø–∞—Å–Ω–æ
        await safeClearMessages(ctx);
        
        // üî• üî• üî• –≠–¢–ê–ü 1: –í–°–ï–ì–î–ê –ü–†–û–í–ï–†–Ø–ï–ú –î–û–°–¢–£–ü –ó–ê–ù–û–í–û
        console.log(`üîÑ [FORCE CHECK] –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –¥–ª—è ${userId}`);
        
        // –û—á–∏—â–∞–µ–º –í–°–ï –∫—ç—à–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        subscriptionCache.del(`subscription:${userId}`);
        channelSubscriptionCache.del(`channel:${userId}`);
        userCacheStatus.del(`cache_status:${userId}`);
        
        // üî• –ü–†–û–í–ï–†–Ø–ï–ú –ü–û–î–ü–ò–°–ö–£ –ò –ö–ê–ù–ê–õ –ó–ê–ù–û–í–û
        console.log(`üîç [ACCESS CHECK] –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –¥–ª—è ${userId}`);
        
        const hasSubscription = await checkSubscription(userId);
        const hasChannelSubscription = await checkChannelSubscription(ctx);
        const hasFullAccess = hasSubscription && hasChannelSubscription;
        
        console.log(`‚úÖ [ACCESS RESULT] ${userId}: –ø–æ–¥–ø–∏—Å–∫–∞=${hasSubscription}, –∫–∞–Ω–∞–ª=${hasChannelSubscription}, –ø–æ–ª–Ω—ã–π –¥–æ—Å—Ç—É–ø=${hasFullAccess}`);
        
        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø –∫—ç—à–∞
        const cacheType = hasFullAccess ? 'full' : 'demo';
        const isDemo = cacheType === 'demo';
        
        // üî• –£–î–ê–õ–Ø–ï–ú –ü–†–ï–õ–û–ê–î–ï–† –ë–ï–ó–û–ü–ê–°–ù–û
        if (accessPreloader) {
            await safeDeleteMessage(accessPreloader.message_id);
            accessPreloader = null;
        }
        
        // üî• üî• üî• –≠–¢–ê–ü 2: –ü–†–û–í–ï–†–Ø–ï–ú, –ó–ê–ì–†–£–ñ–ï–ù –õ–ò –ù–£–ñ–ù–´–ô –ö–≠–®
        if (isDemo && !cacheManager.isGlobalDemoCacheLoaded()) {
            // üî• –î–ï–ú–û-–ö–≠–® –ù–ï –ó–ê–ì–†–£–ñ–ï–ù - –ü–û–ö–ê–ó–´–í–ê–ï–ú –°–û–û–ë–©–ï–ù–ò–ï
            console.log(`‚ùå [DEMO CACHE NOT LOADED] –î–µ–º–æ-–∫—ç—à –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω –¥–ª—è ${userId}`);
            
            await ctx.reply(`
‚ö†Ô∏è <b>–ë–∞–∑–∞ –Ω–µ –≥–æ—Ç–æ–≤–∞! –ü–æ–¥–æ–∂–¥–∏—Ç–µ 1-2 –º–∏–Ω—É—Ç—ã!</b>

–¥–∞–Ω–Ω—ã–µ –µ—â–µ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã –≤ —Å–∏—Å—Ç–µ–º—É.


<b>–ß—Ç–æ –¥–µ–ª–∞—Ç—å:</b>
1. –ü–æ–¥–æ–∂–¥–∏—Ç–µ 1-2 –º–∏–Ω—É—Ç—ã
2. –ù–∞–∂–º–∏—Ç–µ "üåç –í–°–ï –°–¢–†–ê–ù–´" —Å–Ω–æ–≤–∞
3. –ò–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–º–∞–Ω–¥—É /start

<em>–ï—Å–ª–∏ –ø—Ä–æ–±–ª–µ–º–∞ , –Ω–∞–ø–∏—à–∏—Ç–µ –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É @MagicAdd</em>
            `, {
                parse_mode: "HTML",
                reply_markup: {
                    inline_keyboard: [
                        [{ text: "üîÑ –ü–û–í–¢–û–†–ò–¢–¨", callback_data: "all_countries_with_check" }],
                        [{ text: "üîô –ì–õ–ê–í–ù–û–ï –ú–ï–ù–Æ", callback_data: "back_to_menu" }]
                    ]
                }
            });
            
            return;
        }
        
        if (!isDemo && !cacheManager.isGlobalFullCacheLoaded()) {
            // üî• –ü–û–õ–ù–´–ô –ö–≠–® –ù–ï –ó–ê–ì–†–£–ñ–ï–ù, –ù–û –£ –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø –ï–°–¢–¨ –î–û–°–¢–£–ü
            console.log(`üöÄ [FULL CACHE NEEDED] –ì–ª–æ–±–∞–ª—å–Ω—ã–π –ø–æ–ª–Ω—ã–π –∫—ç—à –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω –¥–ª—è ${userId}`);
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –Ω–∞—á–∞–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏
            const loadingMsg = await ctx.reply(`
üîÑ <b>–ó–ê–ì–†–£–ó–ö–ê –ì–õ–û–ë–ê–õ–¨–ù–û–ì–û –î–û–°–¢–£–ü–ê</b>

üéâ –£ –≤–∞—Å –µ—Å—Ç—å –ø–æ–ª–Ω—ã–π –¥–æ—Å—Ç—É–ø!
üìä –ó–∞–≥—Ä—É–∂–∞–µ–º 70,000+ –∞–Ω–∫–µ—Ç –≤ –≥–ª–æ–±–∞–ª—å–Ω—ã–π –±–∞–∑—É...

‚è±Ô∏è <i>–≠—Ç–æ –∑–∞–π–º–µ—Ç 2-3 –º–∏–Ω—É—Ç—ã</i>
üì¶ <i>–ó–∞–≥—Ä—É–∂–∞–µ–º –ø–∞—á–∫–∞–º–∏ –ø–æ 5000 –∞–Ω–∫–µ—Ç</i>
‚ú® <i>–ü–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–æ—Å—Ç—É–ø–Ω–æ –¥–ª—è –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å –ø–æ–ª–Ω—ã–º –¥–æ—Å—Ç—É–ø–æ–º</i>

<em>–ù–µ –∑–∞–∫—Ä—ã–≤–∞–π—Ç–µ —á–∞—Ç, –∑–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç—Å—è –≤ —Ñ–æ–Ω–µ</em>
            `, { parse_mode: "HTML" });
            
            // üî• –ó–ê–ü–£–°–ö–ê–ï–ú –ó–ê–ì–†–£–ó–ö–£ –ì–õ–û–ë–ê–õ–¨–ù–û–ì–û –ö–≠–®–ê (—Ç–æ–ª—å–∫–æ –¥–ª—è –ø–æ–ª–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞)
            cacheManager.lazyLoadGlobalFullCache(db, userId)
                .then((success) => {
                    if (success) {
                        console.log(`‚úÖ [BACKGROUND GLOBAL CACHE] –ì–ª–æ–±–∞–ª—å–Ω—ã–π –ø–æ–ª–Ω—ã–π –∫—ç—à –∑–∞–≥—Ä—É–∂–µ–Ω –¥–ª—è ${userId}`);
                        // –£–¥–∞–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –∑–∞–≥—Ä—É–∑–∫–µ
                        safeDeleteMessage(loadingMsg.message_id);
                        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É—Å–ø–µ—à–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
                        ctx.reply(`
‚úÖ <b> –î–æ—Å—Ç—É–ø –∫ –ø–æ–ª–Ω–æ–π –±–∞–∑–µ –æ—Ç–∫—Ä—ã—Ç!</b>

üéâ –¢–µ–ø–µ—Ä—å –¥–æ—Å—Ç—É–ø–Ω—ã –≤—Å–µ 70,000+ –∞–Ω–∫–µ—Ç!
‚Ä¢ üë§ –í—Å–µ –∫–æ–Ω—Ç–∞–∫—Ç—ã –≤–∏–¥–Ω—ã
‚Ä¢ üìû –¢–µ–ª–µ—Ñ–æ–Ω—ã, Telegram, WhatsApp
‚Ä¢ ‚ö° –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è —Å–∫–æ—Ä–æ—Å—Ç—å —Ä–∞–±–æ—Ç—ã
                            `, { parse_mode: "HTML" });
                    } else {
                        console.log(`‚ùå [BACKGROUND GLOBAL CACHE ERROR] ${userId}: –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å`);
                        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ
                        safeDeleteMessage(loadingMsg.message_id);
                        ctx.reply(`‚ö†Ô∏è <b>–û–®–ò–ë–ö–ê –ó–ê–ì–†–£–ó–ö–ò</b>\n\n–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –ø–æ–ª–Ω—É—é –±–∞–∑—É.\n–ò—Å–ø–æ–ª—å–∑—É–µ–º –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω—ã–π –¥–æ—Å—Ç—É–ø.`, { parse_mode: "HTML" });
                    }
                })
                .catch(error => {
                    console.error(`‚ùå [BACKGROUND GLOBAL CACHE ERROR] ${userId}:`, error.message);
                    safeDeleteMessage(loadingMsg.message_id);
                });
            
            // üî• –ü–û–ö–ê–ó–´–í–ê–ï–ú –ü–ï–†–í–£–Æ –ü–ê–ß–ö–£ –°–¢–†–ê–ù (–∏–∑ –¥–µ–º–æ-–∫—ç—à–∞ –ø–æ–∫–∞ –∏–¥–µ—Ç –∑–∞–≥—Ä—É–∑–∫–∞ –ø–æ–ª–Ω–æ–≥–æ)
            if (cacheManager.isGlobalDemoCacheLoaded()) {
                console.log(`üìä [TEMPORARY] –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–µ–º–æ-—Å—Ç—Ä–∞–Ω—ã –ø–æ–∫–∞ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –≥–ª–æ–±–∞–ª—å–Ω—ã–π –ø–æ–ª–Ω—ã–π –∫—ç—à`);
                await messageManager.sendCountriesKeyboard(ctx, false, 0);
            } else {
                // –ï—Å–ª–∏ –¥–∞–∂–µ –¥–µ–º–æ-–∫—ç—à–∞ –Ω–µ—Ç
                await ctx.reply(`
‚è≥ <b>–ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –ì–õ–û–ë–ê–õ–¨–ù–û–ì–û –ö–≠–®–ê</b>

üìä –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–µ—Ä–≤—ã–µ –∞–Ω–∫–µ—Ç—ã...
‚è±Ô∏è –ü–æ–¥–æ–∂–¥–∏—Ç–µ 30 —Å–µ–∫—É–Ω–¥

<em>–°–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∏—Ç—Å—è –∫ —Ä–∞–±–æ—Ç–µ</em>
                `, { parse_mode: "HTML" });
            }
            
            return;
        }
        
        // üî• üî• üî• –≠–¢–ê–ü 3: –ö–≠–® –ó–ê–ì–†–£–ñ–ï–ù - –ü–û–ö–ê–ó–´–í–ê–ï–ú –°–¢–†–ê–ù–´
        console.log(`‚úÖ [CACHE READY] ${isDemo ? '–î–µ–º–æ' : '–ü–æ–ª–Ω—ã–π'} –∫—ç—à –∑–∞–≥—Ä—É–∂–µ–Ω –¥–ª—è ${userId}`);
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ —Å—Ç–∞—Ç—É—Å–µ
        if (isDemo) {
            await ctx.reply(`
üëÄ <b>–î–ï–ú–û-–†–ï–ñ–ò–ú</b>

‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ: –¥–æ—Å—Ç—É–ø–Ω—ã –í–°–ï —Å—Ç—Ä–∞–Ω—ã –∏ –≥–æ—Ä–æ–¥–∞
üìä –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ: –º–∞–∫—Å–∏–º—É–º 3 –∞–Ω–∫–µ—Ç—ã –Ω–∞ –≥–æ—Ä–æ–¥
üö´ –ö–æ–Ω—Ç–∞–∫—Ç—ã: —Å–∫—Ä—ã—Ç—ã

üíé <b>–î–ª—è –ø–æ–ª–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞:</b>
1. –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ –∫–∞–Ω–∞–ª <a href="https://t.me/+H6Eovikei9xiZWU0"><b>MagicClubPrivate</b></a>
2. –ê–∫—Ç–∏–≤–Ω–∞—è –æ–ø–ª–∞—á–µ–Ω–Ω–∞—è –ø–æ–¥–ø–∏—Å–∫–∞

<em>–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç—Ä–∞–Ω—É –¥–ª—è –Ω–∞—á–∞–ª–∞ –ø–æ–∏—Å–∫–∞</em>
            `, {
                parse_mode: "HTML",
                reply_markup: {
                    inline_keyboard: [
                        [{ text: "üíé –ü–û–õ–£–ß–ò–¢–¨ –ü–û–õ–ù–´–ô –î–û–°–¢–£–ü", callback_data: "get_full_access" }],
                        [{ text: "üì¢ –ü–û–î–ü–ò–°–ê–¢–¨–°–Ø –ù–ê –ö–ê–ù–ê–õ", url: "https://t.me/+H6Eovikei9xiZWU0" }]
                    ]
                }
            });
        } else {
            await ctx.reply(`
‚úÖ <b>–ü–û–õ–ù–´–ô –î–û–°–¢–£–ü –ê–ö–¢–ò–í–ò–†–û–í–ê–ù!</b>

üéâ –¢–µ–ø–µ—Ä—å —É –≤–∞—Å –¥–æ—Å—Ç—É–ø –∫–æ –≤—Å–µ–º 70,000+ –∞–Ω–∫–µ—Ç–∞–º
‚Ä¢ üë§ –í—Å–µ –∫–æ–Ω—Ç–∞–∫—Ç—ã –≤–∏–¥–Ω—ã
‚Ä¢ üìû –¢–µ–ª–µ—Ñ–æ–Ω—ã, Telegram, WhatsApp
‚Ä¢ ‚ö° –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è —Å–∫–æ—Ä–æ—Å—Ç—å

<code>–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç—Ä–∞–Ω—É –¥–ª—è –Ω–∞—á–∞–ª–∞ –ø–æ–∏—Å–∫–∞</code>
            `, {
                parse_mode: "HTML"
            });
        }
        
        // üî• –ü–û–ö–ê–ó–´–í–ê–ï–ú –°–¢–†–ê–ù–´
        await messageManager.sendCountriesKeyboard(ctx, isDemo, 0);
        
    } catch (error) {
        console.error("‚ùå [COUNTRIES CRITICAL] –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞:", error);
        
        // –£–î–ê–õ–Ø–ï–ú –ü–†–ï–õ–û–ê–î–ï–† –ü–†–ò –û–®–ò–ë–ö–ï
        if (accessPreloader) {
            await safeDeleteMessage(accessPreloader.message_id);
        }
        
        try {
            await ctx.answerCbQuery("‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏");
            
            // –ü–†–ò –û–®–ò–ë–ö–ï - –ü–û–ö–ê–ó–´–í–ê–ï–ú –°–û–û–ë–©–ï–ù–ò–ï
            await ctx.reply(`
‚ùå <b>–ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê</b>

–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–ø–∏—Å–æ–∫ —Å—Ç—Ä–∞–Ω.

<em>–í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã:</em>
‚Ä¢ –ì–ª–æ–±–∞–ª—å–Ω—ã–π –∫—ç—à –µ—â–µ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω
‚Ä¢ –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã —Å —Å–µ—Ä–≤–µ—Ä–æ–º
‚Ä¢ –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è

–ü–æ–ø—Ä–æ–±—É–π—Ç–µ:
1. –ü–æ–¥–æ–∂–¥–∞—Ç—å 1-2 –º–∏–Ω—É—Ç—ã
2. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫–æ–º–∞–Ω–¥—É /start
3. –ù–∞–ø–∏—Å–∞—Ç—å –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É @MagicAdd
            `, { parse_mode: "HTML" });
            
        } catch (e) {
            console.error("–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ:", e);
        }
        
    } finally {
        releaseUserLock(userId);
    }
});
bot.command("debug_demo_profile", async (ctx) => {
    try {
        const demoProfiles = cacheManager.getGlobalProfiles(true);
        
        if (!demoProfiles || demoProfiles.length === 0) {
            return ctx.reply("‚ùå –î–µ–º–æ-–∫—ç—à –ø—É—Å—Ç!");
        }
        
        // –ò—â–µ–º –ø—Ä–æ—Ñ–∏–ª—å –°–∞—Ä–∞–µ–≤–æ
        const sarajevoProfiles = demoProfiles.filter(p => {
            const city = cacheManager.normalizeCityName(p.ct || p.city);
            const country = cacheManager.normalizeCountryName(p.c || p.country);
            return city === "–°–∞—Ä–∞–µ–≤–æ" && country === "üáßüá¶ –ë–æ—Å–Ω–∏—è";
        });
        
        let response = `üîç **–î–ò–ê–ì–ù–û–°–¢–ò–ö–ê –î–ï–ú–û-–ü–†–û–§–ò–õ–Ø –°–ê–†–ê–ï–í–û:**\n\n`;
        response += `–í—Å–µ–≥–æ –¥–µ–º–æ-–ø—Ä–æ—Ñ–∏–ª–µ–π: ${demoProfiles.length}\n`;
        response += `–ü—Ä–æ—Ñ–∏–ª–µ–π –°–∞—Ä–∞–µ–≤–æ: ${sarajevoProfiles.length}\n\n`;
        
        if (sarajevoProfiles.length > 0) {
            sarajevoProfiles.forEach((p, i) => {
                response += `**–ü—Ä–æ—Ñ–∏–ª—å ${i+1}:**\n`;
                response += `‚Ä¢ ID: ${p.id || '–Ω–µ—Ç'}\n`;
                response += `‚Ä¢ –ò–º—è: "${p.n}"\n`;
                response += `‚Ä¢ –í–æ–∑—Ä–∞—Å—Ç: ${p.a}\n`;
                response += `‚Ä¢ –°—Ç—Ä–∞–Ω–∞: "${p.c}"\n`;
                response += `‚Ä¢ –ì–æ—Ä–æ–¥: "${p.ct}"\n`;
                response += `‚Ä¢ –û—Å–Ω–æ–≤–Ω–æ–µ —Ñ–æ—Ç–æ: ${p.p ? '‚úÖ' : '‚ùå'}\n`;
                response += `‚Ä¢ –§–æ—Ç–æ –≥–∞–ª–µ—Ä–µ–∏: ${p.phs?.length || 0}\n`;
                response += `‚Ä¢ isDemo: ${p.isDemo}\n`;
                response += `‚Ä¢ TG: ${p.tg ? '–µ—Å—Ç—å' : '—Å–∫—Ä—ã—Ç–æ'}\n`;
                response += `‚Ä¢ –û —Å–µ–±–µ: ${p.ab?.substring(0, 50) || '–Ω–µ—Ç'}...\n\n`;
            });
        } else {
            response += `‚ùå **–ù–ï–¢ –ü–†–û–§–ò–õ–ï–ô –°–ê–†–ê–ï–í–û –í –î–ï–ú–û-–ö–≠–®–ï!**\n\n`;
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É –ø–µ—Ä–≤–æ–≥–æ –ø—Ä–æ—Ñ–∏–ª—è
            if (demoProfiles.length > 0) {
                const sampleProfile = demoProfiles[0];
                response += `**–ü—Ä–∏–º–µ—Ä –ø–µ—Ä–≤–æ–≥–æ –ø—Ä–æ—Ñ–∏–ª—è –≤ –¥–µ–º–æ-–∫—ç—à–µ:**\n`;
                response += `‚Ä¢ –ò–º—è: "${sampleProfile.n}"\n`;
                response += `‚Ä¢ –°—Ç—Ä–∞–Ω–∞: "${sampleProfile.c}"\n`;
                response += `‚Ä¢ –ì–æ—Ä–æ–¥: "${sampleProfile.ct}"\n`;
                response += `‚Ä¢ isDemo: ${sampleProfile.isDemo}\n`;
            }
        }
        
        await ctx.reply(response);
        
    } catch (error) {
        console.error("–û—à–∏–±–∫–∞ debug_demo_profile:", error);
        await ctx.reply(`‚ùå –û—à–∏–±–∫–∞: ${error.message}`);
    }
});
    bot.action("get_full_access", async (ctx) => {
        await messageQueue.add(async () => {
            try {
                await ctx.answerCbQuery("üíé –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ –æ–ø–ª–∞—Ç–µ...");
                
                const keyboard = {
                    inline_keyboard: [
                        [
                            { text: "üíé –ö—É–ø–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É", callback_data: "choose_payment_method" }
                        ],
                        [
                            { text: "üì¢ –ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ –∫–∞–Ω–∞–ª", url: "https://t.me/+H6Eovikei9xiZWU0" }
                        ],
                        [
                            { text: "üîô –ù–∞–∑–∞–¥", callback_data: "back_to_menu" }
                        ]
                    ]
                };

                await ctx.reply(`
üíé <b>–ü–û–õ–£–ß–ò–¢–¨ –ü–û–õ–ù–´–ô –î–û–°–¢–£–ü</b>

–î–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –ø–æ–ª–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞ –∫–æ –≤—Å–µ–º –∞–Ω–∫–µ—Ç–∞–º –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ:

‚úÖ <b>1. –ê–∫—Ç–∏–≤–Ω–∞—è –ø–æ–¥–ø–∏—Å–∫–∞</b>
   ‚Ä¢ –î–æ—Å—Ç—É–ø –∫–æ –≤—Å–µ–º –∞–Ω–∫–µ—Ç–∞–º
   ‚Ä¢ –í—Å–µ –∫–æ–Ω—Ç–∞–∫—Ç—ã –ø—Ä–æ—Ñ–∏–ª–µ–π
   ‚Ä¢ –ü–æ–ª–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å

‚úÖ <b>2. –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ –∫–∞–Ω–∞–ª <a href="https://t.me/+H6Eovikei9xiZWU0"><b>MagicClubPrivate</b></a></b>
   ‚Ä¢ –ù–æ–≤—ã–µ –∞–Ω–∫–µ—Ç—ã –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
   ‚Ä¢ –≠–∫—Å–∫–ª—é–∑–∏–≤–Ω—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç
   ‚Ä¢ –°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è

<b>–ü–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã –ø–æ–¥–ø–∏—Å–∫–∏ –∏ –ø–æ–¥–ø–∏—Å–∫–∏ –Ω–∞ –∫–∞–Ω–∞–ª –≤—ã –ø–æ–ª—É—á–∏—Ç–µ:</b>
‚Ä¢ üîì –ü–æ–ª–Ω—ã–π –¥–æ—Å—Ç—É–ø –∫–æ –≤—Å–µ–º –∞–Ω–∫–µ—Ç–∞–º
‚Ä¢ üìû –í—Å–µ –∫–æ–Ω—Ç–∞–∫—Ç—ã –ø—Ä–æ—Ñ–∏–ª–µ–π  
‚Ä¢ üåç –ù–µ–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω—ã–π –ø–æ–∏—Å–∫ –ø–æ —Å—Ç—Ä–∞–Ω–∞–º –∏ –≥–æ—Ä–æ–¥–∞–º
‚Ä¢ ‚ö° –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—É—é —Å–∫–æ—Ä–æ—Å—Ç—å —Ä–∞–±–æ—Ç—ã

–ù–∞–∂–º–∏—Ç–µ "–ö—É–ø–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É" —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å!
                `, {
                    parse_mode: "HTML",
                    reply_markup: keyboard
                });
                
            } catch (error) {
                console.error("‚ùå –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –ø–æ–ª—É—á–µ–Ω–∏—è –¥–æ—Å—Ç—É–ø–∞:", error);
            }
        });
    });
bot.command("cache_debug", async (ctx) => {
    await messageQueue.add(async () => {
        const userId = ctx.from.id;
        const cacheType = cacheManager.getUserCacheStatus(userId);
        const hasFullAccess = await checkFullAccess(ctx, false);
        const sessionType = ctx.session?.cacheSession?.type || '–Ω–µ—Ç';
        
        const cacheStats = cacheManager.getGlobalCacheStats();
        
        // –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ñ–∏–ª—å—Ç—Ä–∞—Ö
        const filterCacheKeys = globalFilterCache.keys();
        const demoFilterKeys = globalDemoCache.keys().filter(k => k.startsWith('demo:filter:'));
        
        // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º —Ñ–∏–ª—å—Ç—Ä—ã –ø–æ —Å—Ç—Ä–∞–Ω–∞–º –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞
        const filtersByCountry = new Map();
        filterCacheKeys.forEach(key => {
            const match = key.match(/country:([^:]+):/);
            if (match) {
                const country = match[1];
                filtersByCountry.set(country, (filtersByCountry.get(country) || 0) + 1);
            }
        });
        
        // –§–æ—Ä–º–∏—Ä—É–µ–º —Å–ø–∏—Å–æ–∫ —Ç–æ–ø-5 —Å—Ç—Ä–∞–Ω –ø–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É —Ñ–∏–ª—å—Ç—Ä–æ–≤
        let topCountriesInfo = '';
        if (filtersByCountry.size > 0) {
            const sortedCountries = Array.from(filtersByCountry.entries())
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5);
            
            topCountriesInfo = sortedCountries.map(([country, count], index) => 
                `${index + 1}. ${country}: ${count} —Ñ–∏–ª—å—Ç—Ä–æ–≤`
            ).join('\n');
        }
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –±—ã–ª–∞ –ª–∏ –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è
        const precomputed = globalProfilesCache.get("filters:precomputed") || false;
        
        const message = `
üîß <b>–î–ï–ë–ê–ì –ì–õ–û–ë–ê–õ–¨–ù–û–ì–û –ö–≠–®–ê</b>

üë§ <b>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:</b> ${userId}
üíæ <b>–¢–∏–ø –∫—ç—à–∞:</b> ${cacheType || '–Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω'}
üîì <b>–ü–æ–ª–Ω—ã–π –¥–æ—Å—Ç—É–ø:</b> ${hasFullAccess ? '‚úÖ' : '‚ùå'}
üíº <b>–°–µ—Å—Å–∏—è:</b> ${sessionType}
üß† <b>–ü—Ä–µ–¥. –≥–µ–Ω–µ—Ä–∞—Ü–∏—è:</b> ${precomputed ? '‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–∞' : '‚ùå –ù–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞'}

üìä <b>–ì–õ–û–ë–ê–õ–¨–ù–´–ô –ö–≠–® (–æ–±—â–∏–π –¥–ª—è –≤—Å–µ—Ö):</b>
‚Ä¢ –ü–æ–ª–Ω—ã–π –∫—ç—à: ${cacheStats.fullCache.loaded ? `‚úÖ ${cacheStats.fullCache.profilesCount} –∞–Ω–∫–µ—Ç, ${cacheStats.fullCache.countriesCount} —Å—Ç—Ä–∞–Ω` : '‚ùå –ù–µ –∑–∞–≥—Ä—É–∂–µ–Ω'}
‚Ä¢ –î–µ–º–æ –∫—ç—à: ${cacheStats.demoCache.loaded ? `‚úÖ ${cacheStats.demoCache.profilesCount} –∞–Ω–∫–µ—Ç, ${cacheStats.demoCache.countriesCount} —Å—Ç—Ä–∞–Ω` : '‚ùå –ù–µ –∑–∞–≥—Ä—É–∂–µ–Ω'}

üîç <b>–ö–≠–®–ò –§–ò–õ–¨–¢–†–û–í (TTL: 24 —á–∞—Å–∞):</b>
‚Ä¢ –ü–æ–ª–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã: ${filterCacheKeys.length} 
‚Ä¢ –î–µ–º–æ —Ñ–∏–ª—å—Ç—Ä—ã: ${demoFilterKeys.length}

üåç <b>–¢–æ–ø-5 —Å—Ç—Ä–∞–Ω –ø–æ —Ñ–∏–ª—å—Ç—Ä–∞–º:</b>
${topCountriesInfo || '‚ùå –ù–µ—Ç —Ñ–∏–ª—å—Ç—Ä–æ–≤ –≤ –∫—ç—à–µ'}

üë• <b>–ò–ù–î–ò–í–ò–î–£–ê–õ–¨–ù–´–ï –ö–≠–®–ò:</b>
‚Ä¢ –ü–æ–¥–ø–∏—Å–∫–∏: ${cacheStats.subscriptionCacheCount}
‚Ä¢ –ö–∞–Ω–∞–ª—ã: ${cacheStats.channelCacheCount}
‚Ä¢ –°—Ç–∞—Ç—É—Å—ã: ${cacheStats.userStatusCacheCount}

üìñ <b>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —á—Ç–µ–Ω–∏–π:</b>
‚Ä¢ –í—Å–µ–≥–æ —á—Ç–µ–Ω–∏–π: ${readingStats.totalReads}
‚Ä¢ Firestore: ${readingStats.operations.firestoreReads}
‚Ä¢ –ö—ç—à –ø–æ–ø–∞–¥–∞–Ω–∏—è: ${readingStats.operations.cacheHits || 0}
‚Ä¢ –ö—ç—à –ø—Ä–æ–º–∞—Ö–∏: ${readingStats.operations.cacheMisses || 0}
‚Ä¢ –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å: ${readingStats.getStats().cacheEfficiency || '0%'}

‚ö° <b>–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:</b>
${!precomputed && hasFullAccess ? '‚Ä¢ –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ /precompute_filters –¥–ª—è —É—Å–∫–æ—Ä–µ–Ω–∏—è –ø–æ–∏—Å–∫–∞' : ''}
${filterCacheKeys.length === 0 && hasFullAccess ? '‚Ä¢ –ù–µ—Ç —Ñ–∏–ª—å—Ç—Ä–æ–≤ –≤ –∫—ç—à–µ - —Å–≥–µ–Ω–µ—Ä–∏—Ä—É–π—Ç–µ –∏—Ö' : ''}
${filterCacheKeys.length > 50 ? '‚Ä¢ ‚úÖ –ö—ç—à —Ñ–∏–ª—å—Ç—Ä–æ–≤ —Ä–∞–±–æ—Ç–∞–µ—Ç —Ö–æ—Ä–æ—à–æ' : ''}
        `;
        
        const keyboard = {
            inline_keyboard: []
        };
        
        if (hasFullAccess && (!precomputed || filterCacheKeys.length < 50)) {
            keyboard.inline_keyboard.push([
                { text: "üß† –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã", callback_data: "force_precompute" }
            ]);
        }
        
        keyboard.inline_keyboard.push([
            { text: "üîÑ –û–±–Ω–æ–≤–∏—Ç—å", callback_data: "debug_refresh" },
            { text: "üîô –ù–∞–∑–∞–¥", callback_data: "back_to_menu" }
        ]);
        
        await ctx.reply(message, {
            parse_mode: "HTML",
            reply_markup: keyboard
        });
    });
});
bot.command("check_demo_sarajevo", async (ctx) => {
    try {
        // –ü–æ–ª—É—á–∞–µ–º –¥–µ–º–æ-–ø—Ä–æ—Ñ–∏–ª–∏
        const demoProfiles = cacheManager.getGlobalProfiles(true);
        
        if (!demoProfiles || demoProfiles.length === 0) {
            return ctx.reply("‚ùå –î–µ–º–æ-–∫—ç—à –ø—É—Å—Ç!");
        }
        
        // –ò—â–µ–º –ø—Ä–æ—Ñ–∏–ª–∏ –°–∞—Ä–∞–µ–≤–æ
        const sarajevoProfiles = demoProfiles.filter(p => {
            const city = cacheManager.normalizeCityName(p.ct || p.city);
            const country = cacheManager.normalizeCountryName(p.c || p.country);
            return city === "–°–∞—Ä–∞–µ–≤–æ" && country === "üáßüá¶ –ë–æ—Å–Ω–∏—è";
        });
        
        let response = `üîç **–ü–†–û–í–ï–†–ö–ê –°–ê–†–ê–ï–í–û –í –î–ï–ú–û-–ö–≠–®–ï:**\n\n`;
        response += `–í—Å–µ–≥–æ –¥–µ–º–æ-–ø—Ä–æ—Ñ–∏–ª–µ–π: ${demoProfiles.length}\n`;
        response += `–ü—Ä–æ—Ñ–∏–ª–µ–π –°–∞—Ä–∞–µ–≤–æ: ${sarajevoProfiles.length}\n\n`;
        
        if (sarajevoProfiles.length > 0) {
            response += `**–ù–∞–π–¥–µ–Ω—ã –ø—Ä–æ—Ñ–∏–ª–∏:**\n`;
            sarajevoProfiles.forEach((p, i) => {
                response += `${i+1}. ${p.n || p.name}, ${p.a || p.age}\n`;
                response += `   ID: ${p.id || p._id || '–Ω–µ—Ç'}\n`;
                response += `   –ì–æ—Ä–æ–¥: "${p.ct || p.city}"\n`;
                response += `   –°—Ç—Ä–∞–Ω–∞: "${p.c || p.country}"\n`;
                response += `   –û—Å–Ω–æ–≤–Ω–æ–µ —Ñ–æ—Ç–æ: ${p.p ? '‚úÖ' : '‚ùå'}\n`;
                response += `   –§–æ—Ç–æ –≥–∞–ª–µ—Ä–µ–∏: ${p.phs?.length || 0}\n`;
                response += `   –¢–µ–ª–µ—Ñ–æ–Ω: ${p.tel ? '–µ—Å—Ç—å' : '—Å–∫—Ä—ã—Ç'}\n`;
                response += `   Telegram: ${p.tg ? '–µ—Å—Ç—å' : '—Å–∫—Ä—ã—Ç'}\n\n`;
            });
        } else {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≥–æ—Ä–æ–¥–∞ –ë–æ—Å–Ω–∏–∏ –≤ –¥–µ–º–æ-–∫—ç—à–µ
            const bosniaCities = cacheManager.getGlobalCities("üáßüá¶ –ë–æ—Å–Ω–∏—è", true);
            response += `**–ì–æ—Ä–æ–¥–∞ –ë–æ—Å–Ω–∏–∏ –≤ –¥–µ–º–æ-–∫—ç—à–µ:** ${bosniaCities?.length || 0}\n`;
            if (bosniaCities) {
                response += `–°–ø–∏—Å–æ–∫: ${bosniaCities.slice(0, 10).join(', ')}\n`;
            }
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–ª–Ω—ã–π –∫—ç—à –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è
            const fullProfiles = cacheManager.getGlobalProfiles(false);
            if (fullProfiles) {
                const fullSarajevo = fullProfiles.filter(p => {
                    const city = cacheManager.normalizeCityName(p.ct || p.city);
                    const country = cacheManager.normalizeCountryName(p.c || p.country);
                    return city === "–°–∞—Ä–∞–µ–≤–æ" && country === "üáßüá¶ –ë–æ—Å–Ω–∏—è";
                });
                response += `\n**–í –ø–æ–ª–Ω–æ–º –∫—ç—à–µ:** ${fullSarajevo.length} –ø—Ä–æ—Ñ–∏–ª–µ–π –°–∞—Ä–∞–µ–≤–æ\n`;
            }
        }
        
        await ctx.reply(response);
        
    } catch (error) {
        console.error("–û—à–∏–±–∫–∞ check_demo_sarajevo:", error);
        await ctx.reply(`‚ùå –û—à–∏–±–∫–∞: ${error.message}`);
    }
});
// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–Ω–æ–ø–∫–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ñ–∏–ª—å—Ç—Ä–æ–≤
bot.action("force_precompute", async (ctx) => {
    await ctx.answerCbQuery("üß† –ó–∞–ø—É—Å–∫–∞–µ–º –≥–µ–Ω–µ—Ä–∞—Ü–∏—é —Ñ–∏–ª—å—Ç—Ä–æ–≤...");
    await ctx.reply("–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–º–∞–Ω–¥—É /precompute_filters –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ñ–∏–ª—å—Ç—Ä–æ–≤");
});

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
bot.action("debug_refresh", async (ctx) => {
    await ctx.answerCbQuery("üîÑ –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É...");
    await ctx.deleteMessage();
    await ctx.replyWithHTML("–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ /cache_debug —Å–Ω–æ–≤–∞.");
});
bot.command("debug_city_exact", async (ctx) => {
    try {
        const [_, city] = ctx.text.split(' ');
        
        if (!city) return ctx.reply("–ù–∞–ø—Ä–∏–º–µ—Ä: /debug_city_exact –î—É–±–∞–π");
        
        // –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ –ø—Ä–æ—Ñ–∏–ª–∏
        const allProfiles = cacheManager.getGlobalProfiles(false) || [];
        
        // –ò—â–µ–º —Ç–æ—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ (–í–ú–ï–°–¢–ï —Å –∫–∞–≤—ã—á–∫–∞–º–∏)
        const profilesWithQuotes = allProfiles.filter(p => {
            const pCity = p.ct || p.city;
            return pCity && pCity.includes('"') && pCity.includes(city);
        });
        
        let response = `üîç **–ü–û–ò–°–ö –ì–û–†–û–î–ê "${city}":**\n\n`;
        
        if (profilesWithQuotes.length > 0) {
            response += `‚úÖ –ù–∞–π–¥–µ–Ω–æ ${profilesWithQuotes.length} –∞–Ω–∫–µ—Ç —Å –ö–ê–í–´–ß–ö–ê–ú–ò!\n\n`;
            
            profilesWithQuotes.slice(0, 5).forEach((profile, i) => {
                response += `${i+1}. ${profile.n || profile.name}, ${profile.a || profile.age}\n`;
                response += `   –ì–æ—Ä–æ–¥ –≤ –ë–î: "${profile.ct || profile.city}"\n`;
                response += `   –ù–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω: ${cacheManager.normalizeCityName(profile.ct || profile.city)}\n`;
                response += `   –°—Ç—Ä–∞–Ω–∞: ${profile.c || profile.country}\n\n`;
            });
        } else {
            // –ò—â–µ–º –±–µ–∑ –∫–∞–≤—ã—á–µ–∫
            const normalizedCity = cacheManager.normalizeCityName(city);
            const profilesExact = allProfiles.filter(p => {
                const pCity = cacheManager.normalizeCityName(p.ct || p.city);
                return pCity === normalizedCity;
            });
            
            response += `üîç –ü–æ–∏—Å–∫ –ø–æ –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–º—É: "${normalizedCity}"\n`;
            response += `üìä –ù–∞–π–¥–µ–Ω–æ: ${profilesExact.length} –∞–Ω–∫–µ—Ç\n\n`;
            
            profilesExact.slice(0, 3).forEach((profile, i) => {
                response += `${i+1}. ${profile.n || profile.name}\n`;
                response += `   –ò—Å—Ö–æ–¥–Ω—ã–π –≥–æ—Ä–æ–¥: "${profile.ct || profile.city}"\n`;
            });
        }
        
        await ctx.reply(response);
        
    } catch (error) {
        console.error("–û—à–∏–±–∫–∞ debug_city_exact:", error);
        await ctx.reply("‚ùå –û—à–∏–±–∫–∞");
    }
});
bot.command("check_filter_cache", async (ctx) => {
    try {
        const filterKey = "country:üá¶üá™ –û–ê–≠:age:all:city:–î—É–±–∞–π";
        const cached = cacheManager.getGlobalFilter(filterKey, false);
        
        let response = `üîç **–ü–†–û–í–ï–†–ö–ê –ö–≠–®–ê –§–ò–õ–¨–¢–†–û–í:**\n\n`;
        response += `–ö–ª—é—á: ${filterKey}\n`;
        response += `–í –∫—ç—à–µ: ${cached ? `${cached.length} –ø—Ä–æ—Ñ–∏–ª–µ–π` : '‚ùå –Ω–µ—Ç –≤ –∫—ç—à–µ'}\n\n`;
        
        if (cached) {
            response += `–ü–µ—Ä–≤—ã–µ 3 –ø—Ä–æ—Ñ–∏–ª—è:\n`;
            cached.slice(0, 3).forEach((profile, i) => {
                const fullProfile = {
                    id: profile.id,
                    name: profile.n,
                    age: profile.a,
                    country: profile.c,
                    city: profile.ct,
                    about: profile.ab
                };
                response += `${i+1}. ${fullProfile.name}, ${fullProfile.age}\n`;
                response += `   –ì–æ—Ä–æ–¥: "${fullProfile.city}"\n`;
                response += `   –°—Ç—Ä–∞–Ω–∞: "${fullProfile.country}"\n\n`;
            });
        }
        
        await ctx.reply(response);
        
    } catch (error) {
        console.error("–û—à–∏–±–∫–∞ check_filter_cache:", error);
        await ctx.reply("‚ùå –û—à–∏–±–∫–∞");
    }
});
bot.command("check_uae_profiles", async (ctx) => {
    try {
        const allProfiles = cacheManager.getGlobalProfiles(false);
        
        if (!allProfiles || allProfiles.length === 0) {
            return ctx.reply("‚ùå –ì–ª–æ–±–∞–ª—å–Ω—ã–π –∫—ç—à –ø—É—Å—Ç");
        }
        
        // –ò—â–µ–º –ø—Ä–æ—Ñ–∏–ª–∏ –û–ê–≠
        const uaeProfiles = allProfiles.filter(p => {
            const country = p.c || p.country;
            return country && cacheManager.normalizeCountryName(country) === "üá¶üá™ –û–ê–≠";
        });
        
        let response = `üìä **–ü–†–û–§–ò–õ–ò –û–ê–≠ –í –ì–õ–û–ë–ê–õ–¨–ù–û–ú –ö–≠–®–ï:**\n\n`;
        response += `‚Ä¢ –í—Å–µ–≥–æ –ø—Ä–æ—Ñ–∏–ª–µ–π –≤ –∫—ç—à–µ: ${allProfiles.length}\n`;
        response += `‚Ä¢ –ü—Ä–æ—Ñ–∏–ª–µ–π –û–ê–≠: ${uaeProfiles.length}\n\n`;
        
        if (uaeProfiles.length > 0) {
            response += `üèôÔ∏è **–ì–æ—Ä–æ–¥–∞ –û–ê–≠ –≤ –∫—ç—à–µ:**\n`;
            const cities = new Set();
            uaeProfiles.forEach(p => {
                const city = p.ct || p.city;
                if (city) cities.add(`${city} ‚Üí –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω: ${cacheManager.normalizeCityName(city)}`);
            });
            
            Array.from(cities).slice(0, 10).forEach((city, i) => {
                response += `${i+1}. ${city}\n`;
            });
            
            response += `\nüë§ **–ü—Ä–∏–º–µ—Ä—ã –ø—Ä–æ—Ñ–∏–ª–µ–π –û–ê–≠:**\n`;
            uaeProfiles.slice(0, 3).forEach((p, i) => {
                response += `${i+1}. ${p.n || p.name}, ${p.a || p.age}\n`;
                response += `   –ì–æ—Ä–æ–¥: "${p.ct || p.city}"\n`;
                response += `   –°—Ç—Ä–∞–Ω–∞: "${p.c || p.country}"\n\n`;
            });
        } else {
            response += `‚ùå **–ù–ï–¢ –ü–†–û–§–ò–õ–ï–ô –û–ê–≠ –í –ì–õ–û–ë–ê–õ–¨–ù–û–ú –ö–≠–®–ï!**\n`;
            response += `–í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã:\n`;
            response += `1. –ì–ª–æ–±–∞–ª—å–Ω—ã–π –ø–æ–ª–Ω—ã–π –∫—ç—à –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –ø—Ä–æ—Ñ–∏–ª–µ–π –û–ê–≠\n`;
            response += `2. –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∫—ç—à–∞\n`;
            response += `3. –ü—Ä–æ—Ñ–∏–ª–∏ –û–ê–≠ –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª–∏—Å—å\n`;
        }
        
        await ctx.reply(response);
        
    } catch (error) {
        console.error("–û—à–∏–±–∫–∞ check_uae_profiles:", error);
        await ctx.reply("‚ùå –û—à–∏–±–∫–∞");
    }
});
    bot.command("force_check", async (ctx) => {
        await messageQueue.add(async () => {
            try {
                const userId = ctx.from.id;
                
                // –û–ß–ò–©–ê–ï–ú –í–°–ï –ò–ù–î–ò–í–ò–î–£–ê–õ–¨–ù–´–ï –ö–≠–®–ò
                channelSubscriptionCache.del(`channel:${userId}`);
                subscriptionCache.del(`subscription:${userId}`);
                userCacheStatus.del(`cache_status:${userId}`);
                
                if (ctx.session) {
                    delete ctx.session.cacheType;
                    delete ctx.session.hasFullAccess;
                    delete ctx.session.fullAccessChecked;
                    delete ctx.session.fullAccessCheckTime;
                }
                
                // –ü–†–û–í–ï–†–Ø–ï–ú –ó–ê–ù–û–í–û —Å forceRefresh
                const [hasSubscription, hasChannel] = await Promise.all([
                    checkSubscription(userId),
                    checkChannelSubscription(ctx)
                ]);
                
                const accessType = hasSubscription && hasChannel ? 'full' : 'demo';
                cacheManager.setUserCacheStatus(userId, accessType);
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ —Å–µ—Å—Å–∏—é
                if (!ctx.session) ctx.session = {};
                ctx.session.hasFullAccess = hasSubscription && hasChannel;
                ctx.session.fullAccessChecked = true;
                ctx.session.fullAccessCheckTime = Date.now();
                
                await ctx.reply(`
üîÑ <b>–ü–†–ò–ù–£–î–ò–¢–ï–õ–¨–ù–ê–Ø –ü–†–û–í–ï–†–ö–ê</b>

‚úÖ –û—á–∏—â–µ–Ω—ã
‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞

<b>–†–µ–∑—É–ª—å—Ç–∞—Ç:</b>
‚Ä¢ üíé –ü–æ–¥–ø–∏—Å–∫–∞: ${hasSubscription ? '‚úÖ –ê–ö–¢–ò–í–ù–ê' : '‚ùå –ù–ï–¢'}
‚Ä¢ üì¢ –ö–∞–Ω–∞–ª: ${hasChannel ? '‚úÖ –ü–û–î–ü–ò–°–ê–ù' : '‚ùå –ù–ï–¢'}
‚Ä¢ üë§ –†–µ–∂–∏–º: ${accessType === 'full' ? 'üîì –ü–û–õ–ù–´–ô' : 'üëÄ –î–ï–ú–û'}

${!hasChannel ? '‚ö†Ô∏è <b>–í—ã –Ω–µ –ø–æ–¥–ø–∏—Å–∞–Ω—ã –Ω–∞ –∫–∞–Ω–∞–ª <a href="https://t.me/+H6Eovikei9xiZWU0"><b>MagicClubPrivate</b></a></b>' : ''}
                `, { parse_mode: "HTML" });
                
            } catch (error) {
                console.error("‚ùå –û—à–∏–±–∫–∞ force_check:", error);
                await ctx.reply("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏");
            }
        });
    });


    bot.command("reset_cache_stats", async (ctx) => {
        await messageQueue.add(async () => {
            const userId = ctx.from.id;
            // –¢–û–õ–¨–ö–û –î–õ–Ø –ê–î–ú–ò–ù–û–í
            const ADMINS = [123456789]; // –í–∞—à ID
            
            if (!ADMINS.includes(userId)) {
                return ctx.reply("‚ùå –≠—Ç–∞ –∫–æ–º–∞–Ω–¥–∞ —Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤");
            }
            
            readingStats.resetStats();
            
            await ctx.reply("‚úÖ –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —á—Ç–µ–Ω–∏–π —Å–±—Ä–æ—à–µ–Ω–∞");
        });
    });

    // –î–µ–π—Å—Ç–≤–∏–µ –¥–ª—è –ø–æ–∫–∞–∑–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –∫—ç—à–∞
    bot.action("show_cache_stats", async (ctx) => {
        await messageQueue.add(async () => {
            try {
                const cacheStats = cacheManager.getGlobalCacheStats();
                const readStats = readingStats.getStats();
                
                const statsMessage = `
üìä <b>–°–¢–ê–¢–ò–°–¢–ò–ö–ê –ì–õ–û–ë–ê–õ–¨–ù–û–ì–û –ö–≠–®–ê</b>

üîπ <b>–ì–ª–æ–±–∞–ª—å–Ω—ã–π –¥–µ–º–æ-–∫—ç—à:</b>
‚Ä¢ –ê–Ω–∫–µ—Ç: ${cacheStats.demoCache.profilesCount}
‚Ä¢ –°—Ç—Ä–∞–Ω: ${cacheStats.demoCache.countriesCount}
‚Ä¢ –ó–∞–≥—Ä—É–∂–µ–Ω: ${cacheStats.demoCache.loaded ? '‚úÖ' : '‚ùå'}

üîπ <b>–ì–ª–æ–±–∞–ª—å–Ω—ã–π –ø–æ–ª–Ω—ã–π –∫—ç—à:</b>
‚Ä¢ –ê–Ω–∫–µ—Ç: ${cacheStats.fullCache.profilesCount}
‚Ä¢ –°—Ç—Ä–∞–Ω: ${cacheStats.fullCache.countriesCount}
‚Ä¢ –ó–∞–≥—Ä—É–∂–µ–Ω: ${cacheStats.fullCache.loaded ? '‚úÖ' : '‚ùå'}

üîπ <b>–ö—ç—à–∏ —Ñ–∏–ª—å—Ç—Ä–æ–≤:</b>
‚Ä¢ –ü–æ–ª–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã: ${cacheStats.filterCacheKeys}
‚Ä¢ –î–µ–º–æ —Ñ–∏–ª—å—Ç—Ä—ã: ${cacheStats.demoFilterCacheKeys}

üîπ <b>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —á—Ç–µ–Ω–∏–π:</b>
‚Ä¢ –í—Å–µ–≥–æ —á—Ç–µ–Ω–∏–π: ${readStats.totalReads}
‚Ä¢ Firestore —á—Ç–µ–Ω–∏–π: ${readStats.firestoreReads}
‚Ä¢ –ö—ç—à –ø–æ–ø–∞–¥–∞–Ω–∏—è: ${readStats.operations.cacheHits}
‚Ä¢ –ö—ç—à –ø—Ä–æ–º–∞—Ö–∏: ${readStats.operations.cacheMisses}
‚Ä¢ –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å: ${readStats.cacheEfficiency}

üîπ <b>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏:</b>
‚Ä¢ –£–Ω–∏–∫–∞–ª—å–Ω—ã–µ: ${readStats.uniqueUsers}
‚Ä¢ –û–ø–µ—Ä–∞—Ü–∏–π –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: ${readStats.readsPerUser.toFixed(2)}

<code>–ì–ª–æ–±–∞–ª—å–Ω—ã–π –∫—ç—à –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è —Ä–∞–∑ –≤ 7 –¥–Ω–µ–π</code>
                `;
                
                const keyboard = {
                    inline_keyboard: []
                };
                
                if (!cacheStats.fullCache.loaded) {
                    keyboard.inline_keyboard.push([
                        { text: "üöÄ –ó–∞–≥—Ä—É–∑–∏—Ç—å –≥–ª–æ–±–∞–ª—å–Ω—ã–π –ø–æ–ª–Ω—ã–π –∫—ç—à", callback_data: "force_load_global_full_cache" }
                    ]);
                }
                
                keyboard.inline_keyboard.push([
                    { text: "üîÑ –û–±–Ω–æ–≤–∏—Ç—å", callback_data: "show_cache_stats" },
                    { text: "üîô –ù–∞–∑–∞–¥", callback_data: "back_to_menu" }
                ]);
                
                await ctx.reply(statsMessage, {
                    parse_mode: "HTML",
                    reply_markup: keyboard
                });
                await ctx.answerCbQuery();
                
            } catch (error) {
                console.error("‚ùå –û—à–∏–±–∫–∞ –ø–æ–∫–∞–∑–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –∫—ç—à–∞:", error);
            }
        });
    });

    // –î–µ–π—Å—Ç–≤–∏–µ –¥–ª—è –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ –≥–ª–æ–±–∞–ª—å–Ω–æ–≥–æ –ø–æ–ª–Ω–æ–≥–æ –∫—ç—à–∞
    bot.action("force_load_global_full_cache", async (ctx) => {
        await messageQueue.add(async () => {
            try {
                await ctx.answerCbQuery("üöÄ –ó–∞–ø—É—Å–∫–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É...");
                await ctx.reply("–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–º–∞–Ω–¥—É /load_global_full_cache –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –≥–ª–æ–±–∞–ª—å–Ω–æ–≥–æ –ø–æ–ª–Ω–æ–≥–æ –∫—ç—à–∞");
            } catch (error) {
                console.error("‚ùå –û—à–∏–±–∫–∞:", error);
            }
        });
    });

    // –û–ë–†–ê–ë–û–¢–ß–ò–ö –ü–ê–ì–ò–ù–ê–¶–ò–ò –°–¢–†–ê–ù
    bot.action(/^countries_page_(\d+)$/, async (ctx) => {
        const userId = ctx.from.id;
        
        if (!acquireUserLock(userId, 2000)) {
            await ctx.answerCbQuery("‚è≥ –ü–æ–¥–æ–∂–¥–∏—Ç–µ, –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π –∑–∞–ø—Ä–æ—Å...");
            return;
        }
        
        await messageQueue.add(async () => {
            try {
                const page = parseInt(ctx.match[1]);
                
                // –ü–†–û–í–ï–†–Ø–ï–ú –ò –û–ë–ù–û–í–õ–Ø–ï–ú –ö–≠–® (—Å —Å–µ—Å—Å–∏–æ–Ω–Ω—ã–º –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ–º)
                const cacheType = await ensureProperCache(ctx);
                const isDemo = cacheType === 'demo';
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –Ω–æ–≤–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ–π
                const uniqueCountries = await getUniqueCountries(isDemo);
                const countriesPerPage = 30;
                const totalPages = Math.ceil(uniqueCountries.length / countriesPerPage);
                
                if (page < 0 || page >= totalPages) {
                    await ctx.answerCbQuery("‚ùå –ù–µ–≤–µ—Ä–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞");
                    return;
                }
                
                const startIndex = page * countriesPerPage;
                const endIndex = Math.min(startIndex + countriesPerPage, uniqueCountries.length);
                const pageCountries = uniqueCountries.slice(startIndex, endIndex);
                
                const keyboard = [];
                let row = [];
                
                pageCountries.forEach((country, index) => {
                    const countryWithFlag = formatCountryWithFlag(country);
                    row.push({ text: countryWithFlag, callback_data: `country_${country}` });
                    
                    if (row.length === 2 || index === pageCountries.length - 1) {
                        keyboard.push(row);
                        row = [];
                    }
                });
                
                if (totalPages > 1) {
                    const paginationRow = [];
                    
                    if (page > 0) {
                        paginationRow.push({ 
                            text: "‚óÄÔ∏è –ù–∞–∑–∞–¥", 
                            callback_data: `countries_page_${page - 1}` 
                        });
                    }
                    
                    paginationRow.push({ 
                        text: `–°—Ç—Ä–∞–Ω–∞ ${page + 1}/${totalPages}`, 
                        callback_data: "countries_page_info" 
                    });
                    
                    if (page < totalPages - 1) {
                        paginationRow.push({ 
                            text: "–í–ø–µ—Ä–µ–¥ ‚ñ∂Ô∏è", 
                            callback_data: `countries_page_${page + 1}` 
                        });
                    }
                    
                    if (paginationRow.length > 0) {
                        keyboard.push(paginationRow);
                    }
                    
                    if (totalPages > 5) {
                        const quickPagesRow = [];
                        const pagesToShow = Math.min(5, totalPages);
                        
                        for (let i = 0; i < pagesToShow; i++) {
                            quickPagesRow.push({
                                text: i === page ? `‚Ä¢ ${i + 1} ‚Ä¢` : `${i + 1}`,
                                callback_data: `countries_page_${i}`
                            });
                        }
                        
                        if (page >= pagesToShow) {
                            quickPagesRow.push({ text: "...", callback_data: "countries_page_info" });
                            quickPagesRow.push({
                                text: `‚Ä¢ ${page + 1} ‚Ä¢`,
                                callback_data: `countries_page_${page}`
                            });
                        }
                        
                        if (quickPagesRow.length > 0) {
                            keyboard.push(quickPagesRow);
                        }
                    }
                }
                
                keyboard.push([{ text: "üìù –°–û–ó–î–ê–¢–¨ –ê–ù–ö–ï–¢–£", web_app: { url: "https://bot-vai-web-app.web.app/?tab=catalog" } }]);
                
                if (isDemo) {
                    keyboard.push([{ text: "üíé –ü–û–õ–£–ß–ò–¢–¨ –ü–û–õ–ù–´–ô –î–û–°–¢–£–ü", callback_data: "get_full_access" }]);
                }
                
                keyboard.push([{ text: "üîô –ù–∞–∑–∞–¥", callback_data: "back_to_menu" }]);
                
                try {
                    await ctx.editMessageText(
                        isDemo ? 
                        `üëÄ –î–ï–ú–û-–†–ï–ñ–ò–ú: –í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç—Ä–∞–Ω—É (–ø–æ–∫–∞–∑–∞–Ω–æ –ø–æ 3 –∞–Ω–∫–µ—Ç—ã –Ω–∞ –≥–æ—Ä–æ–¥)\n\nüìÑ –°—Ç—Ä–∞–Ω–∏—Ü–∞ ${page + 1} –∏–∑ ${totalPages}\nüåç –í—Å–µ–≥–æ —Å—Ç—Ä–∞–Ω: ${uniqueCountries.length}\n\nüíé –î–ª—è –ø–æ–ª–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞ –í—ã –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –ø–æ–¥–ø–∏—Å–∞–Ω—ã –Ω–∞ –Ω–∞—à –∫–∞–Ω–∞–ª <a href="https://t.me/+H6Eovikei9xiZWU0"><b>MagicClubPrivate</b></a> –∏ –æ–ø–ª–∞—Ç–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É` : 
                        `üåç –í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç—Ä–∞–Ω—É (—Å—Ç—Ä–∞–Ω–∏—Ü–∞ ${page + 1} –∏–∑ ${totalPages})\nüìä –í—Å–µ–≥–æ —Å—Ç—Ä–∞–Ω: ${uniqueCountries.length}\nüìç –ü–æ–∫–∞–∑–∞–Ω–æ: ${pageCountries.length} —Å—Ç—Ä–∞–Ω`,
                        {
                            parse_mode: "HTML",
                            reply_markup: { inline_keyboard: keyboard }
                        }
                    );
                    
                    await ctx.answerCbQuery(`üìÑ –°—Ç—Ä–∞–Ω–∏—Ü–∞ ${page + 1} –∏–∑ ${totalPages}`);
                    
                } catch (error) {
                    console.error("‚ùå –û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã —Å—Ç—Ä–∞–Ω:", error);
                    await ctx.answerCbQuery("‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏");
                }
                
            } catch (error) {
                console.error("‚ùå –û—à–∏–±–∫–∞ –ø–∞–≥–∏–Ω–∞—Ü–∏–∏ —Å—Ç—Ä–∞–Ω:", error);
                await ctx.answerCbQuery("‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏");
            } finally {
                releaseUserLock(userId);
            }
        });
    });

    bot.command("countries_stats", async (ctx) => {
        await messageQueue.add(async () => {
            try {
                const cacheType = await ensureProperCache(ctx);
                const isDemo = cacheType === 'demo';
                
                const uniqueCountries = await getUniqueCountries(isDemo);
                const totalCountries = uniqueCountries.length;
                
                const removeFlag = (countryName) => {
                    if (!countryName) return countryName;
                    const firstChar = countryName.charAt(0);
                    const isEmojiFlag = firstChar.codePointAt(0) > 127;
                    
                    if (isEmojiFlag && countryName.length > 2) {
                        return countryName.substring(2).trim();
                    }
                    return countryName;
                };
                
                const regions = {
                    europe: ['–†–æ—Å—Å–∏—è', '–£–∫—Ä–∞–∏–Ω–∞', '–ë–µ–ª–∞—Ä—É—Å—å', '–ì–µ—Ä–º–∞–Ω–∏—è', '–§—Ä–∞–Ω—Ü–∏—è', '–ò—Ç–∞–ª–∏—è', '–ò—Å–ø–∞–Ω–∏—è', '–ü–æ–ª—å—à–∞', '–ù–∏–¥–µ—Ä–ª–∞–Ω–¥—ã', '–ë–µ–ª—å–≥–∏—è', '–®–≤–µ–π—Ü–∞—Ä–∏—è', '–ê–≤—Å—Ç—Ä–∏—è', '–ü–æ—Ä—Ç—É–≥–∞–ª–∏—è', '–ì—Ä–µ—Ü–∏—è', '–ß–µ—Ö–∏—è', '–®–≤–µ—Ü–∏—è', '–ù–æ—Ä–≤–µ–≥–∏—è', '–§–∏–Ω–ª—è–Ω–¥–∏—è', '–î–∞–Ω–∏—è', '–ò—Ä–ª–∞–Ω–¥–∏—è', '–í–µ–Ω–≥—Ä–∏—è', '–†—É–º—ã–Ω–∏—è', '–ë–æ–ª–≥–∞—Ä–∏—è', '–°–µ—Ä–±–∏—è', '–•–æ—Ä–≤–∞—Ç–∏—è', '–°–ª–æ–≤–∞–∫–∏—è', '–°–ª–æ–≤–µ–Ω–∏—è', '–õ–∏—Ç–≤–∞', '–õ–∞—Ç–≤–∏—è', '–≠—Å—Ç–æ–Ω–∏—è', '–ú–æ–ª–¥–æ–≤–∞', '–ê–ª–±–∞–Ω–∏—è'],
                    asia: ['–ö–∞–∑–∞—Ö—Å—Ç–∞–Ω', '–¢—É—Ä—Ü–∏—è', '–ö–∏—Ç–∞–π', '–Ø–ø–æ–Ω–∏—è', '–Æ–∂–Ω–∞—è –ö–æ—Ä–µ—è', '–ò–Ω–¥–∏—è', '–¢–∞–∏–ª–∞–Ω–¥', '–û–ê–≠', '–£–∑–±–µ–∫–∏—Å—Ç–∞–Ω', '–ö—ã—Ä–≥—ã–∑—Å—Ç–∞–Ω', '–¢–∞–¥–∂–∏–∫–∏—Å—Ç–∞–Ω', '–¢—É—Ä–∫–º–µ–Ω–∏—Å—Ç–∞–Ω', '–ì—Ä—É–∑–∏—è', '–ê—Ä–º–µ–Ω–∏—è', '–ê–∑–µ—Ä–±–∞–π–¥–∂–∞–Ω', '–ò–∑—Ä–∞–∏–ª—å'],
                    america: ['–°–®–ê', '–ö–∞–Ω–∞–¥–∞', '–ú–µ–∫—Å–∏–∫–∞', '–ë—Ä–∞–∑–∏–ª–∏—è'],
                    africa: ['–Æ–ê–†', '–ï–≥–∏–ø–µ—Ç'],
                    oceania: ['–ê–≤—Å—Ç—Ä–∞–ª–∏—è']
                };
                
                let statsByRegion = {};
                Object.keys(regions).forEach(region => {
                    const count = uniqueCountries.filter(country => {
                        const cleanCountry = removeFlag(country);
                        return regions[region].includes(cleanCountry);
                    }).length;
                    statsByRegion[region] = count;
                });
                
                const topCountries = uniqueCountries.slice(0, 10).map((country, i) => {
                    return `${i + 1}. ${country}`;
                }).join('\n');
                
                const statsMessage = `
üåç **–°–¢–ê–¢–ò–°–¢–ò–ö–ê –°–¢–†–ê–ù**

üìä **–û–±—â–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è:**
‚Ä¢ –í—Å–µ–≥–æ —Å—Ç—Ä–∞–Ω: ${totalCountries}
‚Ä¢ –î–µ–º–æ-—Ä–µ–∂–∏–º: ${isDemo ? '‚úÖ' : '‚ùå'}
‚Ä¢ –°—Ç—Ä–∞–Ω–∏—Ü: ${Math.ceil(totalCountries / 60)}

üó∫Ô∏è **–ü–æ —Ä–µ–≥–∏–æ–Ω–∞–º:**
‚Ä¢ –ï–≤—Ä–æ–ø–∞: ${statsByRegion.europe || 0}
‚Ä¢ –ê–∑–∏—è: ${statsByRegion.asia || 0}
‚Ä¢ –ê–º–µ—Ä–∏–∫–∞: ${statsByRegion.america || 0}
‚Ä¢ –ê—Ñ—Ä–∏–∫–∞: ${statsByRegion.africa || 0}
‚Ä¢ –û–∫–µ–∞–Ω–∏—è: ${statsByRegion.oceania || 0}
‚Ä¢ –î—Ä—É–≥–∏–µ: ${totalCountries - Object.values(statsByRegion).reduce((a, b) => a + b, 0)}

üìã **–¢–æ–ø-10 —Å—Ç—Ä–∞–Ω:**
${topCountries}

${totalCountries > 10 ? `... –∏ –µ—â–µ ${totalCountries - 10} —Å—Ç—Ä–∞–Ω` : ''}
                `;
                
                const msg = await ctx.reply(statsMessage, { parse_mode: "Markdown" });
                messageManager.track(ctx.chat.id, msg.message_id);
                
            } catch (error) {
                console.error("‚ùå –û—à–∏–±–∫–∞ –∫–æ–º–∞–Ω–¥—ã countries_stats:", error);
                await ctx.reply("‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ —Å—Ç—Ä–∞–Ω");
            }
        });
    });

    bot.action("countries_page_info", async (ctx) => {
        await ctx.answerCbQuery("üìÑ –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫–∏ –¥–ª—è –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ –ø–æ —Å—Ç—Ä–∞–Ω–∞–º");
    });

    bot.action(/^country_(.+)$/, async (ctx) => {
        const userId = ctx.from.id;
        
        if (!acquireUserLock(userId, 2500)) {
            await ctx.answerCbQuery("‚è≥ –ü–æ–¥–æ–∂–¥–∏—Ç–µ, –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π –∑–∞–ø—Ä–æ—Å...");
            return;
        }
        
        await messageQueue.add(async () => {
            let preloaderMsg = null;
            
            try {
                const country = ctx.match[1];
                
                // üî• –î–û–ë–ê–í–õ–Ø–ï–ú –ü–†–ï–õ–û–ê–î–ï–†
                preloaderMsg = await sendPreloader(ctx, 'country', "üåç –ó–ê–ì–†–£–ó–ö–ê –ì–û–†–û–î–û–í");
                
                const cacheType = await ensureProperCache(ctx);
                const isDemo = cacheType === 'demo';
                
                ctx.session = ctx.session || {};
                ctx.session.profilesPage = 0;
                ctx.session.filterCountry = country;
                ctx.session.displayCountry = country;
                ctx.session.filterCity = null;
                ctx.session.isDemo = isDemo;

                await messageManager.clear(ctx);
                
                await messageManager.sendCitiesKeyboard(ctx, country, isDemo);
                
                // üî• –£–î–ê–õ–Ø–ï–ú –ü–†–ï–õ–û–ê–î–ï–†
                if (preloaderMsg) {
                    await ctx.telegram.deleteMessage(ctx.chat.id, preloaderMsg.message_id);
                }
                
                await ctx.answerCbQuery();
                
            } catch (error) {
                console.error("‚ùå –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≤—ã–±–æ—Ä–∞ —Å—Ç—Ä–∞–Ω—ã:", error);
                
                // üî• –£–î–ê–õ–Ø–ï–ú –ü–†–ï–õ–û–ê–î–ï–† –ü–†–ò –û–®–ò–ë–ö–ï
                if (preloaderMsg) {
                    try {
                        await ctx.telegram.deleteMessage(ctx.chat.id, preloaderMsg.message_id);
                    } catch (e) {}
                }
                
            } finally {
                releaseUserLock(userId);
            }
        });
    });
    
    bot.action(/^city_(.+)$/, async (ctx) => {
        const userId = ctx.from.id;
        
        if (!acquireUserLock(userId, 30000)) {
            await ctx.answerCbQuery("‚è≥ –ü–æ–¥–æ–∂–¥–∏—Ç–µ, –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π –∑–∞–ø—Ä–æ—Å...");
            return;
        }
        
        await messageQueue.add(async () => {
            let preloaderMsg = null;
            
            try {
                const city = ctx.match[1];
                
                await ctx.answerCbQuery("üîç –ò—â–µ–º –∞–Ω–∫–µ—Ç—ã...");
                
                // üî• –î–û–ë–ê–í–õ–Ø–ï–ú –ü–†–ï–õ–û–ê–î–ï–† –î–õ–Ø –ü–û–ò–°–ö–ê –ì–û–†–û–î–ê
                preloaderMsg = await sendPreloader(ctx, 'city', "üîç –ü–û–ò–°–ö –ê–ù–ö–ï–¢");
                
                const cacheType = await ensureProperCache(ctx);
                const isDemo = cacheType === 'demo';
                
                console.log(`üèôÔ∏è [CITY] –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ${userId} –≤—ã–±—Ä–∞–ª –≥–æ—Ä–æ–¥ ${city}, –¥–µ–º–æ=${isDemo}`);
                
                ctx.session = ctx.session || {};
                ctx.session.profilesPage = 0;
                ctx.session.filterCity = city;
                ctx.session.isDemo = isDemo;

                await messageManager.clear(ctx, true, true);
                
                console.log(`üîç [CITY] –ó–∞–≥—Ä—É–∂–∞–µ–º –∞–Ω–∫–µ—Ç—ã –¥–ª—è –≥–æ—Ä–æ–¥–∞ ${city}...`);
                const profiles = await getProfilesPage(0, ctx.session.filterCountry, ctx.session.ageRange, city, isDemo);

                // üî• –£–î–ê–õ–Ø–ï–ú –ü–†–ï–õ–û–ê–î–ï–† –ü–û–°–õ–ï –ó–ê–ì–†–£–ó–ö–ò
                if (preloaderMsg) {
                    await ctx.telegram.deleteMessage(ctx.chat.id, preloaderMsg.message_id);
                }
                preloaderMsg = null;

                if (!profiles.length) {
                    const msg = await ctx.reply(`‚ùå –ê–Ω–∫–µ—Ç –∏–∑ –≥–æ—Ä–æ–¥–∞ "${city}" –Ω–µ –Ω–∞–π–¥–µ–Ω–æ`);
                    messageManager.track(ctx.chat.id, msg.message_id);
                    return;
                }

                console.log(`‚úÖ [CITY] –ù–∞–π–¥–µ–Ω–æ ${profiles.length} –∞–Ω–∫–µ—Ç –¥–ª—è –≥–æ—Ä–æ–¥–∞ ${city}`);

                const foundMsg = await ctx.reply(
                    `üìç <b>–ì–æ—Ä–æ–¥:</b> ${city}\n` +
                    `üåç <b>–°—Ç—Ä–∞–Ω–∞:</b> ${ctx.session.filterCountry}\n` +
                    `üëÄ <b>–†–µ–∂–∏–º:</b> ${isDemo ? '–î–µ–º–æ (3 –∞–Ω–∫–µ—Ç—ã –Ω–∞ –≥–æ—Ä–æ–¥)' : '–ü–æ–ª–Ω—ã–π –¥–æ—Å—Ç—É–ø'}`,
                    { parse_mode: "HTML" }
                );
                messageManager.track(ctx.chat.id, foundMsg.message_id);

                for (let i = 0; i < profiles.length; i++) {
                    const isLast = i === profiles.length - 1;
                    
                    if (i === 0 && profiles.length > 1) {
                        const progressMsg = await ctx.reply(
                            `üì§ <b>–û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∞–Ω–∫–µ—Ç—ã...</b>\n` +
                            `üìä <i>–ü—Ä–æ–≥—Ä–µ—Å—Å: 1/${profiles.length}</i>`,
                            { parse_mode: "HTML" }
                        );
                        messageManager.track(ctx.chat.id, progressMsg.message_id);
                    }
                    
                    await sendProfile(ctx, profiles[i], 0, profiles.length, isLast, isDemo);
                    
                    if (!isLast) {
                        await new Promise((resolve) => setTimeout(resolve, 500));
                    }
                }

            } catch (error) {
                console.error("‚ùå –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≤—ã–±–æ—Ä–∞ –≥–æ—Ä–æ–¥–∞:", error);
                
                // üî• –£–î–ê–õ–Ø–ï–ú –ü–†–ï–õ–û–ê–î–ï–† –ü–†–ò –û–®–ò–ë–ö–ï
                if (preloaderMsg) {
                    try {
                        await ctx.telegram.deleteMessage(ctx.chat.id, preloaderMsg.message_id);
                    } catch (e) {
                        console.log("–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å –ø—Ä–µ–ª–æ–∞–¥–µ—Ä –ø—Ä–∏ –æ—à–∏–±–∫–µ:", e.message);
                    }
                }
                
                try {
                    await ctx.reply(
                        "‚ùå <b>–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∞–Ω–∫–µ—Ç</b>\n\n" +
                        "‚ö†Ô∏è <i>–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑ —á–µ—Ä–µ–∑ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–µ–∫—É–Ω–¥</i>",
                        { parse_mode: "HTML" }
                    );
                } catch (e) {
                    console.error("–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ:", e);
                }
            } finally {
                releaseUserLock(userId);
            }
        });
    });

    bot.action(/^cities_page_(.+)_(\d+)$/, async (ctx) => {
        const userId = ctx.from.id;
        
        if (!acquireUserLock(userId, 2000)) {
            await ctx.answerCbQuery("‚è≥ –ü–æ–¥–æ–∂–¥–∏—Ç–µ, –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π –∑–∞–ø—Ä–æ—Å...");
            return;
        }
        
        await messageQueue.add(async () => {
            try {
                const [_, country, page] = ctx.match;
                const pageNum = parseInt(page);
                
                const cacheType = await ensureProperCache(ctx);
                const isDemo = cacheType === 'demo';
                
                const cities = await getUniqueCitiesForCountry(country, isDemo);
                
                if (!cities || cities.length === 0) {
                    await ctx.answerCbQuery("‚ùå –ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –≥–æ—Ä–æ–¥–æ–≤");
                    return;
                }

                const citiesPerPage = 50;
                const totalPages = Math.ceil(cities.length / citiesPerPage);
                
                if (pageNum < 0 || pageNum >= totalPages) {
                    await ctx.answerCbQuery("‚ùå –ù–µ–≤–µ—Ä–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞");
                    return;
                }

                const keyboard = [];
                let row = [];

                const startIndex = pageNum * citiesPerPage;
                const endIndex = Math.min(startIndex + citiesPerPage, cities.length);
                const pageCities = cities.slice(startIndex, endIndex);

                pageCities.forEach((city, index) => {
                    row.push({ text: city, callback_data: `city_${city}` });
                    if (row.length === 2 || index === pageCities.length - 1) {
                        keyboard.push(row);
                        row = [];
                    }
                });

                const paginationRow = [];
                if (totalPages > 1) {
                    if (pageNum > 0) {
                        paginationRow.push({ 
                            text: "‚óÄÔ∏è –ü—Ä–µ–¥—ã–¥—É—â–∏–µ", 
                            callback_data: `cities_page_${country}_${pageNum - 1}` 
                        });
                    }
                    
                    paginationRow.push({ 
                        text: `${pageNum + 1}/${totalPages}`, 
                        callback_data: "cities_page_info" 
                    });
                    
                    if (pageNum < totalPages - 1) {
                        paginationRow.push({ 
                            text: "–°–ª–µ–¥—É—é—â–∏–µ ‚ñ∂Ô∏è", 
                            callback_data: `cities_page_${country}_${pageNum + 1}` 
                        });
                    }
                    
                    if (paginationRow.length > 0) {
                        keyboard.push(paginationRow);
                    }
                }

                keyboard.push([{ 
                    text: "üìù –°–û–ó–î–ê–¢–¨ –ê–ù–ö–ï–¢–£", 
                    web_app: { url: "https://bot-vai-web-app.web.app/?tab=catalog" } 
                }]);

                if (isDemo) {
                    keyboard.push([{ 
                        text: "üíé –ü–û–õ–£–ß–ò–¢–¨ –ü–û–õ–ù–´–ô –î–û–°–¢–£–ü", 
                        callback_data: "get_full_access" 
                    }]);
                }

                keyboard.push([{ 
                    text: "üîô –ù–∞–∑–∞–¥ –∫ —Å—Ç—Ä–∞–Ω–∞–º", 
                    callback_data: "back_to_countries" 
                }]);

                try {
                    await ctx.editMessageReplyMarkup({
                        inline_keyboard: keyboard
                    });
                    await ctx.answerCbQuery(`üìÑ –°—Ç—Ä–∞–Ω–∏—Ü–∞ ${pageNum + 1} –∏–∑ ${totalPages}`);
                } catch (error) {
                    console.error("‚ùå –û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã –≥–æ—Ä–æ–¥–æ–≤:", error);
                    await ctx.answerCbQuery("‚ùå –û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è");
                }
                
            } catch (error) {
                console.error("‚ùå –û—à–∏–±–∫–∞ –ø–∞–≥–∏–Ω–∞—Ü–∏–∏ –≥–æ—Ä–æ–¥–æ–≤:", error);
                await ctx.answerCbQuery("‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏");
            } finally {
                releaseUserLock(userId);
            }
        });
    });

    bot.action("cities_page_info", async (ctx) => {
        await ctx.answerCbQuery("üìÑ –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫–∏ –¥–ª—è –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ –ø–æ –≥–æ—Ä–æ–¥–∞–º");
    });
// ===================== –û–ë–†–ê–ë–û–¢–ß–ò–ö –î–õ–Ø –ö–ù–û–ü–ö–ò "–í–ï–†–ù–£–¢–¨–°–Ø –ö –ì–û–†–û–î–ê–ú" =====================
bot.action("back_to_current_country_cities", async (ctx) => {
    const userId = ctx.from.id;
    
    if (!acquireUserLock(userId, 2000)) {
        await ctx.answerCbQuery("‚è≥ –ü–æ–¥–æ–∂–¥–∏—Ç–µ, –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π –∑–∞–ø—Ä–æ—Å...");
        return;
    }
    
    await messageQueue.add(async () => {
        try {
            await ctx.answerCbQuery("üèôÔ∏è –í–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –∫ –≥–æ—Ä–æ–¥–∞–º...");
            
            // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â—É—é —Å—Ç—Ä–∞–Ω—É –∏–∑ —Å–µ—Å—Å–∏–∏
            const currentCountry = ctx.session.filterCountry;
            const cacheType = await ensureProperCache(ctx);
            const isDemo = cacheType === 'demo';
            
            if (!currentCountry) {
                console.log(`‚ùå [BACK TO CITIES] –ù–µ—Ç —Å—Ç—Ä–∞–Ω—ã –≤ —Å–µ—Å—Å–∏–∏ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${userId}`);
                await ctx.reply("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Ç–µ–∫—É—â—É—é —Å—Ç—Ä–∞–Ω—É. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Å—Ç—Ä–∞–Ω—É –∑–∞–Ω–æ–≤–æ.");
                await messageManager.sendCountriesKeyboard(ctx, isDemo);
                return;
            }
            
            console.log(`üèôÔ∏è [BACK TO CITIES] –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ${userId} –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è –∫ –≥–æ—Ä–æ–¥–∞–º —Å—Ç—Ä–∞–Ω—ã ${currentCountry}, –¥–µ–º–æ=${isDemo}`);
            
            // –û—á–∏—â–∞–µ–º —ç–∫—Ä–∞–Ω, –Ω–æ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É —Å—Ç—Ä–∞–Ω
            await messageManager.clear(ctx, false, true);
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É –≥–æ—Ä–æ–¥–æ–≤ –¥–ª—è —Ç–µ–∫—É—â–µ–π —Å—Ç—Ä–∞–Ω—ã
            await messageManager.sendCitiesKeyboard(ctx, currentCountry, isDemo);
            
        } catch (error) {
            console.error("‚ùå –û—à–∏–±–∫–∞ –≤–æ–∑–≤—Ä–∞—Ç–∞ –∫ –≥–æ—Ä–æ–¥–∞–º:", error);
            try {
                await ctx.answerCbQuery("‚ùå –û—à–∏–±–∫–∞ –≤–æ–∑–≤—Ä–∞—Ç–∞");
            } catch (e) {
            }
        } finally {
            releaseUserLock(userId);
        }
    });
});
    bot.action("back_to_countries", async (ctx) => {
        const userId = ctx.from.id;
        
        if (!acquireUserLock(userId, 2000)) {
            await ctx.answerCbQuery("‚è≥ –ü–æ–¥–æ–∂–¥–∏—Ç–µ, –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π –∑–∞–ø—Ä–æ—Å...");
            return;
        }
        
        await messageQueue.add(async () => {
            try {
                const cacheType = await ensureProperCache(ctx);
                const isDemo = cacheType === 'demo';
                
                await messageManager.clear(ctx, false, true);
                await messageManager.sendCountriesKeyboard(ctx, isDemo);
                await ctx.answerCbQuery("‚úÖ –í–æ–∑–≤—Ä–∞—Ç –∫ —Å—Ç—Ä–∞–Ω–∞–º");
                
            } catch (error) {
                console.error("‚ùå –û—à–∏–±–∫–∞ –≤–æ–∑–≤—Ä–∞—Ç–∞ –∫ —Å—Ç—Ä–∞–Ω–∞–º:", error);
                try {
                    await ctx.answerCbQuery("‚ùå –û—à–∏–±–∫–∞ –≤–æ–∑–≤—Ä–∞—Ç–∞");
                } catch (e) {
                }
            } finally {
                releaseUserLock(userId);
            }
        });
    });
    
    bot.action("back_to_menu", async (ctx) => {
        const userId = ctx.from.id;
        
        if (!acquireUserLock(userId, 2000)) {
            await ctx.answerCbQuery("‚è≥ –ü–æ–¥–æ–∂–¥–∏—Ç–µ, –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π –∑–∞–ø—Ä–æ—Å...");
            return;
        }
        
        await messageQueue.add(async () => {
            try {
                await messageManager.clear(ctx);
                await messageManager.sendMainMenu(ctx);
                await ctx.answerCbQuery();
            } catch (error) {
                console.error("‚ùå –û—à–∏–±–∫–∞ –≤–æ–∑–≤—Ä–∞—Ç–∞ –≤ –º–µ–Ω—é:", error);
            } finally {
                releaseUserLock(userId);
            }
        });
    });

    bot.action("filter_by_age", async (ctx) => {
        const userId = ctx.from.id;
        
        if (!acquireUserLock(userId, 2000)) {
            await ctx.answerCbQuery("‚è≥ –ü–æ–¥–æ–∂–¥–∏—Ç–µ, –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π –∑–∞–ø—Ä–æ—Å...");
            return;
        }
        
        await messageQueue.add(async () => {
            try {
                const chatId = ctx.chat.id;
                const countryKeyboardId = chatStorage.countryKeyboard.get(chatId);
                const cityKeyboardId = chatStorage.cityKeyboard.get(chatId);

                await messageManager.clear(ctx, true, true);
                if (countryKeyboardId) chatStorage.countryKeyboard.set(chatId, countryKeyboardId);
                if (cityKeyboardId) chatStorage.cityKeyboard.set(chatId, cityKeyboardId);

                const keyboard = AGE_RANGES.map((range) => [
                    { text: range.label, callback_data: `age_range_${range.label}` },
                ]);
                
                keyboard.push([{ text: "‚ùå –°–±—Ä–æ—Å–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä –≤–æ–∑—Ä–∞—Å—Ç–∞", callback_data: "age_range_reset" }]);
                
                const hasFullAccess = await checkFullAccess(ctx);
                if (!hasFullAccess) {
                    keyboard.push([{ text: "üíé –ü–û–õ–£–ß–ò–¢–¨ –ü–û–õ–ù–´–ô –î–û–°–¢–£–ü", callback_data: "get_full_access" }]);
                }
                
                keyboard.push([{ text: "üîô –ù–∞–∑–∞–¥ –≤ –º–µ–Ω—é", callback_data: "back_to_menu" }]);

                const msg = await ctx.reply("–í—ã–±–µ—Ä–∏—Ç–µ –≤–æ–∑—Ä–∞—Å—Ç–Ω–æ–π –¥–∏–∞–ø–∞–∑–æ–Ω:", { reply_markup: { inline_keyboard: keyboard } });
                messageManager.track(ctx.chat.id, msg.message_id);
                await ctx.answerCbQuery();
            } catch (error) {
                console.error("‚ùå –û—à–∏–±–∫–∞ —Ñ–∏–ª—å—Ç—Ä–∞ –ø–æ –≤–æ–∑—Ä–∞—Å—Ç—É:", error);
            } finally {
                releaseUserLock(userId);
            }
        });
    });

    bot.action(/^age_range_(.+)$/, async (ctx) => {
        const userId = ctx.from.id;
        
        if (!acquireUserLock(userId, 3000)) {
            await ctx.answerCbQuery("‚è≥ –ü–æ–¥–æ–∂–¥–∏—Ç–µ, –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π –∑–∞–ø—Ä–æ—Å...");
            return;
        }
        
        await messageQueue.add(async () => {
            try {
                const [_, range] = ctx.match;
                
                const cacheType = await ensureProperCache(ctx);
                const isDemo = cacheType === 'demo';
                
                ctx.session = ctx.session || {};
                ctx.session.profilesPage = 0;
                ctx.session.isDemo = isDemo;

                if (range === "reset") {
                    ctx.session.ageRange = null;
                    await ctx.answerCbQuery("‚úÖ –§–∏–ª—å—Ç—Ä –ø–æ –≤–æ–∑—Ä–∞—Å—Ç—É —Å–±—Ä–æ—à–µ–Ω");
                } else {
                    const selectedRange = AGE_RANGES.find((r) => r.label === range);
                    if (selectedRange) {
                        ctx.session.ageRange = selectedRange;
                        await ctx.answerCbQuery(`‚úÖ –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω —Ñ–∏–ª—å—Ç—Ä: ${range} –ª–µ—Ç`);
                    }
                }

                const currentCountry = ctx.session.filterCountry;
                const currentCity = ctx.session.filterCity;
                const chatId = ctx.chat.id;
                const countryKeyboardId = chatStorage.countryKeyboard.get(chatId);
                const cityKeyboardId = chatStorage.cityKeyboard.get(chatId);

                await messageManager.clear(ctx, true, true);
                if (countryKeyboardId) chatStorage.countryKeyboard.set(chatId, countryKeyboardId);
                if (cityKeyboardId) chatStorage.cityKeyboard.set(chatId, cityKeyboardId);

                const profiles = await getProfilesPage(0, currentCountry, ctx.session.ageRange, currentCity, isDemo);

                if (!profiles.length) {
                    const msg = await ctx.reply("–ê–Ω–∫–µ—Ç –ø–æ –≤—ã–±—Ä–∞–Ω–Ω—ã–º –∫—Ä–∏—Ç–µ—Ä–∏—è–º –Ω–µ –Ω–∞–π–¥–µ–Ω–æ.");
                    messageManager.track(ctx.chat.id, msg.message_id);
                    return;
                }

                let filtersText = "üéØ –ü—Ä–∏–º–µ–Ω–µ–Ω—ã —Ñ–∏–ª—å—Ç—Ä—ã: ";
                if (ctx.session.ageRange) filtersText += `–í–æ–∑—Ä–∞—Å—Ç: ${ctx.session.ageRange.label}`;
                if (currentCountry) filtersText += `, –°—Ç—Ä–∞–Ω–∞: ${currentCountry}`;
                if (currentCity) filtersText += `, –ì–æ—Ä–æ–¥: ${currentCity}`;
                
                if (isDemo) {
                    filtersText += "\nüëÄ –î–ï–ú–û-–†–ï–ñ–ò–ú: –ø–æ–∫–∞–∑–∞–Ω–æ –ø–æ 3 –∞–Ω–∫–µ—Ç—ã –Ω–∞ –≥–æ—Ä–æ–¥";
                }
                
                const filtersMsg = await ctx.reply(filtersText);
                messageManager.track(ctx.chat.id, filtersMsg.message_id);

                for (let i = 0; i < profiles.length; i++) {
                    const isLast = i === profiles.length - 1;
                    await sendProfile(ctx, profiles[i], 0, profiles.length, isLast, isDemo);
                    if (!isLast) await new Promise((resolve) => setTimeout(resolve, 300));
                }

                if (currentCountry && !currentCity) {
                    await messageManager.sendCitiesKeyboard(ctx, currentCountry, isDemo);
                } else {
                    await messageManager.sendMainMenu(ctx);
                }
            } catch (error) {
                console.error("‚ùå –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≤–æ–∑—Ä–∞—Å—Ç–Ω–æ–≥–æ –¥–∏–∞–ø–∞–∑–æ–Ω–∞:", error);
                await ctx.answerCbQuery("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è —Ñ–∏–ª—å—Ç—Ä–∞");
            } finally {
                releaseUserLock(userId);
            }
        });
    });

    // ===================== –£–õ–£–ß–®–ï–ù–ù–ê–Ø –ü–†–û–í–ï–†–ö–ê –ü–û–î–ü–ò–°–ö–ò –ù–ê –ö–ê–ù–ê–õ =====================
   // ================= 14. –ü–†–û–í–ï–†–ö–ê –ü–û–î–ü–ò–°–ö–ò –ù–ê –ö–ê–ù–ê–õ =================
bot.action("check_channel_subscription", async (ctx) => {
  try {
    await ctx.answerCbQuery("üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–ø–∏—Å–∫—É...");

    const isSubscribed = await checkChannelSubscription(ctx);

    if (isSubscribed) {
      await ctx.answerCbQuery("‚úÖ –ü–æ–¥–ø–∏—Å–∫–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞!");

      ctx.session = ctx.session || {};
      ctx.session.channelSubscribed = true;

      const successKeyboard = {
        inline_keyboard: [
          [
            {
              text: "üåç –°–º–æ—Ç—Ä–µ—Ç—å –∞–Ω–∫–µ—Ç—ã",
              callback_data: "all_countries_with_check",
            },
          ],
          [
            { text: "üîô –ù–∞–∑–∞–¥", callback_data: "back_to_main" },
            { text: "üßπ –û—á–∏—Å—Ç–∏—Ç—å —ç–∫—Ä–∞–Ω", callback_data: "clear_screen" },
          ],
        ],
      };

      await ctx.reply(
        `
üéâ <b>–ü–û–î–ü–ò–°–ö–ê –ü–û–î–¢–í–ï–†–ñ–î–ï–ù–ê</b>

‚úÖ –¢–µ–ø–µ—Ä—å —É –≤–∞—Å –µ—Å—Ç—å –¥–æ—Å—Ç—É–ø –∫ –∞–Ω–∫–µ—Ç–∞–º –≤ –¥–µ–º–æ-—Ä–µ–∂–∏–º–µ!
‚ú® –ë–ª–∞–≥–æ–¥–∞—Ä–∏–º –∑–∞ –ø–æ–¥–ø–∏—Å–∫—É –Ω–∞ –Ω–∞—à –∫–∞–Ω–∞–ª <a href="https://t.me/+H6Eovikei9xiZWU0"><b>MagicClubPrivate</b></a>

üëÄ <b></b>
‚Ä¢ –ü–æ–∫–∞–∑–∞–Ω–æ –ø–æ 3 –∞–Ω–∫–µ—Ç—ã –Ω–∞ –≥–æ—Ä–æ–¥  
‚Ä¢ –ö–æ–Ω—Ç–∞–∫—Ç—ã —Å–∫—Ä—ã—Ç—ã
‚Ä¢ ‚ú® –î–ª—è –ø–æ–ª–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞ –í—ã –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –ø–æ–¥–ø–∏—Å–∞–Ω—ã –Ω–∞ –Ω–∞—à –∫–∞–Ω–∞–ª <a href="https://t.me/+H6Eovikei9xiZWU0"><b>MagicClubPrivate</b></a> –∏ –æ–ø–ª–∞—Ç–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É

<b>–ù–∞–∂–º–∏—Ç–µ "–°–º–æ—Ç—Ä–µ—Ç—å –∞–Ω–∫–µ—Ç—ã" —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å!</b>
      `,
        {
          parse_mode: "HTML",
          reply_markup: successKeyboard,
        }
      );
    } else {
      await ctx.answerCbQuery("‚ùå –í—ã –Ω–µ –ø–æ–¥–ø–∏—Å–∞–Ω—ã –Ω–∞ –∫–∞–Ω–∞–ª");

      const notSubscribedKeyboard = {
        inline_keyboard: [
          [
            {
              text: "‚úÖ –Ø –ü–û–î–ü–ò–°–ê–õ–°–Ø",
              callback_data: "check_channel_subscription",
            },
          ],
          [
            {
              text: "üì¢ –ü–û–î–ü–ò–°–ê–¢–¨–°–Ø –ù–ê –ö–ê–ù–ê–õ",
              url: "https://t.me/+H6Eovikei9xiZWU0",
            },
          ],
          [{ text: "üîô –ù–∞–∑–∞–¥", callback_data: "back_to_main" }],
        ],
      };

      await ctx.reply(
        `
‚ùå <b>–ü–û–î–ü–ò–°–ö–ê –ù–ï –ù–ê–ô–î–ï–ù–ê</b>

–ú—ã –Ω–µ –≤–∏–¥–∏–º –≤–∞—à—É –ø–æ–¥–ø–∏—Å–∫—É –Ω–∞ –∫–∞–Ω–∞–ª <a href="https://t.me/+H6Eovikei9xiZWU0"><b>MagicClubPrivate</b></a>

<b>–ü–æ–∂–∞–ª—É–π—Å—Ç–∞:</b>
1. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤—ã –ø–æ–¥–ø–∏—Å–∞–ª–∏—Å—å –Ω–∞ –∫–∞–Ω–∞–ª
2. –ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É "–Ø –ü–û–î–ü–ò–°–ê–õ–°–Ø" –¥–ª—è –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏

–ï—Å–ª–∏ –ø—Ä–æ–±–ª–µ–º–∞ persists, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ:
‚Ä¢ –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å Telegram
‚Ä¢ –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –≤—ã –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ —Ç–æ—Ç –∂–µ –∞–∫–∫–∞—É–Ω—Ç
‚Ä¢ –ù–∞–ø–∏—Å–∞—Ç—å –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É @MagicAdd
      `,
        {
          parse_mode: "HTML",
          reply_markup: notSubscribedKeyboard,
        }
      );
    }
  } catch (error) {
    console.error("–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ–¥–ø–∏—Å–∫–∏ –Ω–∞ –∫–∞–Ω–∞–ª:", error);
    await ctx.answerCbQuery("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ–¥–ø–∏—Å–∫–∏");
  }
});

    // ===================== –ü–†–û–í–ï–†–ö–ê –¢–û–õ–¨–ö–û –ü–û–î–ü–ò–°–ö–ò =====================
    bot.action("check_subscription_now", async (ctx) => {
        await messageQueue.add(async () => {
            try {
                const userId = ctx.from.id;
                await ctx.answerCbQuery("üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–ø–∏—Å–∫—É...");
                
                console.log(`üîç [SUBSCRIPTION CHECK] –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ${userId} –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –ø–æ–¥–ø–∏—Å–∫—É`);
                
                // üî• –¢–ê–ö–ñ–ï –û–ß–ò–©–ê–ï–ú –ö–≠–®–ò
                subscriptionCache.del(`subscription:${userId}`);
                
                const hasSubscription = await checkSubscription(userId);
                const hasChannelSubscription = await checkChannelSubscription(ctx);
                const hasFullAccess = hasSubscription && hasChannelSubscription;
                
                if (hasFullAccess) {
                    // üî• –û–ß–ò–©–ê–ï–ú –í–°–ï –ö–≠–®–ò –ò –û–ë–ù–û–í–õ–Ø–ï–ú –°–¢–ê–¢–£–°
                    channelSubscriptionCache.del(`channel:${userId}`);
                    userCacheStatus.del(`cache_status:${userId}`);
                    cacheManager.setUserCacheStatus(userId, 'full');
                    
                    await ctx.reply(`
üéâ <b>–í–°–ï –£–°–õ–û–í–ò–Ø –í–´–ü–û–õ–ù–ï–ù–´!</b>

‚úÖ –ü–æ–¥–ø–∏—Å–∫–∞: <b>–ê–ö–¢–ò–í–ù–ê</b>
‚úÖ –ö–∞–Ω–∞–ª: <b>–ü–û–î–ü–ò–°–ê–ù</b>

‚ú® –¢–µ–ø–µ—Ä—å —É –≤–∞—Å –ø–æ–ª–Ω—ã–π –¥–æ—Å—Ç—É–ø –∫–æ –≤—Å–µ–º –∞–Ω–∫–µ—Ç–∞–º!

<em>–ù–∞–∂–º–∏—Ç–µ "üåç –í–°–ï –°–¢–†–ê–ù–´" –¥–ª—è –Ω–∞—á–∞–ª–∞ –ø–æ–∏—Å–∫–∞</em>
                    `, {
                        parse_mode: "HTML",
                        reply_markup: {
                            inline_keyboard: [
                                [{ text: "üåç –í–°–ï –°–¢–†–ê–ù–´", callback_data: "all_countries_with_check" }],
                                [{ text: "üîÑ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –µ—â–µ —Ä–∞–∑", callback_data: "check_all_access" }]
                            ]
                        }
                    });
                } else if (hasSubscription) {
                    await ctx.reply(`
‚úÖ <b>–ü–û–î–ü–ò–°–ö–ê –ê–ö–¢–ò–í–ù–ê!</b>

‚ùå <b>–ù–æ –Ω–µ—Ç –ø–æ–¥–ø–∏—Å–∫–∏ –Ω–∞ –∫–∞–Ω–∞–ª <a href="https://t.me/+H6Eovikei9xiZWU0"><b>MagicClubPrivate</b></a></b>

–ß—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å:
1. –ü–æ–¥–ø–∏—à–∏—Ç–µ—Å—å –Ω–∞ <a href="https://t.me/+H6Eovikei9xiZWU0"><b>MagicClubPrivate</b></a>
2. –ù–∞–∂–º–∏—Ç–µ "‚úÖ –Ø –ü–û–î–ü–ò–°–ê–õ–°–Ø –ù–ê –ö–ê–ù–ê–õ"
                    `, {
                        parse_mode: "HTML",
                        reply_markup: {
                            inline_keyboard: [
                                [{ text: "‚úÖ –Ø –ü–û–î–ü–ò–°–ê–õ–°–Ø –ù–ê –ö–ê–ù–ê–õ", callback_data: "check_channel_subscription" }],
                                [{ text: "üì¢ –ü–û–î–ü–ò–°–ê–¢–¨–°–Ø –ù–ê –ö–ê–ù–ê–õ", url: "https://t.me/+H6Eovikei9xiZWU0" }]
                            ]
                        }
                    });
                } else {
                    await ctx.reply(`
‚ùå <b>–ü–û–î–ü–ò–°–ö–ê –ù–ï –ù–ê–ô–î–ï–ù–ê</b>

–£ –≤–∞—Å –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–π –ø–æ–¥–ø–∏—Å–∫–∏.

<b>–ß—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å:</b>
1. –ù–∞–∂–º–∏—Ç–µ "üíé –ö–£–ü–ò–¢–¨ –ü–û–î–ü–ò–°–ö–£" –¥–ª—è –æ–ø–ª–∞—Ç—ã
2. –ü–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã –ø—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–Ω–æ–≤–∞
                    `, {
                        parse_mode: "HTML",
                        reply_markup: {
                            inline_keyboard: [
                                [{ text: "üíé –ö–£–ü–ò–¢–¨ –ü–û–î–ü–ò–°–ö–£", callback_data: "get_full_access" }],
                                [{ text: "üîÑ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–Ω–æ–≤–∞", callback_data: "check_subscription_now" }]
                            ]
                        }
                    });
                }
                
            } catch (error) {
                console.error("–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ–¥–ø–∏—Å–∫–∏:", error);
                await ctx.answerCbQuery("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏");
            }
        });
    });

    bot.action("force_refresh_access", async (ctx) => {
        await messageQueue.add(async () => {
            try {
                const userId = ctx.from.id;
                await ctx.answerCbQuery("üîÑ –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ...");
                
                console.log(`üîÑ [FORCE REFRESH] –ü–æ–ª–Ω—ã–π —Å–±—Ä–æ—Å –∫—ç—à–µ–π –¥–ª—è ${userId}`);
                
                // –û—á–∏—â–∞–µ–º –í–°–ï –∫—ç—à–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                userCacheStatus.del(`cache_status:${userId}`);
                subscriptionCache.del(`subscription:${userId}`);
                channelSubscriptionCache.del(`channel:${userId}`);
                
                // –û—á–∏—â–∞–µ–º —Å–µ—Å—Å–∏—é
                if (ctx.session) {
                    ctx.session = {};
                }
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∑–∞–Ω–æ–≤–æ
                const [hasSubscription, hasChannelSubscription] = await Promise.all([
                    checkSubscription(userId),
                    checkChannelSubscription(ctx)
                ]);
                
                // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Å—Ç–∞—Ç—É—Å –∫—ç—à–∞
                if (hasSubscription && hasChannelSubscription) {
                    cacheManager.setUserCacheStatus(userId, 'full');
                    
                    await ctx.reply(`
üîÑ <b>–°–¢–ê–¢–£–° –û–ë–ù–û–í–õ–ï–ù!</b>

‚úÖ –ü–æ–¥–ø–∏—Å–∫–∞: ${hasSubscription ? '–ê–ö–¢–ò–í–ù–ê' : '–ù–ï –ê–ö–¢–ò–í–ù–ê'}
‚úÖ –ö–∞–Ω–∞–ª: ${hasChannelSubscription ? '–ü–û–î–ü–ò–°–ê–ù' : '–ù–ï –ü–û–î–ü–ò–°–ê–ù'}

${hasSubscription && hasChannelSubscription ? 
                            'üéâ <b>–¢–µ–ø–µ—Ä—å —É –≤–∞—Å –ø–æ–ª–Ω—ã–π –¥–æ—Å—Ç—É–ø!</b>\n–ù–∞–∂–º–∏—Ç–µ "üåç –í–°–ï –°–¢–†–ê–ù–´"' : 
                            '‚ùå <b>–ù–µ –≤—Å–µ —É—Å–ª–æ–≤–∏—è –≤—ã–ø–æ–ª–Ω–µ–Ω—ã</b>\n–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —á—Ç–æ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –≤—ã—à–µ'}
                    `, {
                        parse_mode: "HTML",
                        reply_markup: {
                            inline_keyboard: [
                                [{ text: "üåç –í–°–ï –°–¢–†–ê–ù–´", callback_data: "all_countries_with_check" }],
                                [{ text: "üîÑ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –µ—â–µ —Ä–∞–∑", callback_data: "check_all_access" }]
                            ]
                        }
                    });
                }
                
            } catch (error) {
                console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:", error);
                await ctx.answerCbQuery("‚ùå –û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è");
            }
        });
    });

    // ===================== –ü–†–û–í–ï–†–ö–ê –í–°–ï–• –£–°–õ–û–í–ò–ô =====================
    bot.action("check_all_access", async (ctx) => {
        await messageQueue.add(async () => {
            try {
                const userId = ctx.from.id;
                await ctx.answerCbQuery("üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤—Å–µ —É—Å–ª–æ–≤–∏—è...");
                
                console.log(`üîç [FULL CHECK] –ü–æ–ª–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –¥–ª—è ${userId}`);
                
                // –û—á–∏—â–∞–µ–º –í–°–ï –∫—ç—à–∏
                subscriptionCache.del(`subscription:${userId}`);
                channelSubscriptionCache.del(`channel:${userId}`);
                
                const [hasSubscription, hasChannelSubscription] = await Promise.all([
                    checkSubscription(userId),
                    checkChannelSubscription(ctx)
                ]);
                
                if (hasSubscription && hasChannelSubscription) {
                    // –û–ë–ù–û–í–õ–Ø–ï–ú –°–¢–ê–¢–£–° –í –ö–≠–®–ï –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø
                    cacheManager.setUserCacheStatus(userId, 'full');
                    
                    // –û—á–∏—â–∞–µ–º —Å–µ—Å—Å–∏—é
                    if (ctx.session) {
                        ctx.session.cacheType = 'full';
                        ctx.session.hasFullAccess = true;
                    }
                    
                    await ctx.reply(`
üéâ <b>–í–°–ï –£–°–õ–û–í–ò–Ø –í–´–ü–û–õ–ù–ï–ù–´!</b>

‚úÖ –ü–æ–¥–ø–∏—Å–∫–∞: –ê–ö–¢–ò–í–ù–ê
‚úÖ –ö–∞–Ω–∞–ª: –ü–û–î–ü–ò–°–ê–ù

<b>–ü–æ–ª–Ω—ã–π –¥–æ—Å—Ç—É–ø –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω!</b>

–¢–µ–ø–µ—Ä—å –≤—ã –º–æ–∂–µ—Ç–µ:
‚Ä¢ üåç –ü—Ä–æ—Å–º–∞—Ç—Ä–∏–≤–∞—Ç—å –≤—Å–µ —Å—Ç—Ä–∞–Ω—ã
‚Ä¢ üë§ –í–∏–¥–µ—Ç—å –≤—Å–µ –∫–æ–Ω—Ç–∞–∫—Ç—ã –≤ –∞–Ω–∫–µ—Ç–∞—Ö
‚Ä¢ üöÄ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø–æ–ª–Ω—ã–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª

<code>–ù–∞–∂–º–∏—Ç–µ "üåç –í–°–ï –°–¢–†–ê–ù–´" —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å</code>
                    `, {
                        parse_mode: "HTML",
                        reply_markup: {
                            inline_keyboard: [
                                [{ text: "üåç –í–°–ï –°–¢–†–ê–ù–´", callback_data: "all_countries_with_check" }],
                                [{ text: "üßπ –û—á–∏—Å—Ç–∏—Ç—å —ç–∫—Ä–∞–Ω", callback_data: "clear_screen" }]
                            ]
                        }
                    });
                    
                } else {
                    let missing = [];
                    if (!hasSubscription) missing.push("–∞–∫—Ç–∏–≤–Ω–æ–π –ø–æ–¥–ø–∏—Å–∫–∏");
                    if (!hasChannelSubscription) missing.push("–ø–æ–¥–ø–∏—Å–∫–∏ –Ω–∞ –∫–∞–Ω–∞–ª ");
                    
                    await ctx.reply(`
‚ùå <b>–£–°–õ–û–í–ò–Ø –ù–ï –í–´–ü–û–õ–ù–ï–ù–´</b>

–û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç: ${missing.join(" –∏ ")}

<b>–ß—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å:</b>
${!hasSubscription ? "1. üíé –ö—É–ø–∏—Ç–µ –ø–æ–¥–ø–∏—Å–∫—É —á–µ—Ä–µ–∑ '–ü–û–õ–£–ß–ò–¢–¨ –ü–û–õ–ù–´–ô –î–û–°–¢–£–ü'\n" : ""}
${!hasChannelSubscription ? "2. üì¢ –ü–æ–¥–ø–∏—à–∏—Ç–µ—Å—å –Ω–∞ –∫–∞–Ω–∞–ª \n" : ""}
3. üîÑ –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–Ω–æ–≤–∞ –ø–æ—Å–ª–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —É—Å–ª–æ–≤–∏–π
                    `, {
                        parse_mode: "HTML",
                        reply_markup: {
                            inline_keyboard: [
                                !hasSubscription ? [{ text: "üíé –ö–£–ü–ò–¢–¨ –ü–û–î–ü–ò–°–ö–£", callback_data: "get_full_access" }] : [],
                                !hasChannelSubscription ? [{ text: "üì¢ –ü–û–î–ü–ò–°–ê–¢–¨–°–Ø –ù–ê –ö–ê–ù–ê–õ", url: "https://t.me/+H6Eovikei9xiZWU0" }] : [],
                                [{ text: "‚úÖ –Ø –ü–û–î–ü–ò–°–ê–õ–°–Ø –ù–ê –ö–ê–ù–ê–õ", callback_data: "check_channel_subscription" }],
                                [{ text: "üîÑ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–Ω–æ–≤–∞", callback_data: "check_all_access" }]
                            ].filter(row => row.length > 0)
                        }
                    });
                }
                
            } catch (error) {
                console.error("–û—à–∏–±–∫–∞ –ø–æ–ª–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏:", error);
                await ctx.answerCbQuery("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏");
            }
        });
    });

    bot.action(/^page_(first|prev|next|last|\d+)_(\d+)$/, async (ctx) => {
        const userId = ctx.from.id;
        
        if (!acquireUserLock(userId, 2500)) {
            console.log(`‚è≥ [LOCK] –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ${userId} —É–∂–µ –≤—ã–ø–æ–ª–Ω—è–µ—Ç –¥–µ–π—Å—Ç–≤–∏–µ, –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º –∫–ª–∏–∫`);
            try {
                await ctx.answerCbQuery("‚è≥ –ü–æ–¥–æ–∂–¥–∏—Ç–µ, –∑–∞–≥—Ä—É–∂–∞–µ–º...");
            } catch (e) {
            }
            return;
        }
        
        await messageQueue.add(async () => {
            try {
                const [_, action, currentPage] = ctx.match;
                let newPage = parseInt(currentPage);

                if (action === "first") newPage = 0;
                else if (action === "prev") newPage = Math.max(0, newPage - 1);
                else if (action === "next") newPage = newPage + 1;
                else if (action === "last") {
                    const isDemo = ctx.session?.isDemo || false;
                    const filterKey = `country:${ctx.session.filterCountry || 'all'}:age:${ctx.session.ageRange?.label || 'all'}:city:${ctx.session.filterCity || 'all'}`;
                    const filteredProfiles = cacheManager.getGlobalFilter(filterKey, isDemo);
                    newPage = Math.ceil((filteredProfiles?.length || 0) / SCALING_CONFIG.PERFORMANCE.PROFILES_PER_PAGE) - 1;
                } else {
                    newPage = parseInt(action);
                }

                await messageManager.clear(ctx, true);
                
                ctx.session = ctx.session || {};
                const isDemo = ctx.session.isDemo || false;
                const profiles = await getProfilesPage(newPage, ctx.session.filterCountry, ctx.session.ageRange, ctx.session.filterCity, isDemo);

                if (profiles.length) {
                    ctx.session.profilesPage = newPage;

                    for (let i = 0; i < profiles.length; i++) {
                        const isLast = i === profiles.length - 1;
                        await sendProfile(ctx, profiles[i], newPage, profiles.length, isLast, isDemo);
                        if (!isLast) await new Promise((resolve) => setTimeout(resolve, 300));
                    }
                    
                    await ctx.answerCbQuery(`üìÑ –°—Ç—Ä–∞–Ω–∏—Ü–∞ ${newPage + 1}`);
                } else {
                    const msg = await ctx.reply("–ë–æ–ª—å—à–µ –∞–Ω–∫–µ—Ç –Ω–µ—Ç");
                    messageManager.track(ctx.chat.id, msg.message_id);
                    await ctx.answerCbQuery("‚ùå –ë–æ–ª—å—à–µ –∞–Ω–∫–µ—Ç –Ω–µ—Ç");
                }
                
            } catch (error) {
                console.error("‚ùå –û—à–∏–±–∫–∞ –ø–∞–≥–∏–Ω–∞—Ü–∏–∏:", error);
                try {
                    await ctx.answerCbQuery("‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏");
                } catch (e) {
                }
            } finally {
                releaseUserLock(userId);
            }
        });
    });

    bot.action("clear_screen", async (ctx) => {
        const userId = ctx.from.id;
        
        if (!acquireUserLock(userId, 2000)) {
            await ctx.answerCbQuery("‚è≥ –ü–æ–¥–æ–∂–¥–∏—Ç–µ, –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π –∑–∞–ø—Ä–æ—Å...");
            return;
        }
        
        await messageQueue.add(async () => {
            try {
                await messageManager.clear(ctx);
                await ctx.answerCbQuery("–≠–∫—Ä–∞–Ω –æ—á–∏—â–µ–Ω");
            } catch (error) {
                console.error("‚ùå –û—à–∏–±–∫–∞ –æ—á–∏—Å—Ç–∫–∏:", error);
                await ctx.answerCbQuery("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—á–∏—Å—Ç–∫–µ");
            } finally {
                releaseUserLock(userId);
            }
        });
    });

   // ===================== –§–£–ù–ö–¶–ò–Ø –û–¢–ü–†–ê–í–ö–ò –ü–†–û–§–ò–õ–Ø (–ü–û–õ–ù–û–°–¢–¨–Æ –ü–ï–†–ï–ü–ò–°–ê–ù–ê) =====================
const sendProfile = async (ctx, profile, page, total, isLast, isDemo = false) => {
    return messageQueue.add(async () => {
        try {
            console.log(`üîç [SEND PROFILE START] page=${page}, total=${total}, isLast=${isLast}, isDemo=${isDemo}`);
            
            // üî• –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –ü–†–û–í–ï–†–ö–ê: –ü—Ä–æ—Ñ–∏–ª—å undefined
            if (profile === undefined || profile === null) {
                console.log(`‚ùå [SEND PROFILE] –ü—Ä–æ—Ñ–∏–ª—å undefined/null`);
                
                // üî• –ü—ã—Ç–∞–µ–º—Å—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∏–∑ –∫—ç—à–∞ —Ñ–∏–ª—å—Ç—Ä–æ–≤
                const filterKey = isDemo ? 
                    `demo:country:${ctx.session?.filterCountry || 'all'}:age:${ctx.session?.ageRange?.label || 'all'}:city:${ctx.session?.filterCity || 'all'}` :
                    `country:${ctx.session?.filterCountry || 'all'}:age:${ctx.session?.ageRange?.label || 'all'}:city:${ctx.session?.filterCity || 'all'}`;
                
                console.log(`üîÑ [RECOVERY] –ü—Ä–æ–±—É–µ–º –ø–æ–ª—É—á–∏—Ç—å –∏–∑ –∫—ç—à–∞: ${filterKey}`);
                
                const cachedProfiles = cacheManager.getGlobalFilter(filterKey, isDemo);
                
                if (cachedProfiles && cachedProfiles.length > 0) {
                    console.log(`‚úÖ [RECOVERY SUCCESS] –ù–∞–π–¥–µ–Ω–æ –≤ –∫—ç—à–µ: ${cachedProfiles.length} –ø—Ä–æ—Ñ–∏–ª–µ–π`);
                    
                    // üî• –í–ê–ñ–ù–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ë–µ—Ä–µ–º –ø—Ä–æ—Ñ–∏–ª—å –ø–æ –∏–Ω–¥–µ–∫—Å—É —Å—Ç—Ä–∞–Ω–∏—Ü—ã
                    if (cachedProfiles.length > page) {
                        const targetProfile = cachedProfiles[page];
                        console.log(`‚úÖ [RECOVERY] –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–æ—Ñ–∏–ª—å –∏–∑ –∫—ç—à–∞ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ ${page}:`, targetProfile?.n || targetProfile?.name || 'unknown');
                        profile = targetProfile;
                    } else if (cachedProfiles.length > 0) {
                        // –ï—Å–ª–∏ —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –±–æ–ª—å—à–µ —á–µ–º –ø—Ä–æ—Ñ–∏–ª–µ–π - –±–µ—Ä–µ–º –ø–µ—Ä–≤—ã–π
                        const targetProfile = cachedProfiles[0];
                        console.log(`‚úÖ [RECOVERY] –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø–µ—Ä–≤—ã–π –ø—Ä–æ—Ñ–∏–ª—å –∏–∑ –∫—ç—à–∞:`, targetProfile?.n || targetProfile?.name || 'unknown');
                        profile = targetProfile;
                    } else {
                        console.log(`‚ùå [RECOVERY FAILED] –ù–µ—Ç –ø—Ä–æ—Ñ–∏–ª–µ–π –≤ –∫—ç—à–µ`);
                        profile = null;
                    }
                } else {
                    console.log(`‚ùå [RECOVERY FAILED] –ö—ç—à –ø—É—Å—Ç–æ–π –∏–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω`);
                    profile = null;
                }
            }
            
            // üî• –ü—Ä–æ–≤–µ—Ä–∫–∞: –ü—Ä–æ—Ñ–∏–ª—å –ø—É—Å—Ç–æ–π –æ–±—ä–µ–∫—Ç –∏–ª–∏ –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞
            if (!profile || typeof profile !== 'object' || (!profile.n && !profile.name && !profile.id && !profile._id)) {
                console.log(`‚ö†Ô∏è [SEND PROFILE INVALID] –ü—Ä–æ—Ñ–∏–ª—å –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π, —Å–æ–∑–¥–∞–µ–º –¥–µ–º–æ-–∑–∞–≥–ª—É—à–∫—É`);
                
                const fallbackProfile = {
                    id: 'demo_fallback_' + Date.now(),
                    n: '–î–µ–º–æ-–∞–Ω–∫–µ—Ç–∞',
                    a: 25,
                    c: ctx.session?.filterCountry || '–°—Ç—Ä–∞–Ω–∞',
                    ct: ctx.session?.filterCity || '–ì–æ—Ä–æ–¥',
                    ab: '–≠—Ç–æ –¥–µ–º–æ-–∞–Ω–∫–µ—Ç–∞ –¥–ª—è –ø–æ–∫–∞–∑–∞ —Ä–∞–±–æ—Ç—ã —Å–∏—Å—Ç–µ–º—ã. –î–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –ø–æ–ª–Ω—ã—Ö –∞–Ω–∫–µ—Ç —Å –∫–æ–Ω—Ç–∞–∫—Ç–∞–º–∏ –ø–æ–ª—É—á–∏—Ç–µ –ø–æ–ª–Ω—ã–π –¥–æ—Å—Ç—É–ø.',
                    p: 'https://via.placeholder.com/600x800/0088cc/ffffff?text=Demo+Profile',
                    phs: ['https://via.placeholder.com/600x800/0088cc/ffffff?text=Photo+1', 'https://via.placeholder.com/600x800/0088cc/ffffff?text=Photo+2'],
                    tg: null,
                    tel: null,
                    wa: null,
                    ca: new Date(),
                    isDemo: true
                };
                
                profile = fallbackProfile;
                isDemo = true;
            }
            
            console.log(`‚úÖ [SEND PROFILE READY] –ü—Ä–æ—Ñ–∏–ª—å –≥–æ—Ç–æ–≤: ${profile.n || profile.name || 'unknown'}, isDemo=${isDemo || profile.isDemo}`);
            
            // üî• –û–ë–ù–û–í–õ–ï–ù–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø –û–ß–ò–°–¢–ö–ò –¢–ï–ö–°–¢–ê –° –≠–ö–†–ê–ù–ò–†–û–í–ê–ù–ò–ï–ú HTML
            const cleanTextForHtml = (text) => {
                if (!text || typeof text !== 'string') return "";
                
                // –°–Ω–∞—á–∞–ª–∞ –∑–∞–º–µ–Ω—è–µ–º HTML-—Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ —Å–∏–º–≤–æ–ª—ã
                let cleaned = text
                    .replace(/&/g, '&amp;')   // –î–æ–ª–∂–Ω–æ –±—ã—Ç—å –ø–µ—Ä–≤–æ–π –∑–∞–º–µ–Ω–æ–π
                    .replace(/</g, '&lt;')    // –í–∞–∂–Ω–æ! –ó–∞–º–µ–Ω—è–µ–º < –Ω–∞ &lt;
                    .replace(/>/g, '&gt;')    // –í–∞–∂–Ω–æ! –ó–∞–º–µ–Ω—è–µ–º > –Ω–∞ &gt;
                    .replace(/"/g, '&quot;')  // –ó–∞–º–µ–Ω—è–µ–º –¥–≤–æ–π–Ω—ã–µ –∫–∞–≤—ã—á–∫–∏
                    .replace(/'/g, '&#39;');  // –ó–∞–º–µ–Ω—è–µ–º –æ–¥–∏–Ω–∞—Ä–Ω—ã–µ –∫–∞–≤—ã—á–∫–∏
                
                // –ó–∞—Ç–µ–º —É–±–∏—Ä–∞–µ–º –Ω–µ—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ —Å–∏–º–≤–æ–ª—ã (–∫–∞–∫ –≤ –∏—Å—Ö–æ–¥–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–∏)
                cleaned = cleaned
                    .replace(/[^\x00-\x7F\u0400-\u04FF\u0500-\u052F\u2DE0-\u2DFF\uA640-\uA69F\s.,!?;:()\-+=\[\]{}@#$%^&*<>\/\\|'"`~]/g, '')
                    .trim();
                
                return cleaned;
            };
            
            // üî• –§–£–ù–ö–¶–ò–Ø –û–ß–ò–°–¢–ö–ò URL
            const cleanUrl = (url) => {
                if (!url || typeof url !== 'string') return '';
                return url.trim();
            };
            
            // üî• –ü–†–ï–û–ë–†–ê–ó–û–í–ê–ù–ò–ï –í –ï–î–ò–ù–´–ô –§–û–†–ú–ê–¢
            const fullProfile = {
                id: profile.id || profile._id || 'unknown_' + Date.now(),
                name: cleanTextForHtml(profile.n || profile.name || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'), // –≠–∫—Ä–∞–Ω–∏—Ä—É–µ–º –∏–º—è
                age: parseInt(profile.a || profile.age) || 25,
                country: cleanTextForHtml(profile.c || profile.country || ctx.session?.filterCountry || '–°—Ç—Ä–∞–Ω–∞'), // –≠–∫—Ä–∞–Ω–∏—Ä—É–µ–º —Å—Ç—Ä–∞–Ω—É
                city: cleanTextForHtml(profile.ct || profile.city || ctx.session?.filterCity || '–ì–æ—Ä–æ–¥'), // –≠–∫—Ä–∞–Ω–∏—Ä—É–µ–º –≥–æ—Ä–æ–¥
                about: profile.ab || profile.about || '–û–ø–∏—Å–∞–Ω–∏–µ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ',
                photoUrl: cleanUrl(profile.p || profile.photoUrl || ''),
                photos: Array.isArray(profile.phs || profile.photos) ? (profile.phs || profile.photos).map(cleanUrl) : [],
                telegram: isDemo || profile.isDemo ? null : cleanUrl(profile.tg || profile.telegram),
                phone: isDemo || profile.isDemo ? null : (profile.tel || profile.phone),
                whatsapp: isDemo || profile.isDemo ? null : cleanUrl(profile.wa || profile.whatsapp),
                createdAt: profile.ca || profile.createdAt || new Date(),
                isDemo: isDemo || profile.isDemo || false
            };
            
            console.log(`üîç [FULL PROFILE] –°–æ–∑–¥–∞–Ω: ${fullProfile.name}, —Ñ–æ—Ç–æ: ${fullProfile.photos.length}, –≥–æ—Ä–æ–¥: "${fullProfile.city}", —Å—Ç—Ä–∞–Ω–∞: "${fullProfile.country}"`);
            
            // üî• –ü–û–î–ì–û–¢–û–í–ö–ê –û–ü–ò–°–ê–ù–ò–Ø
            let about = cleanTextForHtml(fullProfile.about);
            const maxAboutLength = SCALING_CONFIG.PERFORMANCE.MAX_CAPTION_LENGTH - 300; // –û—Å—Ç–∞–≤–ª—è–µ–º –º–µ—Å—Ç–æ –¥–ª—è –æ—Å—Ç–∞–ª—å–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞
            
            if (about.length > maxAboutLength) {
                about = about.substring(0, maxAboutLength - 3) + "...";
            }
            
            // üî• –§–£–ù–ö–¶–ò–Ø –§–û–†–ú–ê–¢–ò–†–û–í–ê–ù–ò–Ø –ö–û–ù–¢–ê–ö–¢–û–í (–î–õ–Ø –ü–û–õ–ù–û–ì–û –î–û–°–¢–£–ü–ê)
            const formatTelegram = (username) => {
                if (!username) return "";
                const cleanUsername = cleanUrl(username);
                
                if (/^[0-9+\-() ]+$/.test(cleanUsername)) {
                    const cleanDigits = cleanUsername.replace(/[^0-9]/g, "");
                    if (cleanDigits.startsWith('7') || cleanDigits.startsWith('8') || (cleanDigits.length >= 10 && !cleanDigits.startsWith('1'))) {
                        let telegramNumber = cleanDigits;
                        if (telegramNumber.startsWith('7') && telegramNumber.length === 11) telegramNumber = telegramNumber.substring(1);
                        else if (telegramNumber.startsWith('8') && telegramNumber.length === 11) telegramNumber = telegramNumber.substring(1);
                        return `üîµ <a href="https://t.me/${telegramNumber}">Telegram</a>`;
                    }
                }
                
                if (cleanUsername.startsWith("https://t.me/")) {
                    const cleaned = decodeURIComponent(cleanUsername)
                        .replace("https://t.me/", "")
                        .replace(/^%40/, "@")
                        .replace(/^\+/, "");
                    return `üîµ <a href="https://t.me/${cleaned}">Telegram</a>`;
                }
                
                const cleaned = cleanUsername.replace(/^[@+]/, "");
                return `üîµ <a href="https://t.me/${cleaned}">Telegram</a>`;
            };
            
            const formatWhatsApp = (url) => {
                if (!url) return "";
                const cleanUrlText = cleanUrl(url);
                
                if (/^[0-9+\-() ]+$/.test(cleanUrlText)) {
                    let cleanDigits = cleanUrlText.replace(/[^0-9]/g, "");
                    if (cleanDigits.startsWith('8') && cleanDigits.length === 11) cleanDigits = '7' + cleanDigits.substring(1);
                    else if (cleanDigits.length === 10) cleanDigits = '7' + cleanDigits;
                    
                    if (cleanDigits.length === 11 && cleanDigits.startsWith('7')) {
                        return `üü¢ <a href="https://wa.me/${cleanDigits}">WhatsApp</a>`;
                    }
                }
                
                return `üü¢ <a href="${cleanUrlText}">WhatsApp</a>`;
            };
            
            const formatPhone = (phone) => {
                if (!phone) return "";
                let cleanDigits = cleanTextForHtml(phone).replace(/[^0-9]/g, "");
                if (!cleanDigits) return "";
                
                let formattedPhone = cleanTextForHtml(phone);
                if (cleanDigits.length === 11 || cleanDigits.length === 10) {
                    if (cleanDigits.startsWith('7') && cleanDigits.length === 11) formattedPhone = `+${cleanDigits}`;
                    else if (cleanDigits.startsWith('8') && cleanDigits.length === 11) formattedPhone = `+7${cleanDigits.substring(1)}`;
                    else if (cleanDigits.length === 10) formattedPhone = `+7${cleanDigits}`;
                }
                
                return `üìû ${formattedPhone}`;
            };
            
            // üî• –†–ê–ó–î–ï–õ–Ø–ï–ú –õ–û–ì–ò–ö–£ –î–ï–ú–û –ò –ü–û–õ–ù–û–ì–û –î–û–°–¢–£–ü–ê
            if (fullProfile.isDemo) {
                console.log(`üé≠ [DEMO MODE] –°–æ–∑–¥–∞–µ–º –¥–µ–º–æ-–∞–Ω–∫–µ—Ç—É –¥–ª—è ${fullProfile.name}`);
                
                // üî• –î–ï–ú–û-–ü–û–î–ü–ò–°–¨ (–∫–æ–Ω—Ç–∞–∫—Ç—ã —Å–∫—Ä—ã—Ç—ã)
                const demoCaption = `
üë§ <b>${fullProfile.name}</b>, ${fullProfile.age}
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
üìç <b>${fullProfile.city}, ${fullProfile.country}</b>
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
<em>${about.length > 300 ? about.substring(0, 300) + `...<a href="http://t.me/magicboss_bot/magic">—á–∏—Ç–∞—Ç—å –ø–æ–ª–Ω–æ—Å—Ç—å—é –≤ ‚ú®Magic</a>` : about}</em>
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
üö´ <b>–ö–û–ù–¢–ê–ö–¢–´ –°–ö–†–´–¢–´ (–î–ï–ú–û-–†–ï–ñ–ò–ú)</b>
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
üëÄ <b>–î–ï–ú–û-–†–ï–ñ–ò–ú:</b> –ø–æ–∫–∞–∑–∞–Ω–æ –º–∞–∫—Å–∏–º—É–º 3 –∞–Ω–∫–µ—Ç—ã –Ω–∞ –≥–æ—Ä–æ–¥
üíé <b>–î–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤ –∏ –ø–æ–ª–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞ –∫–æ –≤—Å–µ–º –∞–Ω–∫–µ—Ç–∞–º –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ:</b>

‚úÖ <b>1. –ê–∫—Ç–∏–≤–Ω–∞—è –ø–æ–¥–ø–∏—Å–∫–∞</b>
‚úÖ <b>2. –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ –∫–∞–Ω–∞–ª <a href="https://t.me/+H6Eovikei9xiZWU0"><b>MagicClubPrivate</b></a></b>

‚ú® –ü–æ—Å–ª–µ –ø–æ–ª—É—á–µ–Ω–∏—è –¥–æ—Å—Ç—É–ø–∞ –≤—ã —É–≤–∏–¥–∏—Ç–µ:
‚Ä¢ –í—Å–µ –∫–æ–Ω—Ç–∞–∫—Ç—ã –ø—Ä–æ—Ñ–∏–ª–µ–π (Telegram, WhatsApp, —Ç–µ–ª–µ—Ñ–æ–Ω)
‚Ä¢ –ü–æ–ª–Ω—ã–µ –æ–ø–∏—Å–∞–Ω–∏—è –∞–Ω–∫–µ—Ç
‚Ä¢ –ù–µ–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω—ã–π –¥–æ—Å—Ç—É–ø –∫–æ –≤—Å–µ–º –∞–Ω–∫–µ—Ç–∞–º
‚Ä¢ –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—É—é —Å–∫–æ—Ä–æ—Å—Ç—å —Ä–∞–±–æ—Ç—ã

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
<a href="http://t.me/magicboss_bot/magic"><b>‚ú®Magic WebApp</b></a>
                `.trim();
                
                // üî• –ü–û–î–ì–û–¢–û–í–ö–ê –§–û–¢–û
                let photosToSend = [];
                
                // –û—Å–Ω–æ–≤–Ω–æ–µ —Ñ–æ—Ç–æ
                if (fullProfile.photoUrl && fullProfile.photoUrl.trim() !== '') {
                    try {
                        const url = fullProfile.photoUrl.trim();
                        new URL(url);
                        photosToSend.push(url);
                    } catch (e) {
                        console.log(`‚ùå [DEMO PHOTO] –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π URL –æ—Å–Ω–æ–≤–Ω–æ–≥–æ —Ñ–æ—Ç–æ: ${e.message}`);
                    }
                }
                
                // –§–æ—Ç–æ –≥–∞–ª–µ—Ä–µ–∏
                if (Array.isArray(fullProfile.photos) && fullProfile.photos.length > 0) {
                    fullProfile.photos.forEach((url, index) => {
                        if (typeof url === 'string' && url.trim() !== '') {
                            try {
                                const cleanUrl = url.trim();
                                new URL(cleanUrl);
                                photosToSend.push(cleanUrl);
                            } catch (e) {
                                console.log(`‚ùå [DEMO PHOTO] –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π URL —Ñ–æ—Ç–æ ${index + 1}: ${e.message}`);
                            }
                        }
                    });
                }
                
                // –ï—Å–ª–∏ –Ω–µ—Ç —Ñ–æ—Ç–æ - –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ —Ç–µ–∫—Å—Ç
                if (photosToSend.length === 0) {
                    console.log(`‚ö†Ô∏è [NO PHOTOS] –£ –ø—Ä–æ—Ñ–∏–ª—è "${fullProfile.name}" –Ω–µ—Ç —Ñ–æ—Ç–æ, –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ —Ç–µ–∫—Å—Ç`);
                }
                
                // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ñ–æ—Ç–æ
                photosToSend = photosToSend.slice(0, 10);
                console.log(`üì∏ [DEMO PHOTOS] –ë—É–¥–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ ${photosToSend.length} —Ñ–æ—Ç–æ`);
                
                // üî• –ü–û–î–ì–û–¢–û–í–ö–ê –ö–ù–û–ü–û–ö –ü–ê–ì–ò–ù–ê–¶–ò–ò
                let keyboard = [];
                if (isLast) {
                    const filterKey = `demo:country:${ctx.session?.filterCountry || 'all'}:age:${ctx.session?.ageRange?.label || 'all'}:city:${ctx.session?.filterCity || 'all'}`;
                    const filteredProfiles = cacheManager.getGlobalFilter(filterKey, true) || [];
                    const totalPages = Math.ceil((filteredProfiles.length || 0) / SCALING_CONFIG.PERFORMANCE.PROFILES_PER_PAGE);
                    
                    const currentFilters = {
                        country: ctx.session?.filterCountry,
                        city: ctx.session?.filterCity,
                        ageRange: ctx.session?.ageRange
                    };
                    
                    keyboard = createEnhancedPaginationKeyboard(page, totalPages, filterKey, currentFilters, true);
                    
                    // üî• –î–û–ë–ê–í–õ–Ø–ï–ú –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–´–ï –ö–ù–û–ü–ö–ò
                    keyboard.push(
                        [{ text: "üèôÔ∏è –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ –≥–æ—Ä–æ–¥–∞–º", callback_data: "back_to_current_country_cities" }],
                        [{ text: "üéÇ –§–∏–ª—å—Ç—Ä –ø–æ –≤–æ–∑—Ä–∞—Å—Ç—É", callback_data: "filter_by_age" }],
                        [{ text: "üåç –í—Å–µ —Å—Ç—Ä–∞–Ω—ã", callback_data: "all_countries_with_check" }],
                        [{ text: "üßπ –û—á–∏—Å—Ç–∏—Ç—å —ç–∫—Ä–∞–Ω", callback_data: "clear_screen" }]
                    );
                }
                
                // üî• –§–£–ù–ö–¶–ò–Ø –û–¢–ü–†–ê–í–ö–ò –§–û–¢–û
                const sendPhotoSafely = async (photoUrl, photoNumber, totalPhotos) => {
                    try {
                        const emojiNumbers = ['1Ô∏è‚É£', '2Ô∏è‚É£', '3Ô∏è‚É£', '4Ô∏è‚É£', '5Ô∏è‚É£', '6Ô∏è‚É£', '7Ô∏è‚É£', '8Ô∏è‚É£', '9Ô∏è‚É£', 'üîü'];
                        const numberEmoji = photoNumber <= 10 ? emojiNumbers[photoNumber - 1] : `${photoNumber}.`;
                        const photoCaption = `${numberEmoji} –§–æ—Ç–æ ${photoNumber}/${totalPhotos}`;
                        
                        console.log(`üñºÔ∏è [SEND PHOTO] –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ñ–æ—Ç–æ ${photoNumber}/${totalPhotos}: ${photoUrl.substring(0, 50)}...`);
                        
                        return await ctx.replyWithPhoto(photoUrl, { 
                            caption: photoCaption, 
                            parse_mode: "HTML" 
                        });
                    } catch (error) {
                        console.log(`‚ùå [SEND PHOTO ERROR] –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ç–æ ${photoNumber}: ${error.message}`);
                        return null;
                    }
                };
                
                // üî• –û–¢–ü–†–ê–í–ö–ê –§–û–¢–û
                if (photosToSend.length > 0) {
                    for (let i = 0; i < photosToSend.length; i++) {
                        const photoMsg = await sendPhotoSafely(photosToSend[i], i + 1, photosToSend.length);
                        if (photoMsg) {
                            messageManager.track(ctx.chat.id, photoMsg.message_id);
                            
                            if (i < photosToSend.length - 1) {
                                await new Promise(resolve => setTimeout(resolve, 800));
                            }
                        }
                    }
                }
                
                // üî• –ò–ù–§–û–†–ú–ê–¶–ò–û–ù–ù–û–ï –°–û–û–ë–©–ï–ù–ò–ï
                const infoMessage = await ctx.reply(
                    `‚ú®‚ú®‚ú®‚ú®‚ú®‚ú®‚ú®‚ú®‚ú®‚ú®\n<a href="http://t.me/MagicYourClub"><b>–ù–æ–≤—ã–µ –∞–Ω–∫–µ—Ç—ã –≤ –Ω–∞—à–µ–º ‚û°Ô∏è –∫–∞–Ω–∞–ª–µ</b></a>\n\n`,
                    { parse_mode: "HTML" }
                );
                messageManager.track(ctx.chat.id, infoMessage.message_id);
                await new Promise(resolve => setTimeout(resolve, 500));
                
                // üî• –û–¢–ü–†–ê–í–ö–ê –¢–ï–ö–°–¢–ê –ê–ù–ö–ï–¢–´
                const textMsg = await ctx.reply(demoCaption, {
                    parse_mode: "HTML",
                    reply_markup: keyboard.length > 0 ? { inline_keyboard: keyboard } : undefined,
                });
                
                messageManager.track(ctx.chat.id, textMsg.message_id);
                console.log(`‚úÖ [DEMO PROFILE SENT] –ê–Ω–∫–µ—Ç–∞ ${fullProfile.name} –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ`);
                
                return textMsg;
                
            } else {
                // üî• –ü–û–õ–ù–´–ô –î–û–°–¢–£–ü
                console.log(`üëë [FULL ACCESS] –°–æ–∑–¥–∞–µ–º –ø–æ–ª–Ω—É—é –∞–Ω–∫–µ—Ç—É –¥–ª—è ${fullProfile.name}`);
                
                // üî• –ü–û–õ–ù–ê–Ø –ü–û–î–ü–ò–°–¨ (—Å –∫–æ–Ω—Ç–∞–∫—Ç–∞–º–∏)
                const fullCaption = `
üë§ <b>${fullProfile.name}</b>, ${fullProfile.age}
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
üìç <b>${fullProfile.city}, ${fullProfile.country}</b>
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
<em>${about.length > 300 ? about.substring(0, 300) + `...<a href="http://t.me/magicboss_bot/magic">—á–∏—Ç–∞—Ç—å –ø–æ–ª–Ω–æ—Å—Ç—å—é –≤ ‚ú®Magic</a>` : about}</em>
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
<b>üìû –ö–æ–Ω—Ç–∞–∫—Ç—ã:</b>
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
${fullProfile.phone ? formatPhone(fullProfile.phone) + '\n' : ''}
${fullProfile.telegram ? formatTelegram(fullProfile.telegram) + '\n' : ''}
${fullProfile.whatsapp ? formatWhatsApp(fullProfile.whatsapp) + '\n' : ''}
${(fullProfile.phone || fullProfile.telegram || fullProfile.whatsapp) ? '‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n' : ''}
‚ö†Ô∏è <b>–í–ù–ò–ú–ê–ù–ò–ï!</b>
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
<b>–ï–°–õ–ò –ö–¢–û-–¢–û –ü–†–û–°–ò–¢:</b>
‚Ä¢ –ö—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç—É –Ω–∞–ø–µ—Ä–µ–¥
‚Ä¢ –î–µ–Ω—å–≥–∏ –Ω–∞ —Ç–∞–∫—Å–∏üöï –∏–ª–∏ –¥–æ—Ä–æ–≥—É
‚Ä¢ –ü—Ä–µ–¥–æ–ø–ª–∞—Ç—É –ª—é–±—ã–º —Å–ø–æ—Å–æ–±–æ–º
‚Ä¢ –ü–µ—Ä–µ–≤–æ–¥—ã –Ω–∞ –∫–∞—Ä—Ç—ãüí≥ –∏–ª–∏ —ç–ª–µ–∫—Ç—Ä–æ–Ω–Ω—ã–µ –∫–æ—à–µ–ª—å–∫–∏
‚Ä¢ –ß–µ–∫–∏ –∏–ª–∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –æ–ø–ª–∞—Ç—ã

üî• üî• üî• üî• üî• üî• üî• üî• üî• üî• üî• üî• 
<b>–≠–¢–û 100% –ú–û–®–ï–ù–ù–ò–ö–ò!
–ù–ò –í –ö–û–ï–ú –°–õ–£–ß–ê–ï –ù–ï –û–¢–ü–†–ê–í–õ–Ø–ô–¢–ï –ü–†–ï–î–û–ü–õ–ê–¢–£  üõë –í–ê–° –û–ë–ú–ê–ù–£–¢!</b>
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
<a href="http://t.me/magicboss_bot/magic"><b>‚ú®Magic WebApp</b></a>
                `.trim();
                
                // üî• –ü–û–î–ì–û–¢–û–í–ö–ê –§–û–¢–û
                let photosToSend = [];
                const seenUrls = new Set();
                
                // –û—Å–Ω–æ–≤–Ω–æ–µ —Ñ–æ—Ç–æ
                if (fullProfile.photoUrl && fullProfile.photoUrl.trim() !== '') {
                    try {
                        const url = fullProfile.photoUrl.trim();
                        new URL(url);
                        if (!seenUrls.has(url)) {
                            seenUrls.add(url);
                            photosToSend.push(url);
                        }
                    } catch (e) {
                        console.log(`‚ùå [FULL PHOTO] –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π URL –æ—Å–Ω–æ–≤–Ω–æ–≥–æ —Ñ–æ—Ç–æ: ${e.message}`);
                    }
                }
                
                // –§–æ—Ç–æ –≥–∞–ª–µ—Ä–µ–∏
                if (Array.isArray(fullProfile.photos) && fullProfile.photos.length > 0) {
                    fullProfile.photos.forEach((url, index) => {
                        if (typeof url === 'string' && url.trim() !== '') {
                            try {
                                const cleanUrl = url.trim();
                                new URL(cleanUrl);
                                if (!seenUrls.has(cleanUrl)) {
                                    seenUrls.add(cleanUrl);
                                    photosToSend.push(cleanUrl);
                                }
                            } catch (e) {
                                console.log(`‚ùå [FULL PHOTO] –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π URL —Ñ–æ—Ç–æ ${index + 1}: ${e.message}`);
                            }
                        }
                    });
                }
                
                // –ï—Å–ª–∏ –Ω–µ—Ç —Ñ–æ—Ç–æ
                if (photosToSend.length === 0) {
                    console.log(`‚ö†Ô∏è [FULL PHOTOS] –ù–µ—Ç –≤–∞–ª–∏–¥–Ω—ã—Ö —Ñ–æ—Ç–æ –¥–ª—è ${fullProfile.name}`);
                }
                
                // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ
                photosToSend = photosToSend.slice(0, 10);
                console.log(`üì∏ [FULL PHOTOS] –ë—É–¥–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ ${photosToSend.length} —Ñ–æ—Ç–æ`);
                
                // üî• –ü–û–î–ì–û–¢–û–í–ö–ê –ö–ù–û–ü–û–ö –ü–ê–ì–ò–ù–ê–¶–ò–ò
                let keyboard = [];
                if (isLast) {
                    const filterKey = `country:${ctx.session?.filterCountry || 'all'}:age:${ctx.session?.ageRange?.label || 'all'}:city:${ctx.session?.filterCity || 'all'}`;
                    const filteredProfiles = cacheManager.getGlobalFilter(filterKey, false) || [];
                    const totalPages = Math.ceil((filteredProfiles.length || 0) / SCALING_CONFIG.PERFORMANCE.PROFILES_PER_PAGE);
                    
                    const currentFilters = {
                        country: ctx.session?.filterCountry,
                        city: ctx.session?.filterCity,
                        ageRange: ctx.session?.ageRange
                    };
                    
                    keyboard = createEnhancedPaginationKeyboard(page, totalPages, filterKey, currentFilters);
                    
                    // üî• –î–û–ë–ê–í–õ–Ø–ï–ú –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–´–ï –ö–ù–û–ü–ö–ò
                    keyboard.push(
                        [{ text: "üèôÔ∏è –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ –≥–æ—Ä–æ–¥–∞–º", callback_data: "back_to_current_country_cities" }],
                        [{ text: "üéÇ –§–∏–ª—å—Ç—Ä –ø–æ –≤–æ–∑—Ä–∞—Å—Ç—É", callback_data: "filter_by_age" }],
                        [{ text: "üåç –í—Å–µ —Å—Ç—Ä–∞–Ω—ã", callback_data: "all_countries_with_check" }],
                        [{ text: "üßπ –û—á–∏—Å—Ç–∏—Ç—å —ç–∫—Ä–∞–Ω", callback_data: "clear_screen" }]
                    );
                }
                
                // üî• –§–£–ù–ö–¶–ò–Ø –û–¢–ü–†–ê–í–ö–ò –§–û–¢–û
                const sendPhotoSafely = async (photoUrl, photoNumber, totalPhotos) => {
                    try {
                        const emojiNumbers = ['1Ô∏è‚É£', '2Ô∏è‚É£', '3Ô∏è‚É£', '4Ô∏è‚É£', '5Ô∏è‚É£', '6Ô∏è‚É£', '7Ô∏è‚É£', '8Ô∏è‚É£', '9Ô∏è‚É£', 'üîü'];
                        const numberEmoji = photoNumber <= 10 ? emojiNumbers[photoNumber - 1] : `${photoNumber}.`;
                        const photoCaption = `${numberEmoji} –§–æ—Ç–æ ${photoNumber}/${totalPhotos}`;
                        
                        console.log(`üñºÔ∏è [SEND PHOTO] –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ñ–æ—Ç–æ ${photoNumber}/${totalPhotos}: ${photoUrl.substring(0, 50)}...`);
                        
                        return await ctx.replyWithPhoto(photoUrl, { 
                            caption: photoCaption, 
                            parse_mode: "HTML" 
                        });
                    } catch (error) {
                        console.log(`‚ùå [SEND PHOTO ERROR] –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ç–æ ${photoNumber}: ${error.message}`);
                        return null;
                    }
                };
                
                // üî• –û–¢–ü–†–ê–í–ö–ê –§–û–¢–û
                if (photosToSend.length > 0) {
                    for (let i = 0; i < photosToSend.length; i++) {
                        const photoMsg = await sendPhotoSafely(photosToSend[i], i + 1, photosToSend.length);
                        if (photoMsg) {
                            messageManager.track(ctx.chat.id, photoMsg.message_id);
                            
                            if (i < photosToSend.length - 1) {
                                await new Promise(resolve => setTimeout(resolve, 800));
                            }
                        }
                    }
                }
                
                // üî• –ò–ù–§–û–†–ú–ê–¶–ò–û–ù–ù–û–ï –°–û–û–ë–©–ï–ù–ò–ï
                const infoMessage = await ctx.reply(
                    `‚ú®‚ú®‚ú®‚ú®‚ú®‚ú®‚ú®‚ú®‚ú®‚ú®\n<a href="http://t.me/MagicYourClub"><b>–ù–æ–≤—ã–µ –∞–Ω–∫–µ—Ç—ã –≤ –Ω–∞—à–µ–º ‚û°Ô∏è –∫–∞–Ω–∞–ª–µ</b></a>\n\n`,
                    { parse_mode: "HTML" }
                );
                messageManager.track(ctx.chat.id, infoMessage.message_id);
                await new Promise(resolve => setTimeout(resolve, 500));
                
                // üî• –û–¢–ü–†–ê–í–ö–ê –¢–ï–ö–°–¢–ê –ê–ù–ö–ï–¢–´
                const textMsg = await ctx.reply(fullCaption, {
                    parse_mode: "HTML",
                    reply_markup: keyboard.length > 0 ? { inline_keyboard: keyboard } : undefined,
                });
                
                messageManager.track(ctx.chat.id, textMsg.message_id);
                console.log(`‚úÖ [FULL PROFILE SENT] –ê–Ω–∫–µ—Ç–∞ ${fullProfile.name} –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ`);
                
                return textMsg;
            }
            
        } catch (error) {
            console.error(`üí• [SEND PROFILE CRITICAL ERROR] –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∞–Ω–∫–µ—Ç—ã:`, error);
            console.error(`üìã [ERROR DETAILS]`, {
                profile: profile ? 'exists' : 'undefined',
                page,
                total,
                isLast,
                isDemo,
                errorMessage: error.message,
                stack: error.stack
            });
            
            try {
                // üî• –û–®–ò–ë–ö–ê –≠–ö–†–ê–ù–ò–†–û–í–ê–ù–ò–Ø HTML - –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞
                if (error.message.includes("can't parse entities") || error.message.includes("Unsupported start tag")) {
                    console.error(`üîç [HTML PARSE ERROR] –û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ HTML –≤ –∞–Ω–∫–µ—Ç–µ`);
                    console.error(`üîç [PROBLEMATIC TEXT] –ü—Ä–æ–±–ª–µ–º–Ω—ã–π —Ç–µ–∫—Å—Ç:`, {
                        name: profile?.n || profile?.name,
                        city: profile?.ct || profile?.city,
                        country: profile?.c || profile?.country,
                        about: (profile?.ab || profile?.about)?.substring(0, 100) + '...'
                    });
                }
                
                // üî• –ü–û–°–õ–ï–î–ù–Ø–Ø –ü–û–ü–´–¢–ö–ê - –û–¢–ü–†–ê–í–ò–¢–¨ –ü–†–û–°–¢–û–ï –°–û–û–ë–©–ï–ù–ò–ï –ë–ï–ó HTML
                const fallbackText = `
‚ùå –û–®–ò–ë–ö–ê –ü–†–ò –û–¢–ü–†–ê–í–ö–ï –ê–ù–ö–ï–¢–´

–ü—Ä–∏–Ω–æ—Å–∏–º –∏–∑–≤–∏–Ω–µ–Ω–∏—è, –ø—Ä–æ–∏–∑–æ—à–ª–∞ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∞–Ω–∫–µ—Ç—ã.

–ß—Ç–æ –º–æ–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å:
1. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –≤—ã–±—Ä–∞—Ç—å –¥—Ä—É–≥–æ–π –≥–æ—Ä–æ–¥
2. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫—É "–û—á–∏—Å—Ç–∏—Ç—å —ç–∫—Ä–∞–Ω"
3. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ –ø–æ–∏—Å–∫

–ï—Å–ª–∏ –æ—à–∏–±–∫–∞ –ø–æ–≤—Ç–æ—Ä—è–µ—Ç—Å—è, –Ω–∞–ø–∏—à–∏—Ç–µ –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É @MagicAdd
                `.trim();
                
                const msg = await ctx.reply(fallbackText, { 
                    reply_markup: {
                        inline_keyboard: [
                            [{ text: "–û—á–∏—Å—Ç–∏—Ç—å —ç–∫—Ä–∞–Ω", callback_data: "clear_screen" }],
                            [{ text: "–í—Å–µ —Å—Ç—Ä–∞–Ω—ã", callback_data: "all_countries_with_check" }]
                        ]
                    }
                });
                
                messageManager.track(ctx.chat.id, msg.message_id);
                return msg;
                
            } catch (finalError) {
                console.error(`üíÄ [FATAL ERROR] –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –¥–∞–∂–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ:`, finalError);
                return null;
            }
        }
    });
};
bot.command("debug_demo_cache", async (ctx) => {
    try {
        // –ü–æ–ª—É—á–∞–µ–º –¥–µ–º–æ-–ø—Ä–æ—Ñ–∏–ª–∏
        const demoProfiles = cacheManager.getGlobalProfiles(true);
        
        if (!demoProfiles || demoProfiles.length === 0) {
            return ctx.reply("‚ùå –î–µ–º–æ-–∫—ç—à –ø—É—Å—Ç!");
        }
        
        // –ò—â–µ–º –í–°–ï –ø—Ä–æ—Ñ–∏–ª–∏
        let response = `üîç **–î–ò–ê–ì–ù–û–°–¢–ò–ö–ê –î–ï–ú–û-–ö–≠–®–ê:**\n\n`;
        response += `–í—Å–µ–≥–æ –¥–µ–º–æ-–ø—Ä–æ—Ñ–∏–ª–µ–π: ${demoProfiles.length}\n\n`;
        
        // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –ø–æ —Å—Ç—Ä–∞–Ω–∞–º
        const countries = new Map();
        demoProfiles.forEach(p => {
            const country = p.c || p.country || '–ë–µ–∑ —Å—Ç—Ä–∞–Ω—ã';
            const city = p.ct || p.city || '–ë–µ–∑ –≥–æ—Ä–æ–¥–∞';
            
            if (!countries.has(country)) {
                countries.set(country, {
                    total: 0,
                    cities: new Map()
                });
            }
            
            const countryData = countries.get(country);
            countryData.total++;
            
            if (!countryData.cities.has(city)) {
                countryData.cities.set(city, 0);
            }
            countryData.cities.set(city, countryData.cities.get(city) + 1);
        });
        
        // –í—ã–≤–æ–¥–∏–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
        countries.forEach((data, country) => {
            response += `**${country}:** ${data.total} –ø—Ä–æ—Ñ–∏–ª–µ–π\n`;
            
            // –í—ã–≤–æ–¥–∏–º –≥–æ—Ä–æ–¥–∞ —Å –ø—Ä–æ–±–ª–µ–º–∞–º–∏
            data.cities.forEach((count, city) => {
                if (count === 0 || count === undefined) {
                    response += `  ‚ö†Ô∏è ${city}: ${count} –ø—Ä–æ—Ñ–∏–ª–µ–π (–ü–†–û–ë–õ–ï–ú–ê!)\n`;
                }
            });
            
            // –ù–∞—Ö–æ–¥–∏–º –ø—Ä–æ—Ñ–∏–ª—å –°–∞—Ä–∞–µ–≤–æ
            if (country === "üáßüá¶ –ë–æ—Å–Ω–∏—è") {
                const sarajevoCount = data.cities.get("–°–∞—Ä–∞–µ–≤–æ") || 0;
                const mostarCount = data.cities.get("–ú–æ—Å—Ç–∞—Ä") || 0;
                response += `\n  üéØ **–ë–û–°–ù–ò–Ø –î–ï–¢–ê–õ–ò:**\n`;
                response += `  ‚Ä¢ –°–∞—Ä–∞–µ–≤–æ: ${sarajevoCount} –ø—Ä–æ—Ñ–∏–ª–µ–π\n`;
                response += `  ‚Ä¢ –ú–æ—Å—Ç–∞—Ä: ${mostarCount} –ø—Ä–æ—Ñ–∏–ª–µ–π\n`;
                
                // –ò—â–µ–º –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –ø—Ä–æ—Ñ–∏–ª–∏ –°–∞—Ä–∞–µ–≤–æ
                const sarajevoProfiles = demoProfiles.filter(p => 
                    (p.c === "üáßüá¶ –ë–æ—Å–Ω–∏—è" || p.country === "üáßüá¶ –ë–æ—Å–Ω–∏—è") && 
                    (p.ct === "–°–∞—Ä–∞–µ–≤–æ" || p.city === "–°–∞—Ä–∞–µ–≤–æ")
                );
                
                if (sarajevoProfiles.length > 0) {
                    response += `\n  **–ü—Ä–æ—Ñ–∏–ª–∏ –°–∞—Ä–∞–µ–≤–æ –≤ –¥–µ–º–æ-–∫—ç—à–µ:**\n`;
                    sarajevoProfiles.slice(0, 3).forEach((p, i) => {
                        response += `  ${i+1}. ${p.n || p.name}, ${p.a || p.age}\n`;
                        response += `     ID: ${p.id}\n`;
                        response += `     –§–æ—Ç–æ: ${p.p ? '‚úÖ' : '‚ùå'}\n`;
                        response += `     –§–æ—Ç–æ –≥–∞–ª–µ—Ä–µ–∏: ${p.phs?.length || 0}\n`;
                    });
                } else {
                    response += `\n  ‚ùå **–ù–ï–¢ –ü–†–û–§–ò–õ–ï–ô –°–ê–†–ê–ï–í–û –í –î–ï–ú–û-–ö–≠–®–ï!**\n`;
                }
            }
        });
        
        await ctx.reply(response);
        
    } catch (error) {
        console.error("–û—à–∏–±–∫–∞ debug_demo_cache:", error);
        await ctx.reply(`‚ùå –û—à–∏–±–∫–∞: ${error.message}`);
    }
});
bot.command("debug_demo_sarajevo_detail", async (ctx) => {
    try {
        const demoProfiles = cacheManager.getGlobalProfiles(true);
        
        if (!demoProfiles || demoProfiles.length === 0) {
            return ctx.reply("‚ùå –î–µ–º–æ-–∫—ç—à –ø—É—Å—Ç!");
        }
        
        // –ò—â–µ–º –ø—Ä–æ—Ñ–∏–ª–∏ –°–∞—Ä–∞–µ–≤–æ –≤ –¥–µ–º–æ-–∫—ç—à–µ
        const sarajevoProfiles = demoProfiles.filter(p => {
            const city = cacheManager.normalizeCityName(p.ct || p.city);
            const country = cacheManager.normalizeCountryName(p.c || p.country);
            return city === "–°–∞—Ä–∞–µ–≤–æ" && country === "üáßüá¶ –ë–æ—Å–Ω–∏—è";
        });
        
        let response = `üîç **–î–ï–¢–ê–õ–¨–ù–ê–Ø –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê –°–ê–†–ê–ï–í–û:**\n\n`;
        response += `–í—Å–µ–≥–æ –¥–µ–º–æ-–ø—Ä–æ—Ñ–∏–ª–µ–π: ${demoProfiles.length}\n`;
        response += `–ü—Ä–æ—Ñ–∏–ª–µ–π –°–∞—Ä–∞–µ–≤–æ –≤ –¥–µ–º–æ-–∫—ç—à–µ: ${sarajevoProfiles.length}\n\n`;
        
        if (sarajevoProfiles.length > 0) {
            sarajevoProfiles.forEach((p, i) => {
                response += `**–ü—Ä–æ—Ñ–∏–ª—å ${i+1}:**\n`;
                response += `‚Ä¢ ID: ${p.id || '–Ω–µ—Ç'}\n`;
                response += `‚Ä¢ –ò–º—è: "${p.n}"\n`;
                response += `‚Ä¢ –í–æ–∑—Ä–∞—Å—Ç: ${p.a}\n`;
                response += `‚Ä¢ –°—Ç—Ä–∞–Ω–∞: "${p.c}"\n`;
                response += `‚Ä¢ –ì–æ—Ä–æ–¥: "${p.ct}"\n`;
                response += `‚Ä¢ –û—Å–Ω–æ–≤–Ω–æ–µ —Ñ–æ—Ç–æ: ${p.p ? '‚úÖ' : '‚ùå'}\n`;
                response += `‚Ä¢ –§–æ—Ç–æ –≥–∞–ª–µ—Ä–µ–∏: ${p.phs?.length || 0}\n`;
                response += `‚Ä¢ isDemo: ${p.isDemo}\n`;
                response += `‚Ä¢ TG: ${p.tg ? '—Å–∫—Ä—ã—Ç–æ' : 'null'}\n`;
                response += `‚Ä¢ –û —Å–µ–±–µ: ${p.ab?.substring(0, 50) || '–Ω–µ—Ç'}...\n\n`;
            });
        } else {
            response += `‚ùå **–ù–ï–¢ –ü–†–û–§–ò–õ–ï–ô –°–ê–†–ê–ï–í–û –í –î–ï–ú–û-–ö–≠–®–ï!**\n\n`;
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏–Ω–¥–µ–∫—Å—ã
            const countryCityIndex = globalDemoCache.get("demo:index:country_city");
            if (countryCityIndex) {
                const key = "üáßüá¶ –ë–æ—Å–Ω–∏—è:–°–∞—Ä–∞–µ–≤–æ";
                const indexes = countryCityIndex.get(key);
                response += `üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏–Ω–¥–µ–∫—Å–∞ "${key}": ${indexes ? indexes.length : 0} –ø—Ä–æ—Ñ–∏–ª–µ–π\n`;
            }
        }
        
        await ctx.reply(response);
        
    } catch (error) {
        console.error("–û—à–∏–±–∫–∞ debug_demo_sarajevo_detail:", error);
        await ctx.reply(`‚ùå –û—à–∏–±–∫–∞: ${error.message}`);
    }
});
    bot.command("stats", async (ctx) => {
        await messageQueue.add(async () => {
            try {
                const stats = readingStats.getStats();
                const cacheStats = cacheManager.getGlobalCacheStats();
                
                const statsMessage = `
üìä **–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å–∏—Å—Ç–µ–º—ã**

**–û–ø–µ—Ä–∞—Ü–∏–∏ —á—Ç–µ–Ω–∏—è:**
‚Ä¢ –í—Å–µ–≥–æ –æ–ø–µ—Ä–∞—Ü–∏–π: ${stats.totalReads}
‚Ä¢ Firestore —á—Ç–µ–Ω–∏–π: ${stats.firestoreReads}
‚Ä¢ –ö—ç—à –ø–æ–ø–∞–¥–∞–Ω–∏—è: ${stats.operations.cacheHits}
‚Ä¢ –ö—ç—à –ø—Ä–æ–º–∞—Ö–∏: ${stats.operations.cacheMisses}
‚Ä¢ –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –∫—ç—à–∞: ${stats.cacheEfficiency}

**–î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è –æ–ø–µ—Ä–∞—Ü–∏–π:**
‚Ä¢ –ü—Ä–æ—Ñ–∏–ª–∏: ${stats.operations.profiles}
‚Ä¢ –ü–æ–¥–ø–∏—Å–∫–∏: ${stats.operations.subscriptions}
‚Ä¢ –ü—Ä–æ–≤–µ—Ä–∫–∏ –∫–∞–Ω–∞–ª–∞: ${stats.operations.channelSubscriptions}
‚Ä¢ –°—Ç—Ä–∞–Ω—ã: ${stats.operations.countries}
‚Ä¢ –ì–æ—Ä–æ–¥–∞: ${stats.operations.cities}

**–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏:**
‚Ä¢ –£–Ω–∏–∫–∞–ª—å–Ω—ã–µ: ${stats.uniqueUsers}
‚Ä¢ –û–ø–µ—Ä–∞—Ü–∏–π –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: ${stats.readsPerUser.toFixed(2)}

**–ì–ª–æ–±–∞–ª—å–Ω—ã–π –∫—ç—à:**
‚Ä¢ –ü–æ–ª–Ω—ã–π –∫—ç—à –∑–∞–≥—Ä—É–∂–µ–Ω: ${cacheStats.fullCache.loaded ? '‚úÖ' : '‚ùå'}
‚Ä¢ –î–µ–º–æ –∫—ç—à –∑–∞–≥—Ä—É–∂–µ–Ω: ${cacheStats.demoCache.loaded ? '‚úÖ' : '‚ùå'}
‚Ä¢ –ü–æ–ª–Ω—ã—Ö –ø—Ä–æ—Ñ–∏–ª–µ–π: ${cacheStats.fullCache.profilesCount}
‚Ä¢ –î–µ–º–æ –ø—Ä–æ—Ñ–∏–ª–µ–π: ${cacheStats.demoCache.profilesCount}
‚Ä¢ –ü–æ–ª–Ω—ã—Ö —Ñ–∏–ª—å—Ç—Ä–æ–≤: ${cacheStats.filterCacheKeys}
‚Ä¢ –î–µ–º–æ —Ñ–∏–ª—å—Ç—Ä–æ–≤: ${cacheStats.demoFilterCacheKeys}

**–ò–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–µ –∫—ç—à–∏:**
‚Ä¢ –ü–æ–¥–ø–∏—Å–æ–∫ –≤ –∫—ç—à–µ: ${cacheStats.subscriptionCacheCount}
‚Ä¢ –ü—Ä–æ–≤–µ—Ä–æ–∫ –∫–∞–Ω–∞–ª–∞ –≤ –∫—ç—à–µ: ${cacheStats.channelCacheCount}
‚Ä¢ –°—Ç–∞—Ç—É—Å–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: ${cacheStats.userStatusCacheCount}

**–û—á–µ—Ä–µ–¥—å:**
‚Ä¢ –ê–∫—Ç–∏–≤–Ω—ã–µ –∑–∞–¥–∞—á–∏: ${messageQueue.pending}
‚Ä¢ –ó–∞–¥–∞—á–∏ –≤ –æ–∂–∏–¥–∞–Ω–∏–∏: ${messageQueue.size}
                `;
                
                const msg = await ctx.reply(statsMessage, { parse_mode: "Markdown" });
                messageManager.track(ctx.chat.id, msg.message_id);
                
            } catch (error) {
                console.error("‚ùå –û—à–∏–±–∫–∞ –∫–æ–º–∞–Ω–¥—ã stats:", error);
            }
        });
    });

    bot.command("reset_stats", async (ctx) => {
        await messageQueue.add(async () => {
            try {
                readingStats.resetStats();
                const msg = await ctx.reply("‚úÖ –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —á—Ç–µ–Ω–∏–π —Å–±—Ä–æ—à–µ–Ω–∞");
                messageManager.track(ctx.chat.id, msg.message_id);
            } catch (error) {
                console.error("‚ùå –û—à–∏–±–∫–∞ —Å–±—Ä–æ—Å–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏:", error);
            }
        });
    });

    // –≠–∫—Å–ø–æ—Ä—Ç —Ñ—É–Ω–∫—Ü–∏–π
    module.exports.ensureProperCache = ensureProperCache;
    module.exports.checkFullAccess = checkFullAccess;
    module.exports.checkSubscription = checkSubscription;
    module.exports.checkChannelSubscription = checkChannelSubscription;

   // –í –∫–æ–Ω–µ—Ü —Ñ—É–Ω–∫—Ü–∏–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –¥–æ–±–∞–≤—å—Ç–µ:
setTimeout(async () => {
    if (!globalCacheInitialized) {
        console.log('üöÄ [BOT START] –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≥–ª–æ–±–∞–ª—å–Ω—ã—Ö –∫—ç—à–µ–π...');
        try {
            // –ò–ù–ò–¶–ò–ê–õ–ò–ó–ò–†–£–ï–ú –¢–û–õ–¨–ö–û –ì–õ–û–ë–ê–õ–¨–ù–´–ô –î–ï–ú–û-–ö–≠–® (–æ–¥–∏–Ω —Ä–∞–∑ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ)
            if (!cacheManager.isGlobalDemoCacheLoaded()) {
                console.log('üîÑ [STARTUP] –ó–∞–≥—Ä—É–∑–∫–∞ –≥–ª–æ–±–∞–ª—å–Ω–æ–≥–æ –¥–µ–º–æ-–∫—ç—à–∞...');
                await cacheManager.loadGlobalDemoCache(db);
            }
            
            // üî• –ü–ï–†–ò–û–î–ò–ß–ï–°–ö–û–ï –û–ë–ù–û–í–õ–ï–ù–ò–ï –ö–≠–®–ï–ô –†–ê–ó –í 7 –î–ù–ï–ô
            setInterval(async () => {
                console.log('üîÑ [AUTO CACHE UPDATE] –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≥–ª–æ–±–∞–ª—å–Ω—ã—Ö –∫—ç—à–µ–π (—Ä–∞–∑ –≤ 7 –¥–Ω–µ–π)...');
                try {
                    // –û–±–Ω–æ–≤–ª—è–µ–º –¥–µ–º–æ-–∫—ç—à
                    console.log('üîÑ [AUTO UPDATE] –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≥–ª–æ–±–∞–ª—å–Ω–æ–≥–æ –¥–µ–º–æ-–∫—ç—à–∞...');
                    await cacheManager.loadGlobalDemoCache(db);
                    
                    // –ï—Å–ª–∏ –ø–æ–ª–Ω—ã–π –∫—ç—à –∑–∞–≥—Ä—É–∂–µ–Ω, –æ–±–Ω–æ–≤–ª—è–µ–º –∏ –µ–≥–æ
                    if (cacheManager.isGlobalFullCacheLoaded()) {
                        console.log('üîÑ [AUTO UPDATE] –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≥–ª–æ–±–∞–ª—å–Ω–æ–≥–æ –ø–æ–ª–Ω–æ–≥–æ –∫—ç—à–∞...');
                        await cacheManager.loadGlobalFullCache(db);
                    }
                } catch (error) {
                    console.error('‚ùå [AUTO CACHE UPDATE] –û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫—ç—à–µ–π:', error);
                }
            }, 7 * 24 * 60 * 60 * 1000); // 7 –¥–Ω–µ–π
            
            globalCacheInitialized = true;
            console.log('‚úÖ [BOT START] –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≥–ª–æ–±–∞–ª—å–Ω—ã—Ö –∫—ç—à–µ–π –∑–∞–≤–µ—Ä—à–µ–Ω–∞');
            
        } catch (error) {
            console.error('‚ùå [BOT START] –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –≥–ª–æ–±–∞–ª—å–Ω—ã—Ö –∫—ç—à–µ–π:', error);
        }
    }
}, 3000);

    console.log(`‚úÖ –ú–æ–¥—É–ª—å –ø—Ä–æ—Ñ–∏–ª–µ–π –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω —Å –ì–õ–û–ë–ê–õ–¨–ù–´–ú –ö–≠–®–ï–ú`);
    console.log(`üìä –ì–ª–æ–±–∞–ª—å–Ω—ã–π –¥–µ–º–æ-–∫—ç—à: –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ –±–æ—Ç–∞`);
    console.log(`üìä –ì–ª–æ–±–∞–ª—å–Ω—ã–π –ø–æ–ª–Ω—ã–π –∫—ç—à: –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ —Å –ø–æ–¥–ø–∏—Å–∫–æ–π`);
    console.log(`üìä –ö—ç—à –ø–æ–¥–ø–∏—Å–æ–∫: 24 —á–∞—Å–∞ (–∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–π)`);
    console.log(`üìä –ö—ç—à –ø—Ä–æ–≤–µ—Ä–∫–∏ –∫–∞–Ω–∞–ª–∞: 5 –º–∏–Ω—É—Ç (–∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–π)`);
    console.log(`üìä –û–î–ù–ê –∑–∞–≥—Ä—É–∑–∫–∞ –¥–ª—è –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π!`);
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–ª–Ω–æ–≥–æ –∫—ç—à–∞ –ø–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã (–¥–ª—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å payments.js)
    module.exports.loadFullCacheAfterPayment = async (userId) => {
        console.log(`üöÄ [AFTER PAYMENT] –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ${userId} –æ–ø–ª–∞—Ç–∏–ª –ø–æ–¥–ø–∏—Å–∫—É, –ø—Ä–æ–≤–µ—Ä—è–µ–º –≥–ª–æ–±–∞–ª—å–Ω—ã–π –ø–æ–ª–Ω—ã–π –∫—ç—à`);
        
        if (!cacheManager.isGlobalFullCacheLoaded()) {
            console.log(`üîÑ [AFTER PAYMENT] –ó–∞–≥—Ä—É–∂–∞–µ–º –≥–ª–æ–±–∞–ª—å–Ω—ã–π –ø–æ–ª–Ω—ã–π –∫—ç—à –¥–ª—è ${userId}`);
            await cacheManager.lazyLoadGlobalFullCache(db, userId);
        } else {
            console.log(`‚úÖ [AFTER PAYMENT] –ì–ª–æ–±–∞–ª—å–Ω—ã–π –ø–æ–ª–Ω—ã–π –∫—ç—à —É–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω`);
        }
    };
    setInterval(() => {
        if (globalCacheInitialized) {
            console.log('üíæ –ü–ª–∞–Ω–æ–≤–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∫—ç—à–∞ –Ω–∞ –¥–∏—Å–∫...');
            diskCache.saveAllCaches(
                globalProfilesCache,
                globalDemoCache,
                globalFilterCache
            ).catch(e => console.error('–û—à–∏–±–∫–∞ –ø–ª–∞–Ω–æ–≤–æ–≥–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:', e.message));
        }
    }, 30 * 60 * 1000); // 30 –º–∏–Ω—É—Ç

    // üíæ –°–û–•–†–ê–ù–ï–ù–ò–ï –ü–†–ò –í–´–ö–õ–Æ–ß–ï–ù–ò–ò –ë–û–¢–ê
    const saveCacheOnExit = () => {
        console.log('üîª –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫—ç—à –ø–µ—Ä–µ–¥ –≤—ã—Ö–æ–¥–æ–º...');
        diskCache.saveAllCaches(
            globalProfilesCache,
            globalDemoCache,
            globalFilterCache
        ).finally(() => {
            console.log('‚úÖ –ö—ç—à —Å–æ—Ö—Ä–∞–Ω–µ–Ω, –∑–∞–≤–µ—Ä—à–∞–µ–º —Ä–∞–±–æ—Ç—É');
            if (fs.existsSync(LOCK_FILE)) fs.unlinkSync(LOCK_FILE);
            process.exit(0);
        });
    };

    process.on('SIGINT', saveCacheOnExit);
    process.on('SIGTERM', saveCacheOnExit);

    // üìä –ö–û–ú–ê–ù–î–ê –î–õ–Ø –ü–†–û–í–ï–†–ö–ò –ö–≠–®–ê
    bot.command('cache_info', async (ctx) => {
        const cacheInfo = diskCache.getCacheInfo();
        const demoCount = cacheManager.getGlobalProfiles(true)?.length || 0;
        const fullCount = cacheManager.getGlobalProfiles(false)?.length || 0;
        
        let message = `üíæ <b>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –¥–∏—Å–∫–æ–≤–æ–º –∫—ç—à–µ</b>\n\n`;
        
        if (cacheInfo.exists) {
            message += `üìÇ –§–∞–π–ª –∫—ç—à–∞: ‚úÖ –°—É—â–µ—Å—Ç–≤—É–µ—Ç\n`;
            message += `üì¶ –†–∞–∑–º–µ—Ä: ${cacheInfo.size}\n`;
            message += `üïê –í–æ–∑—Ä–∞—Å—Ç: ${cacheInfo.age}\n`;
            message += `üìÖ –°–æ–∑–¥–∞–Ω: ${cacheInfo.date}\n\n`;
            message += `üóÇÔ∏è –ö–ª—é—á–µ–π –≤ –∫—ç—à–µ:\n`;
            message += `‚Ä¢ –ü—Ä–æ—Ñ–∏–ª–µ–π: ${cacheInfo.keys.profiles}\n`;
            message += `‚Ä¢ –î–µ–º–æ-–¥–∞–Ω–Ω—ã—Ö: ${cacheInfo.keys.demo}\n`;
            message += `‚Ä¢ –§–∏–ª—å—Ç—Ä–æ–≤: ${cacheInfo.keys.filters}\n\n`;
        } else {
            message += `üìÇ –§–∞–π–ª –∫—ç—à–∞: ‚ùå –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç\n\n`;
        }
        
        message += `üìä <b>–í –æ–ø–µ—Ä–∞—Ç–∏–≤–Ω–æ–π –ø–∞–º—è—Ç–∏:</b>\n`;
        message += `‚Ä¢ –î–µ–º–æ-–ø—Ä–æ—Ñ–∏–ª–µ–π: ${demoCount}\n`;
        message += `‚Ä¢ –ü–æ–ª–Ω—ã—Ö –ø—Ä–æ—Ñ–∏–ª–µ–π: ${fullCount}\n`;
        message += `‚Ä¢ –°—Ç—Ä–∞–Ω –≤ –¥–µ–º–æ: ${cacheManager.getGlobalCountries(true)?.length || 0}\n`;
        message += `‚Ä¢ –§–∏–ª—å—Ç—Ä–æ–≤ –≤ –∫—ç—à–µ: ${globalFilterCache.keys().length}\n\n`;
        message += `<code>–ö—ç—à —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –∫–∞–∂–¥—ã–µ 30 –º–∏–Ω—É—Ç</code>`;
        
        await ctx.reply(message, { parse_mode: 'HTML' });
    });

    console.log(`‚úÖ –ú–æ–¥—É–ª—å –ø—Ä–æ—Ñ–∏–ª–µ–π —Å –î–ò–°–ö–û–í–´–ú –ö–≠–®–ï–ú –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω`);
};
